---
layout: page
title: è¨­å®š
permalink: /settings/
---

<link rel="stylesheet" href="{{ '/assets/settings.css' | relative_url }}">

<div id="user-info"></div>
<div id="loading-overlay" class="loading-overlay">
  <div id="loading-progress" style="width: 300px; text-align: center;">
    <div class="progress-text" style="font-size: 16px; margin-bottom: 15px; color: #333;">è¼‰å…¥ä¸­...</div>
    <div style="width: 100%; height: 8px; background-color: #e0e0e0; border-radius: 4px; overflow: hidden;">
      <div class="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px; transition: width 0.3s ease;"></div>
    </div>
  </div>
</div>
<div id="settings-root"></div>

<script>
// API URLï¼ˆæ”¯å‡ºè¡¨ï¼Œæœ€æ–°ï¼‰â”€â”€ ä½¿ç”¨ä½ æŒ‡å®šçš„æ–°ç‰ˆæ”¯å‡º URL
const baseExpense = "https://script.google.com/macros/s/AKfycbxbnCH9JYNcLv4vGJw_lBCbdSmdnX9Cn8o9AfDAo6wX2JmOWFoSgZUANp_P7HSRF8by/exec";
// API URLï¼ˆé ç®—è¡¨ï¼Œæœ€æ–°ï¼‰
const baseBudget  = "https://script.google.com/macros/s/AKfycbzBgww1mzRv3XOuX3uBA9Z93mXxKDZ0JVAycjHTy14PZxImlN-A5iL9aZ2vxTe_JjmF3A/exec";

// è¨­å®šé …ç›®è³‡æ–™ï¼ˆæ¨™é¡Œç”¨æ–¼åœ¨ Google Sheet ä¸­è­˜åˆ¥æ¬„ä½ï¼‰
// æŒ‰éˆ•é¡è‰²èˆ‡é¦–é é †åºä¸€è‡´ï¼šè—ï¼ˆæ”¯ä»˜æ–¹å¼ï¼‰ã€ç´«ï¼ˆæ¶ˆè²»é¡åˆ¥ï¼‰ã€æ©˜ï¼ˆæ”¯ä»˜å¹³å°ï¼‰
const settingsItems = [
  { id: 'payment', icon: 'ğŸ’³', title: 'æ”¯ä»˜æ–¹å¼', colorClass: 'btn-payment', headerKeywords: ['æ”¯ä»˜æ–¹å¼'] },
  { id: 'category', icon: 'ğŸ·ï¸', title: 'æ¶ˆè²»é¡åˆ¥', colorClass: 'btn-category', headerKeywords: ['æ”¯å‡ºï¼é …ç›®', 'æ”¯å‡º-é …ç›®', 'æ¶ˆè²»é¡åˆ¥', 'é¡åˆ¥'] },
  { id: 'platform', icon: 'ğŸ¦', title: 'æ”¯ä»˜å¹³å°', colorClass: 'btn-platform', headerKeywords: ['æ”¯ä»˜å¹³å°', 'å¹³å°'] }
];

// ä¸‹æ‹‰é¸å–®è³‡æ–™å¿«å–
let dropdownData = {};
// æ¬„ä½ç´¢å¼•å°æ‡‰ï¼ˆå¾æ¨™é¡Œè¡Œè®€å–ï¼‰
let columnMapping = {};
// åŸå§‹è³‡æ–™ï¼ˆç”¨æ–¼åŒæ­¥ï¼‰
let originalSheetData = [];
// æ˜¯å¦å·²è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™
let dropdownLoaded = false;

const root = document.getElementById('settings-root');
const loadingOverlay = document.getElementById('loading-overlay');

// æ›´æ–°é€²åº¦æ¢
function updateProgress(current, total, text = 'è¼‰å…¥ä¸­...') {
  const progressContainer = document.getElementById('loading-progress');
  if (!progressContainer) return;
  
  const percentage = total > 0 ? Math.min(100, Math.round((current / total) * 100)) : 0;
  const progressBar = progressContainer.querySelector('.progress-bar');
  const progressText = progressContainer.querySelector('.progress-text');
  
  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
  }
  if (progressText) {
    progressText.textContent = total > 0 ? `${text} (${current}/${total})` : text;
  }
}

// é¡¯ç¤º/éš±è— loading
function showLoading() {
  loadingOverlay.style.display = 'flex';
  updateProgress(0, 0, 'è¼‰å…¥ä¸­...');
}
function hideLoading() {
  const progressContainer = document.getElementById('loading-progress');
  if (progressContainer) {
    const progressBar = progressContainer.querySelector('.progress-bar');
    const progressText = progressContainer.querySelector('.progress-text');
    if (progressBar) {
      progressBar.style.width = '100%';
      progressBar.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
    }
    if (progressText) {
      progressText.textContent = 'âœ“ å·²å®Œæˆ';
      progressText.style.color = '#2ecc71';
      progressText.style.fontWeight = 'bold';
    }
  }
  
  setTimeout(() => {
    loadingOverlay.style.display = 'none';
    // é‡ç½®é€²åº¦æ¢
    if (progressContainer) {
      const progressBar = progressContainer.querySelector('.progress-bar');
      const progressText = progressContainer.querySelector('.progress-text');
      if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.style.background = 'linear-gradient(90deg, #3498db, #2ecc71)';
      }
      if (progressText) {
        progressText.textContent = 'è¼‰å…¥ä¸­...';
        progressText.style.color = '#333';
        progressText.style.fontWeight = 'normal';
      }
    }
  }, 800);
}

// å¾ Google Sheet è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™ï¼ˆsheetIndex = 1ï¼‰
async function loadDropdownData() {
  try {
    const params = { name: "Show Tab Data", sheet: 1, _t: Date.now() };
    const url = `${baseExpense}?${new URLSearchParams(params)}`;
    const res = await fetch(url, {
      method: "GET",
      redirect: "follow",
      mode: "cors",
      cache: "no-store"
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const responseData = await res.json();
    // è™•ç†ä¸åŒçš„è³‡æ–™æ ¼å¼
    let data = null;
    
    // å¦‚æœæ˜¯é™£åˆ—ï¼Œç›´æ¥ä½¿ç”¨
    if (Array.isArray(responseData)) {
      data = responseData;
    } 
    // å¦‚æœæ˜¯ç‰©ä»¶ï¼Œå¯èƒ½æ˜¯å‘½åç¯„åœçš„æ ¼å¼ï¼Œå˜—è©¦æ‰¾åˆ°ç¬¬ä¸€å€‹é™£åˆ—å€¼
    else if (typeof responseData === 'object' && responseData !== null) {
      // å°‹æ‰¾ç¬¬ä¸€å€‹å€¼æ˜¯é™£åˆ—çš„éµ
      for (const key in responseData) {
        if (Array.isArray(responseData[key]) && responseData[key].length > 0) {
          data = responseData[key];
          break;
        }
      }
      // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦ç›´æ¥ä½¿ç”¨æ•´å€‹ sheet çš„è³‡æ–™ç¯„åœ
      // é€™éœ€è¦ GAS è¿”å›æ•´å€‹ sheet çš„è³‡æ–™ï¼Œè€Œä¸æ˜¯å‘½åç¯„åœ
    }
    
    if (!data || !Array.isArray(data) || data.length === 0) {
      // ä¿æŒ dropdownLoaded ç‚º falseï¼Œç¨å¾Œå†æ¬¡é»æ“Šåˆ†é¡æ™‚æœƒå†å˜—è©¦è¼‰å…¥
      return {};
    }
    
    originalSheetData = data;
    const headerRow = data[0];
    // æ ¹æ“šæ¨™é¡Œæ‰¾åˆ°æ¯å€‹è¨­å®šé …ç›®å°æ‡‰çš„æ¬„ä½ç´¢å¼•
    settingsItems.forEach(item => {
      columnMapping[item.id] = -1;
      for (let col = 0; col < headerRow.length; col++) {
        const headerText = (headerRow[col] || '').toString().trim();
        if (item.headerKeywords.some(keyword => headerText.includes(keyword))) {
          columnMapping[item.id] = col;
          break;
        }
      }
    });
    
    // è®€å–é¸é …ï¼ˆè·³éæ¨™é¡Œè¡Œï¼‰
    settingsItems.forEach(item => {
      dropdownData[item.id] = [];
      const col = columnMapping[item.id];
      if (col >= 0) {
        const seen = new Set(); // é¿å…é‡è¤‡
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (!row) continue;
          const raw = row[col];
          if (raw === undefined || raw === null) continue;
          const val = raw.toString().trim();
          if (!val || seen.has(val)) continue;
          seen.add(val);
          dropdownData[item.id].push(val);
        }
      }
    });
    dropdownLoaded = true;
    return dropdownData;
  } catch (error) {
    // ä¿æŒ dropdownLoaded ç‚º falseï¼Œç¨å¾Œå†æ¬¡é»æ“Šåˆ†é¡æ™‚æœƒå†å˜—è©¦è¼‰å…¥
    return {};
  }
}

// åŒæ­¥è³‡æ–™åˆ° Google Sheet
// å°æ–¼ reorder æ“ä½œï¼šrowIndex æ˜¯ newIndexï¼ŒnewValue æ˜¯ newIndexï¼ŒoldValue æ˜¯ oldIndex
async function syncToSheet(itemId, action, rowIndex, newValue, oldValue) {
  const col = columnMapping[itemId];
  if (col < 0) {
    return false;
  }

  // é–å®šæ•´å€‹è¨­å®šé ï¼šé¡¯ç¤º loadingï¼Œé¿å…åœ¨è«‹æ±‚éç¨‹ä¸­ç¹¼çºŒæ“ä½œ
  showLoading();
  // åŒæ™‚åœç”¨æ‰€æœ‰æŒ‰éˆ•ï¼Œç­‰å›å‚³å¾Œæ‰æ¢å¾©
  const allButtons = document.querySelectorAll('button, .settings-btn, .add-option-btn, .delete-option-btn');
  allButtons.forEach(btn => {
    btn.dataset._prevDisabled = btn.disabled ? '1' : '0';
    btn.disabled = true;
  });

  try {
    const postData = {
      name: "Update Dropdown",
      itemId,          // 'category' / 'payment' / 'platform'
      action,          // 'edit', 'add', 'delete', 'reorder'
      column: col,     // ä¸‹æ‹‰é¸å–®è¡¨ä¸­çš„æ¬„ä½ï¼ˆå¦‚æœå¾Œç«¯éœ€è¦ï¼‰
      rowIndex,        // åŸæœ¬åœ¨ä¸‹æ‹‰é¸å–®è¡¨ä¸­çš„ç´¢å¼•ï¼ˆå¦‚æœå¾Œç«¯éœ€è¦ï¼‰
      oldValue: oldValue || '',
      newValue: newValue || '',
      oldIndex: action === 'reorder' ? (typeof oldValue === 'number' ? oldValue : -1) : undefined,
      newIndex: action === 'reorder' ? (typeof newValue === 'number' ? newValue : -1) : undefined
    };
    
    // åªæœ‰ã€Œé¡åˆ¥ã€éœ€è¦åŒæ™‚æ›´æ–°æ”¯å‡ºè¡¨å’Œé ç®—è¡¨ï¼Œå…¶ä»–é …ç›®åªæ›´æ–°æ”¯å‡ºè¡¨
    const isCategory = itemId === 'category';
    
    if (isCategory) {
      
      // åŒæ™‚æ›´æ–°æ”¯å‡ºè¡¨èˆ‡é ç®—è¡¨
      const [resExpense, resBudget] = await Promise.all([
        fetch(baseExpense, {
          method: "POST",
          redirect: "follow",
          mode: "cors",
          body: JSON.stringify(postData)
        }),
        fetch(baseBudget, {
          method: "POST",
          redirect: "follow",
          mode: "cors",
          body: JSON.stringify(postData)
        })
      ]);

      const textExpense = await resExpense.text();
      const textBudget  = await resBudget.text();
      // æª¢æŸ¥å›æ‡‰æ˜¯å¦æˆåŠŸ
      let resultExpense, resultBudget;
      try {
        resultExpense = JSON.parse(textExpense);
        resultBudget = JSON.parse(textBudget);
      } catch (e) {
        return false;
      }

      if (!resultExpense.success || !resultBudget.success) {
        const errorMsg = `åŒæ­¥å¤±æ•—ï¼š\næ”¯å‡ºè¡¨ï¼š${resultExpense.message || 'æœªçŸ¥éŒ¯èª¤'}\né ç®—è¡¨ï¼š${resultBudget.message || 'æœªçŸ¥éŒ¯èª¤'}`;
        alert(errorMsg);
        return false;
      }
    } else {
      
      // åªæ›´æ–°æ”¯å‡ºè¡¨
      const resExpense = await fetch(baseExpense, {
        method: "POST",
        redirect: "follow",
        mode: "cors",
        body: JSON.stringify(postData)
      });

      const textExpense = await resExpense.text();
      // æª¢æŸ¥å›æ‡‰æ˜¯å¦æˆåŠŸ
      let resultExpense;
      try {
        resultExpense = JSON.parse(textExpense);
      } catch (e) {
        return false;
      }

      if (!resultExpense.success) {
        const errorMsg = `åŒæ­¥å¤±æ•—ï¼š\næ”¯å‡ºè¡¨ï¼š${resultExpense.message || 'æœªçŸ¥éŒ¯èª¤'}`;
        alert(errorMsg);
        return false;
      }
    }

    // å¦‚æœæ˜¯æ’åºæ“ä½œï¼Œä¸éœ€è¦é‡æ–°è¼‰å…¥å…¨éƒ¨è³‡æ–™ï¼Œåªéœ€è¦é‡æ–°æ¸²æŸ“ç•¶å‰åˆ—è¡¨
    if (action === 'reorder') {
      // æ’åºæ“ä½œå¾Œï¼Œåªéœ€è¦é‡æ–°æ¸²æŸ“ç•¶å‰æ‰“é–‹çš„é¢æ¿ï¼ˆdropdownData å·²ç¶“åœ¨å‰ç«¯æ›´æ–°äº†ï¼‰
      const activePanel = document.querySelector('.content-panel.active');
      if (activePanel) {
        const panelId = activePanel.id.replace('panel-', '');
        renderOptionsList(panelId);
      }
    } else {
      // å…¶ä»–æ“ä½œï¼ˆæ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤ï¼‰éœ€è¦é‡æ–°è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™ä»¥ç¢ºä¿ä¸€è‡´æ€§
      try {
        await loadDropdownData();
        // é‡æ–°æ¸²æŸ“ç•¶å‰æ‰“é–‹çš„é¢æ¿ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        const activePanel = document.querySelector('.content-panel.active');
        if (activePanel) {
          const panelId = activePanel.id.replace('panel-', '');
          renderOptionsList(panelId);
        }
      } catch (e) {
      }
    }

    // é€šçŸ¥å…¶ä»–é é¢é‡æ–°è¼‰å…¥ä¸‹æ‹‰é¸å–®
    try {
      const updateTime = Date.now().toString();
      localStorage.setItem('dropdownUpdated', updateTime);
      localStorage.setItem('dropdownUpdatedItemId', itemId);
      localStorage.setItem('dropdownUpdatedAction', action);
      // è§¸ç™¼ storage äº‹ä»¶ï¼ˆå¦‚æœå…¶ä»–é é¢åœ¨åŒä¸€å€‹ç€è¦½å™¨è¦–çª—ï¼‰
      window.dispatchEvent(new StorageEvent('storage', {
        key: 'dropdownUpdated',
        newValue: updateTime
      }));
      // ä¹Ÿè§¸ç™¼è‡ªå®šç¾©äº‹ä»¶ï¼Œç”¨æ–¼åŒä¸€é é¢çš„æ›´æ–°
      window.dispatchEvent(new CustomEvent('dropdownUpdated', {
        detail: { itemId, action, updateTime }
      }));
    } catch (e) {
    }

    return true;
  } catch (error) {
    return false;
  } finally {
    // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½è§£é™¤é–å®š
    hideLoading();
    allButtons.forEach(btn => {
      if (btn.dataset._prevDisabled === '0') {
        btn.disabled = false;
      }
      delete btn.dataset._prevDisabled;
    });
  }
}

// å»ºç«‹ä¸»é¸å–®
function createMainMenu() {
  const container = document.createElement('div');
  container.id = 'main-menu';
  container.className = 'settings-container';
  
  // æ·»åŠ æ¨™é¡Œ
  const title = document.createElement('h1');
  title.className = 'settings-title';
  title.textContent = 'è¨­å®š';
  container.appendChild(title);
  
  // æ·»åŠ æŒ‰éˆ•å®¹å™¨
  const buttonsContainer = document.createElement('div');
  buttonsContainer.className = 'settings-buttons-container';
  
  settingsItems.forEach(item => {
    const btn = document.createElement('a');
    btn.href = '#';
    btn.className = `settings-btn ${item.colorClass}`;
    btn.innerHTML = `<span class="btn-icon">${item.icon}</span>${item.title}`;
    btn.onclick = (e) => {
      e.preventDefault();
      showPanel(item.id);
    };
    buttonsContainer.appendChild(btn);
  });
  
  container.appendChild(buttonsContainer);
  return container;
}

// å»ºç«‹å…§å®¹é¢æ¿
function createPanel(item) {
  const panel = document.createElement('div');
  panel.id = `panel-${item.id}`;
  panel.className = 'content-panel';
  
  panel.innerHTML = `
    <div class="panel-header">
      <h2 class="panel-title">${item.icon} ${item.title}</h2>
      <button class="back-btn">â† è¿”å›</button>
    </div>
    <div class="panel-content">
      <div class="options-list" id="list-${item.id}"></div>
      <div class="add-option-container">
        <input type="text" class="add-option-input" id="input-${item.id}" name="input-${item.id}" placeholder="æ–°å¢é¸é …...">
        <button class="add-option-btn" id="add-btn-${item.id}">+ æ–°å¢</button>
      </div>
    </div>
  `;
  
  panel.querySelector('.back-btn').onclick = showMenu;
  panel.querySelector(`#add-btn-${item.id}`).onclick = () => addOption(item.id);
  panel.querySelector(`#input-${item.id}`).onkeypress = (e) => {
    if (e.key === 'Enter') addOption(item.id);
  };
  
  return panel;
}

// æ¸²æŸ“é¸é …åˆ—è¡¨
function renderOptionsList(itemId) {
  const list = document.getElementById(`list-${itemId}`);
  const options = dropdownData[itemId] || [];
  
  if (options.length === 0) {
    list.innerHTML = '<div class="empty-msg">å°šç„¡é¸é …</div>';
    return;
  }
  
  list.innerHTML = '';
  options.forEach((option, index) => {
    const optionDiv = document.createElement('div');
    optionDiv.className = 'option-item';
    optionDiv.dataset.index = index;
    
    // æ‹–æ‹½æ‰‹æŸ„ï¼ˆä¸‰æ¢æ©«æ§“ï¼‰- åªæœ‰é€™å€‹å¯ä»¥æ‹–æ‹½
    const dragHandle = document.createElement('div');
    dragHandle.className = 'drag-handle';
    dragHandle.innerHTML = 'â˜°';
    dragHandle.title = 'æ‹–æ‹½æ’åº';
    dragHandle.draggable = true;
    dragHandle.dataset.index = index;
    
    // å¯ç·¨è¼¯çš„æ–‡å­—
    const textSpan = document.createElement('span');
    textSpan.className = 'option-text';
    textSpan.textContent = option;
    textSpan.title = 'é»æ“Šç·¨è¼¯';
    textSpan.onclick = () => startEdit(itemId, index, textSpan);
    
    // åˆªé™¤æŒ‰éˆ•
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-option-btn';
    deleteBtn.textContent = 'âœ•';
    deleteBtn.onclick = () => deleteOption(itemId, index);
    
    optionDiv.appendChild(dragHandle);
    optionDiv.appendChild(textSpan);
    optionDiv.appendChild(deleteBtn);
    list.appendChild(optionDiv);
  });
  
  // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
  initDragAndDrop(list, itemId);
}

// åˆå§‹åŒ–æ‹–æ‹½æ’åºåŠŸèƒ½ï¼ˆæ”¯æ´æ‰‹æ©Ÿè§¸æ‘¸æ‹–æ›³ï¼Œåªæœ‰ä¸‰æ¢æ©«ç·šå¯ä»¥æ‹–æ›³ï¼‰
function initDragAndDrop(list, itemId) {
  let draggedElement = null;
  let draggedIndex = null;
  let draggedItemDiv = null;
  let touchStartY = 0;
  let touchStartScrollTop = 0;
  let isDraggingTouch = false;
  let touchStartTime = 0;
  let hasMoved = false;
  
  // ç¦ç”¨åˆ—è¡¨æ»¾å‹•å’Œå…¶ä»–äº¤äº’çš„å‡½æ•¸ï¼ˆåªåœ¨çœŸæ­£æ‹–æ›³æ™‚ä½¿ç”¨ï¼‰
  function disableInteractions() {
    // åªç¦ç”¨åˆ—è¡¨å…§å…¶ä»–é¸é …é …çš„é»æ“Šï¼Œä¸å½±éŸ¿åˆ—è¡¨æ»¾å‹•
    list.querySelectorAll('.option-item').forEach(el => {
      if (el !== draggedItemDiv) {
        el.style.pointerEvents = 'none';
      }
    });
    // ç¦ç”¨å…¶ä»–æŒ‰éˆ•ï¼ˆä½†ä¸å½±éŸ¿ä¸‹æ‹‰é¸å–®ï¼‰
    document.querySelectorAll('button:not(.select-display):not(.select-option), a').forEach(el => {
      if (!el.closest('.select-container') && el !== draggedItemDiv && !el.contains(draggedItemDiv)) {
        el.style.pointerEvents = 'none';
      }
    });
  }
  
  // æ¢å¾©äº¤äº’çš„å‡½æ•¸
  function enableInteractions() {
    list.querySelectorAll('.option-item').forEach(el => {
      el.style.pointerEvents = '';
    });
    document.querySelectorAll('button, a').forEach(el => {
      el.style.pointerEvents = '';
    });
  }
  
  // åªåœ¨æ‹–æ‹½æ‰‹æŸ„ä¸Šç»‘å®šäº‹ä»¶ï¼ˆåŒæ™‚æ”¯æ´æ¡Œé¢å’Œæ‰‹æ©Ÿï¼‰
  list.querySelectorAll('.drag-handle').forEach((handle) => {
    // æ¡Œé¢ç‰ˆï¼šHTML5 Drag and Drop
    handle.addEventListener('dragstart', (e) => {
      e.stopPropagation();
      
      draggedItemDiv = handle.closest('.option-item');
      draggedIndex = parseInt(draggedItemDiv.dataset.index);
      draggedElement = handle;
      
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedIndex.toString());
      draggedItemDiv.style.opacity = '0.5';
      
      window._isDragging = true;
      disableInteractions(); // ç¦ç”¨å…¶ä»–äº¤äº’
    });
    
    handle.addEventListener('dragend', (e) => {
      if (draggedItemDiv) {
        draggedItemDiv.style.opacity = '';
      }
      draggedElement = null;
      draggedIndex = null;
      draggedItemDiv = null;
      window._isDragging = false;
      enableInteractions(); // æ¢å¾©äº¤äº’
    });
    
    // æ‰‹æ©Ÿç‰ˆï¼šè§¸æ‘¸æ‹–æ›³ï¼ˆåªæœ‰ä¸‰æ¢æ©«ç·šå¯ä»¥è§¸ç™¼ï¼‰
    handle.addEventListener('touchstart', (e) => {
      // åªå…è¨±åœ¨æ‹–æ‹½æ‰‹æŸ„ä¸Šé–‹å§‹æ‹–æ›³
      if (!handle.contains(e.target) && e.target !== handle) {
        return;
      }
      
      e.stopPropagation();
      isDraggingTouch = true;
      draggedItemDiv = handle.closest('.option-item');
      draggedIndex = parseInt(draggedItemDiv.dataset.index);
      draggedElement = handle;
      
      touchStartY = e.touches[0].clientY;
      touchStartScrollTop = list.scrollTop;
      touchStartTime = Date.now();
      hasMoved = false;
      
      // å…ˆä¸è¨­ç½®æ¨£å¼ï¼Œç­‰ç¢ºèªçœŸçš„åœ¨æ‹–æ›³æ™‚å†è¨­ç½®
      window._isDragging = false; // å…ˆä¸æ¨™è¨˜ç‚ºæ‹–æ›³ï¼Œç­‰ç¢ºèªç§»å‹•å¾Œå†æ¨™è¨˜
    }, { passive: true }); // æ”¹ç‚º passive: trueï¼Œä¸é˜»æ­¢é»˜èªè¡Œç‚º
    
    handle.addEventListener('touchmove', (e) => {
      if (!isDraggingTouch || !draggedItemDiv) return;
      
      const currentY = e.touches[0].clientY;
      const deltaY = currentY - touchStartY;
      
      // æª¢æŸ¥æ˜¯å¦æœ‰æ˜é¡¯çš„ç§»å‹•ï¼ˆé¿å…èª¤è§¸ï¼‰
      if (Math.abs(deltaY) > 10) {
        if (!hasMoved) {
          // ç¬¬ä¸€æ¬¡ç¢ºèªç§»å‹•ï¼Œé–‹å§‹æ‹–æ›³æ¨¡å¼
          hasMoved = true;
          draggedItemDiv.style.opacity = '0.5';
          draggedItemDiv.style.transition = 'none';
          draggedItemDiv.style.zIndex = '1000';
          window._isDragging = true;
          disableInteractions(); // åªåœ¨ç¢ºèªæ‹–æ›³æ™‚æ‰ç¦ç”¨äº¤äº’
        }
        
        // é˜»æ­¢é»˜èªè¡Œç‚ºï¼Œé–‹å§‹æ‹–æ›³
        e.preventDefault();
        e.stopPropagation();
        
        // æ›´æ–°æ‹–æ›³å…ƒç´ ä½ç½®
        draggedItemDiv.style.transform = `translateY(${deltaY}px)`;
        
        // è™•ç†åˆ—è¡¨æ»¾å‹•ï¼ˆç•¶æ¥è¿‘é‚Šç•Œæ™‚è‡ªå‹•æ»¾å‹•ï¼‰
        const handleRect = handle.getBoundingClientRect();
        const listRect = list.getBoundingClientRect();
        
        const scrollThreshold = 50;
        if (handleRect.top < listRect.top + scrollThreshold) {
          list.scrollTop = Math.max(0, list.scrollTop - 5);
        } else if (handleRect.bottom > listRect.bottom - scrollThreshold) {
          list.scrollTop = Math.min(list.scrollHeight - list.clientHeight, list.scrollTop + 5);
        }
        
        // æ‰¾åˆ°æ‡‰è©²æ’å…¥çš„ä½ç½®
        const afterElement = getDragAfterElement(list, currentY, draggedItemDiv);
        if (afterElement == null) {
          // ç§»å‹•åˆ°åº•éƒ¨
          if (list.lastElementChild !== draggedItemDiv) {
            list.appendChild(draggedItemDiv);
          }
        } else if (afterElement === draggedItemDiv) {
          // å¦‚æœè¿”å›çš„æ˜¯æ‹–æ›³å…ƒç´ æœ¬èº«ï¼Œä¸è™•ç†
          return;
        } else {
          // æ’å…¥åˆ°æŒ‡å®šå…ƒç´ ä¹‹å‰ï¼ˆç§»å‹•åˆ°ç¬¬ä¸€ç­†æ™‚ï¼ŒafterElement æ‡‰è©²æ˜¯ç¬¬ä¸€å€‹å…ƒç´ ï¼‰
          if (afterElement !== draggedItemDiv && afterElement.nextSibling !== draggedItemDiv) {
            list.insertBefore(draggedItemDiv, afterElement);
          }
        }
      } else {
        // ç§»å‹•è·é›¢ä¸å¤ ï¼Œå¯èƒ½æ˜¯æ­£å¸¸æ»¾å‹•ï¼Œä¸é˜»æ­¢
        return;
      }
    }, { passive: false });
    
    handle.addEventListener('touchend', async (e) => {
      if (!isDraggingTouch || !draggedItemDiv) {
        enableInteractions(); // ç¢ºä¿æ¢å¾©äº¤äº’
        return;
      }
      
      e.preventDefault();
      e.stopPropagation();
      
      // å¦‚æœæ²’æœ‰æ˜é¡¯ç§»å‹•ï¼Œå¯èƒ½æ˜¯é»æ“Šï¼Œä¸è™•ç†æ‹–æ›³
      if (!hasMoved) {
        isDraggingTouch = false;
        draggedItemDiv.style.opacity = '';
        draggedItemDiv.style.transform = '';
        draggedItemDiv.style.transition = '';
        draggedItemDiv.style.zIndex = '';
        window._isDragging = false;
        enableInteractions();
        draggedElement = null;
        draggedIndex = null;
        draggedItemDiv = null;
        return;
      }
      
      // é‡ç½®æ¨£å¼
      draggedItemDiv.style.opacity = '';
      draggedItemDiv.style.transform = '';
      draggedItemDiv.style.transition = '';
      draggedItemDiv.style.zIndex = '';
      
      if (draggedIndex !== null) {
        const newIndex = Array.from(list.children).indexOf(draggedItemDiv);
        
        if (newIndex !== draggedIndex) {
          // æ›´æ–°é™£åˆ—é †åº
          const options = dropdownData[itemId];
          const [movedItem] = options.splice(draggedIndex, 1);
          options.splice(newIndex, 0, movedItem);
          
          // åŒæ­¥åˆ°å¾Œç«¯
          const success = await syncToSheet(itemId, 'reorder', newIndex, newIndex, draggedIndex);
          
          if (!success) {
            // åŒæ­¥å¤±æ•—ï¼Œå›æ»¾å‰ç«¯æ›´æ”¹
            const options = dropdownData[itemId];
            options.splice(newIndex, 1);
            options.splice(draggedIndex, 0, movedItem);
            renderOptionsList(itemId);
            alert('æ’åºåŒæ­¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        }
      }
      
      // é‡ç½®ç‹€æ…‹
      isDraggingTouch = false;
      draggedElement = null;
      draggedIndex = null;
      draggedItemDiv = null;
      window._isDragging = false;
      hasMoved = false;
      enableInteractions(); // æ¢å¾©äº¤äº’
    }, { passive: false });
    
    handle.addEventListener('touchcancel', (e) => {
      if (draggedItemDiv) {
        draggedItemDiv.style.opacity = '';
        draggedItemDiv.style.transform = '';
        draggedItemDiv.style.transition = '';
        draggedItemDiv.style.zIndex = '';
      }
      isDraggingTouch = false;
      draggedElement = null;
      draggedIndex = null;
      draggedItemDiv = null;
      window._isDragging = false;
      hasMoved = false;
      enableInteractions(); // æ¢å¾©äº¤äº’
    }, { passive: true });
  });
  
  // æ¡Œé¢ç‰ˆï¼šåœ¨é€‰é¡¹é¡¹ä¸Šå¤„ç†æ‹–æ‹½è¿›å…¥ã€æ‚¬åœå’Œæ”¾ç½®
  list.querySelectorAll('.option-item').forEach((item) => {
    item.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.dataTransfer.dropEffect = 'move';
      
      if (!draggedItemDiv || draggedItemDiv === item) return;
      
      const afterElement = getDragAfterElement(list, e.clientY, draggedItemDiv);
      if (afterElement == null) {
        // ç§»å‹•åˆ°åº•éƒ¨
        list.appendChild(draggedItemDiv);
      } else if (afterElement === draggedItemDiv) {
        // å¦‚æœè¿”å›çš„æ˜¯æ‹–æ›³å…ƒç´ æœ¬èº«ï¼Œä¸è™•ç†
        return;
      } else {
        // æ’å…¥åˆ°æŒ‡å®šå…ƒç´ ä¹‹å‰ï¼ˆç§»å‹•åˆ°ç¬¬ä¸€ç­†æ™‚ï¼ŒafterElement æ‡‰è©²æ˜¯ç¬¬ä¸€å€‹å…ƒç´ ï¼‰
        list.insertBefore(draggedItemDiv, afterElement);
      }
    });
    
    item.addEventListener('dragenter', (e) => {
      e.preventDefault();
      e.stopPropagation();
    });
    
    item.addEventListener('drop', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (draggedItemDiv && draggedIndex !== null) {
        const newIndex = Array.from(list.children).indexOf(draggedItemDiv);
        
        if (newIndex !== draggedIndex) {
          // æ›´æ–°é™£åˆ—é †åº
          const options = dropdownData[itemId];
          const [movedItem] = options.splice(draggedIndex, 1);
          options.splice(newIndex, 0, movedItem);
          
          // åŒæ­¥åˆ°å¾Œç«¯
          const success = await syncToSheet(itemId, 'reorder', newIndex, newIndex, draggedIndex);
          
          if (!success) {
            // åŒæ­¥å¤±æ•—ï¼Œå›æ»¾å‰ç«¯æ›´æ”¹
            const options = dropdownData[itemId];
            options.splice(newIndex, 1);
            options.splice(draggedIndex, 0, movedItem);
            renderOptionsList(itemId);
            alert('æ’åºåŒæ­¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        }
        
        // é‡ç½®ç‹€æ…‹
        if (draggedItemDiv) {
          draggedItemDiv.style.opacity = '';
        }
        draggedElement = null;
        draggedIndex = null;
        draggedItemDiv = null;
      }
    });
  });
}

// ç²å–æ‹–æ‹½å¾Œæ‡‰è©²æ’å…¥çš„ä½ç½®ï¼ˆæ’é™¤æ‹–æ›³å…ƒç´ æœ¬èº«ï¼‰
function getDragAfterElement(container, y, draggedElement) {
  const draggableElements = [...container.querySelectorAll('.option-item')].filter(el => el !== draggedElement);
  
  if (draggableElements.length === 0) {
    return null;
  }
  
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    
    // å¦‚æœæ¸¸æ¨™åœ¨ä¸ŠåŠéƒ¨åˆ†ï¼ˆoffset < 0ï¼‰ï¼Œä¸”æ¯”ä¹‹å‰çš„æœ€è¿‘å…ƒç´ æ›´æ¥è¿‘ï¼Œå‰‡æ›´æ–°
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    }
    return closest;
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// é–‹å§‹ç·¨è¼¯
function startEdit(itemId, index, textSpan) {
  const oldValue = dropdownData[itemId][index];
  const input = document.createElement('input');
  input.id = `edit-${itemId}-${index}`;
  input.name = `edit-${itemId}-${index}`;
  input.type = 'text';
  input.className = 'edit-input';
  input.value = oldValue;
  
  const finishEdit = async () => {
    const newValue = input.value.trim();
    if (newValue && newValue !== oldValue) {
      // æª¢æŸ¥æ˜¯å¦é‡è¤‡
      if (dropdownData[itemId].includes(newValue) && dropdownData[itemId].indexOf(newValue) !== index) {
        alert('æ­¤é¸é …å·²å­˜åœ¨');
        input.value = oldValue;
        return;
      }
      
      // å…ˆæ›´æ–°å‰ç«¯ï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
      dropdownData[itemId][index] = newValue;
      renderOptionsList(itemId);
      
      // åŒæ­¥åˆ°å¾Œç«¯
      const success = await syncToSheet(itemId, 'edit', index, newValue, oldValue);
      if (success) {
        // syncToSheet å·²ç¶“æœƒé‡æ–°è¼‰å…¥è³‡æ–™ï¼Œé€™è£¡åªéœ€è¦é‡æ–°æ¸²æŸ“
        renderOptionsList(itemId);
      } else {
        // åŒæ­¥å¤±æ•—ï¼Œå›æ»¾å‰ç«¯æ›´æ”¹
        dropdownData[itemId][index] = oldValue;
        renderOptionsList(itemId);
        alert('ç·¨è¼¯å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    } else {
      renderOptionsList(itemId);
    }
  };
  
  input.onblur = finishEdit;
  input.onkeypress = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      input.blur();
    }
  };
  input.onkeydown = (e) => {
    if (e.key === 'Escape') {
      renderOptionsList(itemId);
    }
  };
  
  textSpan.replaceWith(input);
  input.focus();
  input.select();
}

// æ–°å¢é¸é …
async function addOption(itemId) {
  const input = document.getElementById(`input-${itemId}`);
  const value = input.value.trim();
  
  if (!value) {
    alert('è«‹è¼¸å…¥é¸é …å…§å®¹');
    return;
  }
  
  if (!dropdownData[itemId]) dropdownData[itemId] = [];
  
  if (dropdownData[itemId].includes(value)) {
    alert('æ­¤é¸é …å·²å­˜åœ¨');
    return;
  }
  
  const newIndex = dropdownData[itemId].length;
  // å…ˆæ›´æ–°å‰ç«¯ï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
  dropdownData[itemId].push(value);
  input.value = '';
  renderOptionsList(itemId);
  
  // åŒæ­¥åˆ°å¾Œç«¯
  const success = await syncToSheet(itemId, 'add', newIndex, value, '');
  if (success) {
    // syncToSheet å·²ç¶“æœƒé‡æ–°è¼‰å…¥è³‡æ–™ä¸¦é‡æ–°æ¸²æŸ“ï¼Œé€™è£¡ä¸éœ€è¦é‡è¤‡æ“ä½œ
  } else {
    // åŒæ­¥å¤±æ•—ï¼Œå›æ»¾å‰ç«¯æ›´æ”¹
    dropdownData[itemId].pop();
    input.value = value;
    renderOptionsList(itemId);
    alert('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}

// åˆªé™¤é¸é …
async function deleteOption(itemId, index) {
  const option = dropdownData[itemId][index];
  if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${option}ã€å—ï¼Ÿ`)) {
    // å…ˆæ›´æ–°å‰ç«¯ï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
    dropdownData[itemId].splice(index, 1);
    renderOptionsList(itemId);
    
    // åŒæ­¥åˆ°å¾Œç«¯
    const success = await syncToSheet(itemId, 'delete', index, '', option);
    if (success) {
      // syncToSheet å·²ç¶“æœƒé‡æ–°è¼‰å…¥è³‡æ–™ï¼Œé€™è£¡åªéœ€è¦é‡æ–°æ¸²æŸ“
      renderOptionsList(itemId);
    } else {
      // åŒæ­¥å¤±æ•—ï¼Œå›æ»¾å‰ç«¯æ›´æ”¹
      dropdownData[itemId].splice(index, 0, option);
      renderOptionsList(itemId);
      alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }
}

// é¡¯ç¤ºæŒ‡å®šé¢æ¿ï¼ˆé»åˆ†é¡å¾Œæ‰é¡¯ç¤ºè¼‰å…¥ä¸­ï¼Œä¸¦ç¢ºä¿è³‡æ–™å·²è®€å–ï¼‰
async function showPanel(panelId) {
  // å¦‚æœä¸‹æ‹‰è³‡æ–™é‚„æ²’è¼‰å…¥ï¼Œå°±é¡¯ç¤º loading ä¸¦è¼‰å…¥ä¸€æ¬¡
  if (!dropdownLoaded) {
    showLoading();
    await loadDropdownData();
    hideLoading();
  }

  document.getElementById('main-menu').style.display = 'none';
  document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`panel-${panelId}`).classList.add('active');
  renderOptionsList(panelId);
}

// é¡¯ç¤ºä¸»é¸å–®
function showMenu() {
  document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('main-menu').style.display = 'flex';
}

// åˆå§‹åŒ–é é¢
async function init() {
  // é€²å…¥è¨­å®šé æ™‚ï¼Œå…ˆå»ºç«‹ä¸»é¸å–®èˆ‡å„åˆ†é¡é¢æ¿ï¼Œè®“ç•«é¢ç«‹åˆ»å¯æ“ä½œ
  root.appendChild(createMainMenu());
  settingsItems.forEach(item => {
    root.appendChild(createPanel(item));
  });

  // åŒæ™‚åœ¨èƒŒæ™¯é–‹å§‹è¼‰å…¥ã€Œä¸‹æ‹‰é¸å–®ã€sheet=1 è³‡æ–™ï¼ˆä¸é˜»å¡ç•«é¢ï¼‰
  loadDropdownData();
}

// é˜²æ­¢ iOS Safari å›å½ˆæ•ˆæœï¼ˆå…©å€‹æ–¹å‘éƒ½ä¸è¦ï¼‰ï¼Œä½†åœ¨æ‹–æ›³æ™‚å…è¨±ä¸Šä¸‹ç§»å‹•
(function() {
  let startY = 0;
  let startScrollTop = 0;
  let canPrevent = false;
  let touchStartTarget = null;
  
  // åˆå§‹åŒ–æ‹–æ›³æ¨™è¨˜
  if (typeof window._isDragging === 'undefined') {
    window._isDragging = false;
  }
  
  // æª¢æŸ¥æ˜¯å¦æ˜¯åœ¨æ‹–æ‹½æ‰‹æŸ„ä¸Š
  function isDragHandle(target) {
    return target.closest('.drag-handle') || target.classList.contains('drag-handle');
  }
  
  document.addEventListener('touchstart', function(e) {
    touchStartTarget = e.target;
    
    // å¦‚æœæ˜¯åœ¨æ‹–æ‹½æ‰‹æŸ„ä¸Šï¼Œå…è¨±æ‹–æ›³ï¼Œä¸è™•ç†å›å½ˆé˜²æ­¢
    if (isDragHandle(e.target)) {
      canPrevent = false;
      return;
    }
    
    // å¦‚æœæ­£åœ¨æ‹–æ›³ï¼ˆHTML5 Dragï¼‰ï¼Œä¸è™•ç†å›å½ˆé˜²æ­¢
    if (window._isDragging) {
      canPrevent = false;
      return;
    }
    
    startY = e.touches[0].clientY;
    startScrollTop = window.pageYOffset || document.documentElement.scrollTop;
    canPrevent = true;
  }, { passive: true });
  
  document.addEventListener('touchmove', function(e) {
    // å¦‚æœæ­£åœ¨æ‹–æ›³ï¼ˆHTML5 Dragï¼‰ï¼Œå®Œå…¨ä¸è™•ç†å›å½ˆé˜²æ­¢ï¼Œå…è¨±æ­£å¸¸ç§»å‹•
    if (window._isDragging) {
      return; // ä¸é˜»æ­¢ï¼Œè®“æ‹–æ›³æ­£å¸¸é€²è¡Œ
    }
    
    // å¦‚æœæ˜¯å¾æ‹–æ‹½æ‰‹æŸ„é–‹å§‹çš„è§¸æ‘¸ï¼Œå…è¨±æ­£å¸¸ç§»å‹•
    if (touchStartTarget && isDragHandle(touchStartTarget)) {
      return; // ä¸é˜»æ­¢ï¼Œå…è¨±ä¸Šä¸‹ç§»å‹•
    }
    
    if (!canPrevent) return;
    
    const currentY = e.touches[0].clientY;
    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight;
    const clientHeight = document.documentElement.clientHeight;
    const deltaY = currentY - startY;
    
    // æª¢æŸ¥æ˜¯å¦åœ¨é‚Šç•Œ
    const isAtTop = currentScrollTop <= 0;
    const isAtBottom = currentScrollTop + clientHeight >= scrollHeight - 1;
    
    // åªæœ‰åœ¨é‚Šç•Œä¸”æ»‘å‹•æ–¹å‘æœƒå°è‡´å›å½ˆæ™‚æ‰é˜»æ­¢
    if (isAtTop && deltaY > 0) {
      // åœ¨é ‚éƒ¨ï¼Œå‘ä¸‹æ‹‰ï¼ˆå›å½ˆï¼‰
      e.preventDefault();
      canPrevent = false;
    } else if (isAtBottom && deltaY < 0) {
      // åœ¨åº•éƒ¨ï¼Œå‘ä¸Šæ‹‰ï¼ˆå›å½ˆï¼‰
      e.preventDefault();
      canPrevent = false;
    } else if (isAtTop && startScrollTop === 0 && deltaY < 0) {
      // åœ¨é ‚éƒ¨ï¼Œå‘ä¸Šæ»‘ï¼ˆå›å½ˆï¼‰
      e.preventDefault();
      canPrevent = false;
    } else if (isAtBottom && startScrollTop + clientHeight >= scrollHeight - 1 && deltaY > 0) {
      // åœ¨åº•éƒ¨ï¼Œå‘ä¸‹æ»‘ï¼ˆå›å½ˆï¼‰
      e.preventDefault();
      canPrevent = false;
    }
  }, { passive: false });
  
  document.addEventListener('touchend', function() {
    touchStartTarget = null;
    // å¦‚æœä¸åœ¨æ‹–æ›³ç‹€æ…‹ï¼Œé‡ç½®
    if (!window._isDragging) {
      canPrevent = false;
    }
  }, { passive: true });
  
  document.addEventListener('touchcancel', function() {
    touchStartTarget = null;
    // å¦‚æœä¸åœ¨æ‹–æ›³ç‹€æ…‹ï¼Œé‡ç½®
    if (!window._isDragging) {
      canPrevent = false;
    }
  }, { passive: true });
})();

init();
</script>
