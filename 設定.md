---
layout: page
title: è¨­å®š
permalink: /settings/
---

<link rel="stylesheet" href="{{ '/assets/settings.css' | relative_url }}">

<div id="user-info"></div>
<div id="loading-overlay" class="loading-overlay">
  <div id="loading-progress" style="width: 300px; text-align: center;">
    <div class="progress-text" style="font-size: 16px; margin-bottom: 15px; color: #333;">è¼‰å…¥ä¸­...</div>
    <div style="width: 100%; height: 8px; background-color: #e0e0e0; border-radius: 4px; overflow: hidden;">
      <div class="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px; transition: width 0.3s ease;"></div>
    </div>
  </div>
</div>
<div id="settings-root"></div>

<script>
// API URLï¼ˆæ”¯å‡ºè¡¨ï¼Œæœ€æ–°ï¼‰â”€â”€ ä½¿ç”¨ä½ æŒ‡å®šçš„æ–°ç‰ˆæ”¯å‡º URL
const baseExpense = "https://script.google.com/macros/s/AKfycbxbnCH9JYNcLv4vGJw_lBCbdSmdnX9Cn8o9AfDAo6wX2JmOWFoSgZUANp_P7HSRF8by/exec";
// API URLï¼ˆé ç®—è¡¨ï¼Œæœ€æ–°ï¼‰
const baseBudget  = "https://script.google.com/macros/s/AKfycbzBgww1mzRv3XOuX3uBA9Z93mXxKDZ0JVAycjHTy14PZxImlN-A5iL9aZ2vxTe_JjmF3A/exec";

// è¨­å®šé …ç›®è³‡æ–™ï¼ˆæ¨™é¡Œç”¨æ–¼åœ¨ Google Sheet ä¸­è­˜åˆ¥æ¬„ä½ï¼‰
// æŒ‰éˆ•é¡è‰²èˆ‡é¦–é é †åºä¸€è‡´ï¼šè—ï¼ˆæ”¯ä»˜æ–¹å¼ï¼‰ã€ç´«ï¼ˆæ¶ˆè²»é¡åˆ¥ï¼‰ã€æ©˜ï¼ˆæ”¯ä»˜å¹³å°ï¼‰
const settingsItems = [
  { id: 'payment', icon: 'ğŸ’³', title: 'æ”¯ä»˜æ–¹å¼', colorClass: 'btn-payment', headerKeywords: ['æ”¯ä»˜æ–¹å¼'] },
  { id: 'category', icon: 'ğŸ·ï¸', title: 'æ¶ˆè²»é¡åˆ¥', colorClass: 'btn-category', headerKeywords: ['æ”¯å‡ºï¼é …ç›®', 'æ”¯å‡º-é …ç›®', 'æ¶ˆè²»é¡åˆ¥', 'é¡åˆ¥'] },
  { id: 'platform', icon: 'ğŸ¦', title: 'æ”¯ä»˜å¹³å°', colorClass: 'btn-platform', headerKeywords: ['æ”¯ä»˜å¹³å°', 'å¹³å°'] }
];

// ä¸‹æ‹‰é¸å–®è³‡æ–™å¿«å–
let dropdownData = {};
// æ¬„ä½ç´¢å¼•å°æ‡‰ï¼ˆå¾æ¨™é¡Œè¡Œè®€å–ï¼‰
let columnMapping = {};
// åŸå§‹è³‡æ–™ï¼ˆç”¨æ–¼åŒæ­¥ï¼‰
let originalSheetData = [];
// æ˜¯å¦å·²è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™
let dropdownLoaded = false;
// åŸå§‹ä¸‹æ‹‰é¸å–®è³‡æ–™ï¼ˆç”¨æ–¼æ¯”è¼ƒæ˜¯å¦æœ‰è®Šæ›´ï¼‰
let originalDropdownData = {};
// æ˜¯å¦æœ‰æœªå„²å­˜çš„è®Šæ›´
let hasUnsavedChanges = {};

const root = document.getElementById('settings-root');
const loadingOverlay = document.getElementById('loading-overlay');

// æ›´æ–°é€²åº¦æ¢
function updateProgress(current, total, text = 'è¼‰å…¥ä¸­...') {
  const progressContainer = document.getElementById('loading-progress');
  if (!progressContainer) return;

  const percentage = total > 0 ? Math.min(100, Math.round((current / total) * 100)) : 0;
  const progressBar = progressContainer.querySelector('.progress-bar');
  const progressText = progressContainer.querySelector('.progress-text');

  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
  }
  if (progressText) {
    progressText.textContent = total > 0 ? `${text} (${current}/${total})` : text;
  }
}

// é¡¯ç¤º/éš±è— loading
function showLoading() {
  loadingOverlay.style.display = 'flex';
  updateProgress(0, 0, 'è¼‰å…¥ä¸­...');
}
function hideLoading() {
  const progressContainer = document.getElementById('loading-progress');
  if (progressContainer) {
    const progressBar = progressContainer.querySelector('.progress-bar');
    const progressText = progressContainer.querySelector('.progress-text');
    if (progressBar) {
      progressBar.style.width = '100%';
      progressBar.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
    }
    if (progressText) {
      progressText.textContent = 'âœ“ å·²å®Œæˆ';
      progressText.style.color = '#2ecc71';
      progressText.style.fontWeight = 'bold';
    }
  }

  setTimeout(() => {
    loadingOverlay.style.display = 'none';
    // é‡ç½®é€²åº¦æ¢
    if (progressContainer) {
      const progressBar = progressContainer.querySelector('.progress-bar');
      const progressText = progressContainer.querySelector('.progress-text');
      if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.style.background = 'linear-gradient(90deg, #3498db, #2ecc71)';
      }
      if (progressText) {
        progressText.textContent = 'è¼‰å…¥ä¸­...';
        progressText.style.color = '#333';
        progressText.style.fontWeight = 'normal';
      }
    }
  }, 800);
}

// å¾ Google Sheet è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™ï¼ˆsheetIndex = 1ï¼‰
async function loadDropdownData() {
  try {
    const params = { name: "Show Tab Data", sheet: 1, _t: Date.now() };
    const url = `${baseExpense}?${new URLSearchParams(params)}`;
    const res = await fetch(url, {
      method: "GET",
      redirect: "follow",
      mode: "cors",
      cache: "no-store"
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const responseData = await res.json();
    // è™•ç†ä¸åŒçš„è³‡æ–™æ ¼å¼
    let data = null;

    // å¦‚æœæ˜¯é™£åˆ—ï¼Œç›´æ¥ä½¿ç”¨
    if (Array.isArray(responseData)) {
      data = responseData;
    }
    // å¦‚æœæ˜¯ç‰©ä»¶ï¼Œå¯èƒ½æ˜¯å‘½åç¯„åœçš„æ ¼å¼ï¼Œå˜—è©¦æ‰¾åˆ°ç¬¬ä¸€å€‹é™£åˆ—å€¼
    else if (typeof responseData === 'object' && responseData !== null) {
      // å°‹æ‰¾ç¬¬ä¸€å€‹å€¼æ˜¯é™£åˆ—çš„éµ
      for (const key in responseData) {
        if (Array.isArray(responseData[key]) && responseData[key].length > 0) {
          data = responseData[key];
          break;
        }
      }
      // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦ç›´æ¥ä½¿ç”¨æ•´å€‹ sheet çš„è³‡æ–™ç¯„åœ
      // é€™éœ€è¦ GAS è¿”å›æ•´å€‹ sheet çš„è³‡æ–™ï¼Œè€Œä¸æ˜¯å‘½åç¯„åœ
    }

    if (!data || !Array.isArray(data) || data.length === 0) {
      // ä¿æŒ dropdownLoaded ç‚º falseï¼Œç¨å¾Œå†æ¬¡é»æ“Šåˆ†é¡æ™‚æœƒå†å˜—è©¦è¼‰å…¥
      return {};
    }

    originalSheetData = data;
    const headerRow = data[0];
    // æ ¹æ“šæ¨™é¡Œæ‰¾åˆ°æ¯å€‹è¨­å®šé …ç›®å°æ‡‰çš„æ¬„ä½ç´¢å¼•
    settingsItems.forEach(item => {
      columnMapping[item.id] = -1;
      for (let col = 0; col < headerRow.length; col++) {
        const headerText = (headerRow[col] || '').toString().trim();
        if (item.headerKeywords.some(keyword => headerText.includes(keyword))) {
          columnMapping[item.id] = col;
          break;
        }
      }
    });

    // è®€å–é¸é …ï¼ˆè·³éæ¨™é¡Œè¡Œï¼‰
    settingsItems.forEach(item => {
      dropdownData[item.id] = [];
      const col = columnMapping[item.id];
      if (col >= 0) {
        const seen = new Set(); // é¿å…é‡è¤‡
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (!row) continue;
          const raw = row[col];
          if (raw === undefined || raw === null) continue;
          const val = raw.toString().trim();
          if (!val || seen.has(val)) continue;
          seen.add(val);
          dropdownData[item.id].push(val);
        }
      }
    });
    dropdownLoaded = true;
    return dropdownData;
  } catch (error) {
    // ä¿æŒ dropdownLoaded ç‚º falseï¼Œç¨å¾Œå†æ¬¡é»æ“Šåˆ†é¡æ™‚æœƒå†å˜—è©¦è¼‰å…¥
    return {};
  }
}

// å»ºç«‹ä¸»é¸å–®
function createMainMenu() {
  const container = document.createElement('div');
  container.id = 'main-menu';
  container.className = 'settings-container';

  // æ·»åŠ æ¨™é¡Œ
  const title = document.createElement('h1');
  title.className = 'settings-title';
  title.textContent = 'è¨­å®š';
  container.appendChild(title);

  // æ·»åŠ æŒ‰éˆ•å®¹å™¨
  const buttonsContainer = document.createElement('div');
  buttonsContainer.className = 'settings-buttons-container';

  settingsItems.forEach(item => {
    const btn = document.createElement('a');
    btn.href = '#';
    btn.className = `settings-btn ${item.colorClass}`;
    btn.innerHTML = `<span class="btn-icon">${item.icon}</span>${item.title}`;
    btn.onclick = (e) => {
      e.preventDefault();
      showPanel(item.id);
    };
    buttonsContainer.appendChild(btn);
  });

  container.appendChild(buttonsContainer);
  return container;
}

// å»ºç«‹å…§å®¹é¢æ¿
function createPanel(item) {
  const panel = document.createElement('div');
  panel.id = `panel-${item.id}`;
  panel.className = 'content-panel';

  panel.innerHTML = `
    <div class="panel-header">
      <h2 class="panel-title">${item.icon} ${item.title}</h2>
      <button class="back-btn">â† è¿”å›</button>
    </div>
    <div class="panel-content">
      <div class="options-list" id="list-${item.id}"></div>
      <div class="add-option-container">
        <input type="text" class="add-option-input" id="input-${item.id}" name="input-${item.id}" placeholder="æ–°å¢é¸é …...">
        <button class="add-option-btn" id="add-btn-${item.id}">+ æ–°å¢</button>
      </div>
      <div class="save-container">
        <button class="save-btn" id="save-btn-${item.id}" disabled>ä¿®æ”¹</button>
        <span class="unsaved-hint" id="unsaved-hint-${item.id}"></span>
      </div>
    </div>
  `;

  panel.querySelector('.back-btn').onclick = () => handleBackClick(item.id);
  panel.querySelector(`#add-btn-${item.id}`).onclick = () => addOption(item.id);
  panel.querySelector(`#input-${item.id}`).onkeypress = (e) => {
    if (e.key === 'Enter') addOption(item.id);
  };
  panel.querySelector(`#save-btn-${item.id}`).onclick = () => saveChanges(item.id);

  return panel;
}

// æ¸²æŸ“é¸é …åˆ—è¡¨
function renderOptionsList(itemId) {
  const list = document.getElementById(`list-${itemId}`);
  const options = dropdownData[itemId] || [];

  if (options.length === 0) {
    list.innerHTML = '<div class="empty-msg">å°šç„¡é¸é …</div>';
    return;
  }

  list.innerHTML = '';
  options.forEach((option, index) => {
    const optionDiv = document.createElement('div');
    optionDiv.className = 'option-item';
    optionDiv.dataset.index = index;

    // æ’åºæŒ‰éˆ•å®¹å™¨
    const reorderBtns = document.createElement('div');
    reorderBtns.className = 'reorder-btns';

    // ä¸Šç§»æŒ‰éˆ•
    const upBtn = document.createElement('button');
    upBtn.className = 'reorder-btn';
    upBtn.textContent = 'â–²';
    upBtn.title = 'ä¸Šç§»';
    upBtn.disabled = index === 0;
    upBtn.onclick = () => moveOption(itemId, index, index - 1);

    // ä¸‹ç§»æŒ‰éˆ•
    const downBtn = document.createElement('button');
    downBtn.className = 'reorder-btn';
    downBtn.textContent = 'â–¼';
    downBtn.title = 'ä¸‹ç§»';
    downBtn.disabled = index === options.length - 1;
    downBtn.onclick = () => moveOption(itemId, index, index + 1);

    reorderBtns.appendChild(upBtn);
    reorderBtns.appendChild(downBtn);

    // å¯ç·¨è¼¯çš„æ–‡å­—
    const textSpan = document.createElement('span');
    textSpan.className = 'option-text';
    textSpan.textContent = option;
    textSpan.title = 'é»æ“Šç·¨è¼¯';
    textSpan.onclick = () => startEdit(itemId, index, textSpan);

    // åˆªé™¤æŒ‰éˆ•
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-option-btn';
    deleteBtn.textContent = 'âœ•';
    deleteBtn.onclick = () => deleteOption(itemId, index);

    optionDiv.appendChild(reorderBtns);
    optionDiv.appendChild(textSpan);
    optionDiv.appendChild(deleteBtn);
    list.appendChild(optionDiv);
  });
}

// ç§»å‹•é¸é …ï¼ˆä¸Šç§»æˆ–ä¸‹ç§»ï¼‰- åªæ›´æ–°æœ¬åœ° UI
function moveOption(itemId, fromIndex, toIndex) {
  const options = dropdownData[itemId];
  if (toIndex < 0 || toIndex >= options.length) return;

  // æ›´æ–°é™£åˆ—é †åº
  const [movedItem] = options.splice(fromIndex, 1);
  options.splice(toIndex, 0, movedItem);
  renderOptionsList(itemId);
  updateSaveButtonState(itemId);
}

// é–‹å§‹ç·¨è¼¯ - åªæ›´æ–°æœ¬åœ° UI
function startEdit(itemId, index, textSpan) {
  const oldValue = dropdownData[itemId][index];
  const input = document.createElement('input');
  input.id = `edit-${itemId}-${index}`;
  input.name = `edit-${itemId}-${index}`;
  input.type = 'text';
  input.className = 'edit-input';
  input.value = oldValue;

  const finishEdit = () => {
    const newValue = input.value.trim();
    if (newValue && newValue !== oldValue) {
      // æª¢æŸ¥æ˜¯å¦é‡è¤‡
      if (dropdownData[itemId].includes(newValue) && dropdownData[itemId].indexOf(newValue) !== index) {
        alert('æ­¤é¸é …å·²å­˜åœ¨');
        input.value = oldValue;
        return;
      }

      // æ›´æ–°æœ¬åœ°è³‡æ–™
      dropdownData[itemId][index] = newValue;
      renderOptionsList(itemId);
      updateSaveButtonState(itemId);
    } else {
      renderOptionsList(itemId);
    }
  };

  input.onblur = finishEdit;
  input.onkeypress = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      input.blur();
    }
  };
  input.onkeydown = (e) => {
    if (e.key === 'Escape') {
      renderOptionsList(itemId);
    }
  };

  textSpan.replaceWith(input);
  input.focus();
  input.select();
}

// æ–°å¢é¸é … - åªæ›´æ–°æœ¬åœ° UI
function addOption(itemId) {
  const input = document.getElementById(`input-${itemId}`);
  const value = input.value.trim();

  if (!value) {
    alert('è«‹è¼¸å…¥é¸é …å…§å®¹');
    return;
  }

  if (!dropdownData[itemId]) dropdownData[itemId] = [];

  if (dropdownData[itemId].includes(value)) {
    alert('æ­¤é¸é …å·²å­˜åœ¨');
    return;
  }

  // æ›´æ–°æœ¬åœ°è³‡æ–™
  dropdownData[itemId].push(value);
  input.value = '';
  renderOptionsList(itemId);
  updateSaveButtonState(itemId);
}

// åˆªé™¤é¸é … - åªæ›´æ–°æœ¬åœ° UI
function deleteOption(itemId, index) {
  const option = dropdownData[itemId][index];
  if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${option}ã€å—ï¼Ÿ`)) {
    // æ›´æ–°æœ¬åœ°è³‡æ–™
    dropdownData[itemId].splice(index, 1);
    renderOptionsList(itemId);
    updateSaveButtonState(itemId);
  }
}

// æª¢æŸ¥æ˜¯å¦æœ‰æœªå„²å­˜çš„è®Šæ›´
function hasChanges(itemId) {
  const current = dropdownData[itemId] || [];
  const original = originalDropdownData[itemId] || [];
  if (current.length !== original.length) return true;
  return current.some((val, idx) => val !== original[idx]);
}

// æ›´æ–°å„²å­˜æŒ‰éˆ•ç‹€æ…‹
function updateSaveButtonState(itemId) {
  const saveBtn = document.getElementById(`save-btn-${itemId}`);
  const hintSpan = document.getElementById(`unsaved-hint-${itemId}`);
  const changed = hasChanges(itemId);

  hasUnsavedChanges[itemId] = changed;

  if (saveBtn) {
    saveBtn.disabled = !changed;
  }
  if (hintSpan) {
    hintSpan.textContent = changed ? 'ï¼ˆæœ‰æœªå„²å­˜çš„è®Šæ›´ï¼‰' : '';
  }
}

// è™•ç†è¿”å›æŒ‰éˆ•é»æ“Š
function handleBackClick(itemId) {
  if (hasUnsavedChanges[itemId]) {
    if (!confirm('æ‚¨æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ')) {
      return;
    }
    // é‚„åŸæœ¬åœ°è³‡æ–™
    dropdownData[itemId] = [...originalDropdownData[itemId]];
    hasUnsavedChanges[itemId] = false;
  }
  showMenu();
}

// å„²å­˜è®Šæ›´åˆ°å¾Œç«¯
async function saveChanges(itemId) {
  const saveBtn = document.getElementById(`save-btn-${itemId}`);
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = 'å„²å­˜ä¸­...';
  }

  // é¡¯ç¤º loading ä¸¦ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
  showLoading();
  const allButtons = document.querySelectorAll('button, .settings-btn, .add-option-btn, .delete-option-btn');
  allButtons.forEach(btn => {
    btn.dataset._prevDisabled = btn.disabled ? '1' : '0';
    btn.disabled = true;
  });

  try {
    // å–å¾—åŸå§‹å’Œç¾åœ¨çš„è³‡æ–™
    const original = originalDropdownData[itemId] || [];
    const current = dropdownData[itemId] || [];

    // ç™¼é€æ‰¹æ¬¡æ›´æ–°è«‹æ±‚
    const col = columnMapping[itemId];
    const postData = {
      name: 'Batch Update Dropdown',
      itemId,
      action: 'batchUpdate',
      column: col,
      originalData: original,
      newData: current
    };

    // åªæœ‰ã€Œé¡åˆ¥ã€éœ€è¦åŒæ™‚æ›´æ–°æ”¯å‡ºè¡¨å’Œé ç®—è¡¨
    const isCategory = itemId === 'category';

    if (isCategory) {
      const [resExpense, resBudget] = await Promise.all([
        fetch(baseExpense, {
          method: "POST",
          redirect: "follow",
          mode: "cors",
          body: JSON.stringify(postData)
        }),
        fetch(baseBudget, {
          method: "POST",
          redirect: "follow",
          mode: "cors",
          body: JSON.stringify(postData)
        })
      ]);

      const resultExpense = await resExpense.json();
      const resultBudget = await resBudget.json();

      if (!resultExpense.success || !resultBudget.success) {
        throw new Error(`åŒæ­¥å¤±æ•—ï¼š\næ”¯å‡ºè¡¨ï¼š${resultExpense.message || 'æœªçŸ¥éŒ¯èª¤'}\né ç®—è¡¨ï¼š${resultBudget.message || 'æœªçŸ¥éŒ¯èª¤'}`);
      }
    } else {
      const resExpense = await fetch(baseExpense, {
        method: "POST",
        redirect: "follow",
        mode: "cors",
        body: JSON.stringify(postData)
      });

      const resultExpense = await resExpense.json();

      if (!resultExpense.success) {
        throw new Error(resultExpense.message || 'åŒæ­¥å¤±æ•—');
      }
    }

    // æˆåŠŸå¾Œæ›´æ–°åŸå§‹è³‡æ–™
    originalDropdownData[itemId] = [...current];
    hasUnsavedChanges[itemId] = false;

    // é€šçŸ¥å…¶ä»–é é¢é‡æ–°è¼‰å…¥ä¸‹æ‹‰é¸å–®
    try {
      const updateTime = Date.now().toString();
      localStorage.setItem('dropdownUpdated', updateTime);
      localStorage.setItem('dropdownUpdatedItemId', itemId);
      localStorage.setItem('dropdownUpdatedAction', 'batchUpdate');
      window.dispatchEvent(new StorageEvent('storage', {
        key: 'dropdownUpdated',
        newValue: updateTime
      }));
      window.dispatchEvent(new CustomEvent('dropdownUpdated', {
        detail: { itemId, action: 'batchUpdate', updateTime }
      }));
    } catch (e) {}

    alert('å„²å­˜æˆåŠŸï¼');

  } catch (error) {
    console.error('å„²å­˜å¤±æ•—:', error);
    alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
  } finally {
    // è§£é™¤é–å®š
    hideLoading();
    allButtons.forEach(btn => {
      if (btn.dataset._prevDisabled === '0') {
        btn.disabled = false;
      }
      delete btn.dataset._prevDisabled;
    });

    if (saveBtn) {
      saveBtn.textContent = 'ä¿®æ”¹';
      updateSaveButtonState(itemId);
    }
  }
}

// é¡¯ç¤ºæŒ‡å®šé¢æ¿ï¼ˆé»åˆ†é¡å¾Œæ‰é¡¯ç¤ºè¼‰å…¥ä¸­ï¼Œä¸¦ç¢ºä¿è³‡æ–™å·²è®€å–ï¼‰
async function showPanel(panelId) {
  // å¦‚æœä¸‹æ‹‰è³‡æ–™é‚„æ²’è¼‰å…¥ï¼Œå°±é¡¯ç¤º loading ä¸¦è¼‰å…¥ä¸€æ¬¡
  if (!dropdownLoaded) {
    showLoading();
    await loadDropdownData();
    hideLoading();
  }

  // å„²å­˜åŸå§‹è³‡æ–™ç”¨æ–¼æ¯”è¼ƒ
  originalDropdownData[panelId] = [...(dropdownData[panelId] || [])];
  hasUnsavedChanges[panelId] = false;

  document.getElementById('main-menu').style.display = 'none';
  document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`panel-${panelId}`).classList.add('active');
  renderOptionsList(panelId);
  updateSaveButtonState(panelId);
}

// é¡¯ç¤ºä¸»é¸å–®
function showMenu() {
  document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('main-menu').style.display = 'flex';
}

// åˆå§‹åŒ–é é¢
async function init() {
  // é€²å…¥è¨­å®šé æ™‚ï¼Œå…ˆå»ºç«‹ä¸»é¸å–®èˆ‡å„åˆ†é¡é¢æ¿ï¼Œè®“ç•«é¢ç«‹åˆ»å¯æ“ä½œ
  root.appendChild(createMainMenu());
  settingsItems.forEach(item => {
    root.appendChild(createPanel(item));
  });

  // åŒæ™‚åœ¨èƒŒæ™¯é–‹å§‹è¼‰å…¥ã€Œä¸‹æ‹‰é¸å–®ã€sheet=1 è³‡æ–™ï¼ˆä¸é˜»å¡ç•«é¢ï¼‰
  loadDropdownData();
}

// é˜²æ­¢å›å½ˆæ•ˆæœ
(function() {
  let touchStartY = 0;
  let touchStartScrollTop = 0;
  let startScrollContainer = null;

  // ç²å–æ»¾å‹•å®¹å™¨
  function getScrollContainer(target) {
    const dropdownContainer = target.closest('.category-dropdown, .select-dropdown, .options-list, .select-options');
    if (dropdownContainer) {
      return dropdownContainer;
    }
    return document.documentElement;
  }

  document.addEventListener('touchstart', function(e) {
    touchStartY = e.touches[0].clientY;
    startScrollContainer = getScrollContainer(e.target);

    if (startScrollContainer === document.documentElement) {
      touchStartScrollTop = window.pageYOffset || document.documentElement.scrollTop;
    } else {
      touchStartScrollTop = startScrollContainer.scrollTop;
    }
  }, { passive: true });

  document.addEventListener('touchmove', function(e) {
    if (!startScrollContainer) {
      return;
    }

    const currentY = e.touches[0].clientY;
    const deltaY = currentY - touchStartY;

    let currentScrollTop, scrollHeight, clientHeight;

    if (startScrollContainer === document.documentElement) {
      currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
      scrollHeight = document.documentElement.scrollHeight;
      clientHeight = document.documentElement.clientHeight;
    } else {
      currentScrollTop = startScrollContainer.scrollTop;
      scrollHeight = startScrollContainer.scrollHeight;
      clientHeight = startScrollContainer.clientHeight;
    }

    const isAtTop = currentScrollTop <= 1;
    const isAtBottom = currentScrollTop + clientHeight >= scrollHeight - 1;

    // åœ¨é‚Šç•Œæ™‚é˜»æ­¢å›å½ˆ
    if (isAtTop && deltaY > 0) {
      // åœ¨é ‚éƒ¨å‘ä¸‹æ‹‰
      if (e.cancelable) {
        e.preventDefault();
      }
      if (startScrollContainer === document.documentElement) {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      } else if (startScrollContainer) {
        startScrollContainer.scrollTop = 0;
      }
    } else if (isAtBottom && deltaY < 0) {
      // åœ¨åº•éƒ¨å‘ä¸Šæ‹‰
      if (e.cancelable) {
        e.preventDefault();
      }
      const maxScroll = Math.max(0, scrollHeight - clientHeight);
      if (startScrollContainer === document.documentElement) {
        window.scrollTo(0, maxScroll);
        document.documentElement.scrollTop = maxScroll;
        document.body.scrollTop = maxScroll;
      } else if (startScrollContainer) {
        startScrollContainer.scrollTop = maxScroll;
      }
    }
  }, { passive: false });

  // ç‚ºæ‰€æœ‰ä¸‹æ‹‰é¸å–®å®¹å™¨æ·»åŠ é˜²æ­¢å›å½ˆ
  function setupDropdownPrevention() {
    const dropdowns = document.querySelectorAll('.category-dropdown, .select-dropdown, .options-list, .select-options');
    dropdowns.forEach(dropdown => {
      // é¿å…é‡è¤‡ç¶å®š
      if (dropdown.dataset.bouncePrevented) return;
      dropdown.dataset.bouncePrevented = 'true';

      let dropdownTouchStartY = 0;

      dropdown.addEventListener('touchstart', function(e) {
        dropdownTouchStartY = e.touches[0].clientY;
      }, { passive: true });

      dropdown.addEventListener('touchmove', function(e) {
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - dropdownTouchStartY;
        const currentScrollTop = dropdown.scrollTop;
        const scrollHeight = dropdown.scrollHeight;
        const clientHeight = dropdown.clientHeight;

        const isAtTop = currentScrollTop <= 1;
        const isAtBottom = currentScrollTop + clientHeight >= scrollHeight - 1;

        if (isAtTop && deltaY > 0) {
          if (e.cancelable) {
            e.preventDefault();
          }
          dropdown.scrollTop = 0;
        } else if (isAtBottom && deltaY < 0) {
          if (e.cancelable) {
            e.preventDefault();
          }
          dropdown.scrollTop = Math.max(0, scrollHeight - clientHeight);
        }
      }, { passive: false });
    });
  }

  // é é¢è¼‰å…¥å¾Œè¨­ç½®ä¸‹æ‹‰é¸å–®
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupDropdownPrevention);
  } else {
    setupDropdownPrevention();
  }

  // ç›£è½å‹•æ…‹æ·»åŠ çš„ä¸‹æ‹‰é¸å–®
  const observer = new MutationObserver(() => {
    setupDropdownPrevention();
  });
  observer.observe(document.body, { childList: true, subtree: true });

  document.addEventListener('touchend', function() {
    startScrollContainer = null;
  }, { passive: true });

  document.addEventListener('touchcancel', function() {
    startScrollContainer = null;
  }, { passive: true });
})();

init();
</script>
