---
layout: page
title: è¨­å®š
permalink: /settings/
---

<link rel="stylesheet" href="{{ '/assets/settings.css' | relative_url }}">

<div id="user-info" style="position: fixed; top: 10px; right: 10px; z-index: 1000;"></div>
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-spinner"></div>
  <p>è¼‰å…¥ä¸­...</p>
</div>
<div id="settings-root"></div>

<script>
// API URLï¼ˆæ”¯å‡ºè¡¨ï¼Œæœ€æ–°ï¼‰
const baseExpense = "https://script.google.com/macros/s/AKfycbzZ3lvBx2z2rueEZc2PhoTpo8HdyXkLJ-GkBf_llfpvek08c40wbr7H5wEfH73YQA10/exec";
// API URLï¼ˆé ç®—è¡¨ï¼Œæœ€æ–°ï¼‰
const baseBudget  = "https://script.google.com/macros/s/AKfycbyrRS1rmb2S_M3BNjn_Z-ZR5uZWmpG1j1MDPTF8YqMFzFQxSKFtTjK_tGXuEfa6sP3p/exec";

// è¨­å®šé …ç›®è³‡æ–™ï¼ˆæ¨™é¡Œç”¨æ–¼åœ¨ Google Sheet ä¸­è­˜åˆ¥æ¬„ä½ï¼‰
const settingsItems = [
  { id: 'category', icon: 'ğŸ·ï¸', title: 'æ¶ˆè²»é¡åˆ¥', colorClass: 'btn-category', headerKeywords: ['æ”¯å‡ºï¼é …ç›®', 'æ”¯å‡º-é …ç›®', 'æ¶ˆè²»é¡åˆ¥', 'é¡åˆ¥'] },
  { id: 'payment', icon: 'ğŸ’³', title: 'æ”¯ä»˜æ–¹å¼', colorClass: 'btn-payment', headerKeywords: ['æ”¯ä»˜æ–¹å¼'] },
  { id: 'platform', icon: 'ğŸ¦', title: 'æ”¯ä»˜å¹³å°', colorClass: 'btn-platform', headerKeywords: ['æ”¯ä»˜å¹³å°', 'å¹³å°'] }
];

// ä¸‹æ‹‰é¸å–®è³‡æ–™å¿«å–
let dropdownData = {};
// æ¬„ä½ç´¢å¼•å°æ‡‰ï¼ˆå¾æ¨™é¡Œè¡Œè®€å–ï¼‰
let columnMapping = {};
// åŸå§‹è³‡æ–™ï¼ˆç”¨æ–¼åŒæ­¥ï¼‰
let originalSheetData = [];
// æ˜¯å¦å·²è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™
let dropdownLoaded = false;

const root = document.getElementById('settings-root');
const loadingOverlay = document.getElementById('loading-overlay');

// é¡¯ç¤º/éš±è— loading
function showLoading() {
  loadingOverlay.style.display = 'flex';
}
function hideLoading() {
  loadingOverlay.style.display = 'none';
}

// å¾ Google Sheet è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™ï¼ˆsheetIndex = 1ï¼‰
async function loadDropdownData() {
  try {
    const params = { name: "Show Tab Data", sheet: 1, _t: Date.now() };
    const url = `${baseExpense}?${new URLSearchParams(params)}`;
    const res = await fetch(url, {
      method: "GET",
      redirect: "follow",
      mode: "cors",
      cache: "no-store"
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const responseData = await res.json();
    console.log('[loadDropdownData] åŸå§‹å›æ‡‰è³‡æ–™:', responseData);
    
    // è™•ç†ä¸åŒçš„è³‡æ–™æ ¼å¼
    let data = null;
    
    // å¦‚æœæ˜¯é™£åˆ—ï¼Œç›´æ¥ä½¿ç”¨
    if (Array.isArray(responseData)) {
      data = responseData;
    } 
    // å¦‚æœæ˜¯ç‰©ä»¶ï¼Œå¯èƒ½æ˜¯å‘½åç¯„åœçš„æ ¼å¼ï¼Œå˜—è©¦æ‰¾åˆ°ç¬¬ä¸€å€‹é™£åˆ—å€¼
    else if (typeof responseData === 'object' && responseData !== null) {
      // å°‹æ‰¾ç¬¬ä¸€å€‹å€¼æ˜¯é™£åˆ—çš„éµ
      for (const key in responseData) {
        if (Array.isArray(responseData[key]) && responseData[key].length > 0) {
          data = responseData[key];
          console.log('[loadDropdownData] å¾å‘½åç¯„åœå–å¾—è³‡æ–™:', key);
          break;
        }
      }
      // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦ç›´æ¥ä½¿ç”¨æ•´å€‹ sheet çš„è³‡æ–™ç¯„åœ
      // é€™éœ€è¦ GAS è¿”å›æ•´å€‹ sheet çš„è³‡æ–™ï¼Œè€Œä¸æ˜¯å‘½åç¯„åœ
    }
    
    if (!data || !Array.isArray(data) || data.length === 0) {
      console.warn('[loadDropdownData] ç„¡æ³•è§£æè³‡æ–™æ ¼å¼ï¼Œå›æ‡‰:', responseData);
      // ä¿æŒ dropdownLoaded ç‚º falseï¼Œç¨å¾Œå†æ¬¡é»æ“Šåˆ†é¡æ™‚æœƒå†å˜—è©¦è¼‰å…¥
      return {};
    }
    
    originalSheetData = data;
    const headerRow = data[0];
    console.log('[loadDropdownData] æ¨™é¡Œè¡Œ:', headerRow);
    
    // æ ¹æ“šæ¨™é¡Œæ‰¾åˆ°æ¯å€‹è¨­å®šé …ç›®å°æ‡‰çš„æ¬„ä½ç´¢å¼•
    settingsItems.forEach(item => {
      columnMapping[item.id] = -1;
      for (let col = 0; col < headerRow.length; col++) {
        const headerText = (headerRow[col] || '').toString().trim();
        if (item.headerKeywords.some(keyword => headerText.includes(keyword))) {
          columnMapping[item.id] = col;
          break;
        }
      }
      console.log(`[loadDropdownData] ${item.title} å°æ‡‰æ¬„ä½: ${columnMapping[item.id]}`);
    });
    
    // è®€å–é¸é …ï¼ˆè·³éæ¨™é¡Œè¡Œï¼‰
    settingsItems.forEach(item => {
      dropdownData[item.id] = [];
      const col = columnMapping[item.id];
      if (col >= 0) {
        const seen = new Set(); // é¿å…é‡è¤‡
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (!row) continue;
          const raw = row[col];
          if (raw === undefined || raw === null) continue;
          const val = raw.toString().trim();
          if (!val || seen.has(val)) continue;
          seen.add(val);
          dropdownData[item.id].push(val);
        }
      }
    });
    
    console.log('[loadDropdownData] è§£æå¾Œè³‡æ–™:', dropdownData);
    dropdownLoaded = true;
    return dropdownData;
  } catch (error) {
    console.error('[loadDropdownData] è¼‰å…¥å¤±æ•—:', error);
    // ä¿æŒ dropdownLoaded ç‚º falseï¼Œç¨å¾Œå†æ¬¡é»æ“Šåˆ†é¡æ™‚æœƒå†å˜—è©¦è¼‰å…¥
    return {};
  }
}

// åŒæ­¥è³‡æ–™åˆ° Google Sheetï¼ˆåªåœ¨ã€Œç·¨è¼¯ã€æ™‚ä½¿ç”¨ï¼Œç”¨ä¾†æ‰¹æ¬¡æ›´æ–°æ‰€æœ‰ç¬¦åˆçš„å…§å®¹ï¼‰
async function syncToSheet(itemId, action, rowIndex, newValue, oldValue) {
  const col = columnMapping[itemId];
  if (col < 0) {
    console.error('[syncToSheet] æ‰¾ä¸åˆ°æ¬„ä½ç´¢å¼•');
    return false;
  }
  
  try {
    const postData = {
      name: "Update Dropdown",
      itemId,          // 'category' / 'payment' / 'platform'
      action,          // ç›®å‰åªæœƒç”¨åˆ° 'edit'
      column: col,     // ä¸‹æ‹‰é¸å–®è¡¨ä¸­çš„æ¬„ä½ï¼ˆå¦‚æœå¾Œç«¯éœ€è¦ï¼‰
      rowIndex,        // åŸæœ¬åœ¨ä¸‹æ‹‰é¸å–®è¡¨ä¸­çš„ç´¢å¼•ï¼ˆå¦‚æœå¾Œç«¯éœ€è¦ï¼‰
      oldValue: oldValue || '',
      newValue: newValue || ''
    };
    
    // åªæœ‰ã€Œé¡åˆ¥ã€éœ€è¦åŒæ™‚æ›´æ–°æ”¯å‡ºè¡¨å’Œé ç®—è¡¨ï¼Œå…¶ä»–é …ç›®åªæ›´æ–°æ”¯å‡ºè¡¨
    const isCategory = itemId === 'category';
    
    if (isCategory) {
      console.log('[syncToSheet] ç™¼é€è«‹æ±‚ (æ”¯å‡º + é ç®—):', postData);
      
      // åŒæ™‚æ›´æ–°æ”¯å‡ºè¡¨èˆ‡é ç®—è¡¨
      const [resExpense, resBudget] = await Promise.all([
        fetch(baseExpense, {
          method: "POST",
          redirect: "follow",
          mode: "cors",
          body: JSON.stringify(postData)
        }),
        fetch(baseBudget, {
          method: "POST",
          redirect: "follow",
          mode: "cors",
          body: JSON.stringify(postData)
        })
      ]);

      const textExpense = await resExpense.text();
      const textBudget  = await resBudget.text();
      console.log('[syncToSheet] æ”¯å‡ºå›æ‡‰:', textExpense);
      console.log('[syncToSheet] é ç®—å›æ‡‰:', textBudget);

      // æª¢æŸ¥å›æ‡‰æ˜¯å¦æˆåŠŸ
      let resultExpense, resultBudget;
      try {
        resultExpense = JSON.parse(textExpense);
        resultBudget = JSON.parse(textBudget);
      } catch (e) {
        console.error('[syncToSheet] è§£æå›æ‡‰å¤±æ•—:', e);
        return false;
      }

      if (!resultExpense.success || !resultBudget.success) {
        const errorMsg = `åŒæ­¥å¤±æ•—ï¼š\næ”¯å‡ºè¡¨ï¼š${resultExpense.message || 'æœªçŸ¥éŒ¯èª¤'}\né ç®—è¡¨ï¼š${resultBudget.message || 'æœªçŸ¥éŒ¯èª¤'}`;
        console.error('[syncToSheet]', errorMsg);
        alert(errorMsg);
        return false;
      }
    } else {
      console.log('[syncToSheet] ç™¼é€è«‹æ±‚ (åƒ…æ”¯å‡ºè¡¨):', postData);
      
      // åªæ›´æ–°æ”¯å‡ºè¡¨
      const resExpense = await fetch(baseExpense, {
        method: "POST",
        redirect: "follow",
        mode: "cors",
        body: JSON.stringify(postData)
      });

      const textExpense = await resExpense.text();
      console.log('[syncToSheet] æ”¯å‡ºå›æ‡‰:', textExpense);

      // æª¢æŸ¥å›æ‡‰æ˜¯å¦æˆåŠŸ
      let resultExpense;
      try {
        resultExpense = JSON.parse(textExpense);
      } catch (e) {
        console.error('[syncToSheet] è§£æå›æ‡‰å¤±æ•—:', e);
        return false;
      }

      if (!resultExpense.success) {
        const errorMsg = `åŒæ­¥å¤±æ•—ï¼š\næ”¯å‡ºè¡¨ï¼š${resultExpense.message || 'æœªçŸ¥éŒ¯èª¤'}`;
        console.error('[syncToSheet]', errorMsg);
        alert(errorMsg);
        return false;
      }
    }

    // åŒæ­¥æˆåŠŸå¾Œï¼Œé‡æ–°è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™ä»¥ç¢ºä¿ä¸€è‡´æ€§
    try {
      await loadDropdownData();
      console.log('[syncToSheet] åŒæ­¥æˆåŠŸå¾Œå·²é‡æ–°è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™');
      // é‡æ–°æ¸²æŸ“ç•¶å‰æ‰“é–‹çš„é¢æ¿ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      const activePanel = document.querySelector('.content-panel.active');
      if (activePanel) {
        const panelId = activePanel.id.replace('panel-', '');
        renderOptionsList(panelId);
        console.log('[syncToSheet] å·²é‡æ–°æ¸²æŸ“é¢æ¿:', panelId);
      }
    } catch (e) {
      console.warn('[syncToSheet] é‡æ–°è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™å¤±æ•—:', e);
    }

    // é€šçŸ¥å…¶ä»–é é¢é‡æ–°è¼‰å…¥ä¸‹æ‹‰é¸å–®
    try {
      const updateTime = Date.now().toString();
      localStorage.setItem('dropdownUpdated', updateTime);
      localStorage.setItem('dropdownUpdatedItemId', itemId);
      localStorage.setItem('dropdownUpdatedAction', action);
      // è§¸ç™¼ storage äº‹ä»¶ï¼ˆå¦‚æœå…¶ä»–é é¢åœ¨åŒä¸€å€‹ç€è¦½å™¨è¦–çª—ï¼‰
      window.dispatchEvent(new StorageEvent('storage', {
        key: 'dropdownUpdated',
        newValue: updateTime
      }));
      console.log('[syncToSheet] å·²ç™¼é€æ›´æ–°é€šçŸ¥çµ¦å…¶ä»–é é¢');
    } catch (e) {
      console.warn('[syncToSheet] ç„¡æ³•ç™¼é€æ›´æ–°é€šçŸ¥:', e);
    }

    return true;
  } catch (error) {
    console.error('[syncToSheet] åŒæ­¥å¤±æ•—:', error);
    return false;
  }
}

// å»ºç«‹ä¸»é¸å–®
function createMainMenu() {
  const menu = document.createElement('div');
  menu.id = 'main-menu';
  menu.className = 'settings-container';
  
  settingsItems.forEach(item => {
    const btn = document.createElement('a');
    btn.href = '#';
    btn.className = `settings-btn ${item.colorClass}`;
    btn.innerHTML = `<span class="btn-icon">${item.icon}</span>${item.title}`;
    btn.onclick = (e) => {
      e.preventDefault();
      showPanel(item.id);
    };
    menu.appendChild(btn);
  });
  
  return menu;
}

// å»ºç«‹å…§å®¹é¢æ¿
function createPanel(item) {
  const panel = document.createElement('div');
  panel.id = `panel-${item.id}`;
  panel.className = 'content-panel';
  
  panel.innerHTML = `
    <div class="panel-header">
      <h2 class="panel-title">${item.icon} ${item.title}</h2>
      <button class="back-btn">â† è¿”å›</button>
    </div>
    <div class="panel-content">
      <div class="options-list" id="list-${item.id}"></div>
      <div class="add-option-container">
        <input type="text" class="add-option-input" id="input-${item.id}" name="input-${item.id}" placeholder="æ–°å¢é¸é …...">
        <button class="add-option-btn" id="add-btn-${item.id}">+ æ–°å¢</button>
      </div>
    </div>
  `;
  
  panel.querySelector('.back-btn').onclick = showMenu;
  panel.querySelector(`#add-btn-${item.id}`).onclick = () => addOption(item.id);
  panel.querySelector(`#input-${item.id}`).onkeypress = (e) => {
    if (e.key === 'Enter') addOption(item.id);
  };
  
  return panel;
}

// æ¸²æŸ“é¸é …åˆ—è¡¨
function renderOptionsList(itemId) {
  const list = document.getElementById(`list-${itemId}`);
  const options = dropdownData[itemId] || [];
  
  if (options.length === 0) {
    list.innerHTML = '<div class="empty-msg">å°šç„¡é¸é …</div>';
    return;
  }
  
  list.innerHTML = '';
  options.forEach((option, index) => {
    const optionDiv = document.createElement('div');
    optionDiv.className = 'option-item';
    
    // å¯ç·¨è¼¯çš„æ–‡å­—
    const textSpan = document.createElement('span');
    textSpan.className = 'option-text';
    textSpan.textContent = option;
    textSpan.title = 'é»æ“Šç·¨è¼¯';
    textSpan.onclick = () => startEdit(itemId, index, textSpan);
    
    // åˆªé™¤æŒ‰éˆ•
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-option-btn';
    deleteBtn.textContent = 'âœ•';
    deleteBtn.onclick = () => deleteOption(itemId, index);
    
    optionDiv.appendChild(textSpan);
    optionDiv.appendChild(deleteBtn);
    list.appendChild(optionDiv);
  });
}

// é–‹å§‹ç·¨è¼¯
function startEdit(itemId, index, textSpan) {
  const oldValue = dropdownData[itemId][index];
  const input = document.createElement('input');
  input.id = `edit-${itemId}-${index}`;
  input.name = `edit-${itemId}-${index}`;
  input.type = 'text';
  input.className = 'edit-input';
  input.value = oldValue;
  
  const finishEdit = async () => {
    const newValue = input.value.trim();
    if (newValue && newValue !== oldValue) {
      // æª¢æŸ¥æ˜¯å¦é‡è¤‡
      if (dropdownData[itemId].includes(newValue) && dropdownData[itemId].indexOf(newValue) !== index) {
        alert('æ­¤é¸é …å·²å­˜åœ¨');
        input.value = oldValue;
        return;
      }
      
      // å…ˆæ›´æ–°å‰ç«¯ï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
      dropdownData[itemId][index] = newValue;
      renderOptionsList(itemId);
      
      // åŒæ­¥åˆ°å¾Œç«¯
      const success = await syncToSheet(itemId, 'edit', index, newValue, oldValue);
      if (success) {
        console.log(`[startEdit] ç·¨è¼¯ä¸¦åŒæ­¥åˆ°å¾Œç«¯æˆåŠŸ ${itemId}[${index}]: ${oldValue} -> ${newValue}`);
        // syncToSheet å·²ç¶“æœƒé‡æ–°è¼‰å…¥è³‡æ–™ï¼Œé€™è£¡åªéœ€è¦é‡æ–°æ¸²æŸ“
        renderOptionsList(itemId);
      } else {
        // åŒæ­¥å¤±æ•—ï¼Œå›æ»¾å‰ç«¯æ›´æ”¹
        dropdownData[itemId][index] = oldValue;
        renderOptionsList(itemId);
        alert('ç·¨è¼¯å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    } else {
      renderOptionsList(itemId);
    }
  };
  
  input.onblur = finishEdit;
  input.onkeypress = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      input.blur();
    }
  };
  input.onkeydown = (e) => {
    if (e.key === 'Escape') {
      renderOptionsList(itemId);
    }
  };
  
  textSpan.replaceWith(input);
  input.focus();
  input.select();
}

// æ–°å¢é¸é …
async function addOption(itemId) {
  const input = document.getElementById(`input-${itemId}`);
  const value = input.value.trim();
  
  if (!value) {
    alert('è«‹è¼¸å…¥é¸é …å…§å®¹');
    return;
  }
  
  if (!dropdownData[itemId]) dropdownData[itemId] = [];
  
  if (dropdownData[itemId].includes(value)) {
    alert('æ­¤é¸é …å·²å­˜åœ¨');
    return;
  }
  
  const newIndex = dropdownData[itemId].length;
  // å…ˆæ›´æ–°å‰ç«¯ï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
  dropdownData[itemId].push(value);
  input.value = '';
  renderOptionsList(itemId);
  
  // åŒæ­¥åˆ°å¾Œç«¯
  const success = await syncToSheet(itemId, 'add', newIndex, value, '');
  if (success) {
    console.log(`[addOption] æ–°å¢ä¸¦åŒæ­¥åˆ°å¾Œç«¯æˆåŠŸ ${itemId}: ${value}`);
    // syncToSheet å·²ç¶“æœƒé‡æ–°è¼‰å…¥è³‡æ–™ä¸¦é‡æ–°æ¸²æŸ“ï¼Œé€™è£¡ä¸éœ€è¦é‡è¤‡æ“ä½œ
  } else {
    // åŒæ­¥å¤±æ•—ï¼Œå›æ»¾å‰ç«¯æ›´æ”¹
    dropdownData[itemId].pop();
    input.value = value;
    renderOptionsList(itemId);
    alert('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}

// åˆªé™¤é¸é …
async function deleteOption(itemId, index) {
  const option = dropdownData[itemId][index];
  if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${option}ã€å—ï¼Ÿ`)) {
    // å…ˆæ›´æ–°å‰ç«¯ï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
    dropdownData[itemId].splice(index, 1);
    renderOptionsList(itemId);
    
    // åŒæ­¥åˆ°å¾Œç«¯
    const success = await syncToSheet(itemId, 'delete', index, '', option);
    if (success) {
      console.log(`[deleteOption] åˆªé™¤ä¸¦åŒæ­¥åˆ°å¾Œç«¯æˆåŠŸ ${itemId}[${index}]: ${option}`);
      // syncToSheet å·²ç¶“æœƒé‡æ–°è¼‰å…¥è³‡æ–™ï¼Œé€™è£¡åªéœ€è¦é‡æ–°æ¸²æŸ“
      renderOptionsList(itemId);
    } else {
      // åŒæ­¥å¤±æ•—ï¼Œå›æ»¾å‰ç«¯æ›´æ”¹
      dropdownData[itemId].splice(index, 0, option);
      renderOptionsList(itemId);
      alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }
}

// é¡¯ç¤ºæŒ‡å®šé¢æ¿ï¼ˆé»åˆ†é¡å¾Œæ‰é¡¯ç¤ºè¼‰å…¥ä¸­ï¼Œä¸¦ç¢ºä¿è³‡æ–™å·²è®€å–ï¼‰
async function showPanel(panelId) {
  // å¦‚æœä¸‹æ‹‰è³‡æ–™é‚„æ²’è¼‰å…¥ï¼Œå°±é¡¯ç¤º loading ä¸¦è¼‰å…¥ä¸€æ¬¡
  if (!dropdownLoaded) {
    showLoading();
    await loadDropdownData();
    hideLoading();
  }

  document.getElementById('main-menu').style.display = 'none';
  document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`panel-${panelId}`).classList.add('active');
  renderOptionsList(panelId);
}

// é¡¯ç¤ºä¸»é¸å–®
function showMenu() {
  document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('main-menu').style.display = 'flex';
}

// åˆå§‹åŒ–é é¢
async function init() {
  // é€²å…¥è¨­å®šé æ™‚ï¼Œå…ˆå»ºç«‹ä¸»é¸å–®èˆ‡å„åˆ†é¡é¢æ¿ï¼Œè®“ç•«é¢ç«‹åˆ»å¯æ“ä½œ
  root.appendChild(createMainMenu());
  settingsItems.forEach(item => {
    root.appendChild(createPanel(item));
  });

  // åŒæ™‚åœ¨èƒŒæ™¯é–‹å§‹è¼‰å…¥ã€Œä¸‹æ‹‰é¸å–®ã€sheet=1 è³‡æ–™ï¼ˆä¸é˜»å¡ç•«é¢ï¼‰
  loadDropdownData();
}

init();
</script>
