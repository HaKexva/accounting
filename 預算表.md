---
layout: page
title: é ç®—è¡¨
permalink: /budget_table/
---

<script>

const base = "https://script.google.com/macros/s/AKfycbzLT6v4hPwp25p1VPOZ2G0Fldg6mtz5NGHeigVU4_gg4XA0QAZbgFIa0-RK3w0lzOdyzw/exec";
const params = { name: "Show Tab Data", sheet: 2 };
const url = `${base}?${new URLSearchParams(params)}`;

// å¾è©¦ç®—è¡¨è¼‰å…¥çš„æ‰€æœ‰è¨˜éŒ„ï¼ˆæ”¶å…¥ + æ”¯å‡ºï¼‰ï¼Œä¾åºå­˜èµ·ä¾†
let allRecords = []; // æ‰€æœ‰è¨˜éŒ„
let filteredRecords = []; // ç›®å‰é¡å‹éæ¿¾å¾Œçš„è¨˜éŒ„
let currentRecordIndex = 0;
let isNewMode = false; // æ˜¯å¦åœ¨æ–°å¢æ¨¡å¼
let currentRecordNumber = null; // ç›®å‰é¡¯ç¤ºçš„è¨˜éŒ„ç·¨è™Ÿï¼ˆç”¨æ–¼åˆ‡æ›é¡å‹æ™‚ä¿æŒç›¸åŒç·¨è™Ÿï¼‰

// æ ¹æ“šç›®å‰é¸æ“‡çš„é¡å‹éæ¿¾è¨˜éŒ„
function filterRecordsByType(type) {
  filteredRecords = allRecords.filter(r => r.type === type);

  //  æ–°å¢æ¨¡å¼ï¼šåˆ‡æ›æ”¶å…¥ / æ”¯å‡ºæ¨¡å¼ï¼šé‡æ–°è¨ˆç®—è©²é¡å‹çš„ä¸‹ä¸€å€‹ç·¨è™Ÿ
  if (isNewMode) {
    // è¨ˆç®—æ–°é¡å‹ä¸­æœ€å¤§çš„ç·¨è™Ÿ + 1
    let nextNumber = 1;
    if (filteredRecords.length > 0) {
      const maxNum = Math.max(
        ...filteredRecords
          .map(r => parseInt(r.row[0], 10))
          .filter(n => Number.isFinite(n) && n > 0)
      );
      if (Number.isFinite(maxNum) && maxNum > 0) {
        nextNumber = maxNum + 1;
      }
    }
    
    // æ›´æ–°ç·¨è™Ÿé¡¯ç¤ºç‚ºæ–°é¡å‹çš„ä¸‹ä¸€å€‹ç·¨è™Ÿ
    if (typeof recordNumber !== 'undefined') {
      recordNumber.textContent = `#${String(nextNumber).padStart(3, '0')}`;
      currentRecordNumber = nextNumber; // æ›´æ–°è¨˜éŒ„çš„ç·¨è™Ÿ
    }
    
    // æ¸…ç©ºè¡¨å–®ï¼Œæº–å‚™æ–°å¢
    const itemInput = document.getElementById('item-input');
    const costInput = document.getElementById('cost-input');
    const noteInput = document.getElementById('note-input');
    if (itemInput) itemInput.value = '';
    if (costInput) costInput.value = '';
    if (noteInput) noteInput.value = '';
    
    // å¦‚æœæ˜¯æ”¯å‡ºï¼Œé‡ç½®é¡åˆ¥é¸æ“‡
    if (type === 'æ”¯å‡º') {
      const categorySelectElement = document.getElementById('category-select');
      if (categorySelectElement && categorySelectElement.options.length > 0) {
        categorySelectElement.value = categorySelectElement.options[0].value;
        const selectContainer = categorySelectElement.parentElement;
        if (selectContainer) {
          const selectDisplay = selectContainer.querySelector('div');
          if (selectDisplay) {
            const selectText = selectDisplay.querySelector('div');
            if (selectText) {
              selectText.textContent = categorySelectElement.options[0].textContent;
            }
          }
        }
      }
    }
    
    updateArrowButtons();
    updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
    return;
  }

  // å˜—è©¦æ‰¾åˆ°ç›¸åŒç·¨è™Ÿçš„è¨˜éŒ„
  if (currentRecordNumber !== null && filteredRecords.length > 0) {
    const sameNumberIndex = filteredRecords.findIndex(r => {
      const num = parseInt(r.row[0], 10);
      return Number.isFinite(num) && num > 0 && num === currentRecordNumber;
    });
    
    if (sameNumberIndex >= 0) {
      currentRecordIndex = sameNumberIndex;
      showRecord(sameNumberIndex);
      updateArrowButtons();
      return;
    }
  }
  
  // å¦‚æœæ‰¾ä¸åˆ°ç›¸åŒç·¨è™Ÿï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†
  currentRecordIndex = 0;
  if (filteredRecords.length > 0) {
    showRecord(0);
  } else {
    // æ²’æœ‰è¨˜éŒ„æ™‚ï¼Œæ¸…ç©ºè¡¨å–®ä¸¦æ›´æ–°æŒ‰éˆ•
    const itemInput = document.getElementById('item-input');
    const costInput = document.getElementById('cost-input');
    const noteInput = document.getElementById('note-input');
    if (itemInput) itemInput.value = '';
    if (costInput) costInput.value = '';
    if (noteInput) noteInput.value = '';
    if (typeof recordNumber !== 'undefined') {
      recordNumber.textContent = '#æ–°å¢';
    }
    updateArrowButtons();
    updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
  }
}

// é¡¯ç¤ºç¬¬ index ç­†è¨˜éŒ„åˆ°å¡ç‰‡ä¸Šçš„è¼¸å…¥æ¬„ä½
function showRecord(index) {
  if (!filteredRecords.length) return;
  const { type, row } = filteredRecords[index];
  isNewMode = false; // é¡¯ç¤ºè¨˜éŒ„æ™‚é€€å‡ºæ–°å¢æ¨¡å¼
  updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º

  // æ›´æ–°å·¦ä¸Šè§’ç·¨è™Ÿï¼šåªé¡¯ç¤ºè©²è¨˜éŒ„è‡ªå·±çš„ç·¨è™Ÿï¼ˆrow[0]ï¼‰ï¼Œä¸é¡¯ç¤ºæ”¶å…¥/æ”¯å‡º
  if (typeof recordNumber !== 'undefined') {
    const num = parseInt(row[0], 10);
    const recordNum = Number.isFinite(num) && num > 0 ? num : (index + 1);
    recordNumber.textContent = `#${String(recordNum).padStart(3, '0')}`;
    currentRecordNumber = recordNum; // è¨˜éŒ„ç›®å‰ç·¨è™Ÿ
  }

  // è¨­å®šã€Œæ”¯å‡º / æ”¶å…¥ã€å¤§é¡ï¼ˆåªæ”¹ç•«é¢ï¼Œä¸è§¸ç™¼ change äº‹ä»¶ï¼Œé¿å…éè¿´ï¼‰
  if (typeof categorySelect !== 'undefined' && typeof categorySelectText !== 'undefined') {
    const value = type === 'æ”¶å…¥' || type === 'æ”¯å‡º' ? type : 'æ”¯å‡º';
    categorySelect.value = value;
    categorySelectText.textContent = value;
    // ç›´æ¥æ›´æ–°æ¬„ä½é¡¯ç¤º
    if (typeof updateDivVisibility === 'function') {
      updateDivVisibility();
    }
  }

  // ç­‰ div2 / div3 / div4 ä¾æ“šé¡åˆ¥å»ºç«‹å¥½ä¹‹å¾Œå†å¡«è³‡æ–™
  // ä½¿ç”¨è¼ƒé•·çš„å»¶é²ï¼Œç¢ºä¿ updateDivVisibility å®Œæˆ
  setTimeout(() => {
    const itemInput = document.getElementById('item-input');
    const costInput = document.getElementById('cost-input');
    const noteInput = document.getElementById('note-input');

    if (type === 'æ”¯å‡º') {
      // æ”¯å‡ºï¼š[ç·¨è™Ÿ, æ™‚é–“, category, item, cost, note]
      const categorySelectElement = document.getElementById('category-select');
      if (categorySelectElement) {
        categorySelectElement.value = row[2] || '';
        // åŒæ­¥æ›´æ–°è‡ªè¨‚ä¸‹æ‹‰é¡¯ç¤ºæ–‡å­—ï¼ˆè‹¥å­˜åœ¨ï¼‰
        const selectContainer = categorySelectElement.parentElement;
        if (selectContainer) {
          const selectDisplay = selectContainer.querySelector('div');
          if (selectDisplay) {
            const selectText = selectDisplay.querySelector('div');
            if (selectText) {
              selectText.textContent = row[2] || '';
            }
          }
        }
      }
      if (itemInput) {
        itemInput.value = row[3] || '';
        // ç¢ºä¿å€¼å·²è¨­å®šï¼ˆé¿å… placeholder é¡¯ç¤ºï¼‰
        if (itemInput.value === '' && row[3]) {
          itemInput.value = row[3];
        }
      }
      if (costInput) costInput.value = row[4] || '';
      if (noteInput) noteInput.value = row[5] || '';
    } else {
      // æ”¶å…¥ï¼š[ç·¨è™Ÿ, æ™‚é–“, item, cost, note]
      if (itemInput) {
        itemInput.value = row[2] || '';
        // ç¢ºä¿å€¼å·²è¨­å®šï¼ˆé¿å… placeholder é¡¯ç¤ºï¼‰
        if (itemInput.value === '' && row[2]) {
          itemInput.value = row[2];
        }
      }
      if (costInput) costInput.value = row[3] || '';
      if (noteInput) noteInput.value = row[4] || '';
    }
    
    // æ›´æ–°ç®­é ­æŒ‰éˆ•ç‹€æ…‹
    updateArrowButtons();
  }, 150);
}

const loadContent = async () => {
  // å…ˆæ¸…ç©ºç›®å‰çš„è¨˜éŒ„
  allRecords = [];
  filteredRecords = [];
  currentRecordIndex = 0;

  // å¾è©¦ç®—è¡¨æŠ“å‡ºã€Œç•¶æœˆæ”¶å…¥ / æ”¯å‡ºã€ç­‰è³‡æ–™
  const res = await fetch(url);
  const data = await res.json(); // ShowTabData å›å‚³çš„ç‰©ä»¶

  if (data && typeof data === 'object') {
    Object.keys(data).forEach(key => {
      const rows = data[key] || [];

      const isIncome = key.includes('æ”¶å…¥');
      const isExpense = key.includes('æ”¯å‡º');
      const type = isIncome ? 'æ”¶å…¥' : (isExpense ? 'æ”¯å‡º' : '');

      rows.forEach(row => {
        if (!row || row.length === 0) return;
        // è·³éæ¨™é¡Œåˆ—ã€ç¸½è¨ˆåˆ—ã€åŠæ²’æœ‰æœ‰æ•ˆç·¨è™Ÿï¼ˆéæ•¸å­—æˆ– <= 0ï¼‰
        const num = parseInt(row[0], 10);
        if (!Number.isFinite(num) || num <= 0) return;
        allRecords.push({ type, row });
      });
    });
  }

  // æ ¹æ“šç›®å‰é¸æ“‡çš„é¡å‹éæ¿¾è¨˜éŒ„ï¼ˆé è¨­é¡¯ç¤ºæ”¯å‡ºï¼‰
  const currentType = categorySelect ? categorySelect.value : 'æ”¯å‡º';
  filterRecordsByType(currentType);

  // æ›´æ–°ä¸Šæ–¹ã€Œæ”¶å…¥ / æ”¯å‡º / ç¸½è¨ˆã€
  const TotalParams = { name: "Show Total", sheet: 2 };
  
  const Totalurl = `${base}?${new URLSearchParams(TotalParams)}`;
  const Totalres = await fetch(Totalurl);
  const Totaldata = await Totalres.json();
  incomeAmount.textContent = Totaldata[0];
  expenseAmount.textContent = Totaldata[1];
  totalAmount.textContent = Totaldata[2];
  updateTotalColor(Totaldata[2]);
};


let currentBudgetIndex = 0;

const getCurrentBudget = async () => {
  const res = await fetch(url);
  const data = await res.json();
  const budgets = data;
  return budgets[currentBudgetIndex];
}

const updateBudgetHeader = () => {
  const budget = getCurrentBudget();
  // ç¯„ä¾‹ï¼š#001 é ç®— 1
  recordNumber.textContent = `#${(currentBudgetIndex + 1)
    .toString()
    .padStart(3, '0')} ${budget.name}`;
};

const loadTotal = async () => {
  // ç›´æ¥ä½¿ç”¨å›ºå®šçš„åˆ†é ç´¢å¼•ï¼ˆèˆ‡ loadContent ç›¸åŒï¼‰
  const TotalParams = { name: "Show Total", sheet: 2 };
  const Totalurl = `${base}?${new URLSearchParams(TotalParams)}`;
  const Totalres = await fetch(Totalurl);
  const Totaldata = await Totalres.json();
  incomeAmount.textContent = Totaldata[0];
  expenseAmount.textContent = Totaldata[1];
  totalAmount.textContent = Totaldata[2];
  updateTotalColor(Totaldata[2]);
};

const showSpinner = () => {
  const spinner = document.createElement('div');
  spinner.id = 'loading-spinner';
  spinner.style.position = 'fixed';
  spinner.style.top = '50%';
  spinner.style.left = '50%';
  spinner.style.transform = 'translate(-50%, -50%)';
  spinner.style.zIndex = '99999';
  spinner.style.background = 'rgba(255, 255, 255, 0.95)';
  spinner.style.padding = '20px';
  spinner.style.borderRadius = '8px';
  spinner.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
  spinner.style.border = '2px solid #3498db';
  spinner.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; transform: none;"></div>
      <span>è¼‰å…¥ä¸­...</span>
    </div>
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
  document.getElementsByClassName('post-content')[0].appendChild(spinner);
};

const hideSpinner = () => {
  const spinner = document.getElementById('loading-spinner');
  if (spinner) {
    spinner.remove();
  }
};

const createInputRow = (labelText, inputId, inputType = 'text') => {
  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.alignItems = 'center';
  row.style.justifyContent = 'center';
  row.style.padding = '8px';
  row.style.marginBottom = '8px';
  row.style.width = '100%';
  row.style.boxSizing = 'border-box';
  row.style.gap = '10px';
  
  const label = document.createElement('label');
  label.textContent = labelText;
  label.style.fontSize = '14px';
  label.style.color = '#333';
  label.style.fontWeight = '500';
  label.style.whiteSpace = 'nowrap';
  
  const input = document.createElement('input');
  input.id = inputId;
  input.type = inputType;
  input.style.padding = '6px 10px';
  input.style.border = '1px solid #ddd';
  input.style.borderRadius = '6px';
  input.style.fontSize = '14px';
  input.style.backgroundColor = '#fff';
  input.style.flex = '1';
  
  row.appendChild(label);
  row.appendChild(input);
  return row;
};

const createSelectRow = (labelText, selectId, options) => {
  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.alignItems = 'center';
  row.style.justifyContent = 'center';
  row.style.padding = '8px';
  row.style.marginBottom = '8px';
  row.style.width = '100%';
  row.style.boxSizing = 'border-box';
  row.style.gap = '10px';
  
  const label = document.createElement('label');
  label.textContent = labelText;
  label.style.fontSize = '14px';
  label.style.color = '#333';
  label.style.fontWeight = '500';
  label.style.whiteSpace = 'nowrap';
  
  const selectContainer = document.createElement('div');
  selectContainer.style.position = 'relative';
  selectContainer.style.flex = '1';
  selectContainer.style.minWidth = '200px';
  
  const selectDisplay = document.createElement('div');
  selectDisplay.style.padding = '6px 10px';
  selectDisplay.style.border = '1px solid #ddd';
  selectDisplay.style.borderRadius = '6px';
  selectDisplay.style.fontSize = '14px';
  selectDisplay.style.backgroundColor = '#fff';
  selectDisplay.style.cursor = 'pointer';
  selectDisplay.style.minHeight = '20px';
  selectDisplay.style.display = 'flex';
  selectDisplay.style.alignItems = 'center';
  selectDisplay.style.justifyContent = 'space-between';
  selectDisplay.style.gap = '8px';
  
  const selectText = document.createElement('div');
  selectText.style.flex = '1';
  selectText.style.wordBreak = 'break-word';
  selectText.style.whiteSpace = 'normal';
  selectText.style.minWidth = '0';
  selectText.textContent = options[0].text;
  
  const selectArrow = document.createElement('div');
  selectArrow.textContent = 'â–¼';
  selectArrow.style.fontSize = '10px';
  selectArrow.style.color = '#666';
  selectArrow.style.transition = 'transform 0.2s';
  selectArrow.style.flexShrink = '0';
  selectArrow.style.lineHeight = '1';
  
  selectDisplay.appendChild(selectText);
  selectDisplay.appendChild(selectArrow);
  
  const hiddenSelect = document.createElement('select');
  hiddenSelect.id = selectId;
  hiddenSelect.style.display = 'none';
  hiddenSelect.value = options[0].value;
  
  const dropdown = document.createElement('div');
  dropdown.style.display = 'none';
  dropdown.style.position = 'absolute';
  dropdown.style.top = '100%';
  dropdown.style.left = '0';
  dropdown.style.right = '0';
  dropdown.style.backgroundColor = '#fff';
  dropdown.style.border = '1px solid #ddd';
  dropdown.style.borderRadius = '6px';
  dropdown.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
  dropdown.style.zIndex = '1000';
  dropdown.style.maxHeight = '200px';
  dropdown.style.overflowY = 'auto';
  dropdown.style.marginTop = '4px';
  
  options.forEach(opt => {
    const option = document.createElement('div');
    option.style.padding = '8px 10px';
    option.style.cursor = 'pointer';
    option.style.fontSize = '14px';
    option.style.wordBreak = 'break-word';
    option.style.whiteSpace = 'normal';
    option.style.borderBottom = '1px solid #f0f0f0';
    option.textContent = opt.text;
    option.dataset.value = opt.value;
    
    option.addEventListener('mouseenter', function() {
      this.style.backgroundColor = '#f5f5f5';
    });
    option.addEventListener('mouseleave', function() {
      this.style.backgroundColor = '#fff';
    });
    
    option.addEventListener('click', function() {
      selectText.textContent = opt.text;
      hiddenSelect.value = opt.value;
      dropdown.style.display = 'none';
      selectArrow.style.transform = 'rotate(0deg)';
      hiddenSelect.dispatchEvent(new Event('change'));
    });
    
    dropdown.appendChild(option);
    const hiddenOption = document.createElement('option');
    hiddenOption.value = opt.value;
    hiddenOption.textContent = opt.text;
    hiddenSelect.appendChild(hiddenOption);
  });
  
  selectDisplay.addEventListener('click', function(e) {
    e.stopPropagation();
    const isOpen = dropdown.style.display === 'block';
    dropdown.style.display = isOpen ? 'none' : 'block';
    selectArrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
  });
  
  document.addEventListener('click', function(e) {
    if (!selectContainer.contains(e.target)) {
      dropdown.style.display = 'none';
      selectArrow.style.transform = 'rotate(0deg)';
    }
  });
  
  selectContainer.appendChild(selectDisplay);
  selectContainer.appendChild(dropdown);
  selectContainer.appendChild(hiddenSelect);
  
  row.appendChild(label);
  row.appendChild(selectContainer);
  return row;
};

const updateDivVisibility = () => {
  const categoryValue = categorySelect.value;
  
  div2.innerHTML = '';
  div3.innerHTML = '';
  div4.innerHTML = '';
  
  if (categoryValue === 'æ”¯å‡º') {
    const categoryRow = createSelectRow('é¡åˆ¥ï¼š', 'category-select', [
      { value: 'ç”Ÿæ´»èŠ±è²»ï¼šé£Ÿ', text: 'ç”Ÿæ´»èŠ±è²»ï¼šé£Ÿ' },
      { value: 'ç”Ÿæ´»èŠ±è²»ï¼šè¡£èˆ‡å¤–è²Œ', text: 'ç”Ÿæ´»èŠ±è²»ï¼šè¡£èˆ‡å¤–è²Œ' },
      { value: 'ç”Ÿæ´»èŠ±è²»ï¼šä½ã€å±…å®¶è£ä¿®ã€è¡›ç”Ÿç”¨å“ã€æ¬¡æœˆç¹³ç´å¸³å–®', text: 'ç”Ÿæ´»èŠ±è²»ï¼šä½ã€å±…å®¶è£ä¿®ã€è¡›ç”Ÿç”¨å“ã€æ¬¡æœˆç¹³ç´å¸³å–®' },
      { value: 'ç”Ÿæ´»èŠ±è²»ï¼šè¡Œ', text: 'ç”Ÿæ´»èŠ±è²»ï¼šè¡Œ' },
      { value: 'ç”Ÿæ´»èŠ±è²»ï¼šè‚²', text: 'ç”Ÿæ´»èŠ±è²»ï¼šè‚²' },
      { value: 'ç”Ÿæ´»èŠ±è²»ï¼šæ¨‚', text: 'ç”Ÿæ´»èŠ±è²»ï¼šæ¨‚' },
      { value: 'ç”Ÿæ´»èŠ±è²»ï¼šå¥ï¼ˆé†«ç™‚ï¼‰', text: 'ç”Ÿæ´»èŠ±è²»ï¼šå¥ï¼ˆé†«ç™‚ï¼‰' },
      { value: 'ç”Ÿæ´»èŠ±è²»ï¼šå¸³å–®', text: 'ç”Ÿæ´»èŠ±è²»ï¼šå¸³å–®' },
      { value: 'å„²è“„ï¼šé€€ä¼‘é‡‘ã€é†«ç™‚é å‚™é‡‘ã€éå¹´ç´…åŒ…æ”¯å‡º', text: 'å„²è“„ï¼šé€€ä¼‘é‡‘ã€é†«ç™‚é å‚™é‡‘ã€éå¹´ç´…åŒ…æ”¯å‡º' },
      { value: 'å®¶äººï¼šéå¹´ç´…åŒ…ã€ç´€å¿µæ—¥', text: 'å®¶äººï¼šéå¹´ç´…åŒ…ã€ç´€å¿µæ—¥' }
    ]);
    const costRow = createInputRow('é‡‘é¡ï¼š', 'cost-input', 'number');
    const noteRow = createInputRow('å‚™è¨»ï¼š', 'note-input');
    noteRow.style.marginBottom = '0px';
    
    div2.appendChild(categoryRow);
    div3.appendChild(costRow);
    div4.appendChild(noteRow);
    
    itemContainer.style.display = 'flex';
    div2.style.display = 'flex';
    div3.style.display = 'flex';
    div4.style.display = 'flex';
  } else if (categoryValue === 'æ”¶å…¥') {
    const costRow = createInputRow('é‡‘é¡ï¼š', 'cost-input', 'number');
    const noteRow = createInputRow('å‚™è¨»ï¼š', 'note-input');
    noteRow.style.marginBottom = '0px';
    
    div2.appendChild(costRow);
    div3.appendChild(noteRow);
    
    itemContainer.style.display = 'flex';
    div2.style.display = 'flex';
    div3.style.display = 'flex';
    div4.style.display = 'none';
  }
};

const saveData = async () => {
  const categoryValue = categorySelect.value;
  const itemInput = document.getElementById('item-input');
  const costInput = document.getElementById('cost-input');
  const noteInput = document.getElementById('note-input');
  const TotalParams = { name: "Show Total", sheet: 2 };
  
  if (!itemInput || !costInput) {
    alert('è«‹ç­‰å¾…è¡¨å–®è¼‰å…¥å®Œæˆ');
    return;
  }
  
  const item = itemInput.value.trim();
  const costValue = costInput.value.trim();
  const cost = parseFloat(costValue);
  const note = noteInput ? noteInput.value.trim() : '';
  
  if (!item) {
    alert('è«‹è¼¸å…¥é …ç›®');
    return;
  }
  
  if (!costValue || isNaN(cost) || cost <= 0) {
    alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
    return;
  }
  
  let category = '';
  let range = 0;
  
  if (categoryValue === 'æ”¯å‡º') {
    const div2Display = window.getComputedStyle(div2).display;
    if (div2Display === 'none' || div2Display === '') {
      alert('è«‹ç­‰å¾…è¡¨å–®è¼‰å…¥å®Œæˆ');
      return;
    }
    const categorySelectElement = document.getElementById('category-select');
    if (!categorySelectElement) {
      alert('è«‹ç­‰å¾…è¡¨å–®è¼‰å…¥å®Œæˆ');
      return;
    }
    if (!categorySelectElement.value) {
      alert('è«‹é¸æ“‡æ”¯å‡ºé¡åˆ¥');
      return;
    }
    category = categorySelectElement.value;
    range = 0;
  } else {
    range = 1;
  }
  
  
  saveButton.textContent = 'å„²å­˜ä¸­...';
  saveButton.disabled = true;
  saveButton.style.opacity = '0.6';
  saveButton.style.cursor = 'not-allowed';
  
  let alreadyReset = false; // ç¢ºä¿åªåœ¨åˆé©æ™‚æ©Ÿé‚„åŸæŒ‰éˆ•ç‹€æ…‹
  try {
    const postData = {
      name: "Upsert Data",
      sheet: 2,
      range: range,
      item: item,
      cost: cost,
      note: note,
      
    };
    
    // æ”¯å‡ºæ™‚ï¼ˆrange === 0ï¼‰å¿…é ˆç™¼é€ category
    if (range === 0) {
      postData.category = category;
    }
    
    // å¦‚æœä¸æ˜¯æ–°å¢æ¨¡å¼ï¼Œå¿…é ˆå‚³é€ updateRow åƒæ•¸ä¾†æ›´æ–°ç¾æœ‰è¨˜éŒ„
    // updateRow æ˜¯è¡Œè™Ÿ = ç·¨è™Ÿ + 2ï¼ˆç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œï¼Œè³‡æ–™å¾ç¬¬äºŒè¡Œé–‹å§‹ï¼‰
    if (!isNewMode) {
      if (filteredRecords.length > 0 && currentRecordIndex < filteredRecords.length) {
        const currentRecord = filteredRecords[currentRecordIndex];
        const recordNum = parseInt(currentRecord.row[0], 10);
        if (Number.isFinite(recordNum) && recordNum > 0) {
          postData.updateRow = recordNum + 2;
        } else {
          console.warn('ç„¡æ³•å–å¾—è¨˜éŒ„ç·¨è™Ÿï¼Œç„¡æ³•æ›´æ–°');
          alert('ç„¡æ³•æ›´æ–°è¨˜éŒ„ï¼šæ‰¾ä¸åˆ°è¨˜éŒ„ç·¨è™Ÿ');
          return;
        }
      } else {
        console.warn('ç„¡æ³•å–å¾—ç›®å‰è¨˜éŒ„ï¼Œç„¡æ³•æ›´æ–°');
        alert('ç„¡æ³•æ›´æ–°è¨˜éŒ„ï¼šæ‰¾ä¸åˆ°ç›®å‰è¨˜éŒ„');
        return;
      }
    }

    
    const response = await fetch(base, {
      method: "POST",
      redirect: "follow",
      keepalive: true,
      headers: {
        "Content-Type": "text/plain;charset=utf-8",
      },
      body: JSON.stringify(postData)
    });
    
    const responseText = await response.text();
    
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (e) {
      console.error('ç„¡æ³•è§£æéŸ¿æ‡‰ç‚º JSON:', responseText);
      throw new Error('å¾Œç«¯éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤: ' + responseText);
    }
    
    if (response.ok && result.success) {
      // è¨˜éŒ„æ˜¯å¦åœ¨æ–°å¢æ¨¡å¼
      const wasInNewMode = isNewMode;
      const savedType = categoryValue;
      // è¨˜éŒ„ç›®å‰ç·¨è¼¯çš„è¨˜éŒ„ç·¨è™Ÿï¼ˆç”¨æ–¼ç·¨è¼¯æ¨¡å¼ï¼‰
      const savedRecordNumber = !wasInNewMode && filteredRecords.length > 0 && currentRecordIndex < filteredRecords.length 
        ? parseInt(filteredRecords[currentRecordIndex].row[0], 10) 
        : null;
      
      alert('è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼');
      
      // åœ¨é‡æ–°è¼‰å…¥å‰ï¼Œå…ˆè¨­å®š currentRecordNumberï¼ˆç”¨æ–¼ç·¨è¼¯æ¨¡å¼ï¼‰
      if (!wasInNewMode && savedRecordNumber !== null) {
        currentRecordNumber = savedRecordNumber;
      }
      
      // é‡æ–°è¼‰å…¥è¨˜éŒ„ï¼ˆé¿å…å¿«å–ï¼ŒåŠ å…¥çŸ­å»¶é²ï¼‰
      try {
        await new Promise(r => setTimeout(r, 200));
        await loadContent();
        
        // å¦‚æœå‰›æ‰åœ¨æ–°å¢æ¨¡å¼ï¼Œè‡ªå‹•é€²å…¥ä¸‹ä¸€å€‹æ–°å¢å¡ç‰‡
        if (wasInNewMode) {
          // ç¢ºä¿é¡å‹æ­£ç¢º
          if (categorySelect && categorySelect.value !== savedType) {
            categorySelect.value = savedType;
            categorySelectText.textContent = savedType;
            filterRecordsByType(savedType);
          }
          
          // ç­‰å¾…éæ¿¾å®Œæˆå¾Œï¼Œé€²å…¥æ–°å¢æ¨¡å¼
          setTimeout(() => {
            // è¨ˆç®—ä¸‹ä¸€å€‹ç·¨è™Ÿ
            let nextNumber = 1;
            if (filteredRecords.length > 0) {
              const maxNum = Math.max(
                ...filteredRecords
                  .map(r => parseInt(r.row[0], 10))
                  .filter(n => Number.isFinite(n) && n > 0)
              );
              if (Number.isFinite(maxNum) && maxNum > 0) {
                nextNumber = maxNum + 1;
              }
            }
            
            // é€²å…¥æ–°å¢æ¨¡å¼
            isNewMode = true;
            currentRecordIndex = filteredRecords.length > 0 ? filteredRecords.length - 1 : 0;
            updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
            
            // æ¸…ç©ºè¡¨å–®
            const itemInput = document.getElementById('item-input');
            const costInput = document.getElementById('cost-input');
            const noteInput = document.getElementById('note-input');
            if (itemInput) itemInput.value = '';
            if (costInput) costInput.value = '';
            if (noteInput) noteInput.value = '';
            
            // æ›´æ–°ç·¨è™Ÿé¡¯ç¤º
            if (typeof recordNumber !== 'undefined') {
              recordNumber.textContent = `#${String(nextNumber).padStart(3, '0')}`;
              currentRecordNumber = nextNumber;
            }
            
            // å¦‚æœæ˜¯æ”¯å‡ºï¼Œé‡ç½®é¡åˆ¥é¸æ“‡
            if (savedType === 'æ”¯å‡º') {
              const categorySelectElement = document.getElementById('category-select');
              if (categorySelectElement && categorySelectElement.options.length > 0) {
                categorySelectElement.value = categorySelectElement.options[0].value;
                const selectContainer = categorySelectElement.parentElement;
                if (selectContainer) {
                  const selectDisplay = selectContainer.querySelector('div');
                  if (selectDisplay) {
                    const selectText = selectDisplay.querySelector('div');
                    if (selectText) {
                      selectText.textContent = categorySelectElement.options[0].textContent;
                    }
                  }
                }
              }
            }
            
            updateArrowButtons();
          }, 100);
        } else {
          // å¦‚æœä¸æ˜¯æ–°å¢æ¨¡å¼ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰ï¼Œé‡æ–°é¡¯ç¤ºå‰›æ‰ç·¨è¼¯çš„è¨˜éŒ„
          if (savedRecordNumber !== null) {
            // ç­‰å¾…éæ¿¾å®Œæˆå¾Œï¼Œæ‰¾åˆ°å‰›æ‰ç·¨è¼¯çš„è¨˜éŒ„ä¸¦é¡¯ç¤º
            // ä½¿ç”¨è¼ƒé•·çš„å»¶é²ï¼Œç¢ºä¿ loadContent å’Œ filterRecordsByType å®Œæˆ
            setTimeout(() => {
              const recordIndex = filteredRecords.findIndex(r => {
                const num = parseInt(r.row[0], 10);
                return Number.isFinite(num) && num > 0 && num === savedRecordNumber;
              });
              
              if (recordIndex >= 0) {
                currentRecordIndex = recordIndex;
                showRecord(recordIndex);
                updateArrowButtons();
              } else {
                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†
                if (filteredRecords.length > 0) {
                  currentRecordIndex = 0;
                  showRecord(0);
                  updateArrowButtons();
                }
              }
            }, 300);
          } else {
            // å¦‚æœæ‰¾ä¸åˆ°è¨˜éŒ„ç·¨è™Ÿï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†
            setTimeout(() => {
              if (filteredRecords.length > 0) {
                currentRecordIndex = 0;
                showRecord(0);
                updateArrowButtons();
              }
            }, 100);
          }
        }
      } catch (e) {
        console.warn('é‡æ–°è¼‰å…¥è¨˜éŒ„å¤±æ•—:', e);
      }
      // ç¸½è¨ˆæ›´æ–°å®Œæˆå¾Œï¼Œæ‰é‚„åŸæŒ‰éˆ•ç‹€æ…‹
      saveButton.textContent = 'å„²å­˜';
      saveButton.disabled = false;
      saveButton.style.opacity = '1';
      saveButton.style.cursor = 'pointer';
      alreadyReset = true;
    } else {
      const errorMessage = result.message || result.error || 'æœªçŸ¥éŒ¯èª¤';
      console.error('å¾Œç«¯è¿”å›éŒ¯èª¤:', {
        success: result.success,
        message: errorMessage,
        fullResult: result
      });
      alert('å„²å­˜å¤±æ•—: ' + errorMessage);
      // å¤±æ•—æ™‚é‚„åŸæŒ‰éˆ•ç‹€æ…‹
      saveButton.textContent = 'å„²å­˜';
      saveButton.disabled = false;
      saveButton.style.opacity = '1';
      saveButton.style.cursor = 'pointer';
      alreadyReset = true;
    }
  } catch (error) {
    console.error('å„²å­˜å¤±æ•—:', error);
    console.error('éŒ¯èª¤è©³æƒ…:', {
      message: error.message,
      stack: error.stack,
      name: error.name
    });
    alert('å„²å­˜å¤±æ•—: ' + error.message);
    // ä¾‹å¤–æ™‚é‚„åŸæŒ‰éˆ•ç‹€æ…‹
    saveButton.textContent = 'å„²å­˜';
    saveButton.disabled = false;
    saveButton.style.opacity = '1';
    saveButton.style.cursor = 'pointer';
    alreadyReset = true;
  } finally {
    if (!alreadyReset) {
      saveButton.textContent = 'å„²å­˜';
      saveButton.disabled = false;
      saveButton.style.opacity = '1';
      saveButton.style.cursor = 'pointer';
    }
  }
};

const mobileStyle = document.createElement('style');
mobileStyle.textContent = `
  @media (max-width: 768px) {
    .total-container {
      height: auto !important;
      min-height: 235px !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      width: 100% !important;
    }
    .content-container {
      flex-direction: row !important;
      width: 100% !important;
    }
    .total-content-container {
      width: 50% !important;
      margin-bottom: 0 !important;
    }
    .pie-chart-container {
      width: 45% !important;
      height: 200px !important;
      margin: 0 0 0 10px !important;
    }
    .item-container {
      width: 100% !important;
      padding: 15px !important;
    }
    .item-container input {
      font-size: 24px !important;
      padding: 12px 15px !important;
    }
    .budget-cards-container {
      width: 100vw !important;
      margin-left: calc(-50vw + 50%) !important;
      margin-right: calc(-50vw + 50%) !important;
      margin-top: -20px !important;
      padding-left: 15px !important;
      padding-right: 15px !important;
      box-sizing: border-box !important;
      position: relative !important;
    }
    #record-number {
      font-size: 14px !important;
    }
    #record-date {
      font-size: 12px !important;
    }
    .total-amount-text {
      font-size: 18px !important;
    }
    .total-title-text {
      font-size: 16px !important;
    }
  }
`;
 

const totalContainer = document.createElement('div');
totalContainer.className = 'total-container';
totalContainer.style.position = 'relative';
totalContainer.style.top = '0';
totalContainer.style.left = '0';
totalContainer.style.backgroundColor = 'transparent';
totalContainer.style.borderRadius = '0';
totalContainer.style.boxShadow = 'none';
totalContainer.style.border = 'none';
totalContainer.style.overflow = 'visible';
totalContainer.style.display = 'relative';
totalContainer.style.flexDirection = 'column';
totalContainer.style.justifyContent = 'flex-start';
totalContainer.style.alignItems = 'stretch';

const budgetCardsContainer = document.createElement('div');
budgetCardsContainer.className = 'budget-cards-container';
budgetCardsContainer.style.position = 'relative';
budgetCardsContainer.style.width = '100%';
budgetCardsContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
budgetCardsContainer.style.borderRadius = '12px';
budgetCardsContainer.style.boxShadow = '0 8px 32px rgba(0,0,0,0.2)';
budgetCardsContainer.style.border = '1px solid rgba(255, 255, 255, 0.2)';
budgetCardsContainer.style.backdropFilter = 'blur(10px)';
budgetCardsContainer.style.overflow = 'auto';
budgetCardsContainer.style.zIndex = '999';
budgetCardsContainer.style.display = 'block';
budgetCardsContainer.style.padding = '20px 20px 20px 20px';
budgetCardsContainer.style.marginTop = '20px';

const headerInfo = document.createElement('div');
headerInfo.style.position = 'absolute';
headerInfo.style.top = '15px';
headerInfo.style.right = '50px';
headerInfo.style.display = 'flex';
headerInfo.style.flexDirection = 'column';
headerInfo.style.alignItems = 'flex-end';
headerInfo.style.gap = '4px';
headerInfo.style.zIndex = '1002';
headerInfo.style.pointerEvents = 'none';
headerInfo.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
headerInfo.style.padding = '6px 10px';
headerInfo.style.borderRadius = '6px';
headerInfo.style.backdropFilter = 'blur(5px)';

const recordNumber = document.createElement('div');
recordNumber.id = 'record-number';
recordNumber.textContent = '#001';
recordNumber.style.fontSize = '16px';
recordNumber.style.fontWeight = '600';
recordNumber.style.color = '#333';
recordNumber.style.letterSpacing = '0.5px';
recordNumber.style.lineHeight = '1.2';

const recordDate = document.createElement('div');
recordDate.id = 'record-date';
const updateDateTime = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  recordDate.textContent = `${year}/${month}/${day} ${hours}:${minutes}`;
};
updateDateTime();
setInterval(updateDateTime, 60000);
recordDate.style.fontSize = '13px';
recordDate.style.color = '#666';
recordDate.style.fontWeight = '400';
recordDate.style.lineHeight = '1.2';

headerInfo.appendChild(recordNumber);
headerInfo.appendChild(recordDate);

// åˆªé™¤æŒ‰éˆ•ï¼ˆåƒåœ¾æ¡¶ï¼‰
const deleteButton = document.createElement('button');
deleteButton.innerHTML = 'ğŸ—‘ï¸';
deleteButton.style.position = 'absolute';
deleteButton.style.top = '15px';
deleteButton.style.right = '10px';
deleteButton.style.zIndex = '1003';
deleteButton.style.width = '32px';
deleteButton.style.height = '32px';
deleteButton.style.border = 'none';
deleteButton.style.borderRadius = '6px';
deleteButton.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
deleteButton.style.color = '#dc3545';
deleteButton.style.fontSize = '16px';
deleteButton.style.cursor = 'pointer';
deleteButton.style.display = 'flex';
deleteButton.style.alignItems = 'center';
deleteButton.style.justifyContent = 'center';
deleteButton.style.transition = 'all 0.2s';
deleteButton.style.padding = '0';

deleteButton.addEventListener('mouseenter', function() {
  this.style.backgroundColor = 'rgba(220, 53, 69, 0.2)';
  this.style.transform = 'scale(1.1)';
});

deleteButton.addEventListener('mouseleave', function() {
  this.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
  this.style.transform = 'scale(1)';
});

// åˆªé™¤ç•¶å‰è¨˜éŒ„
deleteButton.addEventListener('click', async () => {
  // æ–°å¢æ¨¡å¼ä¸èƒ½åˆªé™¤
  if (isNewMode) {
    alert('ç„¡æ³•åˆªé™¤ï¼šç›®å‰ç‚ºæ–°å¢æ¨¡å¼');
    return;
  }
  
  // ç¢ºèªåˆªé™¤
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
    return;
  }
  
  if (!filteredRecords.length || currentRecordIndex >= filteredRecords.length) {
    alert('ç„¡æ³•åˆªé™¤ï¼šæ‰¾ä¸åˆ°ç›®å‰è¨˜éŒ„');
    return;
  }
  
  const currentRecord = filteredRecords[currentRecordIndex];
  const recordNum = parseInt(currentRecord.row[0], 10);
  const recordType = currentRecord.type;
  
  if (!Number.isFinite(recordNum) || recordNum <= 0) {
    alert('ç„¡æ³•åˆªé™¤ï¼šæ‰¾ä¸åˆ°è¨˜éŒ„ç·¨è™Ÿ');
    return;
  }
  
  // ç¢ºå®š rangeType (0=æ”¯å‡º, 1=æ”¶å…¥)
  const rangeType = recordType === 'æ”¯å‡º' ? 0 : 1;
  
  // ç¦ç”¨æŒ‰éˆ•
  deleteButton.disabled = true;
  deleteButton.style.opacity = '0.5';
  deleteButton.style.cursor = 'not-allowed';
  
  try {
    const postData = {
      name: "Delete Data",
      sheet: 2,
      range: rangeType,
      number: recordNum.toString() // ç¢ºä¿æ˜¯å­—ä¸²ï¼Œå› ç‚º Google Apps Script ç”¨å­—ä¸²æ¯”è¼ƒ
    };
    
    const response = await fetch(base, {
      method: "POST",
      redirect: "follow",
      keepalive: true,
      headers: {
        "Content-Type": "text/plain;charset=utf-8",
      },
      body: JSON.stringify(postData)
    });
    
    const responseText = await response.text();
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (e) {
      throw new Error('å¾Œç«¯éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤: ' + responseText);
    }
    
    if (response.ok && result.success) {
      alert('è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ï¼');
      
      // é‡æ–°è¼‰å…¥è¨˜éŒ„
      await new Promise(r => setTimeout(r, 200));
      await loadContent();
      
      // åˆªé™¤å¾Œï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†ï¼ˆå¦‚æœé‚„æœ‰è¨˜éŒ„ï¼‰
      setTimeout(() => {
        if (filteredRecords.length > 0) {
          currentRecordIndex = 0;
          showRecord(0);
          updateArrowButtons();
        } else {
          // æ²’æœ‰è¨˜éŒ„æ™‚ï¼Œé€²å…¥æ–°å¢æ¨¡å¼
          isNewMode = true;
          updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
          const itemInput = document.getElementById('item-input');
          const costInput = document.getElementById('cost-input');
          const noteInput = document.getElementById('note-input');
          if (itemInput) itemInput.value = '';
          if (costInput) costInput.value = '';
          if (noteInput) noteInput.value = '';
          if (typeof recordNumber !== 'undefined') {
            recordNumber.textContent = '#æ–°å¢';
          }
          updateArrowButtons();
        }
      }, 300);
    } else {
      const errorMessage = result.message || result.error || 'æœªçŸ¥éŒ¯èª¤';
      alert('åˆªé™¤å¤±æ•—: ' + errorMessage);
    }
  } catch (error) {
    console.error('åˆªé™¤å¤±æ•—:', error);
    alert('åˆªé™¤å¤±æ•—: ' + error.message);
  } finally {
    // é‚„åŸæŒ‰éˆ•ç‹€æ…‹
    deleteButton.disabled = false;
    deleteButton.style.opacity = '1';
    deleteButton.style.cursor = 'pointer';
  }
});

// æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
function updateDeleteButton() {
  // æ–°å¢æ¨¡å¼æ™‚éš±è—åˆªé™¤æŒ‰éˆ•
  if (isNewMode) {
    deleteButton.style.display = 'none';
  } else {
    deleteButton.style.display = 'flex';
  }
}

const leftArrow = document.createElement('button');
leftArrow.innerHTML = 'â€¹';
leftArrow.style.position = 'absolute';
leftArrow.style.left = '10px';
leftArrow.style.top = '50%';
leftArrow.style.transform = 'translateY(-50%)';
leftArrow.style.zIndex = '1001';
leftArrow.style.width = '30px';
leftArrow.style.height = '30px';
leftArrow.style.border = 'none';
leftArrow.style.borderRadius = '50%';
leftArrow.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
leftArrow.style.color = '#333';
leftArrow.style.fontSize = '18px';
leftArrow.style.cursor = 'pointer';
leftArrow.style.display = 'flex';
leftArrow.style.alignItems = 'center';
leftArrow.style.justifyContent = 'center';

const rightArrow = document.createElement('button');
rightArrow.innerHTML = 'â€º';
rightArrow.style.position = 'absolute';
rightArrow.style.right = '10px';
rightArrow.style.top = '50%';
rightArrow.style.transform = 'translateY(-50%)';
rightArrow.style.zIndex = '1001';
rightArrow.style.width = '30px';
rightArrow.style.height = '30px';
rightArrow.style.border = 'none';
rightArrow.style.borderRadius = '50%';
rightArrow.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
rightArrow.style.color = '#333';
rightArrow.style.fontSize = '18px';
rightArrow.style.cursor = 'pointer';
rightArrow.style.display = 'flex';
rightArrow.style.alignItems = 'center';
rightArrow.style.justifyContent = 'center';

// å·¦å³éµåˆ‡æ›æ‰€æœ‰è¨˜éŒ„
// æ›´æ–°ç®­é ­æŒ‰éˆ•ç‹€æ…‹
function updateArrowButtons() {
  if (!filteredRecords.length && !isNewMode) {
    leftArrow.style.display = 'none';
    rightArrow.style.display = 'none';
    return;
  }
  
  leftArrow.style.display = 'flex';
  rightArrow.style.display = 'flex';
  
  // å¦‚æœåœ¨æ–°å¢æ¨¡å¼æˆ–æœ€å¾Œä¸€ç­†ï¼Œå³ç®­é ­è®ŠæˆåŠ è™Ÿ
  if (isNewMode || currentRecordIndex === filteredRecords.length - 1) {
    rightArrow.innerHTML = '+';
    rightArrow.style.fontSize = '20px';
  } else {
    rightArrow.innerHTML = 'â€º';
    rightArrow.style.fontSize = '18px';
  }
}

leftArrow.addEventListener('click', () => {
  if (!filteredRecords.length) return;
  
  // å¦‚æœåœ¨æ–°å¢æ¨¡å¼ï¼Œå›åˆ°æœ€å¾Œä¸€ç­†è¨˜éŒ„
  if (isNewMode) {
    currentRecordIndex = filteredRecords.length - 1;
    showRecord(currentRecordIndex);
    updateArrowButtons();
  } else {
    currentRecordIndex = Math.max(0, currentRecordIndex - 1);
    showRecord(currentRecordIndex);
    updateArrowButtons();
  }
});

rightArrow.addEventListener('click', () => {
  if (!filteredRecords.length) return;
  
  // å¦‚æœåœ¨æœ€å¾Œä¸€ç­†æˆ–æ–°å¢æ¨¡å¼ï¼Œé»æ“ŠåŠ è™Ÿæ–°å¢è¨˜éŒ„
  if (currentRecordIndex === filteredRecords.length - 1 || isNewMode) {
    isNewMode = true; // é€²å…¥æ–°å¢æ¨¡å¼
    updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
    
    // æ¸…ç©ºè¡¨å–®ï¼Œæº–å‚™æ–°å¢
    const itemInput = document.getElementById('item-input');
    const costInput = document.getElementById('cost-input');
    const noteInput = document.getElementById('note-input');
    if (itemInput) itemInput.value = '';
    if (costInput) costInput.value = '';
    if (noteInput) noteInput.value = '';
    
    // è¨ˆç®—ä¸‹ä¸€å€‹ç·¨è™Ÿï¼ˆç›®å‰é¡å‹ä¸­æœ€å¤§çš„ç·¨è™Ÿ + 1ï¼‰
    let nextNumber = 1;
    if (filteredRecords.length > 0) {
      const maxNum = Math.max(
        ...filteredRecords
          .map(r => parseInt(r.row[0], 10))
          .filter(n => Number.isFinite(n) && n > 0)
      );
      if (Number.isFinite(maxNum) && maxNum > 0) {
        nextNumber = maxNum + 1;
      }
    }
    
    // æ›´æ–°ç·¨è™Ÿé¡¯ç¤ºç‚ºä¸‹ä¸€å€‹ç·¨è™Ÿï¼ˆä½†å°šæœªå¯«å›è©¦ç®—è¡¨ï¼‰
    if (typeof recordNumber !== 'undefined') {
      recordNumber.textContent = `#${String(nextNumber).padStart(3, '0')}`;
      currentRecordNumber = nextNumber; // è¨˜éŒ„æ–°å¢æ¨¡å¼çš„ç·¨è™Ÿ
    }
    
    updateArrowButtons();
  } else {
    currentRecordIndex = Math.min(filteredRecords.length - 1, currentRecordIndex + 1);
    showRecord(currentRecordIndex);
    updateArrowButtons();
  }
});

const div1 = document.createElement('div');
div1.style.display = 'flex';
div1.style.alignItems = 'center';
div1.style.justifyContent = 'center';
div1.style.padding = '8px';
div1.style.marginBottom = '8px';
div1.style.width = '100%';
div1.style.boxSizing = 'border-box';
div1.style.gap = '10px';

const categoryLabel = document.createElement('label');
categoryLabel.textContent = 'é¡åˆ¥ï¼š';
categoryLabel.style.fontSize = '14px';
categoryLabel.style.color = '#333';
categoryLabel.style.fontWeight = '500';
categoryLabel.style.whiteSpace = 'nowrap';

const categorySelectContainer = document.createElement('div');
categorySelectContainer.style.position = 'relative';
categorySelectContainer.style.flex = '1';
categorySelectContainer.style.minWidth = '200px';

const categorySelectDisplay = document.createElement('div');
categorySelectDisplay.style.padding = '6px 10px';
categorySelectDisplay.style.border = '1px solid #ddd';
categorySelectDisplay.style.borderRadius = '6px';
categorySelectDisplay.style.fontSize = '14px';
categorySelectDisplay.style.backgroundColor = '#fff';
categorySelectDisplay.style.cursor = 'pointer';
categorySelectDisplay.style.minHeight = '20px';
categorySelectDisplay.style.display = 'flex';
categorySelectDisplay.style.alignItems = 'center';
categorySelectDisplay.style.justifyContent = 'space-between';
categorySelectDisplay.style.gap = '8px';

const categorySelectText = document.createElement('div');
categorySelectText.style.flex = '1';
categorySelectText.style.wordBreak = 'break-word';
categorySelectText.style.whiteSpace = 'normal';
categorySelectText.style.minWidth = '0';
categorySelectText.textContent = 'æ”¯å‡º';

const categorySelectArrow = document.createElement('div');
categorySelectArrow.textContent = 'â–¼';
categorySelectArrow.style.fontSize = '10px';
categorySelectArrow.style.color = '#666';
categorySelectArrow.style.transition = 'transform 0.2s';
categorySelectArrow.style.flexShrink = '0';
categorySelectArrow.style.lineHeight = '1';

categorySelectDisplay.appendChild(categorySelectText);
categorySelectDisplay.appendChild(categorySelectArrow);

const categorySelect = document.createElement('select');
categorySelect.style.display = 'none';
categorySelect.value = 'æ”¯å‡º';
const optionExpense = document.createElement('option');
optionExpense.value = 'æ”¯å‡º';
optionExpense.textContent = 'æ”¯å‡º';
const optionIncome = document.createElement('option');
optionIncome.value = 'æ”¶å…¥';
optionIncome.textContent = 'æ”¶å…¥';
categorySelect.appendChild(optionExpense);
categorySelect.appendChild(optionIncome);

const categoryDropdown = document.createElement('div');
categoryDropdown.style.display = 'none';
categoryDropdown.style.position = 'absolute';
categoryDropdown.style.top = '100%';
categoryDropdown.style.left = '0';
categoryDropdown.style.right = '0';
categoryDropdown.style.backgroundColor = '#fff';
categoryDropdown.style.border = '1px solid #ddd';
categoryDropdown.style.borderRadius = '6px';
categoryDropdown.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
categoryDropdown.style.zIndex = '1000';
categoryDropdown.style.maxHeight = '200px';
categoryDropdown.style.overflowY = 'auto';
categoryDropdown.style.marginTop = '4px';

const categoryOption1 = document.createElement('div');
categoryOption1.style.padding = '8px 10px';
categoryOption1.style.cursor = 'pointer';
categoryOption1.style.fontSize = '14px';
categoryOption1.style.wordBreak = 'break-word';
categoryOption1.style.whiteSpace = 'normal';
categoryOption1.style.borderBottom = '1px solid #f0f0f0';
categoryOption1.textContent = 'æ”¯å‡º';
categoryOption1.dataset.value = 'æ”¯å‡º';

categoryOption1.addEventListener('mouseenter', function() {
  this.style.backgroundColor = '#f5f5f5';
});
categoryOption1.addEventListener('mouseleave', function() {
  this.style.backgroundColor = '#fff';
});
categoryOption1.addEventListener('click', function() {
  categorySelectText.textContent = 'æ”¯å‡º';
  categorySelect.value = 'æ”¯å‡º';
  categoryDropdown.style.display = 'none';
  categorySelectArrow.style.transform = 'rotate(0deg)';
  categorySelect.dispatchEvent(new Event('change'));
});

const categoryOption2 = document.createElement('div');
categoryOption2.style.padding = '8px 10px';
categoryOption2.style.cursor = 'pointer';
categoryOption2.style.fontSize = '14px';
categoryOption2.style.wordBreak = 'break-word';
categoryOption2.style.whiteSpace = 'normal';
categoryOption2.textContent = 'æ”¶å…¥';
categoryOption2.dataset.value = 'æ”¶å…¥';

categoryOption2.addEventListener('mouseenter', function() {
  this.style.backgroundColor = '#f5f5f5';
});
categoryOption2.addEventListener('mouseleave', function() {
  this.style.backgroundColor = '#fff';
});
categoryOption2.addEventListener('click', function() {
  categorySelectText.textContent = 'æ”¶å…¥';
  categorySelect.value = 'æ”¶å…¥';
  categoryDropdown.style.display = 'none';
  categorySelectArrow.style.transform = 'rotate(0deg)';
  categorySelect.dispatchEvent(new Event('change'));
});

categoryDropdown.appendChild(categoryOption1);
categoryDropdown.appendChild(categoryOption2);

categorySelectDisplay.addEventListener('click', function(e) {
  e.stopPropagation();
  const isOpen = categoryDropdown.style.display === 'block';
  categoryDropdown.style.display = isOpen ? 'none' : 'block';
  categorySelectArrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
});

document.addEventListener('click', function(e) {
  if (!categorySelectContainer.contains(e.target)) {
    categoryDropdown.style.display = 'none';
    categorySelectArrow.style.transform = 'rotate(0deg)';
  }
});

categorySelectContainer.appendChild(categorySelectDisplay);
categorySelectContainer.appendChild(categoryDropdown);
categorySelectContainer.appendChild(categorySelect);

const itemContainer = document.createElement('div');
itemContainer.className = 'item-container';
itemContainer.style.width = '100%';
itemContainer.style.padding = '20px';
itemContainer.style.marginBottom = '0px';
itemContainer.style.display = 'flex';
itemContainer.style.flexDirection = 'column';
itemContainer.style.alignItems = 'stretch';

const itemTitleInput = document.createElement('input');
itemTitleInput.id = 'item-input';
itemTitleInput.type = 'text';
itemTitleInput.placeholder = 'è¼¸å…¥é …ç›®åç¨±...';
itemTitleInput.style.width = '100%';
itemTitleInput.style.padding = '15px 20px';
itemTitleInput.style.border = 'none';
itemTitleInput.style.borderRadius = '0';
itemTitleInput.style.fontSize = '32px';
itemTitleInput.style.fontWeight = '700';
itemTitleInput.style.color = '#1a1a1a';
itemTitleInput.style.backgroundColor = 'transparent';
itemTitleInput.style.outline = 'none';
itemTitleInput.style.boxSizing = 'border-box';
itemTitleInput.style.borderBottom = '3px solid #e0e0e0';
itemTitleInput.style.transition = 'all 0.3s ease';
itemTitleInput.style.letterSpacing = '-0.5px';
itemTitleInput.style.lineHeight = '1.2';

itemTitleInput.addEventListener('focus', function() {
  this.style.borderBottomColor = '#4CAF50';
  this.style.borderBottomWidth = '4px';
});

itemTitleInput.addEventListener('blur', function() {
  this.style.borderBottomColor = '#e0e0e0';
  this.style.borderBottomWidth = '3px';
});


itemContainer.appendChild(itemTitleInput);

const div2 = document.createElement('div');
div2.style.display = 'none';
const div3 = document.createElement('div');
div3.style.display = 'none';
const div4 = document.createElement('div');
div4.style.display = 'none';

const saveButton = document.createElement('button');
saveButton.textContent = 'å„²å­˜';
saveButton.style.padding = '10px 20px';
saveButton.style.margin = '5px auto 0 auto';
saveButton.style.display = 'block';
saveButton.style.backgroundColor = '#4CAF50';
saveButton.style.color = '#fff';
saveButton.style.border = 'none';
saveButton.style.borderRadius = '6px';
saveButton.style.fontSize = '16px';
saveButton.style.cursor = 'pointer';
saveButton.style.fontWeight = '500';
saveButton.style.minWidth = '120px';

const columnsContainer = document.createElement('div');
columnsContainer.style.display = 'flex';
columnsContainer.style.flexDirection = 'column';
columnsContainer.style.gap = '20px';
columnsContainer.style.width = '100%';

const incomeColumn = document.createElement('div');
incomeColumn.style.display = 'flex';
incomeColumn.style.alignItems = 'center';
incomeColumn.style.gap = '15px';

const incomeTitle = document.createElement('h3');
incomeTitle.textContent = 'æ”¶å…¥ï¼š';
incomeTitle.style.margin = '0';
incomeTitle.style.color = '#1976d2';
incomeTitle.style.fontSize = '18px';
incomeTitle.style.transform = 'translate(0px, 20px)';
incomeTitle.style.fontSize = '20px';

const incomeAmount = document.createElement('div');
incomeAmount.textContent = 0;
incomeAmount.style.fontSize = '24px';
incomeAmount.style.fontWeight = 'bold';
incomeAmount.style.color = '#1976d2';
incomeAmount.style.transform = 'translate(0px, 20px)';
incomeAmount.style.fontSize = '24px';

const expenseColumn = document.createElement('div');
expenseColumn.style.display = 'flex';
expenseColumn.style.alignItems = 'center';
expenseColumn.style.gap = '15px';

const expenseTitle = document.createElement('h3');
expenseTitle.textContent = 'æ”¯å‡ºï¼š';
expenseTitle.style.margin = '0';
expenseTitle.style.color = '#1976d2';
expenseTitle.style.fontSize = '18px';
expenseTitle.style.transform = 'translate(0px, 20px)';
expenseTitle.style.fontSize = '20px';

const expenseAmount = document.createElement('div');
expenseAmount.textContent = 0;
expenseAmount.style.fontSize = '24px';
expenseAmount.style.fontWeight = 'bold';
expenseAmount.style.color = '#1976d2';
expenseAmount.style.transform = 'translate(0px, 20px)';
expenseAmount.style.fontSize = '24px';

const totalColumn = document.createElement('div');
totalColumn.style.display = 'flex';
totalColumn.style.alignItems = 'center';
totalColumn.style.gap = '15px';

const totalTitle = document.createElement('h3');
totalTitle.textContent = 'ç¸½è¨ˆï¼š';
totalTitle.style.margin = '0';
totalTitle.style.color = '#1976d2';
totalTitle.style.fontSize = '18px';
totalTitle.style.transform = 'translate(0px, 20px)';
totalTitle.style.fontSize = '20px';

const totalAmount = document.createElement('div');
totalAmount.textContent = 0;
totalAmount.style.fontSize = '24px';
totalAmount.style.fontWeight = 'bold';
totalAmount.style.color = '#1976d2';
totalAmount.style.transform = 'translate(0px, 20px)';
totalAmount.style.fontSize = '24px';

const updateTotalColor = (value) => {
  const numValue = parseFloat(value) || 0;
  if (numValue > 0) {
    totalAmount.style.color = '#2e7d32'; // ç¶ è‰²
    totalTitle.style.color = '#2e7d32'; // ç¶ è‰²
  } else if (numValue < 0) {
    totalAmount.style.color = '#d32f2f'; // ç´…è‰²
    totalTitle.style.color = '#d32f2f'; // ç´…è‰²
  } else {
    totalAmount.style.color = '#1976d2'; // è—è‰²ï¼ˆé›¶å€¼ï¼‰
    totalTitle.style.color = '#1976d2'; // è—è‰²ï¼ˆé›¶å€¼ï¼‰
  }
};

const pieChartContainer = document.createElement('div');
pieChartContainer.className = 'pie-chart-container';
pieChartContainer.style.width = '100%';
pieChartContainer.style.height = '100%';
pieChartContainer.style.minHeight = '200px';
pieChartContainer.style.margin = '20px 0';
pieChartContainer.style.display = 'flex';
pieChartContainer.style.justifyContent = 'center';
pieChartContainer.style.alignItems = 'center';
pieChartContainer.style.backgroundColor = 'rgba(248, 249, 250, 0.8)';
pieChartContainer.style.borderRadius = '12px';
pieChartContainer.style.border = '3px solid #007bff';

const pieChartPlaceholder = document.createElement('div');
pieChartPlaceholder.textContent = 'åœ“é¤…åœ–å€åŸŸ';
pieChartPlaceholder.style.color = '#6c757d';
pieChartPlaceholder.style.fontSize = '18px';
pieChartPlaceholder.style.fontWeight = '500';
 

const contentContainer = document.createElement('div');
contentContainer.className = 'content-container';
contentContainer.style.display = 'flex';
contentContainer.style.flexDirection = 'row';
contentContainer.style.justifyContent = 'space-between';
contentContainer.style.alignItems = 'flex-start';
contentContainer.style.width = '100%';

const totalContentContainer = document.createElement('div');
totalContentContainer.className = 'total-content-container';
totalContentContainer.style.width = '45%';
totalContentContainer.style.display = 'flex';
totalContentContainer.style.flexDirection = 'column';
totalContentContainer.style.justifyContent = 'center';
totalContentContainer.style.alignItems = 'center';
totalContentContainer.style.paddingLeft = '0px';
totalContentContainer.style.paddingTop = '0px';

pieChartContainer.style.width = '50%';
pieChartContainer.style.height = 'auto';
pieChartContainer.style.margin = '0';
pieChartContainer.style.display = 'flex';
pieChartContainer.style.justifyContent = 'center';
pieChartContainer.style.alignItems = 'center';

const submitContainer = document.createElement('div');
submitContainer.style.width = '100%';
submitContainer.style.display = 'flex';
submitContainer.style.justifyContent = 'center';
submitContainer.style.padding = '0';

document.head.appendChild(mobileStyle);

totalContainer.appendChild(contentContainer);
  contentContainer.appendChild(totalContentContainer);
    totalContentContainer.appendChild(columnsContainer);
      columnsContainer.appendChild(incomeColumn);
        incomeColumn.appendChild(incomeTitle);
        incomeColumn.appendChild(incomeAmount);
      columnsContainer.appendChild(expenseColumn);
        expenseColumn.appendChild(expenseTitle);
        expenseColumn.appendChild(expenseAmount);
      columnsContainer.appendChild(totalColumn);
        totalColumn.appendChild(totalTitle);
        totalColumn.appendChild(totalAmount);
  contentContainer.appendChild(pieChartContainer);
    pieChartContainer.appendChild(pieChartPlaceholder);
budgetCardsContainer.appendChild(headerInfo);
budgetCardsContainer.appendChild(deleteButton);
budgetCardsContainer.appendChild(leftArrow);
budgetCardsContainer.appendChild(rightArrow);
budgetCardsContainer.appendChild(itemContainer);
budgetCardsContainer.appendChild(div1);
  div1.appendChild(categoryLabel);
  div1.appendChild(categorySelectContainer);
budgetCardsContainer.appendChild(div2);
budgetCardsContainer.appendChild(div3);
budgetCardsContainer.appendChild(div4);
budgetCardsContainer.appendChild(submitContainer);
  submitContainer.appendChild(saveButton);

categorySelect.addEventListener('change', () => {
  updateDivVisibility();
  if (allRecords.length > 0) {
    filterRecordsByType(categorySelect.value);
  }
});
updateDivVisibility();
saveButton.addEventListener('click', saveData);
saveButton.addEventListener('click', loadTotal);

document.addEventListener('DOMContentLoaded', async function() {
  document.getElementsByClassName('post-content')[0].appendChild(totalContainer);
  document.getElementsByClassName('post-content')[0].appendChild(budgetCardsContainer);

  showSpinner();
  
  try {
    await loadContent();
    updateDeleteButton(); // åˆå§‹åŒ–åˆªé™¤æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
  } catch (error) {
    console.error('è¼‰å…¥å¤±æ•—:', error);
    const errorContainer = document.createElement('div');
    errorContainer.innerHTML = 'è¼‰å…¥å¤±æ•—: ' + error.message;
    errorContainer.style.color = 'red';
    errorContainer.style.marginTop = '20px';
    document.getElementsByClassName('post-content')[0].appendChild(errorContainer);
  } finally {
    hideSpinner();
  }
});


// createBtn.addEventListener('click', function() {
//   const modal = document.createElement('div');
//   modal.style.position = 'fixed';
//   modal.style.top = '0';
//   modal.style.left = '0';
//   modal.style.width = '100%';
//   modal.style.height = '100%';
//   modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
//   modal.style.zIndex = '2000';
//   modal.style.display = 'flex';
//   modal.style.justifyContent = 'center';
//   modal.style.alignItems = 'center';

//   const formContainer = document.createElement('div');
//   formContainer.style.backgroundColor = 'white';
//   formContainer.style.padding = '30px';
//   formContainer.style.borderRadius = '10px';
//   formContainer.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
//   formContainer.style.width = '400px';
//   formContainer.style.maxWidth = '90vw';

//   const title = document.createElement('h2');
//   title.textContent = 'Add Data';
//   title.style.marginTop = '0';
//   title.style.marginBottom = '20px';
//   title.style.textAlign = 'center';
//   title.style.color = '#333';

//   const form = document.createElement('form');
  
//   const fields = [
//     { name: 'sheet', label: 'Sheet', type: 'text', placeholder: 'è«‹è¼¸å…¥åç¨±' },
//     { name: 'range', label: 'Range', type: 'text', placeholder: 'è«‹è¼¸å…¥ç¯„åœ' },
//     { name: 'category', label: 'Category', type: 'text', placeholder: 'è«‹è¼¸å…¥é¡åˆ¥' },
//     { name: 'item', label: 'Item', type: 'text', placeholder: 'è«‹è¼¸å…¥é …ç›®åç¨±' },
//     { name: 'cost', label: 'Cost', type: 'number', placeholder: 'è«‹è¼¸å…¥é‡‘é¡' },
//     { name: 'note', label: 'Note', type: 'text', placeholder: 'è«‹è¼¸å…¥å‚™è¨»' }
//   ];

//   fields.forEach(field => {
//     const fieldContainer = document.createElement('div');
//     fieldContainer.style.marginBottom = '15px';

//     const label = document.createElement('label');
//     label.textContent = field.label + ':';
//     label.style.display = 'block';
//     label.style.marginBottom = '5px';
//     label.style.fontWeight = 'bold';
//     label.style.color = '#555';

//     const input = document.createElement('input');
//     input.type = field.type;
//     input.name = field.name;
//     input.placeholder = field.placeholder;
//     input.style.width = '100%';
//     input.style.padding = '8px';
//     input.style.border = '1px solid #ddd';
//     input.style.borderRadius = '4px';
//     input.style.fontSize = '14px';
//     input.required = true;

//     fieldContainer.appendChild(label);
//     fieldContainer.appendChild(input);
//     form.appendChild(fieldContainer);
//   });

//   const buttonGroup = document.createElement('div');
//   buttonGroup.style.display = 'flex';
//   buttonGroup.style.justifyContent = 'space-between';
//   buttonGroup.style.marginTop = '20px';

//   const submitBtn = document.createElement('button');
//   submitBtn.type = 'submit';
//   submitBtn.textContent = 'æäº¤';
//   submitBtn.style.padding = '10px 20px';
//   submitBtn.style.backgroundColor = '#4CAF50';
//   submitBtn.style.color = 'white';
//   submitBtn.style.border = 'none';
//   submitBtn.style.borderRadius = '4px';
//   submitBtn.style.cursor = 'pointer';
//   submitBtn.style.fontSize = '14px';

//   const cancelBtn = document.createElement('button');
//   cancelBtn.type = 'button';
//   cancelBtn.textContent = 'å–æ¶ˆ';
//   cancelBtn.style.padding = '10px 20px';
//   cancelBtn.style.backgroundColor = '#f44336';
//   cancelBtn.style.color = 'white';
//   cancelBtn.style.border = 'none';
//   cancelBtn.style.borderRadius = '4px';
//   cancelBtn.style.cursor = 'pointer';
//   cancelBtn.style.fontSize = '14px';

//   buttonGroup.appendChild(submitBtn);
//   buttonGroup.appendChild(cancelBtn);

//   form.appendChild(buttonGroup);
//   formContainer.appendChild(title);
//   formContainer.appendChild(form);
//   modal.appendChild(formContainer);
//   document.getElementsByClassName('post-content')[0].appendChild(modal);

//     form.addEventListener('submit', async function(e) {
//       e.preventDefault();
      
//       const formData = new FormData(form);
//       const data = {};
//       for (let [key, value] of formData.entries()) {
//         data[key] = value;
//       }
      
//       const postData = {
//         name: "Add Data",
//         sheet: parseInt(data.sheet) || 2,
//         range: parseInt(data.range) || 0,
//         category: data.category || '',
//         item: data.item || '',
//         cost: parseFloat(data.cost) || 0,
//         note: data.note || ''
//       };
      
//       submitBtn.textContent = 'æäº¤ä¸­...';
//       submitBtn.disabled = true;
      
//       try {
//         const response = await fetch(base, {
//           method: "POST",
//           redirect: "follow",
//           keepalive: true,
//           headers: {
//             "Content-Type": "text/plain;charset=utf-8",
//           },
//           body: JSON.stringify(postData)
//         });
        
//         if (response.ok) {
//           const result = await response.json();
//         } catch (error) {
//     });

//   cancelBtn.addEventListener('click', function() {
//     document.getElementsByClassName('post-content')[0].removeChild(modal);
//   });

//   modal.addEventListener('click', function(e) {
//     if (e.target === modal) {
//       document.getElementsByClassName('post-content')[0].removeChild(modal);
//     }
//   });
// });

// deleteBtn.addEventListener('click', function() {
//   const modal = document.createElement('div');
//   modal.style.position = 'fixed';
//   modal.style.top = '0';
//   modal.style.left = '0';
//   modal.style.width = '100%';
//   modal.style.height = '100%';
//   modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
//   modal.style.zIndex = '2000';
//   modal.style.display = 'flex';
//   modal.style.justifyContent = 'center';
//   modal.style.alignItems = 'center';

//   const formContainer = document.createElement('div');
//   formContainer.style.backgroundColor = 'white';
//   formContainer.style.padding = '30px';
//   formContainer.style.borderRadius = '10px';
//   formContainer.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
//   formContainer.style.width = '400px';
//   formContainer.style.maxWidth = '90vw';

//   const title = document.createElement('h2');
//   title.textContent = 'åˆªé™¤è³‡æ–™';
//   title.style.marginTop = '0';
//   title.style.marginBottom = '20px';
//   title.style.textAlign = 'center';
//   title.style.color = '#333';

//   const form = document.createElement('form');
  
//   const fields = [
//     { name: 'sheet', label: 'Sheet', type: 'text', placeholder: 'è«‹è¼¸å…¥åç¨±' },
//     { name: 'range', label: 'Range', type: 'text', placeholder: 'è«‹è¼¸å…¥ç¯„åœ' },
//     { name: 'category', label: 'Category', type: 'text', placeholder: 'è«‹è¼¸å…¥é¡åˆ¥' },
//     { name: 'item', label: 'Item', type: 'text', placeholder: 'è«‹è¼¸å…¥é …ç›®åç¨±' },
//     { name: 'cost', label: 'Cost', type: 'number', placeholder: 'è«‹è¼¸å…¥é‡‘é¡' },
//     { name: 'note', label: 'Note', type: 'text', placeholder: 'è«‹è¼¸å…¥å‚™è¨»' }
//   ];

//   fields.forEach(field => {
//     const fieldContainer = document.createElement('div');
//     fieldContainer.style.marginBottom = '15px';

//     const label = document.createElement('label');
//     label.textContent = field.label + ':';
//     label.style.display = 'block';
//     label.style.marginBottom = '5px';
//     label.style.fontWeight = 'bold';
//     label.style.color = '#555';

//     const input = document.createElement('input');
//     input.type = field.type;
//     input.name = field.name;
//     input.placeholder = field.placeholder;
//     input.style.width = '100%';
//     input.style.padding = '8px';
//     input.style.border = '1px solid #ddd';
//     input.style.borderRadius = '4px';
//     input.style.fontSize = '14px';
//     input.required = true;

//     fieldContainer.appendChild(label);
//     fieldContainer.appendChild(input);
//     form.appendChild(fieldContainer);
//   });

//   const buttonGroup = document.createElement('div');
//   buttonGroup.style.display = 'flex';
//   buttonGroup.style.justifyContent = 'space-between';
//   buttonGroup.style.marginTop = '20px';

//   const submitBtn = document.createElement('button');
//   submitBtn.type = 'submit';
//   submitBtn.textContent = 'æäº¤';
//   submitBtn.style.padding = '10px 20px';
//   submitBtn.style.backgroundColor = '#4CAF50';
//   submitBtn.style.color = 'white';
//   submitBtn.style.border = 'none';
//   submitBtn.style.borderRadius = '4px';
//   submitBtn.style.cursor = 'pointer';
//   submitBtn.style.fontSize = '14px';

//   const cancelBtn = document.createElement('button');
//   cancelBtn.type = 'button';
//   cancelBtn.textContent = 'å–æ¶ˆ';
//   cancelBtn.style.padding = '10px 20px';
//   cancelBtn.style.backgroundColor = '#f44336';
//   cancelBtn.style.color = 'white';
//   cancelBtn.style.border = 'none';
//   cancelBtn.style.borderRadius = '4px';
//   cancelBtn.style.cursor = 'pointer';
//   cancelBtn.style.fontSize = '14px';

//   buttonGroup.appendChild(submitBtn);
//   buttonGroup.appendChild(cancelBtn);

//   form.appendChild(buttonGroup);
//   formContainer.appendChild(title);
//   formContainer.appendChild(form);
//   modal.appendChild(formContainer);
//   document.getElementsByClassName('post-content')[0].appendChild(modal);

//     form.addEventListener('submit', async function(e) {
//       e.preventDefault();
      
//       const formData = new FormData(form);
//       const data = {};
//       for (let [key, value] of formData.entries()) {
//         data[key] = value;
//       }
      
//       const postData = {
//         name: "Delete Data",
//         sheet: parseInt(data.sheet) || 2,
//         range: parseInt(data.range) || 0,
//         category: data.category || '',
//         item: data.item || '',
//         cost: parseFloat(data.cost) || 0,
//         note: data.note || ''
//       };
      
//       submitBtn.textContent = 'æäº¤ä¸­...';
//       submitBtn.disabled = true;
      
//       try {
//         const response = await fetch(base, {
//           method: "POST",
//           redirect: "follow",
//           keepalive: true,
//           headers: {
//             "Content-Type": "text/plain;charset=utf-8",
//           },
//           body: JSON.stringify(postData)
//         });
        
//         if (response.ok) {
//           const result = await response.json();
//         } catch (error) {
//       }
//     });

//   cancelBtn.addEventListener('click', function() {
//     document.getElementsByClassName('post-content')[0].removeChild(modal);
//   });

//   modal.addEventListener('click', function(e) {
//     if (e.target === modal) {
//       document.getElementsByClassName('post-content')[0].removeChild(modal);
//     }
//   });
// });

</script>