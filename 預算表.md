---
layout: page
title: é ç®—è¡¨
permalink: /budget_table/
---

<link rel="stylesheet" href="{{ '/assets/budget-table.css' | relative_url }}">

<script>

// æ–°ç‰ˆé ç®—ï¼æ”¯å‡º APIï¼ˆèˆ‡æ”¯å‡ºé ä¸€è‡´ï¼‰
const base = "https://script.google.com/macros/s/AKfycby8s1gyATpTHzd3ZQl0QgQjaPYaHmuxWg-IQbD7-EFamqObcGcCdzucgnQmnB_1T7Rx/exec";

// ===== å…¨åŸŸç‹€æ…‹è®Šæ•¸ =====
let currentSheetIndex = 2; // ç›®å‰é¸æ“‡çš„è©¦ç®—è¡¨åˆ†é ç´¢å¼•ï¼ˆ2 ä»£è¡¨ç¬¬ä¸‰å€‹åˆ†é ï¼‰
let sheetNames = []; // æ‰€æœ‰æœˆä»½åˆ†é åç¨±ï¼ˆä¸å«å‰å…©å€‹ã€Œç©ºç™½è¡¨ã€ã€ã€Œä¸‹æ‹‰é¸å–®ã€ï¼‰
let allMonthsData = {}; // é å…ˆè¼‰å…¥çš„æ‰€æœ‰æœˆä»½è³‡æ–™ï¼ˆkey: sheetIndex, value: { data, total }ï¼‰
let allRecords = []; // ç›®å‰é¸æ“‡æœˆä»½çš„è¨˜éŒ„ï¼ˆæ”¶å…¥ + æ”¯å‡ºï¼‰
let filteredRecords = []; // ç›®å‰é¡å‹éæ¿¾å¾Œçš„è¨˜éŒ„
let currentRecordIndex = 0;
let isNewMode = false; // æ˜¯å¦åœ¨æ–°å¢æ¨¡å¼
let currentRecordNumber = null; // ç›®å‰é¡¯ç¤ºçš„è¨˜éŒ„ç·¨è™Ÿ
let isSwitchingMonth = false; // é˜²æ­¢å¿«é€Ÿé€£çºŒåˆ‡æ›æœˆä»½
let monthSelectChangeHandler = null; // å„²å­˜æœˆä»½é¸æ“‡äº‹ä»¶è™•ç†å™¨ï¼Œç”¨æ–¼ç§»é™¤
let currentAbortController = null; // ç”¨æ–¼å–æ¶ˆæ­£åœ¨é€²è¡Œçš„è«‹æ±‚

// ===== ä¸‹æ‹‰é¸å–®é¸é …ï¼ˆå¾ã€Œä¸‹æ‹‰é¸å–®ã€sheet=1 è¼‰å…¥ï¼‰=====
let EXPENSE_CATEGORY_OPTIONS = [
  { value: 'ç”Ÿæ´»èŠ±è²»ï¼šé£Ÿ', text: 'ç”Ÿæ´»èŠ±è²»ï¼šé£Ÿ' },
  { value: 'ç”Ÿæ´»èŠ±è²»ï¼šè¡£èˆ‡å¤–è²Œ', text: 'ç”Ÿæ´»èŠ±è²»ï¼šè¡£èˆ‡å¤–è²Œ' },
  { value: 'ç”Ÿæ´»èŠ±è²»ï¼šä½ã€å±…å®¶è£ä¿®ã€è¡›ç”Ÿç”¨å“ã€æ¬¡æœˆç¹³ç´å¸³å–®', text: 'ç”Ÿæ´»èŠ±è²»ï¼šä½ã€å±…å®¶è£ä¿®ã€è¡›ç”Ÿç”¨å“ã€æ¬¡æœˆç¹³ç´å¸³å–®' },
  { value: 'ç”Ÿæ´»èŠ±è²»ï¼šè¡Œ', text: 'ç”Ÿæ´»èŠ±è²»ï¼šè¡Œ' },
  { value: 'ç”Ÿæ´»èŠ±è²»ï¼šè‚²', text: 'ç”Ÿæ´»èŠ±è²»ï¼šè‚²' },
  { value: 'ç”Ÿæ´»èŠ±è²»ï¼šæ¨‚', text: 'ç”Ÿæ´»èŠ±è²»ï¼šæ¨‚' },
  { value: 'ç”Ÿæ´»èŠ±è²»ï¼šå¥ï¼ˆé†«ç™‚ï¼‰', text: 'ç”Ÿæ´»èŠ±è²»ï¼šå¥ï¼ˆé†«ç™‚ï¼‰' },
  { value: 'ç”Ÿæ´»èŠ±è²»ï¼šå¸³å–®', text: 'ç”Ÿæ´»èŠ±è²»ï¼šå¸³å–®' },
  { value: 'å„²è“„ï¼šé€€ä¼‘é‡‘ã€é†«ç™‚é å‚™é‡‘ã€éå¹´ç´…åŒ…æ”¯å‡º', text: 'å„²è“„ï¼šé€€ä¼‘é‡‘ã€é†«ç™‚é å‚™é‡‘ã€éå¹´ç´…åŒ…æ”¯å‡º' },
  { value: 'å®¶äººï¼šéå¹´ç´…åŒ…ã€ç´€å¿µæ—¥', text: 'å®¶äººï¼šéå¹´ç´…åŒ…ã€ç´€å¿µæ—¥' }
];

// å¾ã€Œä¸‹æ‹‰é¸å–®ã€sheet=1 è¼‰å…¥æœ€æ–°é¸é …
// æ³¨æ„ï¼šä¸‹æ‹‰é¸å–®è³‡æ–™åœ¨æ”¯å‡ºè¡¨çš„ Google Sheet ä¸­ï¼Œæ‰€ä»¥ä½¿ç”¨åŒä¸€å€‹æ–°ç‰ˆ URL
const baseExpenseForDropdown = "https://script.google.com/macros/s/AKfycby8s1gyATpTHzd3ZQl0QgQjaPYaHmuxWg-IQbD7-EFamqObcGcCdzucgnQmnB_1T7Rx/exec";

async function loadDropdownOptions() {
  try {
    const params = { name: "Show Tab Data", sheet: 1, _t: Date.now() };
    const url = `${baseExpenseForDropdown}?${new URLSearchParams(params)}`;
    const res = await fetch(url, {
      method: "GET",
      redirect: "follow",
      mode: "cors",
      cache: "no-store"
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const responseData = await res.json();
    // è™•ç†ä¸åŒçš„è³‡æ–™æ ¼å¼
    let data = null;
    
    // å¦‚æœæ˜¯é™£åˆ—ï¼Œç›´æ¥ä½¿ç”¨
    if (Array.isArray(responseData)) {
      data = responseData;
    } 
    // å¦‚æœæ˜¯ç‰©ä»¶ï¼Œå¯èƒ½æ˜¯å‘½åç¯„åœçš„æ ¼å¼ï¼Œå˜—è©¦æ‰¾åˆ°ç¬¬ä¸€å€‹é™£åˆ—å€¼
    else if (typeof responseData === 'object' && responseData !== null) {
      // å°‹æ‰¾ç¬¬ä¸€å€‹å€¼æ˜¯é™£åˆ—çš„éµ
      for (const key in responseData) {
        if (Array.isArray(responseData[key]) && responseData[key].length > 0) {
          data = responseData[key];
          break;
        }
      }
    }
    
    if (!data || !Array.isArray(data) || data.length === 0) {
      return;
    }

    const headerRow = data[0];
    // æ‰¾å°æ‡‰æ¬„ä½ï¼ˆé ç®—è¡¨ä½¿ç”¨ã€Œæ”¯å‡ºï¼é …ç›®ã€ï¼‰
    const colCategory = findHeaderColumn(headerRow, ['æ”¯å‡ºï¼é …ç›®', 'æ”¯å‡º-é …ç›®', 'æ¶ˆè²»é¡åˆ¥', 'é¡åˆ¥']);
    const readColumn = (col) => {
      const arr = [];
      if (col < 0) return arr;
      const seen = new Set();
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row) continue;
        const raw = row[col];
        if (raw === undefined || raw === null) continue;
        const val = raw.toString().trim();
        if (!val || seen.has(val)) continue;
        seen.add(val);
        arr.push({ value: val, text: val });
      }
      return arr;
    };

    if (colCategory >= 0) {
      EXPENSE_CATEGORY_OPTIONS = readColumn(colCategory);
      // å¦‚æœç•¶å‰é¡¯ç¤ºçš„æ˜¯æ”¯å‡ºé¡åˆ¥ï¼Œé‡æ–°æ¸²æŸ“
      const categorySelect = document.getElementById('category-select');
      if (categorySelect && categorySelect.value === 'æ”¯å‡º') {
        // ä¿å­˜ç•¶å‰é¸æ“‡çš„å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
        const currentCategorySelect = document.getElementById('expense-category-select');
        const currentValue = currentCategorySelect ? currentCategorySelect.value : '';
        updateDivVisibility('æ”¯å‡º');
        // å¦‚æœä¹‹å‰æœ‰é¸æ“‡å€¼ï¼Œå˜—è©¦æ¢å¾©
        if (currentValue) {
          setTimeout(() => {
            const newCategorySelect = document.getElementById('expense-category-select');
            if (newCategorySelect && newCategorySelect.querySelector(`option[value="${currentValue}"]`)) {
              newCategorySelect.value = currentValue;
              // åŒæ­¥æ›´æ–°è‡ªè¨‚ä¸‹æ‹‰é¡¯ç¤ºæ–‡å­—
              const selectContainer = newCategorySelect.parentElement;
              if (selectContainer) {
                const selectDisplay = selectContainer.querySelector('.select-display');
                if (selectDisplay) {
                  const selectText = selectDisplay.querySelector('.select-text');
                  if (selectText) {
                    const selectedOpt = newCategorySelect.options[newCategorySelect.selectedIndex];
                    selectText.textContent = selectedOpt ? selectedOpt.textContent : '';
                  }
                }
              }
            }
          }, 100);
        }
      }
    } else {
    }

  } catch (err) {
  }
}

function findHeaderColumn(headerRow, keywords) {
  for (let c = 0; c < headerRow.length; c++) {
    const headerText = (headerRow[c] || '').toString().trim();
    if (!headerText) continue;
    if (keywords.some(k => headerText.includes(k))) return c;
  }
  return -1;
}

// ===== çµ±ä¸€çš„ API èª¿ç”¨å‡½æ•¸ =====
async function callAPI(postData) {
  // å–æ¶ˆä¹‹å‰çš„è«‹æ±‚ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (currentAbortController) {
    currentAbortController.abort();
  }
  
  // å‰µå»ºæ–°çš„ AbortController
  currentAbortController = new AbortController();
  const signal = currentAbortController.signal;
  
  try {
    const response = await fetch(base, {
      method: "POST",
      redirect: "follow",
      mode: "cors",
      keepalive: true,
      signal: signal, // æ·»åŠ  abort signal
      body: JSON.stringify(postData)
    });
    
    const responseText = await response.text();
    if (!responseText || responseText.trim() === '') {
      currentAbortController = null;
      return { success: true, data: null, total: null };
    }
    
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (e) {
      currentAbortController = null;
      throw new Error('å¾Œç«¯éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤: ' + responseText.substring(0, 100));
    }
    
    if (!response.ok || !result.success) {
      currentAbortController = null;
      throw new Error(result.message || result.error || 'æ“ä½œå¤±æ•—');
    }
    
    // è«‹æ±‚æˆåŠŸå¾Œï¼Œæ¸…é™¤ AbortController
    currentAbortController = null;
    return result;
  } catch (error) {
    // å¦‚æœæ˜¯å–æ¶ˆè«‹æ±‚ï¼Œä¸æ‹‹å‡ºéŒ¯èª¤
    if (error.name === 'AbortError') {
      currentAbortController = null;
      throw new Error('è«‹æ±‚å·²å–æ¶ˆ');
    }
    currentAbortController = null;
    throw error;
  }
}

// ===== æ‰¾åˆ°æœ€æ¥è¿‘çš„æœˆä»½ï¼ˆç•¶å‰æœˆä»½æˆ–æœ€æ–°æœˆä»½ï¼‰=====
function findClosestMonth() {
  if (sheetNames.length === 0) return 2;
  
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1;
  const currentMonthStr = `${currentYear}${String(currentMonth).padStart(2, '0')}`;
  
  const currentIndex = sheetNames.findIndex(name => name === currentMonthStr);
  if (currentIndex !== -1) {
    return currentIndex + 2;
  }
  
  return sheetNames.length + 1; // æœ€å¾Œä¸€å€‹æœˆä»½çš„ sheetIndex
}

// ===== å¦‚æœæ²’æœ‰è¨˜éŒ„ï¼Œé€²å…¥æ–°å¢æ¨¡å¼ =====
function enterNewModeIfEmpty() {
  if (filteredRecords.length > 0) return;
  
  const currentType = categorySelect ? categorySelect.value : 'æ”¯å‡º';
  let nextNumber = 1;
  const allRecordsOfType = allRecords.filter(r => r.type === currentType);
  if (allRecordsOfType.length > 0) {
    const maxNum = Math.max(
      ...allRecordsOfType
        .map(r => parseInt(r.row[0], 10))
        .filter(n => Number.isFinite(n) && n > 0)
    );
    if (Number.isFinite(maxNum) && maxNum > 0) {
      nextNumber = maxNum + 1;
    }
  }
  isNewMode = true;
  if (typeof recordNumber !== 'undefined') {
    recordNumber.textContent = ''; // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç·¨è™Ÿ
    recordNumber.style.display = 'none'; // éš±è—ç·¨è™Ÿ
  }
  if (typeof recordDate !== 'undefined') {
    recordDate.textContent = getNowFormattedDateTime();
  }
  const itemInput = document.getElementById('item-input');
  const costInput = document.getElementById('cost-input');
  const noteInput = document.getElementById('note-input');
  if (itemInput) itemInput.value = '';
  if (costInput) costInput.value = '';
  if (noteInput) noteInput.value = '';
  updateDeleteButton();
  updateArrowButtons();
}

// æ ¹æ“šç›®å‰é¸æ“‡çš„é¡å‹éæ¿¾è¨˜éŒ„
function filterRecordsByType(type) {
  filteredRecords = allRecords.filter(r => r.type === type);
  
  // ç¢ºä¿ currentRecordIndex åœ¨æœ‰æ•ˆç¯„åœå…§
  if (currentRecordIndex >= filteredRecords.length && filteredRecords.length > 0) {
    currentRecordIndex = filteredRecords.length - 1;
  } else if (filteredRecords.length === 0) {
    currentRecordIndex = 0;
  }

  //  æ–°å¢æ¨¡å¼ï¼šåˆ‡æ›æ”¶å…¥ / æ”¯å‡ºæ¨¡å¼ï¼šé‡æ–°è¨ˆç®—è©²é¡å‹çš„ä¸‹ä¸€å€‹ç·¨è™Ÿ
  if (isNewMode) {
    // è¨ˆç®—æ–°é¡å‹ä¸­æœ€å¤§çš„ç·¨è™Ÿ + 1
    let nextNumber = 1;
    if (filteredRecords.length > 0) {
      const maxNum = Math.max(
        ...filteredRecords
          .map(r => parseInt(r.row[0], 10))
          .filter(n => Number.isFinite(n) && n > 0)
      );
      if (Number.isFinite(maxNum) && maxNum > 0) {
        nextNumber = maxNum + 1;
      }
    }
    
    // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç·¨è™Ÿ
    if (typeof recordNumber !== 'undefined') {
      recordNumber.textContent = ''; // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç·¨è™Ÿ
      recordNumber.style.display = 'none'; // éš±è—ç·¨è™Ÿ
    }
    
    // æ¸…ç©ºè¡¨å–®ï¼Œæº–å‚™æ–°å¢
    const itemInput = document.getElementById('item-input');
    const costInput = document.getElementById('cost-input');
    const noteInput = document.getElementById('note-input');
    if (itemInput) itemInput.value = '';
    if (costInput) costInput.value = '';
    if (noteInput) noteInput.value = '';
    
    // å¦‚æœæ˜¯æ”¯å‡ºï¼Œé‡ç½®é¡åˆ¥é¸æ“‡
    if (type === 'æ”¯å‡º') {
      const categorySelectElement = document.getElementById('expense-category-select');
      if (categorySelectElement && categorySelectElement.options.length > 0) {
        categorySelectElement.value = categorySelectElement.options[0].value;
        const selectContainer = categorySelectElement.parentElement;
        if (selectContainer) {
          const selectDisplay = selectContainer.querySelector('div');
          if (selectDisplay) {
            const selectText = selectDisplay.querySelector('div');
            if (selectText) {
              selectText.textContent = categorySelectElement.options[0].textContent;
            }
          }
        }
      }
    }
    
    updateArrowButtons();
    updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
    return;
  }

  // å˜—è©¦æ‰¾åˆ°ç›¸åŒç·¨è™Ÿçš„è¨˜éŒ„
  if (currentRecordNumber !== null && filteredRecords.length > 0) {
    const sameNumberIndex = filteredRecords.findIndex(r => {
      const num = parseInt(r.row[0], 10);
      return Number.isFinite(num) && num > 0 && num === currentRecordNumber;
    });
    
    if (sameNumberIndex >= 0) {
      currentRecordIndex = sameNumberIndex;
      showRecord(sameNumberIndex);
      updateArrowButtons();
      return;
    }
  }
  
  // å¦‚æœæ‰¾ä¸åˆ°ç›¸åŒç·¨è™Ÿï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†
  currentRecordIndex = 0;
  if (filteredRecords.length > 0) {
    showRecord(0);
  } else {
    // æ²’æœ‰è¨˜éŒ„æ™‚ï¼Œæ¸…ç©ºè¡¨å–®ä¸¦æ›´æ–°æŒ‰éˆ•
    const itemInput = document.getElementById('item-input');
    const costInput = document.getElementById('cost-input');
    const noteInput = document.getElementById('note-input');
    if (itemInput) itemInput.value = '';
    if (costInput) costInput.value = '';
    if (noteInput) noteInput.value = '';
    if (typeof recordNumber !== 'undefined') {
      recordNumber.textContent = ''; // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç·¨è™Ÿ
      recordNumber.style.display = 'none'; // éš±è—ç·¨è™Ÿ
    }
    updateArrowButtons();
    updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
  }
}

// å–å¾—ç¾åœ¨æ™‚é–“ä¸¦æ ¼å¼åŒ–ç‚º YYYY/MM/DD HH:MM
function getNowFormattedDateTime() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  return `${year}/${month}/${day} ${hours}:${minutes}`;
}

// å°‡å„ç¨®æ™‚é–“å­—ä¸²æ ¼å¼çµ±ä¸€è½‰ç‚º YYYY/MM/DD HH:MM
function formatRecordDateTime(raw) {
  if (!raw) return '';
  
  // å˜—è©¦ä»¥ Date è§£æï¼ˆæ”¯æ´ ISO ä¾‹å¦‚ 2025-11-30T12:34:56Zï¼‰
  const dt = new Date(raw);
  if (Number.isNaN(dt.getTime())) {
    // è§£æå¤±æ•—æ™‚ï¼Œä¿ç•™åŸå­—ä¸²ï¼ˆä¾‹å¦‚å·²ç¶“æ˜¯ 2025/11/30 12:34ï¼‰
    return raw;
  }
  
  const year = dt.getFullYear();
  const month = String(dt.getMonth() + 1).padStart(2, '0');
  const day = String(dt.getDate()).padStart(2, '0');
  const hours = String(dt.getHours()).padStart(2, '0');
  const minutes = String(dt.getMinutes()).padStart(2, '0');
  return `${year}/${month}/${day} ${hours}:${minutes}`;
}

// é¡¯ç¤ºç¬¬ index ç­†è¨˜éŒ„åˆ°å¡ç‰‡ä¸Šçš„è¼¸å…¥æ¬„ä½
function showRecord(index) {
  if (!filteredRecords.length) return;
  
  // ç¢ºä¿ index åœ¨æœ‰æ•ˆç¯„åœå…§
  if (index < 0 || index >= filteredRecords.length) {
    index = Math.max(0, Math.min(index, filteredRecords.length - 1));
  }
  
  currentRecordIndex = index; // æ›´æ–°ç•¶å‰ç´¢å¼•
  const { type, row } = filteredRecords[index];
  isNewMode = false; // é¡¯ç¤ºè¨˜éŒ„æ™‚é€€å‡ºæ–°å¢æ¨¡å¼
  updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º

  // æ›´æ–°å·¦ä¸Šè§’ç·¨è™Ÿï¼šåªé¡¯ç¤ºè©²è¨˜éŒ„è‡ªå·±çš„ç·¨è™Ÿï¼ˆrow[0]ï¼‰ï¼Œä¸é¡¯ç¤ºæ”¶å…¥/æ”¯å‡º
  if (typeof recordNumber !== 'undefined') {
    const num = parseInt(row[0], 10);
    const recordNum = Number.isFinite(num) && num > 0 ? num : (index + 1);
    recordNumber.textContent = `#${String(recordNum).padStart(3, '0')}`;
    currentRecordNumber = recordNum; // è¨˜éŒ„ç›®å‰ç·¨è™Ÿ
  }

  // æ›´æ–°å³ä¸Šè§’ã€Œè³‡æ–™æ™‚é–“ã€ï¼šä½¿ç”¨æ¯ç­†è¨˜éŒ„çš„æ™‚é–“æ¬„ä½ï¼ˆrow[1]ï¼Œé€šå¸¸ç‚ºè©¦ç®—è¡¨ä¸­çš„æ™‚é–“ / æœ€å¾Œä¿®æ­£æ™‚é–“ï¼‰
  if (typeof recordDate !== 'undefined') {
    recordDate.textContent = formatRecordDateTime(row[1] || '');
  }

  // è¨­å®šã€Œæ”¯å‡º / æ”¶å…¥ã€å¤§é¡ï¼ˆåªæ”¹ç•«é¢ï¼Œä¸è§¸ç™¼ change äº‹ä»¶ï¼Œé¿å…éè¿´ï¼‰
  if (typeof categorySelect !== 'undefined' && typeof categorySelectText !== 'undefined') {
    const value = type === 'æ”¶å…¥' || type === 'æ”¯å‡º' ? type : 'æ”¯å‡º';
    categorySelect.value = value;
    categorySelectText.textContent = value;
    // ç›´æ¥æ›´æ–°æ¬„ä½é¡¯ç¤º
    if (typeof updateDivVisibility === 'function') {
      updateDivVisibility();
    }
  }

  // ç­‰ div2 / div3 / div4 ä¾æ“šé¡åˆ¥å»ºç«‹å¥½ä¹‹å¾Œå†å¡«è³‡æ–™
  // ä½¿ç”¨è¼ƒé•·çš„å»¶é²ï¼Œç¢ºä¿ updateDivVisibility å®Œæˆ
  setTimeout(() => {
    const itemInput = document.getElementById('item-input');
    const costInput = document.getElementById('cost-input');
    const noteInput = document.getElementById('note-input');

    if (type === 'æ”¯å‡º') {
      // æ”¯å‡ºï¼š[ç·¨è™Ÿ, æ™‚é–“, category, item, cost, note]
      const categorySelectElement = document.getElementById('expense-category-select');
      if (categorySelectElement) {
        categorySelectElement.value = row[2] || '';
        // åŒæ­¥æ›´æ–°è‡ªè¨‚ä¸‹æ‹‰é¡¯ç¤ºæ–‡å­—ï¼ˆè‹¥å­˜åœ¨ï¼‰
        const selectContainer = categorySelectElement.parentElement;
        if (selectContainer) {
          const selectDisplay = selectContainer.querySelector('div');
          if (selectDisplay) {
            const selectText = selectDisplay.querySelector('div');
            if (selectText) {
              selectText.textContent = row[2] || '';
            }
          }
        }
      }
      if (itemInput) {
        itemInput.value = row[3] || '';
        // ç¢ºä¿å€¼å·²è¨­å®šï¼ˆé¿å… placeholder é¡¯ç¤ºï¼‰
        if (itemInput.value === '' && row[3]) {
          itemInput.value = row[3];
        }
      }
      if (costInput) costInput.value = row[4] || '';
      if (noteInput) noteInput.value = row[5] || '';
    } else {
      // æ”¶å…¥ï¼š[ç·¨è™Ÿ, æ™‚é–“, item, cost, note]
      if (itemInput) {
        itemInput.value = row[2] || '';
        // ç¢ºä¿å€¼å·²è¨­å®šï¼ˆé¿å… placeholder é¡¯ç¤ºï¼‰
        if (itemInput.value === '' && row[2]) {
          itemInput.value = row[2];
        }
      }
      if (costInput) costInput.value = row[3] || '';
      if (noteInput) noteInput.value = row[4] || '';
    }
    
    // æ›´æ–°ç®­é ­æŒ‰éˆ•ç‹€æ…‹
    updateArrowButtons();
  }, 150);
}

// è™•ç†å¾ Apps Script å›å‚³çš„è³‡æ–™ï¼ˆç”¨æ–¼æ›´æ–° allRecordsï¼‰
const processDataFromResponse = (data, shouldFilter = true) => {
  // å…ˆæ¸…ç©ºç›®å‰çš„è¨˜éŒ„
  allRecords = [];

  if (data && typeof data === 'object') {
    Object.keys(data).forEach(key => {
      const rows = data[key] || [];

      const isIncome = key.includes('æ”¶å…¥');
      const isExpense = key.includes('æ”¯å‡º');
      const type = isIncome ? 'æ”¶å…¥' : (isExpense ? 'æ”¯å‡º' : '');
      
      if (!type) return; // è·³éä¸æ˜¯æ”¶å…¥æˆ–æ”¯å‡ºçš„è³‡æ–™

      rows.forEach(row => {
        if (!row || row.length === 0) return;
        
        // è·³éç¸½è¨ˆè¡Œå’Œç©ºè¡Œ
        const firstCell = row[0];
        if (firstCell === 'ç¸½è¨ˆ' || firstCell === '' || firstCell === null || firstCell === undefined) {
          return;
        }
        
        // è·³éæ¨™é¡Œåˆ—ï¼ˆéæ•¸å­—ç·¨è™Ÿï¼‰
        const num = parseInt(row[0], 10);
        if (!Number.isFinite(num) || num <= 0) return;
        
        // å°±ç®—å®Œå…¨ç›¸åŒä¹Ÿéƒ½è¦é¡¯ç¤ºï¼ˆä¸åšå»é‡ï¼‰
        allRecords.push({ type, row });
      });
    });
  }
  // æ ¹æ“šç›®å‰é¸æ“‡çš„é¡å‹éæ¿¾è¨˜éŒ„ï¼ˆé è¨­é¡¯ç¤ºæ”¯å‡ºï¼‰
  if (shouldFilter) {
  const currentType = categorySelect ? categorySelect.value : 'æ”¯å‡º';
  filterRecordsByType(currentType);
  }
};

// åœ“é¤…åœ–å·²å–æ¶ˆï¼Œä¸å†ç¹ªè£½ï¼ˆä¿ç•™å‡½å¼ä»‹é¢ä»¥é¿å…å…¶ä»–ç¨‹å¼ç¢¼å‡ºéŒ¯ï¼‰
const renderPieChart = (_totalData) => {
  return;
};

// æ›´æ–°ç¸½è¨ˆé¡¯ç¤º + åœ“é¤…åœ–
const updateTotalDisplay = (totalData) => {
  if (Array.isArray(totalData) && totalData.length >= 3) {
    incomeAmount.textContent = totalData[0];
    expenseAmount.textContent = totalData[1];
    totalAmount.textContent = totalData[2];
    updateTotalColor(totalData[2]);
    renderPieChart(totalData);
  }
};

// è¼‰å…¥å–®å€‹æœˆä»½çš„è³‡æ–™å’Œç¸½è¨ˆ
const loadMonthData = async (sheetIndex) => {
  // é©—è­‰ sheetIndex æ˜¯å¦æœ‰æ•ˆ
  if (!Number.isFinite(sheetIndex) || sheetIndex < 2) {
    throw new Error(`ç„¡æ•ˆçš„ sheet ç´¢å¼•: ${sheetIndex}`);
  }

  // å–æ¶ˆä¹‹å‰çš„è«‹æ±‚ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (currentAbortController) {
    currentAbortController.abort();
  }
  
  // å‰µå»ºæ–°çš„ AbortController
  currentAbortController = new AbortController();
  const signal = currentAbortController.signal;

  // å¾è©¦ç®—è¡¨æŠ“å‡ºã€Œç•¶æœˆæ”¶å…¥ / æ”¯å‡ºã€ç­‰è³‡æ–™ - æ·»åŠ æ™‚é–“æˆ³é¿å…å¿«å–
  const dataParams = { name: "Show Tab Data", sheet: sheetIndex, _t: Date.now() };
  const dataUrl = `${base}?${new URLSearchParams(dataParams)}`;
  const res = await fetch(dataUrl, {
    method: "GET",
    redirect: "follow",
    mode: "cors",
    cache: "no-store", // å¼·åˆ¶ä¸ä½¿ç”¨å¿«å–
    signal: signal // æ·»åŠ  abort signal
  });
  
  if (!res.ok) {
    throw new Error(`è¼‰å…¥è³‡æ–™å¤±æ•—: HTTP ${res.status} ${res.statusText}`);
  }
  
  const data = await res.json();
  // èª¿è©¦ï¼šæª¢æŸ¥æ¯å€‹ key çš„è³‡æ–™é•·åº¦
  Object.keys(data).forEach(key => {
    const rows = data[key] || [];
  });

  // è¼‰å…¥ç¸½è¨ˆ - æ·»åŠ æ™‚é–“æˆ³é¿å…å¿«å–
  const TotalParams = { name: "Show Total", sheet: sheetIndex, _t: Date.now() };
  const Totalurl = `${base}?${new URLSearchParams(TotalParams)}`;
  const Totalres = await fetch(Totalurl, {
    method: "GET",
    redirect: "follow",
    mode: "cors",
    cache: "no-store", // å¼·åˆ¶ä¸ä½¿ç”¨å¿«å–
    signal: signal // æ·»åŠ  abort signal
  });
  
  if (!Totalres.ok) {
    throw new Error(`è¼‰å…¥ç¸½è¨ˆå¤±æ•—: HTTP ${Totalres.status} ${Totalres.statusText}`);
  }
  
  const totalData = await Totalres.json();
  
  // è«‹æ±‚æˆåŠŸå¾Œï¼Œæ¸…é™¤ AbortController
  currentAbortController = null;
  
  // æ ¹æ“šè³‡æ–™è¨ˆç®—ç¸½è¨ˆï¼ˆå› ç‚º Google Apps Script çš„ç¸½è¨ˆå¯èƒ½æœ‰å•é¡Œï¼‰
  let calculatedIncome = 0;
  let calculatedExpense = 0;
  let incomeCount = 0;
  let expenseCount = 0;
  
  // ä½¿ç”¨ Set ä¾†è¿½è¹¤å·²è™•ç†çš„è¨˜éŒ„ï¼Œé¿å…é‡è¤‡è¨ˆç®—
  const processedIncomeRecords = new Set();
  const processedExpenseRecords = new Set();
  
  if (data && typeof data === 'object') {
    // ç²å–ç•¶å‰æœˆä»½åç¨±ï¼ˆå¾ sheetNames ä¸­æŸ¥æ‰¾ï¼ŒsheetIndex æ˜¯å¯¦éš›çš„ sheet ç´¢å¼•ï¼Œéœ€è¦æ¸› 2ï¼‰
    const monthIndex = sheetIndex - 2;
    const currentMonthName = (monthIndex >= 0 && monthIndex < sheetNames.length) ? sheetNames[monthIndex] : '';
    
    Object.keys(data).forEach(key => {
      const rows = data[key] || [];
      const isIncome = key.includes('æ”¶å…¥');
      const isExpense = key.includes('æ”¯å‡º');
      
      // åªè™•ç†ç•¶å‰æœˆä»½çš„è³‡æ–™ï¼ˆå‘½åç¯„åœåç¨±æ‡‰è©²åŒ…å«ç•¶å‰æœˆä»½ï¼‰
      const isCurrentMonth = currentMonthName && key.includes(currentMonthName);
      if (!isCurrentMonth && (isIncome || isExpense)) {
        return;
      }
      
      if (!isIncome && !isExpense) return; // è·³éä¸æ˜¯æ”¶å…¥æˆ–æ”¯å‡ºçš„è³‡æ–™
      // çµ±è¨ˆæœ‰æ•ˆè¨˜éŒ„æ•¸
      let validRowsCount = 0;
      
      rows.forEach((row, rowIndex) => {
        if (!row || row.length === 0) return;
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºè¡Œï¼ˆæ‰€æœ‰æ¬„ä½éƒ½æ˜¯ç©ºï¼‰
        const isEmptyRow = row.every(cell => cell === '' || cell === null || cell === undefined);
        if (isEmptyRow) {
          return;
        }
        
        // è·³éç¸½è¨ˆè¡Œï¼ˆç¬¬ä¸€æ¬„æ˜¯ "ç¸½è¨ˆ" æˆ–ç©ºå­—ä¸²ï¼‰
        const firstCell = row[0];
        if (firstCell === 'ç¸½è¨ˆ' || firstCell === '' || firstCell === null || firstCell === undefined) {
          return;
        }
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆè¨˜éŒ„ï¼ˆç¬¬ä¸€æ¬„æ‡‰è©²æ˜¯æ•¸å­—ç·¨è™Ÿï¼‰
        const num = parseInt(firstCell, 10);
        if (!Number.isFinite(num) || num <= 0) {
          return;
        }
        
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“è™•ç†éé€™ç­†è¨˜éŒ„ï¼ˆä½¿ç”¨ç·¨è™Ÿ+æ™‚é–“ä½œç‚ºå”¯ä¸€æ¨™è­˜ï¼‰
        const recordKey = `${num}_${row[1] || ''}`;
        if (isIncome) {
          if (processedIncomeRecords.has(recordKey)) {
            return;
          }
          processedIncomeRecords.add(recordKey);
        } else if (isExpense) {
          if (processedExpenseRecords.has(recordKey)) {
            return;
          }
          processedExpenseRecords.add(recordKey);
        }
        
        // æ”¶å…¥ï¼š[ç·¨è™Ÿ, æ™‚é–“, item, cost, note] - cost åœ¨ç´¢å¼• 3 (Dæ¬„)
        // æ”¯å‡ºï¼š[ç·¨è™Ÿ, æ™‚é–“, category, item, cost, note] - cost åœ¨ç´¢å¼• 4 (Kæ¬„ï¼Œä½†åœ¨G-Lç¯„åœä¸­æ˜¯ç´¢å¼•4)
        const costIndex = isIncome ? 3 : (isExpense ? 4 : -1);
        if (costIndex >= 0 && row[costIndex] !== undefined && row[costIndex] !== null && row[costIndex] !== '') {
          const cost = parseFloat(row[costIndex]);
          if (Number.isFinite(cost) && cost !== 0) { // å…è¨±è² æ•¸ï¼Œä½†ä¸ç´¯åŠ 0
            validRowsCount++;
            if (isIncome) {
              calculatedIncome += cost;
              incomeCount++;
              // åªåœ¨æœ‰æ•ˆè¨˜éŒ„æ•¸å°‘æ–¼ 20 æ™‚æ‰è¼¸å‡ºè©³ç´°æ—¥èªŒï¼Œé¿å…æ§åˆ¶å°è¢«åˆ·å±
              if (incomeCount <= 20) {
              }
            } else if (isExpense) {
              calculatedExpense += cost;
              expenseCount++;
              // åªåœ¨æœ‰æ•ˆè¨˜éŒ„æ•¸å°‘æ–¼ 20 æ™‚æ‰è¼¸å‡ºè©³ç´°æ—¥èªŒï¼Œé¿å…æ§åˆ¶å°è¢«åˆ·å±
              if (expenseCount <= 20) {
              }
            }
          }
        }
      });
    });
  }
  
  const calculatedTotal = calculatedIncome - calculatedExpense;
  const calculatedTotalData = [calculatedIncome, calculatedExpense, calculatedTotal];
  // ä½¿ç”¨è¨ˆç®—çš„ç¸½è¨ˆï¼Œè€Œä¸æ˜¯ API è¿”å›çš„ç¸½è¨ˆ
  return { data, total: calculatedTotalData };
};

// é å…ˆè¼‰å…¥å…¶ä»–æœˆä»½çš„è³‡æ–™ï¼ˆåœ¨èƒŒæ™¯ä½µç™¼è«‹æ±‚ï¼Œé¿å…ä¹‹å¾Œåˆ‡æ›æœˆä»½å¡é “ï¼‰
const preloadAllMonthsData = async () => {
  if (sheetNames.length === 0) return;
  // ä½¿ç”¨ä¸¦ç™¼è¼‰å…¥ä»¥æé«˜é€Ÿåº¦ï¼Œä¸¦ç•¥éç›®å‰æ­£åœ¨é¡¯ç¤ºçš„åˆ†é ï¼ˆé¿å…é‡è¤‡è«‹æ±‚ï¼‰
  const promises = sheetNames.map(async (name, idx) => {
    const sheetIndex = idx + 2; // è½‰ç‚ºå¯¦éš› sheet index
    if (sheetIndex === currentSheetIndex) {
      return null; // è·³éç•¶å‰æœˆä»½ï¼Œå› ç‚ºå·²ç¶“è¼‰å…¥éäº†
    }
    try {
      const monthData = await loadMonthData(sheetIndex);
      allMonthsData[sheetIndex] = monthData;
      // æª¢æŸ¥è¼‰å…¥çš„è³‡æ–™
      const totalPreview = Array.isArray(monthData.total) ? monthData.total : 'N/A';
      return { sheetIndex, name, success: true };
    } catch (error) {
      return { sheetIndex, name, success: false, error };
    }
  });
  
  await Promise.all(promises);
  Object.keys(allMonthsData).forEach(key => {
    const monthData = allMonthsData[key];
    const total = Array.isArray(monthData.total) ? monthData.total : 'N/A';
  });
};

// å¾è¨˜æ†¶é«”è¼‰å…¥ç•¶å‰æœˆä»½çš„è³‡æ–™ï¼ˆä¸ç™¼é€è«‹æ±‚ï¼‰
const loadContentFromMemory = () => {
  // å…ˆæ¸…ç©ºç›®å‰çš„è¨˜éŒ„ï¼ˆç¢ºä¿ä¸åŒæœˆä»½çš„è³‡æ–™ä¸æœƒæ··åœ¨ä¸€èµ·ï¼‰
  allRecords = [];
  filteredRecords = [];
  currentRecordIndex = 0;

  // é©—è­‰ currentSheetIndex æ˜¯å¦æœ‰æ•ˆ
  if (!Number.isFinite(currentSheetIndex) || currentSheetIndex < 2) {
    currentSheetIndex = 2; // é è¨­ç‚ºç¬¬ä¸‰å€‹åˆ†é 
  }

  // å¾è¨˜æ†¶é«”è®€å–è³‡æ–™
  const monthData = allMonthsData[currentSheetIndex];
  if (!monthData) {
    return false; // è¡¨ç¤ºéœ€è¦é‡æ–°è¼‰å…¥
  }

  // è™•ç†è³‡æ–™ï¼ˆæœƒè‡ªå‹•éæ¿¾ä¸¦é¡¯ç¤ºè¨˜éŒ„ï¼‰
  processDataFromResponse(monthData.data, true);
  
  // æ›´æ–°ç¸½è¨ˆ
  updateTotalDisplay(monthData.total);
  
  // ç¢ºä¿é¡¯ç¤ºç¬¬ä¸€ç­†è¨˜éŒ„ï¼ˆå¦‚æœæœ‰çš„è©±ï¼Œä¸”ä¸åœ¨æ–°å¢æ¨¡å¼ï¼‰
  if (!isNewMode && filteredRecords.length > 0) {
    showRecord(0);
  }
  
  return true; // è¡¨ç¤ºæˆåŠŸå¾è¨˜æ†¶é«”è¼‰å…¥
};

// è¼‰å…¥ç•¶å‰æœˆä»½çš„è³‡æ–™ï¼ˆå„ªå…ˆå¾è¨˜æ†¶é«”è®€å–ï¼Œå¦‚æœæ²’æœ‰å‰‡ç™¼é€è«‹æ±‚ï¼‰
const loadContent = async (forceReload = false) => {
  // å¦‚æœä¸å¼·åˆ¶é‡æ–°è¼‰å…¥ï¼Œå…ˆå˜—è©¦å¾è¨˜æ†¶é«”è®€å–
  if (!forceReload && loadContentFromMemory()) {
    return; // æˆåŠŸå¾è¨˜æ†¶é«”è¼‰å…¥ï¼Œç›´æ¥è¿”å›
  }

  // å¦‚æœè¨˜æ†¶é«”ä¸­æ²’æœ‰è³‡æ–™ï¼Œæˆ–éœ€è¦å¼·åˆ¶é‡æ–°è¼‰å…¥ï¼Œå‰‡ç™¼é€è«‹æ±‚
  try {
    const monthData = await loadMonthData(currentSheetIndex);
    
    // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„è³‡æ–™
    allMonthsData[currentSheetIndex] = monthData;
    
    // è™•ç†è³‡æ–™
    processDataFromResponse(monthData.data);
    
    // æ›´æ–°ç¸½è¨ˆ
    updateTotalDisplay(monthData.total);
  } catch (error) {
    throw error;
  }
};


const loadTotal = async () => {
  // é©—è­‰ currentSheetIndex æ˜¯å¦æœ‰æ•ˆ
  if (!Number.isFinite(currentSheetIndex) || currentSheetIndex < 2) {
    currentSheetIndex = 2; // é è¨­ç‚ºç¬¬ä¸‰å€‹åˆ†é 
  }
  
  // å„ªå…ˆå¾è¨˜æ†¶é«”è®€å–ç¸½è¨ˆ
  const monthData = allMonthsData[currentSheetIndex];
  if (monthData && monthData.total) {
    updateTotalDisplay(monthData.total);
    return;
  }
  
  // å¦‚æœè¨˜æ†¶é«”ä¸­æ²’æœ‰ï¼Œå‰‡ç™¼é€è«‹æ±‚
  try {
    const TotalParams = { name: "Show Total", sheet: currentSheetIndex };
  const Totalurl = `${base}?${new URLSearchParams(TotalParams)}`;
    const Totalres = await fetch(Totalurl, {
      method: "GET",
      redirect: "follow",
      mode: "cors"
    });
    
    if (!Totalres.ok) {
      throw new Error(`è¼‰å…¥ç¸½è¨ˆå¤±æ•—: HTTP ${Totalres.status} ${Totalres.statusText}`);
    }
    
  const Totaldata = await Totalres.json();
    
    // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„ç¸½è¨ˆï¼ˆå¦‚æœè³‡æ–™å­˜åœ¨ï¼‰
    if (allMonthsData[currentSheetIndex]) {
      allMonthsData[currentSheetIndex].total = Totaldata;
    } else {
      // å¦‚æœè³‡æ–™ä¸å­˜åœ¨ï¼Œå‰µå»ºä¸€å€‹æ–°çš„æ¢ç›®
      allMonthsData[currentSheetIndex] = { total: Totaldata };
    }
    
    updateTotalDisplay(Totaldata);
  } catch (error) {
    // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œåªè¨˜éŒ„ï¼Œé¿å…å½±éŸ¿å…¶ä»–åŠŸèƒ½
  }
};

const showSpinner = () => {
  // å¦‚æœå·²ç¶“å­˜åœ¨ï¼Œå…ˆç§»é™¤
  const existingOverlay = document.getElementById('loading-overlay');
  if (existingOverlay) {
    existingOverlay.remove();
  }
  
  // å‰µå»ºå…¨å±é®ç½©ï¼ˆä¸è¦†è“‹é é¦–ï¼‰
  const overlay = document.createElement('div');
  overlay.id = 'loading-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    z-index: 1500; /* ä½æ–¼é é¦– (2000)ï¼Œä¸æ“‹ä½æ¼¢å ¡é¸å–®èˆ‡é¸é … */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: not-allowed;
  `;
  
  const spinner = document.createElement('div');
  spinner.id = 'loading-spinner';
  spinner.innerHTML = `
    <div>
      <div class="spinner-circle"></div>
      <span>è¼‰å…¥ä¸­...</span>
    </div>
  `;
  
  overlay.appendChild(spinner);
  document.body.appendChild(overlay);
};

const hideSpinner = () => {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) {
    overlay.remove();
  }
  const spinner = document.getElementById('loading-spinner');
  if (spinner) {
    spinner.remove();
  }
};

const createInputRow = (labelText, inputId, inputType = 'text') => {
  const row = document.createElement('div');
  row.className = 'input-row';
  
  const label = document.createElement('label');
  label.textContent = labelText;
  label.htmlFor = inputId; // é—œè¯åˆ° input
  
  const input = document.createElement('input');
  input.id = inputId;
  input.name = inputId; // æ·»åŠ  name å±¬æ€§ä»¥æ”¯æŒè‡ªå‹•å¡«å……
  input.type = inputType;
  
  row.appendChild(label);
  row.appendChild(input);
  return row;
};

const createTextareaRow = (labelText, textareaId, rows = 3) => {
  const row = document.createElement('div');
  row.className = 'input-row';
  
  const label = document.createElement('label');
  label.textContent = labelText;
  label.htmlFor = textareaId; // é—œè¯åˆ° textarea
  
  const textarea = document.createElement('textarea');
  textarea.id = textareaId;
  textarea.name = textareaId; // æ·»åŠ  name å±¬æ€§ä»¥æ”¯æŒè‡ªå‹•å¡«å……
  textarea.rows = rows;
  
  row.appendChild(label);
  row.appendChild(textarea);
  return row;
};

const createSelectRow = (labelText, selectId, options) => {
  const row = document.createElement('div');
  row.className = 'select-row';
  
  const label = document.createElement('label');
  label.textContent = labelText;
  label.htmlFor = selectId; // é—œè¯åˆ° select
  
  const selectContainer = document.createElement('div');
  selectContainer.className = 'select-container';
  
  const selectDisplay = document.createElement('div');
  selectDisplay.className = 'select-display';
  
  const selectText = document.createElement('div');
  selectText.className = 'select-text';
  selectText.textContent = options[0].text;
  
  const selectArrow = document.createElement('div');
  selectArrow.className = 'select-arrow';
  selectArrow.textContent = 'â–¼';
  
  selectDisplay.appendChild(selectText);
  selectDisplay.appendChild(selectArrow);
  
  const hiddenSelect = document.createElement('select');
  hiddenSelect.id = selectId;
  hiddenSelect.name = selectId; // æ·»åŠ  name å±¬æ€§ä»¥æ”¯æŒè‡ªå‹•å¡«å……
  hiddenSelect.style.display = 'none';
  hiddenSelect.value = options[0].value;
  
  const dropdown = document.createElement('div');
  dropdown.className = 'select-dropdown';
  
  options.forEach(opt => {
    const option = document.createElement('div');
    option.className = 'select-option';
    option.textContent = opt.text;
    option.dataset.value = opt.value;
    
    option.addEventListener('click', function() {
      selectText.textContent = opt.text;
      hiddenSelect.value = opt.value;
      dropdown.style.display = 'none';
      selectArrow.style.transform = 'rotate(0deg)';
      hiddenSelect.dispatchEvent(new Event('change'));
    });
    
    dropdown.appendChild(option);
    const hiddenOption = document.createElement('option');
    hiddenOption.value = opt.value;
    hiddenOption.textContent = opt.text;
    hiddenSelect.appendChild(hiddenOption);
  });
  
  selectDisplay.addEventListener('click', function(e) {
    e.stopPropagation();
    const isOpen = dropdown.style.display === 'block';
    dropdown.style.display = isOpen ? 'none' : 'block';
    selectArrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
  });
  
  document.addEventListener('click', function(e) {
    if (!selectContainer.contains(e.target)) {
      dropdown.style.display = 'none';
      selectArrow.style.transform = 'rotate(0deg)';
    }
  });
  
  selectContainer.appendChild(selectDisplay);
  selectContainer.appendChild(dropdown);
  selectContainer.appendChild(hiddenSelect);
  
  row.appendChild(label);
  row.appendChild(selectContainer);
  return row;
};

const updateDivVisibility = (forceType = null) => {
  // å¦‚æœæä¾›äº†é¡å‹åƒæ•¸ï¼Œä½¿ç”¨å®ƒï¼›å¦å‰‡å˜—è©¦å¾ DOM ç²å–æœ€æ–°å…ƒç´ çš„å€¼
  let categoryValue = forceType;
  if (categoryValue === null) {
    // å…ˆå˜—è©¦å¾å…¨å±€è®Šæ•¸ç²å–
    if (typeof categorySelect !== 'undefined' && categorySelect.value) {
      categoryValue = categorySelect.value;
    } else {
      // å¦‚æœå…¨å±€è®Šæ•¸ä¸å¯ç”¨ï¼Œå¾ DOM ç²å–æœ€æ–°å…ƒç´ 
      const categorySelectElement = document.getElementById('category-select');
      if (categorySelectElement) {
        categoryValue = categorySelectElement.value;
      } else {
        categoryValue = 'æ”¯å‡º'; // é»˜èªå€¼
      }
    }
  }
  
  div2.innerHTML = '';
  div3.innerHTML = '';
  div4.innerHTML = '';
  
  if (categoryValue === 'æ”¯å‡º') {
    const categoryRow = createSelectRow('é¡åˆ¥ï¼š', 'expense-category-select', EXPENSE_CATEGORY_OPTIONS);
    const costRow = createInputRow('é‡‘é¡ï¼š', 'cost-input', 'number');
    const noteRow = createTextareaRow('å‚™è¨»ï¼š', 'note-input', 3);
    noteRow.style.marginBottom = '0px';
    
    div2.appendChild(categoryRow);
    div3.appendChild(costRow);
    div4.appendChild(noteRow);
    
    itemContainer.style.display = 'flex';
    div2.style.display = 'flex';
    div3.style.display = 'flex';
    div4.style.display = 'flex';
  } else if (categoryValue === 'æ”¶å…¥') {
    const costRow = createInputRow('é‡‘é¡ï¼š', 'cost-input', 'number');
    const noteRow = createTextareaRow('å‚™è¨»ï¼š', 'note-input', 3);
    noteRow.style.marginBottom = '0px';
    
    div2.appendChild(costRow);
    div3.appendChild(noteRow);
    
    itemContainer.style.display = 'flex';
    div2.style.display = 'flex';
    div3.style.display = 'flex';
    div4.style.display = 'none';
  }
};

const saveData = async () => {
  const categoryValue = categorySelect.value;
  const itemInput = document.getElementById('item-input');
  const costInput = document.getElementById('cost-input');
  const noteInput = document.getElementById('note-input');
  const TotalParams = { name: "Show Total", sheet: currentSheetIndex };
  
  if (!itemInput || !costInput) {
    alert('è«‹ç­‰å¾…è¡¨å–®è¼‰å…¥å®Œæˆ');
    return;
  }
  
  const item = itemInput.value.trim();
  const costValue = costInput.value.trim();
  const cost = parseFloat(costValue);
  const note = noteInput ? noteInput.value.trim() : '';
  
  if (!item) {
    alert('è«‹è¼¸å…¥é …ç›®');
    return;
  }
  
  if (!costValue || isNaN(cost) || cost <= 0) {
    alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
    return;
  }
  
  let category = '';
  let range = 0;
  
  if (categoryValue === 'æ”¯å‡º') {
    const div2Display = window.getComputedStyle(div2).display;
    if (div2Display === 'none' || div2Display === '') {
      alert('è«‹ç­‰å¾…è¡¨å–®è¼‰å…¥å®Œæˆ');
      return;
    }
    const categorySelectElement = document.getElementById('expense-category-select');
    if (!categorySelectElement) {
      alert('è«‹ç­‰å¾…è¡¨å–®è¼‰å…¥å®Œæˆ');
      return;
    }
    if (!categorySelectElement.value) {
      alert('è«‹é¸æ“‡æ”¯å‡ºé¡åˆ¥');
      return;
    }
    category = categorySelectElement.value;
    range = 0;
  } else {
    range = 1;
  }
  
  
  // é–å®šæ•´å€‹é é¢ï¼Œç­‰å¾…å¾Œç«¯å›å‚³
  showSpinner();
  saveButton.textContent = 'å„²å­˜ä¸­...';
  saveButton.disabled = true;
  saveButton.style.opacity = '0.6';
  saveButton.style.cursor = 'not-allowed';
  
  // ç¦ç”¨æ‰€æœ‰è¼¸å…¥å’ŒæŒ‰éˆ•
  if (itemInput) itemInput.disabled = true;
  if (costInput) costInput.disabled = true;
  if (noteInput) noteInput.disabled = true;
  if (categorySelect) categorySelect.disabled = true;
  const expenseCategorySelect = document.getElementById('expense-category-select');
  if (expenseCategorySelect) expenseCategorySelect.disabled = true;
  leftArrow.disabled = true;
  rightArrow.disabled = true;
  deleteButton.disabled = true;
  if (monthSelect) monthSelect.disabled = true;
  
  let alreadyReset = false; // ç¢ºä¿åªåœ¨åˆé©æ™‚æ©Ÿé‚„åŸæŒ‰éˆ•ç‹€æ…‹
  try {
    const postData = {
      name: "Upsert Data",
      sheet: currentSheetIndex,
      range: range,
      item: item,
      cost: cost,
      note: note,
      
    };
    
    // æ”¯å‡ºæ™‚ï¼ˆrange === 0ï¼‰å¿…é ˆç™¼é€ category
    if (range === 0) {
      postData.category = category;
    }
    
    // å¦‚æœä¸æ˜¯æ–°å¢æ¨¡å¼ï¼Œå¿…é ˆå‚³é€ updateRow åƒæ•¸ä¾†æ›´æ–°ç¾æœ‰è¨˜éŒ„
    // updateRow æ˜¯è¡Œè™Ÿ = ç·¨è™Ÿ + 2ï¼ˆç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œï¼Œè³‡æ–™å¾ç¬¬äºŒè¡Œé–‹å§‹ï¼‰
    if (!isNewMode) {
      if (filteredRecords.length > 0 && currentRecordIndex < filteredRecords.length) {
        const currentRecord = filteredRecords[currentRecordIndex];
        const recordNum = parseInt(currentRecord.row[0], 10);
        if (Number.isFinite(recordNum) && recordNum > 0) {
          postData.updateRow = recordNum + 2;
        } else {
          alert('ç„¡æ³•æ›´æ–°è¨˜éŒ„ï¼šæ‰¾ä¸åˆ°è¨˜éŒ„ç·¨è™Ÿ');
          return;
        }
      } else {
        alert('ç„¡æ³•æ›´æ–°è¨˜éŒ„ï¼šæ‰¾ä¸åˆ°ç›®å‰è¨˜éŒ„');
        return;
      }
    }

    
    const response = await fetch(base, {
      method: "POST",
      redirect: "follow",
      mode: "cors",
      keepalive: true,
      headers: {
        "Content-Type": "text/plain;charset=utf-8",
      },
      body: JSON.stringify(postData)
    });
    
    const responseText = await response.text();
    
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (e) {
      throw new Error('å¾Œç«¯éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤: ' + responseText);
    }
    
    if (response.ok && result.success) {
      // è¨˜éŒ„æ˜¯å¦åœ¨æ–°å¢æ¨¡å¼
      const wasInNewMode = isNewMode;
      const savedType = categoryValue;
      // è¨˜éŒ„ç›®å‰ç·¨è¼¯çš„è¨˜éŒ„ç·¨è™Ÿï¼ˆç”¨æ–¼ç·¨è¼¯æ¨¡å¼ï¼‰
      const savedRecordNumber = !wasInNewMode && filteredRecords.length > 0 && currentRecordIndex < filteredRecords.length 
        ? parseInt(filteredRecords[currentRecordIndex].row[0], 10) 
        : null;
      
      alert('è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼');
      
      // åœ¨é‡æ–°è¼‰å…¥å‰ï¼Œå…ˆè¨­å®š currentRecordNumberï¼ˆç”¨æ–¼ç·¨è¼¯æ¨¡å¼ï¼‰
      if (!wasInNewMode && savedRecordNumber !== null) {
        currentRecordNumber = savedRecordNumber;
      }
      
      // å¦‚æœ Apps Script å›å‚³äº† data å’Œ totalï¼Œç›´æ¥ä½¿ç”¨ï¼Œå¦å‰‡é‡æ–°è¼‰å…¥
      if (result.data && result.total) {
        // æ›´æ–°è¨˜æ†¶é«”ä¸­ç•¶å‰æœˆä»½çš„è³‡æ–™
        allMonthsData[currentSheetIndex] = {
          data: result.data,
          total: result.total
        };
        
        // è¨˜éŒ„ç•¶å‰é¡¯ç¤ºçš„è¨˜éŒ„ç·¨è™Ÿï¼ˆç”¨æ–¼æ›´æ–°å¾Œé‡æ–°å®šä½ï¼‰
        const currentDisplayedRecordNumber = !wasInNewMode && filteredRecords.length > 0 && currentRecordIndex < filteredRecords.length
          ? parseInt(filteredRecords[currentRecordIndex].row[0], 10)
          : null;
        
        // ä½¿ç”¨å›å‚³çš„è³‡æ–™æ›´æ–°è¨˜éŒ„å’Œç¸½è¨ˆï¼ˆä¸è‡ªå‹•éæ¿¾ï¼Œç¨å¾Œæ‰‹å‹•éæ¿¾ï¼‰
        processDataFromResponse(result.data, false);
        updateTotalDisplay(result.total);
        
        // æ ¹æ“šä¿å­˜çš„é¡å‹é‡æ–°éæ¿¾è¨˜éŒ„
        const currentType = categorySelect ? categorySelect.value : savedType;
        filterRecordsByType(currentType);
        
        // ç­‰å¾…éæ¿¾å®Œæˆ
        await new Promise(r => setTimeout(r, 100));
        
        // å¦‚æœå‰›æ‰åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œå˜—è©¦æ‰¾åˆ°å‰›æ‰ç·¨è¼¯çš„è¨˜éŒ„ä¸¦å®šä½
        if (!wasInNewMode && currentDisplayedRecordNumber !== null) {
          const recordIndex = filteredRecords.findIndex(r => {
            const num = parseInt(r.row[0], 10);
            return Number.isFinite(num) && num > 0 && num === currentDisplayedRecordNumber;
          });
          
          if (recordIndex >= 0) {
            currentRecordIndex = recordIndex;
            showRecord(recordIndex);
            updateArrowButtons();
          } else {
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†
            if (filteredRecords.length > 0) {
              currentRecordIndex = 0;
              showRecord(0);
              updateArrowButtons();
            }
          }
        } else {
          // æ–°å¢æ¨¡å¼æˆ–æ‰¾ä¸åˆ°è¨˜éŒ„æ™‚ï¼Œé‡ç½®ç´¢å¼•
          currentRecordIndex = 0;
          if (filteredRecords.length > 0) {
            showRecord(0);
            updateArrowButtons();
          }
        }
      } else {
      // é‡æ–°è¼‰å…¥è¨˜éŒ„ï¼ˆé¿å…å¿«å–ï¼ŒåŠ å…¥çŸ­å»¶é²ï¼‰
      try {
        await new Promise(r => setTimeout(r, 200));
        await loadContent();
        } catch (e) {
        }
      }
        
        // å¦‚æœå‰›æ‰åœ¨æ–°å¢æ¨¡å¼ï¼Œè‡ªå‹•é€²å…¥ä¸‹ä¸€å€‹æ–°å¢å¡ç‰‡
        if (wasInNewMode) {
          // ç¢ºä¿é¡å‹æ­£ç¢º
          if (categorySelect && categorySelect.value !== savedType) {
            categorySelect.value = savedType;
            categorySelectText.textContent = savedType;
            filterRecordsByType(savedType);
          }
          
          // ç­‰å¾…éæ¿¾å®Œæˆå¾Œï¼Œé€²å…¥æ–°å¢æ¨¡å¼
          setTimeout(() => {
            // è¨ˆç®—ä¸‹ä¸€å€‹ç·¨è™Ÿ
            let nextNumber = 1;
            if (filteredRecords.length > 0) {
              const maxNum = Math.max(
                ...filteredRecords
                  .map(r => parseInt(r.row[0], 10))
                  .filter(n => Number.isFinite(n) && n > 0)
              );
              if (Number.isFinite(maxNum) && maxNum > 0) {
                nextNumber = maxNum + 1;
              }
            }
            
            // é€²å…¥æ–°å¢æ¨¡å¼
            isNewMode = true;
            currentRecordIndex = filteredRecords.length > 0 ? filteredRecords.length - 1 : 0;
            updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
            
            // æ¸…ç©ºè¡¨å–®
            const itemInput = document.getElementById('item-input');
            const costInput = document.getElementById('cost-input');
            const noteInput = document.getElementById('note-input');
            if (itemInput) itemInput.value = '';
            if (costInput) costInput.value = '';
            if (noteInput) noteInput.value = '';
            
            // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç·¨è™Ÿ
            if (typeof recordNumber !== 'undefined') {
              recordNumber.textContent = ''; // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç·¨è™Ÿ
              recordNumber.style.display = 'none'; // éš±è—ç·¨è™Ÿ
            }
            
            // æ–°å¢ä¸‹ä¸€ç­†æ™‚ï¼Œã€Œè³‡æ–™æ™‚é–“ã€ä½¿ç”¨ç¾åœ¨æ™‚é–“
            if (typeof recordDate !== 'undefined') {
              recordDate.textContent = getNowFormattedDateTime();
            }
            
            // å¦‚æœæ˜¯æ”¯å‡ºï¼Œé‡ç½®é¡åˆ¥é¸æ“‡
            if (savedType === 'æ”¯å‡º') {
              const categorySelectElement = document.getElementById('expense-category-select');
              if (categorySelectElement && categorySelectElement.options.length > 0) {
                categorySelectElement.value = categorySelectElement.options[0].value;
                const selectContainer = categorySelectElement.parentElement;
                if (selectContainer) {
                  const selectDisplay = selectContainer.querySelector('div');
                  if (selectDisplay) {
                    const selectText = selectDisplay.querySelector('div');
                    if (selectText) {
                      selectText.textContent = categorySelectElement.options[0].textContent;
                    }
                  }
                }
              }
            }
            
            updateArrowButtons();
          }, 100);
        } else {
          // å¦‚æœä¸æ˜¯æ–°å¢æ¨¡å¼ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰ï¼Œé‡æ–°é¡¯ç¤ºå‰›æ‰ç·¨è¼¯çš„è¨˜éŒ„
          if (savedRecordNumber !== null) {
            // ç­‰å¾…éæ¿¾å®Œæˆå¾Œï¼Œæ‰¾åˆ°å‰›æ‰ç·¨è¼¯çš„è¨˜éŒ„ä¸¦é¡¯ç¤º
            // ä½¿ç”¨è¼ƒé•·çš„å»¶é²ï¼Œç¢ºä¿ loadContent å’Œ filterRecordsByType å®Œæˆ
            setTimeout(() => {
              const recordIndex = filteredRecords.findIndex(r => {
                const num = parseInt(r.row[0], 10);
                return Number.isFinite(num) && num > 0 && num === savedRecordNumber;
              });
              
              if (recordIndex >= 0) {
                currentRecordIndex = recordIndex;
                showRecord(recordIndex);
                updateArrowButtons();
              } else {
                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†
                if (filteredRecords.length > 0) {
                  currentRecordIndex = 0;
                  showRecord(0);
                  updateArrowButtons();
                }
              }
            }, 300);
          } else {
            // å¦‚æœæ‰¾ä¸åˆ°è¨˜éŒ„ç·¨è™Ÿï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†
            setTimeout(() => {
              if (filteredRecords.length > 0) {
                currentRecordIndex = 0;
                showRecord(0);
                updateArrowButtons();
              }
            }, 100);
          }
        }
      
      // ç¸½è¨ˆæ›´æ–°å®Œæˆå¾Œï¼Œæ‰é‚„åŸæŒ‰éˆ•ç‹€æ…‹
      saveButton.textContent = 'å„²å­˜';
      saveButton.disabled = false;
      saveButton.style.opacity = '1';
      saveButton.style.cursor = 'pointer';
      alreadyReset = true;
    } else {
      const errorMessage = result.message || result.error || 'æœªçŸ¥éŒ¯èª¤';
      alert('å„²å­˜å¤±æ•—: ' + errorMessage);
      // å¤±æ•—æ™‚é‚„åŸæŒ‰éˆ•ç‹€æ…‹
      saveButton.textContent = 'å„²å­˜';
      saveButton.disabled = false;
      saveButton.style.opacity = '1';
      saveButton.style.cursor = 'pointer';
      alreadyReset = true;
    }
  } catch (error) {
    alert('å„²å­˜å¤±æ•—: ' + error.message);
    // ä¾‹å¤–æ™‚é‚„åŸæŒ‰éˆ•ç‹€æ…‹
    saveButton.textContent = 'å„²å­˜';
    saveButton.disabled = false;
    saveButton.style.opacity = '1';
    saveButton.style.cursor = 'pointer';
    alreadyReset = true;
  } finally {
    // æ¢å¾©æ‰€æœ‰æŒ‰éˆ•å’Œè¼¸å…¥
    hideSpinner();
    if (!alreadyReset) {
      saveButton.textContent = 'å„²å­˜';
      saveButton.disabled = false;
      saveButton.style.opacity = '1';
      saveButton.style.cursor = 'pointer';
    }
    
    // æ¢å¾©æ‰€æœ‰è¼¸å…¥å’ŒæŒ‰éˆ•
    if (itemInput) itemInput.disabled = false;
    if (costInput) costInput.disabled = false;
    if (noteInput) noteInput.disabled = false;
    if (categorySelect) categorySelect.disabled = false;
    const expenseCategorySelect = document.getElementById('expense-category-select');
    if (expenseCategorySelect) expenseCategorySelect.disabled = false;
    leftArrow.disabled = false;
    rightArrow.disabled = false;
    deleteButton.disabled = false;
    if (monthSelect) monthSelect.disabled = false;
  }
};
 

const totalContainer = document.createElement('div');
totalContainer.className = 'total-container';

const budgetCardsContainer = document.createElement('div');
budgetCardsContainer.className = 'budget-cards-container';

const headerInfo = document.createElement('div');
headerInfo.className = 'header-info';

const recordNumber = document.createElement('div');
recordNumber.id = 'record-number';
recordNumber.textContent = '#001';

const recordDate = document.createElement('div');
recordDate.id = 'record-date';
recordDate.textContent = ''; // é¡¯ç¤ºæ¯ç­†è¨˜éŒ„çš„æ™‚é–“ï¼ˆä¾‹å¦‚è©¦ç®—è¡¨ä¸­çš„æœ€å¾Œä¿®æ­£æ™‚é–“ï¼‰

headerInfo.appendChild(recordNumber);
headerInfo.appendChild(recordDate);

// å°‡æœˆä»½ä¸‹æ‹‰é¸å–®æ”¾åœ¨é é¢æ¨™é¡Œå³å´ï¼ˆä¾‹å¦‚ã€Œé ç®—è¡¨ã€å³é‚Šï¼‰
document.addEventListener('DOMContentLoaded', () => {
  const titleEl = document.querySelector('.post-title');
  if (titleEl && monthSelectWrapper) {
    titleEl.appendChild(monthSelectWrapper);
  }
});

// åˆªé™¤æŒ‰éˆ•ï¼ˆåƒåœ¾æ¡¶ï¼‰
const deleteButton = document.createElement('button');
deleteButton.className = 'delete-button';
deleteButton.innerHTML = 'ğŸ—‘ï¸';

// åˆªé™¤ç•¶å‰è¨˜éŒ„çš„å‡½æ•¸ï¼ˆå¯è¢«æŒ‰éˆ•å’Œéµç›¤èª¿ç”¨ï¼‰
const deleteCurrentRecord = async () => {
  // æ–°å¢æ¨¡å¼ä¸èƒ½åˆªé™¤
  if (isNewMode) {
    alert('ç„¡æ³•åˆªé™¤ï¼šç›®å‰ç‚ºæ–°å¢æ¨¡å¼');
    return;
  }
  
  // ç¢ºèªåˆªé™¤
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
    return;
  }
  
  if (!filteredRecords.length || currentRecordIndex >= filteredRecords.length) {
    alert('ç„¡æ³•åˆªé™¤ï¼šæ‰¾ä¸åˆ°ç›®å‰è¨˜éŒ„');
    return;
  }
  
  const currentRecord = filteredRecords[currentRecordIndex];
  const recordNum = parseInt(currentRecord.row[0], 10);
  const recordType = currentRecord.type;
  
  if (!Number.isFinite(recordNum) || recordNum <= 0) {
    alert('ç„¡æ³•åˆªé™¤ï¼šæ‰¾ä¸åˆ°è¨˜éŒ„ç·¨è™Ÿ');
    return;
  }
  
  // ç¢ºå®š rangeType (0=æ”¯å‡º, 1=æ”¶å…¥)
  const rangeType = recordType === 'æ”¯å‡º' ? 0 : 1;
  
  // é–å®šæ•´å€‹é é¢ï¼Œç­‰å¾…å¾Œç«¯å›å‚³
  showSpinner();
  deleteButton.disabled = true;
  
  // ç¦ç”¨æ‰€æœ‰è¼¸å…¥å’ŒæŒ‰éˆ•
  const itemInput = document.getElementById('item-input');
  const costInput = document.getElementById('cost-input');
  const noteInput = document.getElementById('note-input');
  if (itemInput) itemInput.disabled = true;
  if (costInput) costInput.disabled = true;
  if (noteInput) noteInput.disabled = true;
  if (categorySelect) categorySelect.disabled = true;
  const expenseCategorySelect = document.getElementById('expense-category-select');
  if (expenseCategorySelect) expenseCategorySelect.disabled = true;
  leftArrow.disabled = true;
  rightArrow.disabled = true;
  saveButton.disabled = true;
  if (monthSelect) monthSelect.disabled = true;
  
  try {
    const postData = {
      name: "Delete Data",
      sheet: currentSheetIndex,
      range: rangeType,
      number: recordNum.toString() // ç¢ºä¿æ˜¯å­—ä¸²ï¼Œå› ç‚º Google Apps Script ç”¨å­—ä¸²æ¯”è¼ƒ
    };
    
    const response = await fetch(base, {
      method: "POST",
      redirect: "follow",
      mode: "cors",
      keepalive: true,
      headers: {
        "Content-Type": "text/plain;charset=utf-8",
      },
      body: JSON.stringify(postData)
    });
    
    const responseText = await response.text();
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (e) {
      throw new Error('å¾Œç«¯éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤: ' + responseText);
    }
    
    if (response.ok && result.success) {
      alert('è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ï¼');
      
      // å¦‚æœ Apps Script å›å‚³äº† data å’Œ totalï¼Œç›´æ¥ä½¿ç”¨ï¼Œå¦å‰‡é‡æ–°è¼‰å…¥
      if (result.data && result.total) {
        // æ›´æ–°è¨˜æ†¶é«”ä¸­ç•¶å‰æœˆä»½çš„è³‡æ–™
        allMonthsData[currentSheetIndex] = {
          data: result.data,
          total: result.total
        };
        
        // ä½¿ç”¨å›å‚³çš„è³‡æ–™æ›´æ–°è¨˜éŒ„å’Œç¸½è¨ˆ
        processDataFromResponse(result.data, false);
        updateTotalDisplay(result.total);
        
        // æ ¹æ“šç•¶å‰é¡å‹é‡æ–°éæ¿¾è¨˜éŒ„
        const currentType = categorySelect ? categorySelect.value : recordType;
        filterRecordsByType(currentType);
        
        // ç­‰å¾…éæ¿¾å®Œæˆå¾Œå†é¡¯ç¤ºè¨˜éŒ„
        await new Promise(r => setTimeout(r, 100));
      } else {
        // é‡æ–°è¼‰å…¥è¨˜éŒ„ï¼ˆä¸¦æ›´æ–°è¨˜æ†¶é«”ï¼‰
      await new Promise(r => setTimeout(r, 200));
        await loadContent(true); // å¼·åˆ¶é‡æ–°è¼‰å…¥
      }
      
      // åˆªé™¤å¾Œï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†ï¼ˆå¦‚æœé‚„æœ‰è¨˜éŒ„ï¼‰
      await new Promise(r => setTimeout(r, 100));
        if (filteredRecords.length > 0) {
          currentRecordIndex = 0;
          showRecord(0);
          updateArrowButtons();
        } else {
          // æ²’æœ‰è¨˜éŒ„æ™‚ï¼Œé€²å…¥æ–°å¢æ¨¡å¼
          isNewMode = true;
          updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
          const itemInput = document.getElementById('item-input');
          const costInput = document.getElementById('cost-input');
          const noteInput = document.getElementById('note-input');
          if (itemInput) itemInput.value = '';
          if (costInput) costInput.value = '';
          if (noteInput) noteInput.value = '';
          if (typeof recordNumber !== 'undefined') {
          recordNumber.textContent = ''; // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç·¨è™Ÿ
          recordNumber.style.display = 'none'; // éš±è—ç·¨è™Ÿ
          }
          // æ–°å¢æ¨¡å¼ç„¡è³‡æ–™æ™‚ï¼Œè³‡æ–™æ™‚é–“ä½¿ç”¨ç¾åœ¨æ™‚é–“
          if (typeof recordDate !== 'undefined') {
          recordDate.value = getNowFormattedDateTime();
          }
          updateArrowButtons();
        }
    } else {
      const errorMessage = result.message || result.error || 'æœªçŸ¥éŒ¯èª¤';
      alert('åˆªé™¤å¤±æ•—: ' + errorMessage);
    }
  } catch (error) {
    alert('åˆªé™¤å¤±æ•—: ' + error.message);
  } finally {
    // æ¢å¾©æ‰€æœ‰æŒ‰éˆ•å’Œè¼¸å…¥
    hideSpinner();
    deleteButton.disabled = false;
    
    // æ¢å¾©æ‰€æœ‰è¼¸å…¥å’ŒæŒ‰éˆ•
    const itemInput = document.getElementById('item-input');
    const costInput = document.getElementById('cost-input');
    const noteInput = document.getElementById('note-input');
    if (itemInput) itemInput.disabled = false;
    if (costInput) costInput.disabled = false;
    if (noteInput) noteInput.disabled = false;
    if (categorySelect) categorySelect.disabled = false;
    const expenseCategorySelect = document.getElementById('expense-category-select');
    if (expenseCategorySelect) expenseCategorySelect.disabled = false;
    leftArrow.disabled = false;
    rightArrow.disabled = false;
    saveButton.disabled = false;
    if (monthSelect) monthSelect.disabled = false;
  }
};

// åƒåœ¾æ¡¶æŒ‰éˆ•é»æ“Šäº‹ä»¶
deleteButton.addEventListener('click', deleteCurrentRecord);

// æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
function updateDeleteButton() {
  // æ–°å¢æ¨¡å¼æ™‚éš±è—åˆªé™¤æŒ‰éˆ•
  if (isNewMode) {
    deleteButton.style.display = 'none';
  } else {
    deleteButton.style.display = 'flex';
  }
}

const leftArrow = document.createElement('button');
leftArrow.className = 'arrow-button left';
leftArrow.innerHTML = 'â€¹';

const rightArrow = document.createElement('button');
rightArrow.className = 'arrow-button right';
rightArrow.innerHTML = 'â€º';

// å·¦å³éµåˆ‡æ›æ‰€æœ‰è¨˜éŒ„
// æ›´æ–°ç®­é ­æŒ‰éˆ•ç‹€æ…‹
function updateArrowButtons() {
  // å¦‚æœæ²’æœ‰è¨˜éŒ„ä¸”æ˜¯æ–°å¢æ¨¡å¼ï¼Œéš±è—æ‰€æœ‰ç®­é ­
  if (!filteredRecords.length && isNewMode) {
    leftArrow.style.display = 'none';
    rightArrow.style.display = 'none';
    return;
  }
  
  // å¦‚æœæ²’æœ‰è¨˜éŒ„ä¸”ä¸æ˜¯æ–°å¢æ¨¡å¼ï¼Œä¹Ÿéš±è—æ‰€æœ‰ç®­é ­
  if (!filteredRecords.length && !isNewMode) {
    leftArrow.style.display = 'none';
    rightArrow.style.display = 'none';
    return;
  }
  
  // å¦‚æœæœ‰è¨˜éŒ„ï¼Œæ­£å¸¸é¡¯ç¤ºç®­é ­
  // å¦‚æœåœ¨æ–°å¢æ¨¡å¼ï¼Œå·¦ç®­é ­é¡¯ç¤ºåŠ è™Ÿ
  if (isNewMode) {
    leftArrow.style.display = 'flex';
    leftArrow.innerHTML = '+';
    leftArrow.classList.add('plus');
  } else {
    // å¦‚æœåœ¨ç¬¬ä¸€ç­†è¨˜éŒ„ï¼Œéš±è—å·¦ç®­é ­
    if (currentRecordIndex === 0) {
    leftArrow.style.display = 'none';
  } else {
  leftArrow.style.display = 'flex';
      leftArrow.innerHTML = 'â€¹';
      leftArrow.classList.remove('plus');
    }
  }
  
  rightArrow.style.display = 'flex';
  
  // å¦‚æœåœ¨æ–°å¢æ¨¡å¼æˆ–æœ€å¾Œä¸€ç­†ï¼Œå³ç®­é ­è®ŠæˆåŠ è™Ÿ
  if (isNewMode || currentRecordIndex === filteredRecords.length - 1) {
    rightArrow.innerHTML = '+';
    rightArrow.classList.add('plus');
  } else {
    rightArrow.innerHTML = 'â€º';
    rightArrow.classList.remove('plus');
  }
}

// åˆ‡æ›åˆ°ä¸Šä¸€ç­†è¨˜éŒ„
function goToPreviousRecord() {
  // å¦‚æœåœ¨æ–°å¢æ¨¡å¼ï¼Œé»æ“Šå·¦ç®­é ­ï¼ˆåŠ è™Ÿï¼‰é€²å…¥æ–°å¢æ¨¡å¼
  if (isNewMode) {
    // å·²ç¶“åœ¨æ–°å¢æ¨¡å¼ï¼Œä¸éœ€è¦åšä»€éº¼ï¼Œæˆ–è€…å¯ä»¥é‡æ–°æ¸…ç©ºè¡¨å–®
    return;
  }
  
  if (!filteredRecords.length) return;
  
  // ç¢ºä¿ currentRecordIndex åœ¨æœ‰æ•ˆç¯„åœå…§
  if (currentRecordIndex >= filteredRecords.length) {
    currentRecordIndex = filteredRecords.length - 1;
  }
  
    currentRecordIndex = Math.max(0, currentRecordIndex - 1);
    if (currentRecordIndex < filteredRecords.length) {
    showRecord(currentRecordIndex);
    }
    updateArrowButtons();
}

// åˆ‡æ›åˆ°ä¸‹ä¸€ç­†è¨˜éŒ„æˆ–é€²å…¥æ–°å¢æ¨¡å¼
function goToNextRecord() {
  if (!filteredRecords.length) return;
  
  // ç¢ºä¿ currentRecordIndex åœ¨æœ‰æ•ˆç¯„åœå…§
  if (currentRecordIndex >= filteredRecords.length) {
    currentRecordIndex = filteredRecords.length - 1;
  }
  
  // å¦‚æœåœ¨æœ€å¾Œä¸€ç­†æˆ–æ–°å¢æ¨¡å¼ï¼Œé€²å…¥æ–°å¢æ¨¡å¼
  if (currentRecordIndex === filteredRecords.length - 1 || isNewMode) {
    isNewMode = true; // é€²å…¥æ–°å¢æ¨¡å¼
    updateDeleteButton(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º
    
    // æ¸…ç©ºè¡¨å–®ï¼Œæº–å‚™æ–°å¢
    const itemInput = document.getElementById('item-input');
    const costInput = document.getElementById('cost-input');
    const noteInput = document.getElementById('note-input');
    if (itemInput) itemInput.value = '';
    if (costInput) costInput.value = '';
    if (noteInput) noteInput.value = '';
    
    // è¨ˆç®—ä¸‹ä¸€å€‹ç·¨è™Ÿï¼ˆç›®å‰é¡å‹ä¸­æœ€å¤§çš„ç·¨è™Ÿ + 1ï¼‰
    let nextNumber = 1;
    if (filteredRecords.length > 0) {
      const maxNum = Math.max(
        ...filteredRecords
          .map(r => parseInt(r.row[0], 10))
          .filter(n => Number.isFinite(n) && n > 0)
      );
      if (Number.isFinite(maxNum) && maxNum > 0) {
        nextNumber = maxNum + 1;
      }
    }
    
    // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç·¨è™Ÿ
    if (typeof recordNumber !== 'undefined') {
      recordNumber.textContent = ''; // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç·¨è™Ÿ
      recordNumber.style.display = 'none'; // éš±è—ç·¨è™Ÿ
    }
    
    // æ–°å¢æ¨¡å¼çš„ã€Œè³‡æ–™æ™‚é–“ã€ä½¿ç”¨ç¾åœ¨æ™‚é–“
    if (typeof recordDate !== 'undefined') {
      recordDate.textContent = getNowFormattedDateTime();
    }
    
    updateArrowButtons();
  } else {
    currentRecordIndex = Math.min(filteredRecords.length - 1, currentRecordIndex + 1);
    showRecord(currentRecordIndex);
    updateArrowButtons();
  }
}

// ç®­é ­æŒ‰éˆ•äº‹ä»¶
leftArrow.addEventListener('click', goToPreviousRecord);
rightArrow.addEventListener('click', goToNextRecord);

// åˆ‡æ›æ”¶å…¥/æ”¯å‡ºé¡å‹
function switchType(targetType) {
    // ç¢ºä¿ categorySelect å…ƒç´ å­˜åœ¨
    const categorySelectElement = document.getElementById('category-select');
    if (!categorySelectElement) {
      return; // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
    }
    
    const currentType = categorySelectElement.value || 'æ”¯å‡º';
    
    // å¦‚æœç›®æ¨™é¡å‹èˆ‡ç•¶å‰é¡å‹ä¸åŒï¼Œå‰‡åˆ‡æ›
    if (currentType !== targetType) {
      // åœ¨éæ–°å¢æ¨¡å¼ä¸‹ï¼Œä¿å­˜ç•¶å‰è¨˜éŒ„ç·¨è™Ÿï¼Œä»¥ä¾¿åœ¨ç›®æ¨™é¡å‹ä¸­æŸ¥æ‰¾ç›¸åŒç·¨è™Ÿçš„è¨˜éŒ„
      // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°å¢æ¨¡å¼ï¼šå¦‚æœ isNewMode ç‚º true æˆ–æ²’æœ‰è¨˜éŒ„ï¼Œå‰‡ç‚ºæ–°å¢æ¨¡å¼
      const isActuallyNewMode = isNewMode || (filteredRecords.length === 0);
      
      if (!isActuallyNewMode) {
        // å„ªå…ˆå¾ç•¶å‰è¨˜éŒ„ç²å–ç·¨è™Ÿ
        if (filteredRecords.length > 0 && currentRecordIndex < filteredRecords.length) {
          const currentRecord = filteredRecords[currentRecordIndex];
          const recordNum = parseInt(currentRecord.row[0], 10);
          if (Number.isFinite(recordNum) && recordNum > 0) {
            currentRecordNumber = recordNum; // ä¿å­˜ç•¶å‰ç·¨è™Ÿ
          }
        }
        // å¦‚æœå¾è¨˜éŒ„ç²å–å¤±æ•—ï¼Œå˜—è©¦å¾é¡¯ç¤ºçš„ç·¨è™Ÿå…ƒç´ ä¸­è®€å–
        if (currentRecordNumber === null && typeof recordNumber !== 'undefined') {
          const recordNumText = recordNumber.textContent;
          const match = recordNumText.match(/#(\d+)/);
          if (match && match[1]) {
            const recordNum = parseInt(match[1], 10);
            if (Number.isFinite(recordNum) && recordNum > 0) {
              currentRecordNumber = recordNum;
            }
          }
        }
      }
      
      // å…ˆæ›´æ–°å…¨å±€è®Šæ•¸ï¼Œé€™æ¨£ updateDivVisibility æ‰èƒ½è®€å–åˆ°æ­£ç¢ºçš„å€¼
      if (typeof categorySelect !== 'undefined') {
        categorySelect.value = targetType;
      }
      
      // æ›´æ–° DOM å…ƒç´ 
      categorySelectElement.value = targetType;
      
      // æ›´æ–°é¡¯ç¤ºæ–‡å­—
      const selectContainer = categorySelectElement.parentElement;
      if (selectContainer) {
        const selectDisplay = selectContainer.querySelector('div');
        if (selectDisplay) {
          const selectText = selectDisplay.querySelector('div');
          if (selectText) {
            selectText.textContent = targetType;
          }
        }
      }
      
      // å…ˆæ›´æ–° UI å…ƒç´ é¡¯ç¤ºï¼ˆç‰¹åˆ¥æ˜¯æ”¯å‡º/æ”¶å…¥çš„æ¬„ä½åˆ‡æ›ï¼‰
      if (typeof updateDivVisibility === 'function') {
        updateDivVisibility();
      }
      
      // ç„¶å¾Œéæ¿¾è¨˜éŒ„ä¸¦æ›´æ–° UIï¼ˆfilterRecordsByType æœƒè‡ªå‹•è™•ç†ç›¸åŒç·¨è™Ÿçš„æŸ¥æ‰¾ï¼‰
      // ä½¿ç”¨ setTimeout ç¢ºä¿ updateDivVisibility å®Œæˆå¾Œå†åŸ·è¡Œ
      setTimeout(() => {
      // updateDivVisibility æœƒé‡æ–°å‰µå»º expense-category-select å…ƒç´ ï¼Œéœ€è¦é‡æ–°ç²å–ä¸¦æ›´æ–°
      const newCategorySelectElement = document.getElementById('expense-category-select');
        if (newCategorySelectElement) {
          // æ›´æ–°æ–°å‰µå»ºçš„å…ƒç´ çš„å€¼ï¼ˆå¦‚æœç›®æ¨™é¡å‹æ˜¯æ”¯å‡ºï¼Œè¨­ç½®ç¬¬ä¸€å€‹é¸é …ï¼›å¦‚æœæ˜¯æ”¶å…¥ï¼Œä¸éœ€è¦è¨­ç½®ï¼‰
          if (targetType === 'æ”¯å‡º' && newCategorySelectElement.options.length > 0) {
            newCategorySelectElement.value = newCategorySelectElement.options[0].value;
            // åŒæ­¥æ›´æ–°è‡ªè¨‚ä¸‹æ‹‰é¡¯ç¤ºæ–‡å­—
            const newSelectContainer = newCategorySelectElement.parentElement;
            if (newSelectContainer) {
              const newSelectDisplay = newSelectContainer.querySelector('div');
              if (newSelectDisplay) {
                const newSelectText = newSelectDisplay.querySelector('div');
                if (newSelectText) {
                  newSelectText.textContent = newCategorySelectElement.options[0].textContent;
                }
              }
            }
          }
          
          // æ›´æ–°å…¨å±€è®Šæ•¸çš„ value å±¬æ€§ï¼ˆé›–ç„¶å…ƒç´ å·²æ›´æ›ï¼Œä½†æˆ‘å€‘å¯ä»¥é€šéæ›´æ–°å±¬æ€§ä¾†ä¿æŒä¸€è‡´æ€§ï¼‰
          // å¯¦éš›ä¸Šï¼Œç”±æ–¼ categorySelect æ˜¯ constï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿å¾ŒçºŒä»£ç¢¼ä½¿ç”¨ getElementById ç²å–æœ€æ–°å…ƒç´ 
          // ä½†ç‚ºäº†å…¼å®¹æ€§ï¼Œæˆ‘å€‘ä¹Ÿæ›´æ–°å…¨å±€è®Šæ•¸çš„ valueï¼ˆå¦‚æœå…ƒç´ é‚„å­˜åœ¨çš„è©±ï¼‰
          if (typeof categorySelect !== 'undefined' && categorySelect.parentNode) {
            categorySelect.value = targetType;
          }
        }
        
        if (typeof filterRecordsByType === 'function') {
          filterRecordsByType(targetType);
        }
        
        // æ›´æ–°ç›¸é—œ UI å…ƒç´ 
        if (typeof updateArrowButtons === 'function') {
          updateArrowButtons();
        }
        if (typeof updateDeleteButton === 'function') {
          updateDeleteButton();
        }
      }, 200);
  }
}

// éµç›¤äº‹ä»¶ï¼ˆé›»è…¦å·¦å³éµåˆ‡æ›è¨˜éŒ„ï¼Œä¸Šä¸‹éµåˆ‡æ›æ”¶å…¥/æ”¯å‡ºï¼ŒDeleteéµåˆªé™¤è¨˜éŒ„ï¼‰
document.addEventListener('keydown', (e) => {
  // å¦‚æœæ­£åœ¨è¼¸å…¥æ–‡å­—ï¼Œä¸è§¸ç™¼åˆ‡æ›ï¼ˆä½†Deleteéµé™¤å¤–ï¼Œå› ç‚ºå®ƒæœ¬èº«å°±æ˜¯ç”¨æ–¼åˆªé™¤çš„ï¼‰
  const activeElement = document.activeElement;
  if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
    // Deleteéµåœ¨è¼¸å…¥æ¡†ä¸­æ™‚ï¼Œåªåˆªé™¤æ–‡å­—ï¼Œä¸è§¸ç™¼è¨˜éŒ„åˆªé™¤
    if (e.key === 'Delete' || e.key === 'Backspace') {
      return;
    }
    return;
  }
  
  if (e.key === 'ArrowLeft') {
    e.preventDefault();
    goToPreviousRecord();
  } else if (e.key === 'ArrowRight') {
    e.preventDefault();
    goToNextRecord();
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    // å‘ä¸Šéµ = åˆ‡æ›åˆ°æ”¶å…¥
    switchType('æ”¶å…¥');
  } else if (e.key === 'ArrowDown') {
    e.preventDefault();
    // å‘ä¸‹éµ = åˆ‡æ›åˆ°æ”¯å‡º
    switchType('æ”¯å‡º');
  } else if (e.key === 'Delete' || e.key === 'Backspace') {
    e.preventDefault();
    // Deleteéµæˆ–Backspaceéµ = åˆªé™¤ç•¶å‰è¨˜éŒ„
    deleteCurrentRecord();
  }
});

// è§¸æ‘¸æ»‘å‹•äº‹ä»¶ï¼ˆæ‰‹æ©Ÿå·¦å³æ»‘å‹•åˆ‡æ›è¨˜éŒ„ï¼Œä¸Šä¸‹æ»‘å‹•åˆ‡æ›æ”¶å…¥/æ”¯å‡ºï¼‰
let touchStartX = 0;
let touchEndX = 0;
let touchStartY = 0;
let touchEndY = 0;
let isSwiping = false;
let swipeDirection = null; // 'horizontal' æˆ– 'vertical'

budgetCardsContainer.addEventListener('touchstart', (e) => {
  touchStartX = e.changedTouches[0].screenX;
  touchStartY = e.changedTouches[0].screenY;
  isSwiping = false;
  swipeDirection = null;
}, { passive: true });

budgetCardsContainer.addEventListener('touchmove', (e) => {
  // å¦‚æœå·²ç¶“ç¢ºå®šäº†æ–¹å‘ï¼Œç›´æ¥è™•ç†
  if (swipeDirection === 'vertical') {
    // å¦‚æœæ˜¯å‚ç›´æ»‘å‹•ï¼Œé˜»æ­¢é é¢æ»¾å‹•ï¼ˆåªåœ¨äº‹ä»¶å¯å–æ¶ˆæ™‚ï¼‰
    if (e.cancelable) {
      e.preventDefault();
    }
    return;
  }
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºæ°´å¹³æˆ–å‚ç›´æ»‘å‹•
  const currentX = e.changedTouches[0].screenX;
  const currentY = e.changedTouches[0].screenY;
  const deltaX = Math.abs(currentX - touchStartX);
  const deltaY = Math.abs(currentY - touchStartY);
  
  // å¦‚æœç§»å‹•è·é›¢è¶³å¤ å¤§ï¼ˆé™ä½é–¾å€¼ä»¥æ›´æ—©åˆ¤æ–·ï¼‰ï¼Œåˆ¤æ–·æ»‘å‹•æ–¹å‘
  if (deltaX > 5 || deltaY > 5) {
    if (deltaX > deltaY && deltaX > 10) {
      // æ°´å¹³æ»‘å‹•
      swipeDirection = 'horizontal';
      isSwiping = true;
    } else if (deltaY > deltaX && deltaY > 10) {
      // å‚ç›´æ»‘å‹• - ç«‹å³é˜»æ­¢é é¢æ»¾å‹•
      swipeDirection = 'vertical';
      isSwiping = true;
      // åªåœ¨äº‹ä»¶å¯å–æ¶ˆæ™‚é˜»æ­¢é é¢æ»¾å‹•
      if (e.cancelable) {
        e.preventDefault();
      }
    }
  }
}, { passive: false });

budgetCardsContainer.addEventListener('touchend', (e) => {
  touchEndX = e.changedTouches[0].screenX;
  touchEndY = e.changedTouches[0].screenY;
  
  // ä¿å­˜æ»‘å‹•æ–¹å‘ï¼Œå› ç‚º handleSwipe éœ€è¦ä½¿ç”¨å®ƒ
  const currentSwipeDirection = swipeDirection;
  
  if (isSwiping && currentSwipeDirection) {
    handleSwipe(currentSwipeDirection);
  }
  
  isSwiping = false;
  swipeDirection = null;
}, { passive: true });

function handleSwipe(direction) {
  const deltaX = touchEndX - touchStartX;
  const deltaY = touchEndY - touchStartY;
  
  // æ ¹æ“šå·²ç¢ºå®šçš„æ»‘å‹•æ–¹å‘è™•ç†
  if (direction === 'horizontal') {
    // è™•ç†æ°´å¹³æ»‘å‹•ï¼ˆæ°´å¹³è·é›¢å¤§æ–¼ 50pxï¼‰
    if (Math.abs(deltaX) > 50) {
      if (deltaX > 0) {
        // å‘å³æ»‘å‹• = ä¸Šä¸€ç­†
        goToPreviousRecord();
      } else {
        // å‘å·¦æ»‘å‹• = ä¸‹ä¸€ç­†
        goToNextRecord();
      }
    }
  } else if (direction === 'vertical') {
    // è™•ç†å‚ç›´æ»‘å‹•ï¼ˆå‚ç›´è·é›¢å¤§æ–¼ 50pxï¼‰
    if (Math.abs(deltaY) > 50) {
      if (deltaY > 0) {
        // å‘ä¸‹æ»‘å‹• = åˆ‡æ›åˆ°æ”¯å‡º
        switchType('æ”¯å‡º');
      } else {
        // å‘ä¸Šæ»‘å‹• = åˆ‡æ›åˆ°æ”¶å…¥
        switchType('æ”¶å…¥');
      }
    }
  }
}

const div1 = document.createElement('div');
div1.className = 'category-select-row';

const categoryLabel = document.createElement('label');
categoryLabel.className = 'category-select-label';
categoryLabel.textContent = 'é¡åˆ¥ï¼š';
categoryLabel.htmlFor = 'category-select'; // é—œè¯åˆ° select

const categorySelectContainer = document.createElement('div');
categorySelectContainer.className = 'category-select-container';

const categorySelectDisplay = document.createElement('div');
categorySelectDisplay.className = 'category-select-display';

const categorySelectText = document.createElement('div');
categorySelectText.className = 'category-select-text';
categorySelectText.textContent = 'æ”¯å‡º';

const categorySelectArrow = document.createElement('div');
categorySelectArrow.className = 'category-select-arrow';
categorySelectArrow.textContent = 'â–¼';

categorySelectDisplay.appendChild(categorySelectText);
categorySelectDisplay.appendChild(categorySelectArrow);

const categorySelect = document.createElement('select');
categorySelect.id = 'category-select'; // æ·»åŠ  id ä»¥æ”¯æŒ label é—œè¯
categorySelect.name = 'category-select'; // æ·»åŠ  name å±¬æ€§ä»¥æ”¯æŒè‡ªå‹•å¡«å……
categorySelect.style.display = 'none';
categorySelect.value = 'æ”¯å‡º';
const optionExpense = document.createElement('option');
optionExpense.value = 'æ”¯å‡º';
optionExpense.textContent = 'æ”¯å‡º';
const optionIncome = document.createElement('option');
optionIncome.value = 'æ”¶å…¥';
optionIncome.textContent = 'æ”¶å…¥';
categorySelect.appendChild(optionExpense);
categorySelect.appendChild(optionIncome);

const categoryDropdown = document.createElement('div');
categoryDropdown.className = 'category-dropdown';

const categoryOption1 = document.createElement('div');
categoryOption1.className = 'category-option';
categoryOption1.textContent = 'æ”¯å‡º';
categoryOption1.dataset.value = 'æ”¯å‡º';
categoryOption1.addEventListener('click', function() {
  categorySelectText.textContent = 'æ”¯å‡º';
  categorySelect.value = 'æ”¯å‡º';
  categoryDropdown.style.display = 'none';
  categorySelectArrow.style.transform = 'rotate(0deg)';
  categorySelect.dispatchEvent(new Event('change'));
});

const categoryOption2 = document.createElement('div');
categoryOption2.className = 'category-option';
categoryOption2.textContent = 'æ”¶å…¥';
categoryOption2.dataset.value = 'æ”¶å…¥';
categoryOption2.addEventListener('click', function() {
  categorySelectText.textContent = 'æ”¶å…¥';
  categorySelect.value = 'æ”¶å…¥';
  categoryDropdown.style.display = 'none';
  categorySelectArrow.style.transform = 'rotate(0deg)';
  categorySelect.dispatchEvent(new Event('change'));
});

categoryDropdown.appendChild(categoryOption1);
categoryDropdown.appendChild(categoryOption2);

categorySelectDisplay.addEventListener('click', function(e) {
  e.stopPropagation();
  const isOpen = categoryDropdown.style.display === 'block';
  categoryDropdown.style.display = isOpen ? 'none' : 'block';
  categorySelectArrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
});

document.addEventListener('click', function(e) {
  if (!categorySelectContainer.contains(e.target)) {
    categoryDropdown.style.display = 'none';
    categorySelectArrow.style.transform = 'rotate(0deg)';
  }
});

categorySelectContainer.appendChild(categorySelectDisplay);
categorySelectContainer.appendChild(categoryDropdown);
categorySelectContainer.appendChild(categorySelect);

const itemContainer = document.createElement('div');
itemContainer.className = 'item-container';
itemContainer.className = 'item-container';

const itemTitleInput = document.createElement('input');
itemTitleInput.id = 'item-input';
itemTitleInput.name = 'item-input'; // æ·»åŠ  name å±¬æ€§ä»¥æ”¯æŒè‡ªå‹•å¡«å……
itemTitleInput.type = 'text';
itemTitleInput.placeholder = 'è¼¸å…¥é …ç›®åç¨±...';


itemContainer.appendChild(itemTitleInput);

const div2 = document.createElement('div');
div2.style.display = 'none';
const div3 = document.createElement('div');
div3.style.display = 'none';
const div4 = document.createElement('div');
div4.style.display = 'none';

const saveButton = document.createElement('button');
saveButton.textContent = 'å„²å­˜';
saveButton.className = 'save-button';

const columnsContainer = document.createElement('div');
columnsContainer.className = 'columns-container';

const incomeColumn = document.createElement('div');
incomeColumn.className = 'income-column';

const incomeTitle = document.createElement('h3');
incomeTitle.className = 'income-title';
incomeTitle.textContent = 'æ”¶å…¥ï¼š';

const incomeAmount = document.createElement('div');
incomeAmount.className = 'income-amount';
incomeAmount.textContent = 0;

const expenseColumn = document.createElement('div');
expenseColumn.className = 'expense-column';

const expenseTitle = document.createElement('h3');
expenseTitle.className = 'expense-title';
expenseTitle.textContent = 'æ”¯å‡ºï¼š';

const expenseAmount = document.createElement('div');
expenseAmount.className = 'expense-amount';
expenseAmount.textContent = 0;

const totalColumn = document.createElement('div');
totalColumn.className = 'total-column';

const totalTitle = document.createElement('h3');
totalTitle.className = 'total-title';
totalTitle.textContent = 'ç¸½è¨ˆï¼š';

const totalAmount = document.createElement('div');
totalAmount.className = 'total-amount';
totalAmount.textContent = 0;

const updateTotalColor = (value) => {
  const numValue = parseFloat(value) || 0;
  totalAmount.classList.remove('positive', 'negative');
  totalTitle.classList.remove('positive', 'negative');
  if (numValue > 0) {
    totalAmount.classList.add('positive');
    totalTitle.classList.add('positive');
  } else if (numValue < 0) {
    totalAmount.classList.add('negative');
    totalTitle.classList.add('negative');
  }
};

// æœˆä»½é¸æ“‡ä¸‹æ‹‰ï¼ˆç½®æ–¼åœ“é¤…åœ–ä¸Šæ–¹ï¼‰
let monthSelect = null;
const monthSelectWrapper = document.createElement('div');
monthSelectWrapper.className = 'month-select-wrapper';

const monthSelectLabel = document.createElement('span');
monthSelectLabel.className = 'month-select-label';
monthSelectLabel.textContent = 'æœˆä»½ï¼š';

monthSelect = document.createElement('select');
monthSelect.id = 'month-select';
monthSelect.name = 'month-select';
monthSelect.className = 'month-select';

monthSelectWrapper.appendChild(monthSelectLabel);
monthSelectWrapper.appendChild(monthSelect);

const submitContainer = document.createElement('div');
submitContainer.style.width = '100%';
submitContainer.style.display = 'flex';
submitContainer.style.justifyContent = 'center';
submitContainer.style.padding = '0';

// è¼‰å…¥æœˆä»½åˆ—è¡¨
async function loadMonthNames() {
    const params = { name: "Show Tab Name" };
  const url = `${base}?${new URLSearchParams(params)}&_t=${Date.now()}`;
  const res = await fetch(url, {
      method: "GET",
      redirect: "follow",
    mode: "cors",
    cache: "no-store"
    });
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    
    if (!Array.isArray(data) || data.length === 0) {
    return [];
    }
    
    sheetNames = data;
  return sheetNames;
}

// åˆå§‹åŒ–æœˆä»½ä¸‹æ‹‰é¸å–®
const initMonthSelect = async () => {
  if (!monthSelect) return;
  
  try {
    // è¼‰å…¥æœˆä»½åˆ—è¡¨
    await loadMonthNames();
    
    if (sheetNames.length === 0) {
      return;
    }
    
    // æª¢æŸ¥ç•¶å‰æœˆä»½æ˜¯å¦å·²æœ‰è¡¨æ ¼ï¼Œè‹¥æ²’æœ‰å‰‡è«‹å¾Œç«¯å»ºç«‹ï¼ˆæ”¯å‡ºè¡¨å’Œé ç®—è¡¨éƒ½éœ€è¦ï¼‰
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const currentMonthStr = `${year}${month}`;
    const hasCurrentMonth = sheetNames.includes(currentMonthStr);
    
    if (!hasCurrentMonth) {
      try {
        const createResult = await callAPI({ name: "Create Tab" });
        alert(createResult.message || `å·²å»ºç«‹æ–°åˆ†é ï¼š${currentMonthStr}`);
        // é‡æ–°è¼‰å…¥æœˆä»½åˆ—è¡¨
        await loadMonthNames();
      } catch (createError) {
        alert('ç„¡æ³•è‡ªå‹•å»ºç«‹æœ¬æœˆè¡¨æ ¼ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æ‰‹å‹•å»ºç«‹ã€‚');
      }
    }
    
    // æ¸…ç©ºèˆŠé¸é …
    monthSelect.innerHTML = '';
    
    // å»ºç«‹é¸é …
    sheetNames.forEach((name, idx) => {
      const opt = document.createElement('option');
      opt.value = String(idx);
      opt.textContent = name;
      monthSelect.appendChild(opt);
    });
    
    // é¸æ“‡æœ€æ¥è¿‘ç•¶å‰æœˆä»½çš„åˆ†é 
    const closestSheetIndex = findClosestMonth();
    currentSheetIndex = closestSheetIndex;
    const selectIndex = currentSheetIndex - 2;
    if (selectIndex >= 0 && selectIndex < sheetNames.length) {
      monthSelect.value = String(selectIndex);
    }
    
    // å„ªå…ˆè¼‰å…¥ç•¶å‰æœˆä»½ä¸¦ç«‹å³é¡¯ç¤ºï¼Œå…¶ä»–æœˆä»½åœ¨èƒŒæ™¯è¼‰å…¥
    // æ³¨æ„ï¼šspinner å·²åœ¨ DOMContentLoaded æ™‚é¡¯ç¤ºï¼Œé€™è£¡ä¸éœ€è¦å†é¡¯ç¤º
    try {
      // å…ˆè¼‰å…¥ç•¶å‰æœˆä»½è³‡æ–™ä¸¦ç«‹å³é¡¯ç¤º
      const currentMonthData = await loadMonthData(currentSheetIndex);
      allMonthsData[currentSheetIndex] = currentMonthData;
      
      // ç«‹å³è™•ç†ä¸¦é¡¯ç¤ºç•¶å‰æœˆä»½è³‡æ–™
      processDataFromResponse(currentMonthData.data);
      updateTotalDisplay(currentMonthData.total);
      enterNewModeIfEmpty();
      updateDeleteButton();
      updateArrowButtons();
      
      // é—œé–‰è¼‰å…¥é®ç½©ï¼Œè®“ç”¨æˆ¶å¯ä»¥ç«‹å³æ“ä½œ
      hideSpinner();
      
      // åœ¨èƒŒæ™¯é è¼‰å…¶ä»–æœˆä»½çš„è³‡æ–™ï¼ˆä¸é˜»å¡ï¼‰
      preloadAllMonthsData().catch(() => {
        // èƒŒæ™¯é è¼‰å¤±æ•—ä¸å½±éŸ¿ç•¶å‰æ“ä½œ
      });
    } catch (e) {
      hideSpinner();
      // å¦‚æœç•¶å‰æœˆä»½è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦å¾è¨˜æ†¶é«”è®€å–
      if (loadContentFromMemory()) {
        enterNewModeIfEmpty();
        updateDeleteButton();
        updateArrowButtons();
      }
      
      // åœ¨èƒŒæ™¯é è¼‰å…¶ä»–æœˆä»½çš„è³‡æ–™ï¼ˆä¸é˜»å¡ï¼‰
      preloadAllMonthsData().catch(() => {
        // èƒŒæ™¯é è¼‰å¤±æ•—ä¸å½±éŸ¿ç•¶å‰æ“ä½œ
      });
    }
    
    // ä¸‹æ‹‰é¸å–®è®Šæ›´æ™‚ï¼Œåˆ‡æ›æœˆä»½ï¼ˆå¾è¨˜æ†¶é«”è®€å–ï¼Œä¸ç™¼é€è«‹æ±‚ï¼‰
    // å…ˆç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (monthSelectChangeHandler) {
      monthSelect.removeEventListener('change', monthSelectChangeHandler);
    }
    
    monthSelectChangeHandler = async () => {
      // é˜²æ­¢å¿«é€Ÿé€£çºŒåˆ‡æ›
      if (isSwitchingMonth) {
        return;
      }
      
      const idx = parseInt(monthSelect.value, 10);
      if (!Number.isFinite(idx) || idx < 0 || idx >= sheetNames.length) {
        return;
      }
      
      // å¦‚æœé¸æ“‡çš„æ˜¯ç•¶å‰æœˆä»½ï¼Œä¸éœ€è¦åˆ‡æ›
      if (currentSheetIndex === idx + 2) {
        return;
      }
      
      isSwitchingMonth = true;
      const oldSheetIndex = currentSheetIndex;
      currentSheetIndex = idx + 2; // è½‰ç‚ºå¯¦éš› sheet indexï¼ˆå‰å…©å€‹æ˜¯ã€Œç©ºç™½è¡¨ã€å’Œã€Œä¸‹æ‹‰é¸å–®ã€ï¼‰
      const monthName = sheetNames[idx];
      
      // åˆ‡æ›æœˆä»½æ™‚ï¼Œé›¢é–‹æ–°å¢æ¨¡å¼ä¸¦é‡ç½®ç‹€æ…‹
      isNewMode = false;
      currentRecordNumber = null;
      
          const itemInput = document.getElementById('item-input');
          const costInput = document.getElementById('cost-input');
          const noteInput = document.getElementById('note-input');
      const expenseCategorySelect = document.getElementById('expense-category-select');
      
      try {
        // å…ˆå˜—è©¦å¾è¨˜æ†¶é«”è¼‰å…¥è³‡æ–™ï¼ˆä¸ç™¼é€è«‹æ±‚ã€ä¸é¡¯ç¤ºè¼‰å…¥å‹•ç•«ï¼‰
        if (loadContentFromMemory()) {
          // å¾è¨˜æ†¶é«”è¼‰å…¥æˆåŠŸï¼Œç«‹å³æ›´æ–° UI
          updateDeleteButton();
          updateArrowButtons();
          enterNewModeIfEmpty();
          isSwitchingMonth = false;
        } else {
          // è¨˜æ†¶é«”ä¸­æ²’æœ‰è³‡æ–™æ™‚ï¼Œç™¼é€è«‹æ±‚è¼‰å…¥ï¼Œä½†ã€Œä¸é¡¯ç¤ºæ•´é è¼‰å…¥ä¸­é®ç½©ã€
          // åªæš«æ™‚é–å®šè¼¸å…¥èˆ‡æŒ‰éˆ•ï¼Œé¿å…åœ¨è¼‰å…¥æœŸé–“èª¤æ“ä½œ
          if (itemInput) itemInput.disabled = true;
          if (costInput) costInput.disabled = true;
          if (noteInput) noteInput.disabled = true;
          if (categorySelect) categorySelect.disabled = true;
          if (expenseCategorySelect) expenseCategorySelect.disabled = true;
          leftArrow.disabled = true;
          rightArrow.disabled = true;
          saveButton.disabled = true;
          deleteButton.disabled = true;
          if (monthSelect) monthSelect.disabled = true;
          
          try {
            await loadContent(true);
            updateDeleteButton();
            updateArrowButtons();
            enterNewModeIfEmpty();
          } finally {
            // æ¢å¾©æ‰€æœ‰æŒ‰éˆ•å’Œè¼¸å…¥
            if (itemInput) itemInput.disabled = false;
            if (costInput) costInput.disabled = false;
            if (noteInput) noteInput.disabled = false;
            if (categorySelect) categorySelect.disabled = false;
            if (expenseCategorySelect) expenseCategorySelect.disabled = false;
            leftArrow.disabled = false;
            rightArrow.disabled = false;
            saveButton.disabled = false;
            deleteButton.disabled = false;
            if (monthSelect) monthSelect.disabled = false;
            isSwitchingMonth = false;
          }
        }
      } catch (e) {
        // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œæ¢å¾©åŸä¾†çš„æœˆä»½
        currentSheetIndex = oldSheetIndex;
        if (monthSelect) {
          const oldSelectIndex = oldSheetIndex - 2;
          if (oldSelectIndex >= 0 && oldSelectIndex < sheetNames.length) {
            monthSelect.value = String(oldSelectIndex);
          }
        }
        isSwitchingMonth = false;
          hideSpinner();
      }
    };
    
    monthSelect.addEventListener('change', monthSelectChangeHandler);
    
    // åˆå§‹è¼‰å…¥ç›®å‰é¸æ“‡çš„æœˆä»½è³‡æ–™ï¼ˆå¾è¨˜æ†¶é«”è®€å–ï¼Œä¸éœ€è¦ spinnerï¼‰
    // å¦‚æœè¨˜æ†¶é«”ä¸­æ²’æœ‰è³‡æ–™ï¼ŒinitMonthSelect å·²ç¶“è¼‰å…¥ä¸¦é¡¯ç¤ºäº†
    if (loadContentFromMemory()) {
      // å¾è¨˜æ†¶é«”è¼‰å…¥æˆåŠŸï¼Œåªéœ€è¦æ›´æ–° UI
    updateDeleteButton();
    updateArrowButtons();
    }
  } catch (error) {
    // CORS / fetch é¡éŒ¯èª¤åœ¨å¯¦éš›ä½¿ç”¨ä¸Šä¸å½±éŸ¿çµæœï¼Œé€™è£¡ä¸å†å½ˆå‡ºæç¤ºè¦–çª—ï¼Œé¿å…å¹²æ“¾æ“ä½œ
  }
};


totalContainer.appendChild(columnsContainer);
  columnsContainer.appendChild(incomeColumn);
    incomeColumn.appendChild(incomeTitle);
    incomeColumn.appendChild(incomeAmount);
  columnsContainer.appendChild(expenseColumn);
    expenseColumn.appendChild(expenseTitle);
    expenseColumn.appendChild(expenseAmount);
  columnsContainer.appendChild(totalColumn);
    totalColumn.appendChild(totalTitle);
    totalColumn.appendChild(totalAmount);
budgetCardsContainer.appendChild(headerInfo);
budgetCardsContainer.appendChild(deleteButton);
budgetCardsContainer.appendChild(leftArrow);
budgetCardsContainer.appendChild(rightArrow);
budgetCardsContainer.appendChild(itemContainer);
budgetCardsContainer.appendChild(div1);
  div1.appendChild(categoryLabel);
  div1.appendChild(categorySelectContainer);
budgetCardsContainer.appendChild(div2);
budgetCardsContainer.appendChild(div3);
budgetCardsContainer.appendChild(div4);
budgetCardsContainer.appendChild(submitContainer);
  submitContainer.appendChild(saveButton);

categorySelect.addEventListener('change', () => {
  updateDivVisibility();
  if (allRecords.length > 0) {
    filterRecordsByType(categorySelect.value);
  }
});
updateDivVisibility();
saveButton.addEventListener('click', saveData);
saveButton.addEventListener('click', loadTotal);

document.addEventListener('DOMContentLoaded', async function() {
  // ç«‹å³é¡¯ç¤ºè¼‰å…¥å‹•ç•«ï¼Œè®“ç”¨æˆ¶çŸ¥é“é é¢æ­£åœ¨è¼‰å…¥
  showSpinner();
  
  document.getElementsByClassName('post-content')[0].appendChild(totalContainer);
  document.getElementsByClassName('post-content')[0].appendChild(budgetCardsContainer);

  try {
    // éé˜»å¡è¼‰å…¥ã€Œä¸‹æ‹‰é¸å–®ã€sheet çš„æœ€æ–°é¸é …
    const refreshDropdowns = () => {
      loadDropdownOptions().then(() => {
        // å¦‚æœç•¶å‰é¡¯ç¤ºçš„æ˜¯æ”¯å‡ºé¡åˆ¥ï¼Œé‡æ–°æ¸²æŸ“
        const categorySelect = document.getElementById('category-select');
        if (categorySelect && categorySelect.value === 'æ”¯å‡º') {
          updateDivVisibility('æ”¯å‡º');
        }
      }).catch(err => {
      });
    };
    
    refreshDropdowns();

    // ç›£è½è¨­å®šé çš„æ›´æ–°é€šçŸ¥ï¼ˆç•¶è¨­å®šé æ›´æ–°ä¸‹æ‹‰é¸å–®å¾Œï¼Œè‡ªå‹•é‡æ–°è¼‰å…¥ï¼‰
    window.addEventListener('storage', (e) => {
      if (e.key === 'dropdownUpdated') {
        refreshDropdowns();
      }
    });
    
    // ä¹Ÿç›£è½åŒé é¢çš„ storage äº‹ä»¶ï¼ˆå› ç‚º storage äº‹ä»¶åªåœ¨å…¶ä»–æ¨™ç±¤é è§¸ç™¼ï¼‰
    let lastUpdateTime = localStorage.getItem('dropdownUpdated');
    setInterval(() => {
      const current = localStorage.getItem('dropdownUpdated');
      if (current && current !== lastUpdateTime) {
        lastUpdateTime = current;
        refreshDropdowns();
      }
    }, 1000); // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡

    // initMonthSelect å…§éƒ¨æœƒè™•ç†è¼‰å…¥ä¸¦åœ¨å®Œæˆæ™‚éš±è— spinner
    await initMonthSelect(); // å…ˆè¼‰å…¥æœˆä»½æ¸…å–®ä¸¦è¼‰å…¥å°æ‡‰æœˆä»½è³‡æ–™
    updateDeleteButton(); // åˆå§‹åŒ–åˆªé™¤æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
  } catch (error) {
    hideSpinner(); // ç¢ºä¿éŒ¯èª¤æ™‚ä¹Ÿéš±è— spinner
    const errorContainer = document.createElement('div');
    errorContainer.innerHTML = 'è¼‰å…¥å¤±æ•—: ' + error.message;
    errorContainer.style.color = 'red';
    errorContainer.style.marginTop = '20px';
    document.getElementsByClassName('post-content')[0].appendChild(errorContainer);
  }
});

</script>