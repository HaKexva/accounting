---
layout: page
title: 支出
permalink: /expense/
---

<link rel="stylesheet" href="{{ '/assets/expense-table.css' | relative_url }}">

<div id="user-info"></div>

<script>

// 支出表 / 預算表 GAS Web App URL（最新）
// 支出用「新的」 URL，預算維持原本的 URL
const baseExpense = "https://script.google.com/macros/s/AKfycbwsJHez5Ki-FJlHoWz-8P9QaXlU5ad2lWvBEEDyatSGAdF-im4SqSKw5xcJDNhcqC0g/exec";
const baseBudget  = "https://script.google.com/macros/s/AKfycbyimmztYoFsY-Nli8cFHJ4j7t5DSEm3NhSgt0_2iRzPtgAK1TOdq3DulWrnNE4vKB9_/exec";
// 目前選擇的試算表分頁索引（對應 Apps Script 中的 getSheets()[index]，2 代表第三個分頁）
let currentSheetIndex = 2;
// 從 Show Tab Name 取得的所有月份分頁名稱
// 如果前兩個是無效項目（空白表、下拉選單），則會被過濾掉
let sheetNames = [];
// 記錄原始數據是否包含前兩個無效項目，用於正確計算 sheetIndex
let hasInvalidFirstTwoSheets = false;

// 預先載入的所有月份資料（key: sheetIndex, value: { data: {...}, total: [...] }）
let allMonthsData = {}; // 儲存每個月份的資料和總計

// 純新增模式，不需要記錄索引
let allRecords = []; // 用於歷史紀錄列表

// ===== 下拉選單選項（以「下拉選單」sheet=1 為主，以下為預設值／後備值）=====
let EXPENSE_CATEGORY_OPTIONS = [
  { value: '生活花費：食', text: '生活花費：食' },
  { value: '生活花費：衣與外貌', text: '生活花費：衣與外貌' },
  { value: '生活花費：住、居家裝修、衛生用品、次月繳納帳單', text: '生活花費：住、居家裝修、衛生用品、次月繳納帳單' },
  { value: '生活花費：行', text: '生活花費：行' },
  { value: '生活花費：育', text: '生活花費：育' },
  { value: '生活花費：樂', text: '生活花費：樂' },
  { value: '生活花費：健（醫療）', text: '生活花費：健（醫療）' },
  { value: '生活花費：帳單', text: '生活花費：帳單' },
  { value: '儲蓄：退休金、醫療預備金、過年紅包支出', text: '儲蓄：退休金、醫療預備金、過年紅包支出' },
  { value: '家人：過年紅包、紀念日', text: '家人：過年紅包、紀念日' }
];
let PAYMENT_METHOD_OPTIONS = [
  { value: '現金', text: '現金' },
  { value: '信用卡', text: '信用卡' },
  { value: '轉帳', text: '轉帳' },
  { value: '存款或儲值的支出：LINE BANK / 悠遊付 / mos card / 髮果 等', text: '存款或儲值的支出：LINE BANK / 悠遊付 / mos card / 髮果 等' }
];
let CREDIT_CARD_PAYMENT_OPTIONS = [
  { value: '分期付款', text: '分期付款' },
  { value: '一次支付', text: '一次支付' }
];
let MONTH_PAYMENT_OPTIONS = [
  { value: '本月支付', text: '本月支付' },
  { value: '次月支付', text: '次月支付' }
];
let PAYMENT_PLATFORM_OPTIONS = [
  { value: 'LINE BANK', text: 'LINE BANK' },
  { value: '悠遊付', text: '悠遊付' },
  { value: 'mos card', text: 'mos card' },
  { value: '髮果', text: '髮果' }
];

// 從「下拉選單」sheet=1 載入最新選項（只打一小次 API，速度很快）
async function loadDropdownOptions() {
  try {
    const params = { name: "Show Tab Data", sheet: 1, _t: Date.now() };
    const url = `${baseExpense}?${new URLSearchParams(params)}`;
    const res = await fetch(url, {
      method: "GET",
      redirect: "follow",
      mode: "cors",
      cache: "no-store"
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const responseData = await res.json();
    // 處理不同的資料格式
    let data = null;

    // 如果是陣列，直接使用
    if (Array.isArray(responseData)) {
      data = responseData;
    }
    // 如果是物件，可能是命名範圍的格式，嘗試找到第一個陣列值
    else if (typeof responseData === 'object' && responseData !== null) {
      // 尋找第一個值是陣列的鍵
      for (const key in responseData) {
        if (Array.isArray(responseData[key]) && responseData[key].length > 0) {
          data = responseData[key];
          break;
        }
      }
    }

    if (!data || !Array.isArray(data) || data.length === 0) {
      return;
    }

    const headerRow = data[0];
    // 找對應欄位
    const colCategory   = findHeaderColumn(headerRow, ['消費類別', '類別']);
    const colPayment    = findHeaderColumn(headerRow, ['支付方式']);
    const colCreditCard = findHeaderColumn(headerRow, ['信用卡支付方式']);
    const colMonthPay   = findHeaderColumn(headerRow, ['本月／次月支付']);
    const colPlatform   = findHeaderColumn(headerRow, ['支付平台', '平台']);

    const readColumn = (col) => {
      const arr = [];
      if (col < 0) return arr;
      const seen = new Set();
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row) continue;
        const raw = row[col];
        if (raw === undefined || raw === null) continue;
        const val = raw.toString().trim();
        if (!val || seen.has(val)) continue;
        seen.add(val);
        arr.push({ value: val, text: val });
      }
      return arr;
    };

    if (colCategory >= 0) {
      EXPENSE_CATEGORY_OPTIONS = readColumn(colCategory);
    }
    if (colPayment >= 0) {
      PAYMENT_METHOD_OPTIONS = readColumn(colPayment);
    }
    if (colCreditCard >= 0) {
      CREDIT_CARD_PAYMENT_OPTIONS = readColumn(colCreditCard);
    }
    if (colMonthPay >= 0) {
      MONTH_PAYMENT_OPTIONS = readColumn(colMonthPay);
    }
    if (colPlatform >= 0) {
      PAYMENT_PLATFORM_OPTIONS = readColumn(colPlatform);
    }

  } catch (err) {
  }
}

// 根據新的選項更新指定 select + 自訂顯示（如果存在）
function updateSelectOptions(selectId, options) {
  const select = document.getElementById(selectId);
  if (!select) {
    return;
  }

  if (!options || options.length === 0) {
    return;
  }

  const currentValue = select.value;
  select.innerHTML = '';

  options.forEach(opt => {
    const o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.text;
    select.appendChild(o);
  });

  // 恢復之前選擇的值（如果還存在）
  if (currentValue && options.some(o => o.value === currentValue)) {
    select.value = currentValue;
  }

  // 更新自訂下拉選單的顯示文字
  const container = select.parentElement;
  if (container) {
    const display = container.querySelector('.select-display');
    if (display) {
      const textEl = display.querySelector('.select-text');
      if (textEl) {
        const selectedOpt = select.options[select.selectedIndex];
        textEl.textContent = selectedOpt ? selectedOpt.textContent : '';
      }

      // 更新下拉選單的選項列表
      const dropdown = container.querySelector('.select-dropdown');
      if (dropdown) {
        dropdown.innerHTML = '';
        options.forEach(opt => {
          const item = document.createElement('div');
          item.className = 'select-option';
          item.textContent = opt.text;
          item.onclick = () => {
            select.value = opt.value;
            if (textEl) textEl.textContent = opt.text;
            dropdown.style.display = 'none';
            const arrow = container.querySelector('.select-arrow');
            if (arrow) arrow.style.transform = 'rotate(0deg)';
            // 觸發 change 事件
            select.dispatchEvent(new Event('change'));
          };
          dropdown.appendChild(item);
        });
      }
    }
  }
}

function findHeaderColumn(headerRow, keywords) {
  for (let c = 0; c < headerRow.length; c++) {
    const headerText = (headerRow[c] || '').toString().trim();
    if (!headerText) continue;
    if (keywords.some(k => headerText.includes(k))) return c;
  }
  return -1;
}

// 清空表單，準備新增
function clearForm() {
    const itemInput = document.getElementById('item-input');
  const expenseCategorySelect = document.getElementById('expense-category-select');
  const paymentMethodSelect = document.getElementById('payment-method-select');
  const creditCardPaymentSelect = document.getElementById('credit-card-payment-select');
  const monthPaymentSelect = document.getElementById('month-payment-select');
  const paymentPlatformSelect = document.getElementById('payment-platform-select');
  const actualCostInput = document.getElementById('actual-cost-input');
  const recordCostInput = document.getElementById('record-cost-input');
    const noteInput = document.getElementById('note-input');

  if (itemInput) itemInput.value = '';
  if (expenseCategorySelect && expenseCategorySelect.options.length > 0) {
    expenseCategorySelect.value = expenseCategorySelect.options[0].value;
    const selectContainer = expenseCategorySelect.parentElement;
        if (selectContainer) {
      const selectDisplay = selectContainer.querySelector('.select-display');
          if (selectDisplay) {
        const selectText = selectDisplay.querySelector('.select-text');
            if (selectText) {
          selectText.textContent = expenseCategorySelect.options[0].textContent;
        }
      }
    }
  }
  // 支付方式不自動重置，保持用戶之前的選擇
  // if (paymentMethodSelect && paymentMethodSelect.options.length > 0) {
  //   paymentMethodSelect.value = paymentMethodSelect.options[0].value;
  //   const selectContainer = paymentMethodSelect.parentElement;
  //   if (selectContainer) {
  //     const selectDisplay = selectContainer.querySelector('.select-display');
  //     if (selectDisplay) {
  //       const selectText = selectDisplay.querySelector('.select-text');
  //       if (selectText) {
  //         selectText.textContent = paymentMethodSelect.options[0].textContent;
  //       }
  //     }
  //   }
  //   paymentMethodSelect.dispatchEvent(new Event('change'));
  // }
  if (creditCardPaymentSelect) creditCardPaymentSelect.value = '';
  if (monthPaymentSelect) monthPaymentSelect.value = '';
  if (paymentPlatformSelect) paymentPlatformSelect.value = '';
  if (actualCostInput) actualCostInput.value = '';
  if (recordCostInput) recordCostInput.value = '';
    if (noteInput) noteInput.value = '';

  // 日期已移除
}

// 取得現在日期並格式化為 YYYY/MM/DD（不包含時間）
function getNowFormattedDateTime() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}/${month}/${day}`;
}

// 將各種時間字串格式統一轉為 YYYY/MM/DD（不包含時間）
function formatRecordDateTime(raw) {
  if (!raw) return '';
  const dt = new Date(raw);
  if (Number.isNaN(dt.getTime())) {
    if (typeof raw === 'string' && raw.includes('/')) {
      return raw.split(' ')[0];
    }
    return raw;
  }
  const year = dt.getFullYear();
  const month = String(dt.getMonth() + 1).padStart(2, '0');
  const day = String(dt.getDate()).padStart(2, '0');
  return `${year}/${month}/${day}`;
}

// 統一的 API 調用函數
async function callAPI(postData) {
  const response = await fetch(baseExpense, {
    method: "POST",
    redirect: "follow",
    mode: "cors",
    keepalive: true,
    body: JSON.stringify(postData)
  });

  const responseText = await response.text();
  // 部分 GAS 可能回傳空字串；視為成功（無額外資料）
  if (!responseText || responseText.trim() === '') {
    return { success: true, data: null, total: null };
  }

  let result;
  try {
    result = JSON.parse(responseText);
  } catch (e) {
    throw new Error('後端響應格式錯誤: ' + responseText.substring(0, 100));
  }

  if (!response.ok || !result.success) {
    throw new Error(result.message || result.error || '操作失敗');
  }

  // 請求成功後，清除快取以確保下次載入時取得最新資料
  try {
    const storageKey = `expense_monthData_${currentSheetIndex}`;
    sessionStorage.removeItem(storageKey);
    delete allMonthsData[currentSheetIndex];
  } catch (e) {
    // 忽略錯誤
  }

  return result;
}

// ===== 歷史紀錄列表刷新（統一邏輯，避免重複）=====
function refreshHistoryList() {
  const historyModal = document.querySelector('.history-modal');
  if (!historyModal) return;

  const newRecords = loadHistoryListFromCache(currentSheetIndex);
  const listElement = historyModal.querySelector('.history-list');
  if (!listElement) return;

  listElement.innerHTML = '';
  const displayRecords = newRecords.filter(r => !isHeaderRecord(r));
  if (displayRecords.length === 0) {
    const emptyMsg = document.createElement('div');
    emptyMsg.textContent = '尚無歷史紀錄';
    emptyMsg.style.cssText = 'text-align: center; padding: 40px; color: #999;';
    listElement.appendChild(emptyMsg);
  } else {
    displayRecords.forEach(record => {
      listElement.appendChild(createHistoryItem(record, listElement));
    });
  }
}

// 統一的更新暫存區和歷史記錄列表
// 如果提供了 data 和 total，直接使用，否則重新載入
async function updateCacheAndHistory(resultData = null, resultTotal = null) {
  // 如果有回傳的資料，直接使用，否則重新載入
  if (resultData && resultTotal) {
    // 處理回傳的資料並更新暫存區（後端返回的 data 是陣列格式）
    processDataFromResponse(resultData, false, currentSheetIndex);
    allMonthsData[currentSheetIndex] = { data: resultData, total: resultTotal };

    // 保存到 sessionStorage
    try {
      const storageKey = `expense_monthData_${currentSheetIndex}`;
      sessionStorage.setItem(storageKey, JSON.stringify(allMonthsData[currentSheetIndex]));
    } catch (e) {
      // sessionStorage 可能已滿或不可用，忽略錯誤
    }
  } else {
    // 沒有回傳資料，重新載入
    try {
      const monthData = await loadMonthData(currentSheetIndex);
      allMonthsData[currentSheetIndex] = monthData;
    } catch (error) {
    }
  }

  // 更新歷史記錄列表
  refreshHistoryList();
}

// 填充表單欄位（用於編輯模式）
function fillForm(row) {
  if (!row) return;

  // 根據 Apps Script 結構：[時間(0), item(1), category(2), spendWay(3), creditCard(4), monthIndex(5), actualCost(6), payment(7), recordCost(8), note(9)]
  setTimeout(() => {
    const itemInput = document.getElementById('item-input');
    const expenseCategorySelect = document.getElementById('expense-category-select');
    const paymentMethodSelect = document.getElementById('payment-method-select');
    const creditCardPaymentSelect = document.getElementById('credit-card-payment-select');
    const monthPaymentSelect = document.getElementById('month-payment-select');
    const paymentPlatformSelect = document.getElementById('payment-platform-select');
    const actualCostInput = document.getElementById('actual-cost-input');
    const recordCostInput = document.getElementById('record-cost-input');
    const noteInput = document.getElementById('note-input');

    // 項目
    if (itemInput) {
      itemInput.value = row[1] || '';
    }

    // 類別
    if (expenseCategorySelect) {
      expenseCategorySelect.value = row[2] || '';
      // 同步更新自訂下拉顯示文字
      const selectContainer = expenseCategorySelect.parentElement;
      if (selectContainer) {
        const selectDisplay = selectContainer.querySelector('.select-display');
        if (selectDisplay) {
          const selectText = selectDisplay.querySelector('.select-text');
          if (selectText) {
            const selectedOption = expenseCategorySelect.options[expenseCategorySelect.selectedIndex];
            selectText.textContent = selectedOption ? selectedOption.textContent : row[2] || '';
          }
        }
      }
    }

    // 支付方式
    if (paymentMethodSelect) {
      paymentMethodSelect.value = row[3] || '';
      // 同步更新自訂下拉顯示文字
      const selectContainer = paymentMethodSelect.parentElement;
      if (selectContainer) {
        const selectDisplay = selectContainer.querySelector('.select-display');
        if (selectDisplay) {
          const selectText = selectDisplay.querySelector('.select-text');
          if (selectText) {
            const selectedOption = paymentMethodSelect.options[paymentMethodSelect.selectedIndex];
            selectText.textContent = selectedOption ? selectedOption.textContent : row[3] || '';
          }
        }
      }
      // 觸發支付方式變更，以顯示/隱藏相關欄位
      paymentMethodSelect.dispatchEvent(new Event('change'));
    }

    // 信用卡支付方式（如果支付方式是信用卡）
    if (creditCardPaymentSelect && row[3] === '信用卡支出') {
      creditCardPaymentSelect.value = row[4] || '';
      // 同步更新自訂下拉顯示文字
      const selectContainer = creditCardPaymentSelect.parentElement;
        if (selectContainer) {
        const selectDisplay = selectContainer.querySelector('.select-display');
          if (selectDisplay) {
          const selectText = selectDisplay.querySelector('.select-text');
            if (selectText) {
            const selectedOption = creditCardPaymentSelect.options[creditCardPaymentSelect.selectedIndex];
            selectText.textContent = selectedOption ? selectedOption.textContent : row[4] || '';
          }
        }
      }
    }

    // 本月/次月支付（如果支付方式是信用卡）
    if (monthPaymentSelect && row[3] === '信用卡支出') {
      monthPaymentSelect.value = row[5] || '';
      // 同步更新自訂下拉顯示文字
      const selectContainer = monthPaymentSelect.parentElement;
        if (selectContainer) {
        const selectDisplay = selectContainer.querySelector('.select-display');
          if (selectDisplay) {
          const selectText = selectDisplay.querySelector('.select-text');
            if (selectText) {
            const selectedOption = monthPaymentSelect.options[monthPaymentSelect.selectedIndex];
            selectText.textContent = selectedOption ? selectedOption.textContent : row[5] || '';
          }
        }
      }
    }

    // 支付平台（如果支付方式是存款或儲值的支出）
    if (paymentPlatformSelect && row[3] === '存款或儲值的支出：LINE BANK / 悠遊付 / mos card / 髮果 等') {
      paymentPlatformSelect.value = row[7] || '';
      // 同步更新自訂下拉顯示文字
      const selectContainer = paymentPlatformSelect.parentElement;
      if (selectContainer) {
        const selectDisplay = selectContainer.querySelector('.select-display');
        if (selectDisplay) {
          const selectText = selectDisplay.querySelector('.select-text');
          if (selectText) {
            const selectedOption = paymentPlatformSelect.options[paymentPlatformSelect.selectedIndex];
            selectText.textContent = selectedOption ? selectedOption.textContent : row[7] || '';
          }
        }
      }
    }

    // 實際消費金額
    if (actualCostInput) {
      actualCostInput.value = row[6] || '';
    }

    // 列帳消費金額
    if (recordCostInput) {
      recordCostInput.value = row[8] || '';
    }

    // 備註
    if (noteInput) {
      noteInput.value = row[9] || '';
    }

  }, 150);
}

// 判斷一列是否為標題列（例如：時間 / 日期, 項目 等），用於歷史紀錄顯示時略過
function isHeaderRecord(record) {
  if (!record || !record.row) return false;
  const row = record.row;
  const c0 = (row[0] || '').toString().trim();
  const c1 = (row[1] || '').toString().trim();
  if (!c0 && !c1) return false;
  const headerWords0 = ['時間', '日期'];
  const headerWords1 = ['項目', '品項', '標題'];
  const isHeader0 = headerWords0.some(w => c0.includes(w));
  const isHeader1 = headerWords1.some(w => c1.includes(w));
  return isHeader0 && isHeader1;
}

// ===== 預算快取與預先彙總（從預算表載入） =====

// 每個月份對應的「預算支出彙總」，key: sheetIndex, value: { [category: string]: number }
const budgetTotals = {};

// 載入預算表中指定月份的資料，並先把每個類別的預算加總好存起來
async function loadBudgetForMonth(sheetIndex) {
  // 如果已經有快取，直接返回
  if (budgetTotals[sheetIndex]) {
    return budgetTotals[sheetIndex];
  }

  const params = { name: "Show Tab Data", sheet: sheetIndex, _t: Date.now() };
  const url = `${baseBudget}?${new URLSearchParams(params)}`;
  let res;
  try {
    res = await fetch(url, {
      method: "GET",
      redirect: "follow",
      mode: "cors",
      cache: "no-store"
    });
  } catch (err) {
    throw new Error(`無法連接預算表伺服器: ${err.message}`);
  }

  if (!res.ok) {
    throw new Error(`載入預算資料失敗: HTTP ${res.status} ${res.statusText}`);
  }

  let data;
  try {
    data = await res.json();
  } catch (jsonErr) {
    const text = await res.text();
    throw new Error('預算表回應格式錯誤');
  }

  const categoryTotals = {};

  if (data && typeof data === 'object') {
    Object.keys(data).forEach(key => {
      const rows = data[key] || [];
      // 只處理包含「支出」字樣的命名範圍（例如：當月支出預算202512）
      const isExpenseBudget = key.includes('支出');
      if (!isExpenseBudget) {
        return;
      }
      rows.forEach((row, rowIndex) => {
        if (!row || row.length === 0) {
          return;
        }

        const firstCell = row[0];
        // 跳過標題列與總計列
        if (firstCell === '編號') {
          return;
        }
        if (firstCell === '總計') {
          return;
        }

        // 真正的資料列：允許 firstCell 為空，只要有類別和金額即可
        // 類別欄位：優先用第 3 欄(row[2])，如果是空的就用第 2 欄(row[1])，以支援「生活花費：食」這種寫法
        let category = (row[2] || '').toString().trim();
        if (!category) {
          category = (row[1] || '').toString().trim();
        }

        const costRaw = row[4];
        const cost = parseFloat(costRaw);
        if (!category) {
          return;
        }
        if (!Number.isFinite(cost)) {
          return;
        }

        categoryTotals[category] = (categoryTotals[category] || 0) + cost;
      });
    });
  } else {
  }

  budgetTotals[sheetIndex] = categoryTotals;

  if (Object.keys(categoryTotals).length === 0) {
  }

  return categoryTotals;
}

// 處理從 Apps Script 回傳的資料（用於更新 allRecords）
const processDataFromResponse = (data, shouldFilter = true, sheetIndexForContext = null) => {
  // 先清空目前的記錄
  allRecords = [];

  // 如果數據是陣列格式，需要先轉換
  if (Array.isArray(data)) {
    const convertedData = {};
    let expenseRows = [];

    data.forEach((row, rowIndex) => {
      if (!row || row.length === 0) return;

      // 跳過標題行（第一行通常是標題）
      if (rowIndex === 0) {
        const firstCell = String(row[0] || '').trim().toLowerCase();
        if (firstCell === '交易日期' || firstCell === '時間' || firstCell === '日期' ||
            firstCell.includes('項目') || firstCell.includes('金額')) {
          return; // 跳過標題行
        }
      }

      // 跳過總計行
      const firstCell = String(row[0] || '').trim();
      if (firstCell === '總計' || firstCell === '') {
        return;
      }

      // 根據 Apps Script 結構：[時間(0), item(1), category(2), spendWay(3), creditCard(4), monthIndex(5), actualCost(6), payment(7), recordCost(8), note(9)]
      // 支出頁面處理所有符合結構的行（10欄）
      if (row.length >= 10) {
        // 檢查第一欄是否為時間格式或有效資料
        const timeValue = row[0];
        // 如果第一欄是時間格式（包含 / 或 -），或者是有效的日期字串，或者是非空值，則認為是有效記錄
        // 排除明顯的標題行（如 "交易日期"）
        const timeStr = String(timeValue || '').trim();
        const isHeader = timeStr.toLowerCase() === '交易日期' ||
                         timeStr.toLowerCase() === '時間' ||
                         timeStr.toLowerCase() === '日期';

        if (!isHeader && timeValue !== null && timeValue !== undefined && timeStr !== '') {
          // 進一步檢查：如果是日期格式或非空字串，則加入
          if (timeStr.includes('/') || timeStr.includes('-') ||
              !isNaN(Date.parse(timeValue)) || timeStr.length > 0) {
          expenseRows.push(row);
          }
        }
      }
    });

    if (expenseRows.length > 0) convertedData['當月支出預算'] = expenseRows;

    data = convertedData;
  }

  if (data && typeof data === 'object' && !Array.isArray(data)) {
    // 獲取當前月份名稱（允許覆蓋 sheetIndex，避免顯示錯月）
    const effectiveSheetIndex = (sheetIndexForContext !== undefined && sheetIndexForContext !== null) ? sheetIndexForContext : currentSheetIndex;
    const monthIndex = effectiveSheetIndex - 2;
    const currentMonthName = (monthIndex >= 0 && monthIndex < sheetNames.length && sheetNames.length > 0) ? sheetNames[monthIndex] : '';

    // 使用 Set 來追蹤已處理的記錄，避免重複添加
    const processedRowKeys = new Set();

    Object.keys(data).forEach(key => {
      const rows = data[key] || [];

      // 根據命名範圍名稱判斷類型
      // 命名範圍格式：當月收入202506 或 當月支出預算202506
      const isIncome = key.includes('收入');
      const isExpense = key.includes('支出');

      if (!isIncome && !isExpense) {
        return; // 跳過不是收入或支出的資料
      }

      // 只處理當前月份的資料（命名範圍名稱應該包含當前月份）
      // 但如果鍵名是 '當月支出預算' 或 '當月收入'（陣列轉換後的格式），則跳過月份檢查
      const isGenericKey = key === '當月支出預算' || key === '當月收入' || key.includes('當月支出預算') || key.includes('當月收入');
      const isCurrentMonth = isGenericKey || (currentMonthName && key.includes(currentMonthName));
      if (!isCurrentMonth) {
        return; // 跳過不是當前月份的資料
      }

      const type = isIncome ? '收入' : '支出';

      rows.forEach(row => {
        if (!row || row.length === 0) return;

        // 跳過總計行和空行
        const firstCell = (row[0] || '').toString().trim();
        if (firstCell === '交易日期' || firstCell === '總計' || firstCell === '') {
          return;
        }

        // 對於支出類型，第一欄是時間格式，不是數字編號
        // 所以不需要檢查是否為數字，只需要確保不是標題行
        const isHeader = firstCell.toLowerCase() === '交易日期' ||
                         firstCell.toLowerCase() === '時間' ||
                         firstCell.toLowerCase() === '日期' ||
                         firstCell.includes('項目') ||
                         firstCell.includes('金額');
        if (isHeader) {
          return;
        }

        // 使用時間、項目和金額作為唯一標識，避免重複添加
        const rowKey = `${row[0] || ''}_${row[1] || ''}_${row[8] || ''}`;
        if (processedRowKeys.has(rowKey)) {
          console.warn('[支出表] processDataFromResponse: 發現重複記錄，跳過:', rowKey, 'key =', key);
          return; // 跳過重複記錄
        }
        processedRowKeys.add(rowKey);

        allRecords.push({ type, row });
      });
    });

    console.log('[支出表] processDataFromResponse: 處理了', processedRowKeys.size, '筆唯一記錄');
  }

  // 根據目前選擇的類型過濾記錄（預設顯示支出）
  if (shouldFilter) {
    filterRecordsByType('支出'); // 現在只有支出

    // 載入後自動顯示第二筆記錄（跳過第一筆）
    if (filteredRecords.length > 1) {
      currentRecordIndex = 1;
      setTimeout(() => {
        showRecord(1);
        updateArrowButtons();
      }, 100);
    } else if (filteredRecords.length === 1) {
      // 如果只有一筆，進入新增模式
      isNewMode = true;
      currentRecordIndex = 0;
      updateArrowButtons();
    }
  }
};

// 重新計算上方「預算 / 支出 / 餘額」
const updateTotalDisplay = () => {
  const expenseCategorySelect = document.getElementById('expense-category-select');
  const recordCostInput = document.getElementById('record-cost-input'); // 使用列帳金額
  const currentCategory = expenseCategorySelect ? expenseCategorySelect.value : '';

  // 1. 預算：從預算表預先彙總好的資料中讀出（快取在 budgetTotals）
  let budget = 0;
  const budgetData = budgetTotals[currentSheetIndex];
  if (budgetData && currentCategory) {
    budget = parseFloat(budgetData[currentCategory]) || 0;
  }

  // 2. 支出：從當前月份的回傳資料中，篩出同類別的，並加上即時輸入金額
  let historyExpense = 0;
  let records = [];
  const monthData = allMonthsData[currentSheetIndex];
  if (monthData && monthData.data) {
    // 只有在有暫存資料時才從暫存載入，避免一開始還沒載完就一直噴警告
    records = loadHistoryListFromCache(currentSheetIndex); // 只讀暫存，不發請求
  }

  // 檢查是否在編輯模式（有當前記錄且不在新增模式）
  const isEditing = typeof currentRecordIndex !== 'undefined' &&
                    typeof filteredRecords !== 'undefined' &&
                    filteredRecords.length > 0 &&
                    currentRecordIndex >= 0 &&
                    currentRecordIndex < filteredRecords.length;

  // 如果正在編輯，需要從歷史記錄中排除當前正在編輯的記錄（避免重複計算）
  let currentRecordOriginalCost = 0;
  if (isEditing) {
    const currentRecord = filteredRecords[currentRecordIndex];
    if (currentRecord && currentRecord.row) {
      const row = currentRecord.row;
      const categoryStr = (row[2] || '').trim();
      // 只有當前記錄的類別與選擇的類別相同時，才需要排除
      if (!currentCategory || categoryStr === currentCategory) {
        const raw = row[8] !== undefined && row[8] !== null && row[8] !== '' ? row[8] : 0;
        currentRecordOriginalCost = parseFloat(raw) || 0;
      }
    }
  }

  if (Array.isArray(records) && records.length > 0) {
    // 使用 Set 來追蹤已處理的記錄，避免重複計算
    const processedRecordKeys = new Set();

    historyExpense = records.reduce((sum, r) => {
      const row = r.row || [];
      const categoryStr = (row[2] || '').trim();
      if (currentCategory && categoryStr !== currentCategory) return sum;

      // 使用列帳金額（index 8）
      const raw = row[8] !== undefined && row[8] !== null && row[8] !== '' ? row[8] : 0;
      const num = parseFloat(raw) || 0;

      // 使用時間、項目和金額作為唯一標識，避免重複計算
      const recordKey = `${row[0] || ''}_${row[1] || ''}_${raw}`;
      if (processedRecordKeys.has(recordKey)) {
        console.warn('[支出表] 發現重複記錄，跳過:', recordKey, 'row =', row);
        return sum; // 跳過重複記錄
      }
      processedRecordKeys.add(recordKey);

      // 如果正在編輯這筆記錄，從總計中排除原始金額（避免重複計算）
      if (isEditing && currentRecordOriginalCost > 0) {
        const recordCost = parseFloat(raw) || 0;
        // 檢查是否為同一筆記錄（通過時間和項目來判斷）
        const currentRecord = filteredRecords[currentRecordIndex];
        if (currentRecord && currentRecord.row) {
          const currentTime = (currentRecord.row[0] || '').toString().trim();
          const currentItem = (currentRecord.row[1] || '').toString().trim();
          const recordTime = (row[0] || '').toString().trim();
          const recordItem = (row[1] || '').toString().trim();
          if (currentTime === recordTime && currentItem === recordItem && recordCost === currentRecordOriginalCost) {
            console.log('[支出表] 跳過正在編輯的記錄，避免重複計算');
            return sum; // 跳過這筆記錄，因為它會被即時輸入取代
          }
        }
      }

      return sum + num;
    }, 0);

    console.log('[支出表] updateTotalDisplay: 處理了', processedRecordKeys.size, '筆唯一記錄，總計 =', historyExpense);
  }

  // 即時輸入的列帳金額（不等待秒數）
  // 只有在新增模式或編輯模式時才加上（編輯模式時，原始金額已經從 historyExpense 中排除了）
  const liveInput = recordCostInput ? (parseFloat(recordCostInput.value) || 0) : 0;
  const expense = historyExpense + liveInput;

  // 3. 餘額：預算 - 支出
  const remain = budget - expense;

  // 格式化顯示（使用千分位符號）
  incomeAmount.textContent = budget.toLocaleString('zh-TW');
  expenseAmount.textContent = expense.toLocaleString('zh-TW');
  totalAmount.textContent = remain.toLocaleString('zh-TW');
  updateTotalColor(remain);
};

// 載入單個月份的資料和總計
const loadMonthData = async (sheetIndex) => {
  // 驗證 sheetIndex 是否有效
  if (!Number.isFinite(sheetIndex) || sheetIndex < 2) {
    throw new Error(`無效的 sheet 索引: ${sheetIndex}`);
  }

  // 從試算表抓出「當月收入 / 支出」等資料 - 添加時間戳避免快取
  const dataParams = { name: "Show Tab Data", sheet: sheetIndex, _t: Date.now() };
  const dataUrl = `${baseExpense}?${new URLSearchParams(dataParams)}`;
  let res;
  try {
    res = await fetch(dataUrl, {
    method: "GET",
    redirect: "follow",
    mode: "cors",
    cache: "no-store" // 強制不使用快取
  });
  } catch (fetchError) {
    throw new Error(`無法連接到伺服器: ${fetchError.message}。請檢查網路連接或 CORS 設定。`);
  }

  if (!res.ok) {
    throw new Error(`載入資料失敗: HTTP ${res.status} ${res.statusText}`);
  }

  let data;
  try {
    data = await res.json();
  } catch (jsonError) {
    const text = await res.text();
    throw new Error(`伺服器回應格式錯誤: ${jsonError.message}`);
  }

  // 如果數據是陣列格式（Apps Script ShowTabData 返回 getValues()），需要轉換為物件格式
  if (Array.isArray(data)) {
    // 將陣列轉換為物件格式，以便與 processDataFromResponse 兼容
    // 假設陣列包含所有數據行，我們需要根據實際情況區分收入和支出
    // 由於支出頁面只處理支出數據，我們將其轉換為物件格式
    const convertedData = {};

    // 支出記錄通常是：編號, 時間, 類別, 項目, 金額, 備註, ...
    // 我們將所有數據都放到 "當月支出" 鍵下
    // 如果有收入數據，可能需要根據欄位數量或其他標識來區分
    let expenseRows = [];
    let incomeRows = [];

    data.forEach((row, index) => {
      if (!row || row.length === 0) return;

      // 跳過標題行或空行
      const firstCell = row[0];
      if (firstCell === '' || firstCell === null || firstCell === undefined) return;

      // 跳過「總計」行
      if (firstCell === '總計' || firstCell.toString().trim() === '總計') {
        return;
      }

      // 根據 Apps Script 結構：[時間(0), item(1), category(2), spendWay(3), creditCard(4), monthIndex(5), actualCost(6), payment(7), recordCost(8), note(9)]
      // 支出頁面主要處理支出，所有行都當作支出處理（因為結構相同）
      if (row.length >= 10) {
        // 確保是有效數據行（時間欄位不為空）
        if (firstCell !== '' && firstCell !== null && firstCell !== undefined) {
          expenseRows.push(row);
        }
      }
    });

    // 構建物件格式，使用一個通用的鍵名
    if (expenseRows.length > 0) {
      // 使用一個包含 "支出" 的鍵名，以便後續處理邏輯識別
      convertedData['當月支出預算'] = expenseRows;
    }
    if (incomeRows.length > 0) {
      convertedData['當月收入'] = incomeRows;
    }
    data = convertedData; // 將轉換後的數據賦值回去
  } else {
  // 檢查每個 key 的資料長度
  Object.keys(data).forEach(key => {
    const rows = data[key] || [];
  });
  }

  // 載入總計 - 由於 CORS 問題，先跳過總計 API，直接計算總計
  // 注意：如果 CORS 問題解決後，可以恢復此 API 調用
  let totalData = null;

  try {
  const TotalParams = { name: "Show Total", sheet: sheetIndex, _t: Date.now() };
  const Totalurl = `${baseExpense}?${new URLSearchParams(TotalParams)}`;
  const Totalres = await fetch(Totalurl, {
    method: "GET",
    redirect: "follow",
    mode: "cors",
    cache: "no-store" // 強制不使用快取
  });

    if (Totalres.ok) {
      try {
        totalData = await Totalres.json();
      } catch (jsonError) {
        totalData = null;
      }
    } else {
      totalData = null;
    }
  } catch (fetchError) {
    // CORS 或網路錯誤：記錄警告，但不拋出錯誤，改用計算的總計
    totalData = null;
  }

  // 根據資料計算總計（因為 Google Apps Script 的總計可能有問題）
  let calculatedIncome = 0;
  let calculatedExpense = 0;
  let incomeCount = 0;
  let expenseCount = 0;

  // 使用 Set 來追蹤已處理的記錄，避免重複計算
  const processedIncomeRecords = new Set();
  const processedExpenseRecords = new Set();

  if (data && typeof data === 'object') {
    // 獲取當前月份名稱（從 sheetNames 中查找，sheetIndex 是實際的 sheet 索引，需要減 2）
    const monthIndex = sheetIndex - 2;
    const currentMonthName = (monthIndex >= 0 && monthIndex < sheetNames.length && sheetNames.length > 0) ? sheetNames[monthIndex] : '';

    Object.keys(data).forEach(key => {
      const rows = data[key] || [];

      // 根據命名範圍名稱判斷類型
      // 命名範圍格式：當月收入202506 或 當月支出預算202506
      const isIncome = key.includes('收入');
      const isExpense = key.includes('支出');

      if (!isIncome && !isExpense) {
        return; // 跳過不是收入或支出的資料
      }

      // 只處理當前月份的資料（命名範圍名稱應該包含當前月份）
      const isCurrentMonth = currentMonthName && key.includes(currentMonthName);
      if (!isCurrentMonth) {
        return; // 跳過不是當前月份的資料
      }

      rows.forEach((row, rowIndex) => {
        if (!row || row.length === 0) return;

        // 檢查是否為空行（所有欄位都是空）
        const isEmptyRow = row.every(cell => cell === '' || cell === null || cell === undefined);
        if (isEmptyRow) {
          return;
        }

        // 跳過總計行（第一欄是 "總計" 或空字串）
        const firstCell = row[0];
        if (firstCell === '交易日期' || firstCell === '總計' || firstCell === '' || firstCell === null || firstCell === undefined) {
          return;
        }

        // 檢查是否為有效記錄（第一欄應該是數字編號）
        const num = parseInt(firstCell, 10);
        if (!Number.isFinite(num) || num <= 0) {
          return;
        }

        // 檢查是否已經處理過這筆記錄（使用編號+時間作為唯一標識）
        const recordKey = `${num}_${row[1] || ''}`;
        if (isIncome) {
          if (processedIncomeRecords.has(recordKey)) {
            return;
          }
          processedIncomeRecords.add(recordKey);
        } else if (isExpense) {
          if (processedExpenseRecords.has(recordKey)) {
            return;
          }
          processedExpenseRecords.add(recordKey);
        }

        // 收入：[編號, 時間, item, cost, note] - cost 在索引 3 (D欄)
        // 支出：[編號, 時間, category, item, cost, note] - cost 在索引 4 (K欄)
        const costIndex = isIncome ? 3 : (isExpense ? 4 : -1);
        if (costIndex >= 0 && row[costIndex] !== undefined && row[costIndex] !== null && row[costIndex] !== '') {
          const cost = parseFloat(row[costIndex]);
          if (Number.isFinite(cost) && cost !== 0) { // 允許負數，但不累加0
            if (isIncome) {
              calculatedIncome += cost;
              incomeCount++;
            } else if (isExpense) {
              calculatedExpense += cost;
              expenseCount++;
            }
          }
        }
      });

    });
  }

  const calculatedTotal = calculatedIncome - calculatedExpense;
  const calculatedTotalData = [calculatedIncome, calculatedExpense, calculatedTotal];
  // 使用計算的總計，而不是 API 返回的總計
  return { data, total: calculatedTotalData };
};

// 預先載入所有月份的資料
const preloadAllMonthsData = async () => {
  if (sheetNames.length === 0) return;

  // 計算需要載入的月份總數（排除當前月份，因為已經載入過了）
  const monthsToLoad = sheetNames.filter((name, idx) => {
    const sheetIndex = idx + 2;
    return sheetIndex !== currentSheetIndex;
  });

  const totalMonths = monthsToLoad.length;
  if (totalMonths === 0) return; // 如果沒有需要預載的月份，直接返回

  let loadedCount = 0;
  const baseProgress = 2; // 已經載入了月份列表(1)和當前月份(1)
  const totalProgress = sheetNames.length + 1; // 總進度 = 月份列表(1) + 所有月份

  // 由新到舊排序（假設月份字串如 202512），並行送出所有請求
  // 先放目前選擇的月份，其餘按年月由新到舊
  const allMonths = sheetNames.map((name, idx) => ({ name, sheetIndex: idx + 2 }));
  const current = allMonths.find(m => m.sheetIndex === currentSheetIndex);
  const others = allMonths.filter(m => m.sheetIndex !== currentSheetIndex)
    .sort((a, b) => (parseInt(b.name, 10) || 0) - (parseInt(a.name, 10) || 0));
  const orderedMonths = current ? [current, ...others] : others;

  const tasks = orderedMonths.map(async ({ name, sheetIndex }) => {
    if (sheetIndex === currentSheetIndex) {
      return null; // 跳過當前月份，因為已經載入過了
    }

    // 先檢查是否已經有預先存取的資料
    if (allMonthsData[sheetIndex]) {
      loadedCount++;
      updateProgress(baseProgress + loadedCount, totalProgress, '載入月份（從快取）');
      return { sheetIndex, name, success: true, fromCache: true };
    }

    try {
      const monthData = await loadMonthData(sheetIndex);
      allMonthsData[sheetIndex] = monthData;

      // 保存到 sessionStorage
      try {
        const storageKey = `expense_monthData_${sheetIndex}`;
        sessionStorage.setItem(storageKey, JSON.stringify(monthData));
      } catch (e) {
        // sessionStorage 可能已滿或不可用，忽略錯誤
      }

      // 更新進度條（baseProgress + 已載入的月份數）
      loadedCount++;
      updateProgress(baseProgress + loadedCount, totalProgress, '載入月份');

      return { sheetIndex, name, success: true, fromCache: false };
    } catch (error) {
      // 即使失敗也更新進度
      loadedCount++;
      updateProgress(baseProgress + loadedCount, totalProgress, '載入月份');

      // 載入失敗，繼續處理其他月份
      return { sheetIndex, name, success: false, error: error.message || error.toString() };
    }
  });

  const results = await Promise.all(tasks);

  // 更新進度條到 100%
  updateProgress(totalProgress, totalProgress, '載入完成');

  Object.keys(allMonthsData).forEach(key => {
    const monthData = allMonthsData[key];
    const total = Array.isArray(monthData.total) ? monthData.total : 'N/A';
  });

  // 延遲一點後隱藏進度條，讓用戶看到「載入完成」提示
  // 注意：hideSpinner 內部已經有 800ms 延遲顯示「已完成」，所以這裡不需要額外延遲
  setTimeout(() => {
    hideSpinner();
  }, 100);
};

// 從記憶體載入當前月份的資料（不發送請求）
const loadContentFromMemory = () => {
  // 先清空目前的記錄（確保不同月份的資料不會混在一起）
  allRecords = [];
  filteredRecords = [];
  currentRecordIndex = 0;

  // 驗證 currentSheetIndex 是否有效
  if (!Number.isFinite(currentSheetIndex) || currentSheetIndex < 2) {
    currentSheetIndex = 2; // 預設為第三個分頁
  }

  // 先從記憶體讀取資料
  let monthData = allMonthsData[currentSheetIndex];

  // 如果記憶體中沒有，嘗試從 sessionStorage 讀取
  if (!monthData) {
    try {
      const storageKey = `expense_monthData_${currentSheetIndex}`;
      const storedData = sessionStorage.getItem(storageKey);
      if (storedData) {
        monthData = JSON.parse(storedData);
        // 同時載入到記憶體
        allMonthsData[currentSheetIndex] = monthData;
      }
    } catch (e) {
      // sessionStorage 可能不可用或數據損壞，忽略錯誤
    }
  }

  if (!monthData) {
    return false; // 表示需要重新載入
  }

  // 確認載入的資料
  const totalPreview = Array.isArray(monthData.total) ? monthData.total : 'N/A';

  // 處理資料（會自動過濾並顯示記錄）
  processDataFromResponse(monthData.data, true);

  // 更新總計顯示（使用預算表快取 + 當前類別支出）
  updateTotalDisplay();

  // 確保顯示第二筆記錄（跳過第一筆），如果有的話，且不在新增模式
  if (!isNewMode && filteredRecords.length > 1) {
    currentRecordIndex = 1;
    showRecord(1);
  } else if (!isNewMode && filteredRecords.length === 1) {
    // 如果只有一筆，進入新增模式
    isNewMode = true;
    currentRecordIndex = 0;
  }

  return true; // 表示成功從記憶體載入
};

// 載入當前月份的資料（優先從記憶體讀取，如果沒有則發送請求）
const loadContent = async (forceReload = false) => {
  // 如果不強制重新載入，先嘗試從記憶體讀取
  if (!forceReload && loadContentFromMemory()) {
    return; // 成功從記憶體載入，直接返回
  }

  // 如果記憶體中沒有資料，或需要強制重新載入，則發送請求
  try {
    const monthData = await loadMonthData(currentSheetIndex);

    // 更新記憶體中的資料
    allMonthsData[currentSheetIndex] = monthData;

    // 保存到 sessionStorage
    try {
      const storageKey = `expense_monthData_${currentSheetIndex}`;
      sessionStorage.setItem(storageKey, JSON.stringify(monthData));
    } catch (e) {
      // sessionStorage 可能已滿或不可用，忽略錯誤
    }

    // 處理資料
    processDataFromResponse(monthData.data);

    // 更新總計顯示（使用預算表快取 + 當前類別支出）
    updateTotalDisplay();

    // 載入後自動顯示第二筆記錄（跳過第一筆）
    if (filteredRecords.length > 1) {
      currentRecordIndex = 1;
      setTimeout(() => {
        showRecord(1);
        updateArrowButtons();
      }, 150);
    } else if (filteredRecords.length === 1) {
      // 如果只有一筆，進入新增模式
      isNewMode = true;
      currentRecordIndex = 0;
      updateArrowButtons();
    }
  } catch (error) {
    throw error;
  }
};


const loadTotal = async () => {
  // 驗證 currentSheetIndex 是否有效
  if (!Number.isFinite(currentSheetIndex) || currentSheetIndex < 2) {
    currentSheetIndex = 2; // 預設為第三個分頁
  }

  // 優先從預算快取讀取（預算表來源）
  if (budgetTotals[currentSheetIndex]) {
    updateTotalDisplay();
    return;
  }

  // 如果快取中沒有，則向「預算表」發送請求並彙總同類別預算
  try {
    await loadBudgetForMonth(currentSheetIndex);
    updateTotalDisplay();
  } catch (error) {
    // 不拋出錯誤，只記錄，避免影響其他功能
  }
};

// 更新進度條
const updateProgress = (current, total, text = '載入中...') => {
  const progressContainer = document.getElementById('loading-progress');
  if (!progressContainer) return;

  const percentage = total > 0 ? Math.min(100, Math.round((current / total) * 100)) : 0;
  const progressBar = progressContainer.querySelector('.progress-bar');
  const progressText = progressContainer.querySelector('.progress-text');

  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
  }
  if (progressText) {
    progressText.textContent = total > 0 ? `${text} (${current}/${total})` : text;
  }
};

const showSpinner = () => {
  // 如果已經存在，先移除
  const existingOverlay = document.getElementById('loading-overlay');
  if (existingOverlay) {
    existingOverlay.remove();
  }

  // 檢查是否有歷史紀錄模態框打開（z-index: 10000）
  const historyModal = document.querySelector('.history-modal');
  const isHistoryModalOpen = historyModal && window.getComputedStyle(historyModal).display !== 'none';
  // 如果歷史紀錄模態框打開，進度條的 z-index 要高於模態框（10000）
  const zIndexValue = isHistoryModalOpen ? 10001 : 1500;

  // 創建全屏遮罩（不覆蓋頁首）
  const overlay = document.createElement('div');
  overlay.id = 'loading-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: ${isHistoryModalOpen ? '0' : '60px'};
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    z-index: ${zIndexValue}; /* 歷史紀錄模態框打開時要高於模態框 (10000)，否則低於頁首 (2000) */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: not-allowed;
  `;

  const progressContainer = document.createElement('div');
  progressContainer.id = 'loading-progress';
  progressContainer.innerHTML = `
    <div style="width: 300px; text-align: center;">
      <div class="progress-text" style="font-size: 16px; margin-bottom: 15px; color: #333;">載入中...</div>
      <div style="width: 100%; height: 8px; background-color: #e0e0e0; border-radius: 4px; overflow: hidden;">
        <div class="progress-bar" style="width: 0%; height: 100%; border-radius: 4px; transition: width 0.3s ease;"></div>
      </div>
    </div>
  `;

  overlay.appendChild(progressContainer);
  document.body.appendChild(overlay);
};

const hideSpinner = () => {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) {
    // 先顯示「已完成」提示
    const progressContainer = document.getElementById('loading-progress');
    if (progressContainer) {
      const progressBar = progressContainer.querySelector('.progress-bar');
      const progressText = progressContainer.querySelector('.progress-text');
      if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
      }
      if (progressText) {
        progressText.textContent = '✓ 已完成';
        progressText.style.color = '#2ecc71';
        progressText.style.fontWeight = 'bold';
      }
    }

    // 延遲 800ms 後移除，讓用戶看到「已完成」提示
    setTimeout(() => {
      overlay.remove();
      const spinner = document.getElementById('loading-spinner');
      if (spinner) {
        spinner.remove();
      }
      const progress = document.getElementById('loading-progress');
      if (progress) {
        progress.remove();
      }
    }, 800);
  } else {
    const spinner = document.getElementById('loading-spinner');
    if (spinner) {
      spinner.remove();
    }
    const progress = document.getElementById('loading-progress');
    if (progress) {
      progress.remove();
    }
  }
};

const createInputRow = (labelText, inputId, inputType = 'text') => {
  const row = document.createElement('div');
  row.className = 'input-row';

  const label = document.createElement('label');
  label.textContent = labelText;
  label.htmlFor = inputId; // 關聯到 input

  const input = document.createElement('input');
  input.id = inputId;
  input.name = inputId; // 添加 name 屬性以支持自動填充
  input.type = inputType;

  row.appendChild(label);
  row.appendChild(input);
  return row;
};

const createTextareaRow = (labelText, textareaId, rows = 3) => {
  const row = document.createElement('div');
  row.className = 'input-row';

  const label = document.createElement('label');
  label.textContent = labelText;
  label.htmlFor = textareaId; // 關聯到 textarea

  const textarea = document.createElement('textarea');
  textarea.id = textareaId;
  textarea.name = textareaId; // 添加 name 屬性以支持自動填充
  textarea.rows = rows;

  row.appendChild(label);
  row.appendChild(textarea);
  return row;
};

const createSelectRow = (labelText, selectId, options) => {
  const row = document.createElement('div');
  row.className = 'select-row';

  const label = document.createElement('label');
  label.textContent = labelText;
  label.htmlFor = selectId; // 關聯到 select

  const selectContainer = document.createElement('div');
  selectContainer.className = 'select-container';

  const selectDisplay = document.createElement('div');
  selectDisplay.className = 'select-display';

  // 處理空選項的情況
  const safeOptions = (options && options.length > 0) ? options : [{ value: '', text: '無選項' }];

  const selectText = document.createElement('div');
  selectText.className = 'select-text';
  selectText.textContent = safeOptions[0].text;

  const selectArrow = document.createElement('div');
  selectArrow.className = 'select-arrow';
  selectArrow.textContent = '▼';

  selectDisplay.appendChild(selectText);
  selectDisplay.appendChild(selectArrow);

  const hiddenSelect = document.createElement('select');
  hiddenSelect.id = selectId;
  hiddenSelect.name = selectId; // 添加 name 屬性以支持自動填充
  hiddenSelect.style.display = 'none';
  hiddenSelect.value = safeOptions[0].value;

  const dropdown = document.createElement('div');
  dropdown.className = 'select-dropdown';

  safeOptions.forEach(opt => {
    const option = document.createElement('div');
    option.className = 'select-option';
    option.textContent = opt.text;
    option.dataset.value = opt.value;

    option.addEventListener('click', function() {
      selectText.textContent = opt.text;
      hiddenSelect.value = opt.value;
      dropdown.style.display = 'none';
      selectArrow.style.transform = 'rotate(0deg)';
      hiddenSelect.dispatchEvent(new Event('change'));
    });

    dropdown.appendChild(option);
    const hiddenOption = document.createElement('option');
    hiddenOption.value = opt.value;
    hiddenOption.textContent = opt.text;
    hiddenSelect.appendChild(hiddenOption);
  });

  selectDisplay.addEventListener('click', function(e) {
    e.stopPropagation();
    const isOpen = dropdown.style.display === 'block';

    // 關閉所有其他下拉選單
    document.querySelectorAll('.select-dropdown').forEach(otherDropdown => {
      if (otherDropdown !== dropdown) {
        otherDropdown.style.display = 'none';
        const otherContainer = otherDropdown.closest('.select-container');
        if (otherContainer) {
          const otherArrow = otherContainer.querySelector('.select-arrow');
          if (otherArrow) {
            otherArrow.style.transform = 'rotate(0deg)';
          }
        }
      }
    });

    dropdown.style.display = isOpen ? 'none' : 'block';
    selectArrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
  });

  document.addEventListener('click', function(e) {
    if (!selectContainer.contains(e.target)) {
      dropdown.style.display = 'none';
      selectArrow.style.transform = 'rotate(0deg)';
    }
  });

  selectContainer.appendChild(selectDisplay);
  selectContainer.appendChild(dropdown);
  selectContainer.appendChild(hiddenSelect);

  row.appendChild(label);
  row.appendChild(selectContainer);
  return row;
};

// （已移至上方：callAPI 與 updateCacheAndHistory）

// 獲取表單數據
function getFormData(prefix = '') {
  const itemInput = document.getElementById(prefix ? `${prefix}-item-input` : 'item-input');
  const dateInput = document.getElementById(prefix ? `${prefix}-date-input` : 'date-input');
  const expenseCategorySelect = document.getElementById(prefix ? `${prefix}-expense-category-select` : 'expense-category-select');
  const paymentMethodSelect = document.getElementById(prefix ? `${prefix}-payment-method-select` : 'payment-method-select');
  const creditCardPaymentSelect = document.getElementById(prefix ? `${prefix}-credit-card-payment-select` : 'credit-card-payment-select');
  const monthPaymentSelect = document.getElementById(prefix ? `${prefix}-month-payment-select` : 'month-payment-select');
  const paymentPlatformSelect = document.getElementById(prefix ? `${prefix}-payment-platform-select` : 'payment-platform-select');
  const actualCostInput = document.getElementById(prefix ? `${prefix}-actual-cost-input` : 'actual-cost-input');
  const recordCostInput = document.getElementById(prefix ? `${prefix}-record-cost-input` : 'record-cost-input');
  const noteInput = document.getElementById(prefix ? `${prefix}-note-input` : 'note-input');

  if (!itemInput || !expenseCategorySelect || !paymentMethodSelect || !actualCostInput || !recordCostInput) {
    throw new Error('請等待表單載入完成');
  }

  const item = itemInput.value.trim();
  // 獲取日期並轉換為 YYYY/MM/DD 格式
  let date = '';
  if (dateInput && dateInput.value) {
    const dateValue = dateInput.value; // 格式：YYYY-MM-DD
    const [year, month, day] = dateValue.split('-');
    date = `${year}/${month}/${day}`;
  } else {
    // 如果沒有選擇日期，使用今天
    date = getNowFormattedDateTime();
  }

  const category = expenseCategorySelect.value;
  const spendWay = paymentMethodSelect.value;
  const actualCostValue = actualCostInput.value.trim();
  const recordCostValue = recordCostInput.value.trim();
  const note = noteInput ? noteInput.value.trim() : '';

  if (!item) throw new Error('請輸入項目');
  if (!category) throw new Error('請選擇類別');
  if (!spendWay) throw new Error('請選擇支付方式');

  const actualCost = parseFloat(actualCostValue) || 0;
  const recordCost = parseFloat(recordCostValue) || 0;

  if (!actualCostValue || isNaN(actualCost) || actualCost <= 0) {
    throw new Error('請輸入有效實際消費金額');
  }

  if (!recordCostValue || isNaN(recordCost) || recordCost <= 0) {
    throw new Error('請輸入有效列帳消費金額');
  }

  let creditCard = '';
  let monthIndex = '';
  let payment = '';

  if (spendWay === '信用卡支出') {
    creditCard = creditCardPaymentSelect ? creditCardPaymentSelect.value : '';
    monthIndex = monthPaymentSelect ? monthPaymentSelect.value : '';
  } else if (spendWay === '存款或儲值的支出：LINE BANK / 悠遊付 / mos card / 髮果 等') {
    payment = paymentPlatformSelect ? paymentPlatformSelect.value : '';
  }

  return { date, item, category, spendWay, creditCard, monthIndex, actualCost, payment, recordCost, note };
}

const updateDivVisibility = (forceType = null) => {
  // 如果提供了類型參數，使用它；否則嘗試從 DOM 獲取最新元素的值
  let categoryValue = forceType;
  if (categoryValue === null) {
    // 先嘗試從全局變數獲取
    if (typeof categorySelect !== 'undefined' && categorySelect.value) {
      categoryValue = categorySelect.value;
    } else {
      // 如果全局變數不可用，從 DOM 獲取最新元素
      const categorySelectElement = document.getElementById('category-select');
      if (categorySelectElement) {
        categoryValue = categorySelectElement.value;
      } else {
        categoryValue = '支出'; // 默認值
      }
    }
  }

  div2.innerHTML = '';
  div3.innerHTML = '';
  div4.innerHTML = '';

  // 添加日期輸入字段（在所有類型中都顯示）
  const dateRow = createInputRow('日期：', 'date-input', 'date');
  const dateInput = dateRow.querySelector('#date-input');
  if (dateInput) {
    // 設置默認值為今天
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    dateInput.value = `${year}-${month}-${day}`;
  }

  if (categoryValue === '支出') {
    const categoryRow = createSelectRow('類別：', 'expense-category-select', [
      { value: '生活花費：食', text: '生活花費：食' },
      { value: '生活花費：衣與外貌', text: '生活花費：衣與外貌' },
      { value: '生活花費：住、居家裝修、衛生用品、次月繳納帳單', text: '生活花費：住、居家裝修、衛生用品、次月繳納帳單' },
      { value: '生活花費：行', text: '生活花費：行' },
      { value: '生活花費：育', text: '生活花費：育' },
      { value: '生活花費：樂', text: '生活花費：樂' },
      { value: '生活花費：健（醫療）', text: '生活花費：健（醫療）' },
      { value: '生活花費：帳單', text: '生活花費：帳單' },
      { value: '儲蓄：退休金、醫療預備金、過年紅包支出', text: '儲蓄：退休金、醫療預備金、過年紅包支出' },
      { value: '家人：過年紅包、紀念日', text: '家人：過年紅包、紀念日' }
    ]);
    const costRow = createInputRow('金額：', 'cost-input', 'number');
    const noteRow = createTextareaRow('備註：', 'note-input', 3);
    noteRow.style.marginBottom = '0px';

    div2.appendChild(dateRow);
    div2.appendChild(categoryRow);
    div3.appendChild(costRow);
    div4.appendChild(noteRow);

    itemContainer.style.display = 'flex';
    div2.style.display = 'flex';
    div3.style.display = 'flex';
    div4.style.display = 'flex';
  } else if (categoryValue === '收入') {
    const costRow = createInputRow('金額：', 'cost-input', 'number');
    const noteRow = createTextareaRow('備註：', 'note-input', 3);
    noteRow.style.marginBottom = '0px';

    div2.appendChild(dateRow);
    div2.appendChild(costRow);
    div3.appendChild(noteRow);

    itemContainer.style.display = 'flex';
    div2.style.display = 'flex';
    div3.style.display = 'flex';
    div4.style.display = 'none';
  }
};

const saveData = async () => {
  // 鎖定整個頁面，等待後端回傳
  showSpinner();
  saveButton.textContent = '儲存中...';
  saveButton.disabled = true;
  saveButton.style.opacity = '0.6';
  saveButton.style.cursor = 'not-allowed';

  // 禁用所有輸入和按鈕
  const itemInput = document.getElementById('item-input');
  const expenseCategorySelect = document.getElementById('expense-category-select');
  const paymentMethodSelect = document.getElementById('payment-method-select');
  const creditCardPaymentSelect = document.getElementById('credit-card-payment-select');
  const monthPaymentSelect = document.getElementById('month-payment-select');
  const paymentPlatformSelect = document.getElementById('payment-platform-select');
  const actualCostInput = document.getElementById('actual-cost-input');
  const recordCostInput = document.getElementById('record-cost-input');
  const noteInput = document.getElementById('note-input');
  if (itemInput) itemInput.disabled = true;
  if (expenseCategorySelect) expenseCategorySelect.disabled = true;
  if (paymentMethodSelect) paymentMethodSelect.disabled = true;
  if (creditCardPaymentSelect) creditCardPaymentSelect.disabled = true;
  if (monthPaymentSelect) monthPaymentSelect.disabled = true;
  if (paymentPlatformSelect) paymentPlatformSelect.disabled = true;
  if (actualCostInput) actualCostInput.disabled = true;
  if (recordCostInput) recordCostInput.disabled = true;
  if (noteInput) noteInput.disabled = true;
  if (historyButton) historyButton.disabled = true;

  try {
    const formData = getFormData();
    const monthIndex = currentSheetIndex - 2;
    const currentMonthName = (monthIndex >= 0 && monthIndex < sheetNames.length) ? sheetNames[monthIndex] : '';
    const result = await callAPI({
      name: "Upsert Data",
      sheet: currentSheetIndex,
      ...formData
    });

    // 等待後端回傳後才顯示成功訊息
    alert('資料已成功儲存！');

    // 使用回傳資料更新暫存
    if (result && result.data) {
      allMonthsData[currentSheetIndex] = { data: result.data, total: result.total };
      processDataFromResponse(result.data, false, currentSheetIndex);
      // 同步刷新歷史紀錄列表
      refreshHistoryList();

      // 保存到 sessionStorage
      try {
        const storageKey = `expense_monthData_${currentSheetIndex}`;
        sessionStorage.setItem(storageKey, JSON.stringify(allMonthsData[currentSheetIndex]));
      } catch (e) {
        // sessionStorage 可能已滿或不可用，忽略錯誤
      }
    }

    // 更新總計顯示（使用最新資料重新計算）
    updateTotalDisplay();

    // 儲存完成後清空表單，準備下一筆新增
    clearForm();
  } catch (error) {
    alert('儲存失敗: ' + error.message);
  } finally {
    // 恢復所有按鈕和輸入
    hideSpinner();
    saveButton.textContent = '儲存';
    saveButton.disabled = false;
    saveButton.style.opacity = '1';
    saveButton.style.cursor = 'pointer';

    if (itemInput) itemInput.disabled = false;
    if (expenseCategorySelect) expenseCategorySelect.disabled = false;
    if (paymentMethodSelect) paymentMethodSelect.disabled = false;
    if (creditCardPaymentSelect) creditCardPaymentSelect.disabled = false;
    if (monthPaymentSelect) monthPaymentSelect.disabled = false;
    if (paymentPlatformSelect) paymentPlatformSelect.disabled = false;
    if (actualCostInput) actualCostInput.disabled = false;
    if (recordCostInput) recordCostInput.disabled = false;
    if (noteInput) noteInput.disabled = false;
    if (historyButton) historyButton.disabled = false;
  }
};


const totalContainer = document.createElement('div');
totalContainer.className = 'total-container';

const budgetCardsContainer = document.createElement('div');
budgetCardsContainer.className = 'budget-cards-container';

// 日期已移除


// 刪除功能已移除（純新增模式不需要）
// 刪除功能改為在歷史紀錄彈出視窗中處理

// 歷史紀錄按鈕（時鐘圖標）
// 歷史紀錄按鈕（文字按鈕）
const historyButton = document.createElement('button');
historyButton.className = 'history-button';
historyButton.textContent = '歷史紀錄';
historyButton.style.cssText = `
  display: inline-block;
  margin-left: 20px;
  padding: 4px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background-color: #fff;
  color: #333;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
`;
historyButton.onmouseenter = () => {
  historyButton.style.backgroundColor = '#f5f5f5';
};
historyButton.onmouseleave = () => {
  historyButton.style.backgroundColor = '#fff';
};

// 防止重複點擊的標誌
let isHistoryModalOpen = false;

// 月份選擇容器
let monthSelectContainer = null;

// 載入月份列表
async function loadMonthNames() {
  try {
    const params = { name: "Show Tab Name" };
    const url = `${baseExpense}?${new URLSearchParams(params)}&_t=${Date.now()}`;
    const response = await fetch(url, {
      method: "GET",
      redirect: "follow",
      mode: "cors",
      cache: "no-store"
    });

    if (!response.ok) {
      throw new Error(`載入失敗: HTTP ${response.status}`);
    }

    const data = await response.json();

    if (Array.isArray(data)) {
      // 檢查前兩個項目是否是無效項目（空白表、下拉選單）
      const invalidItems = ['空白表', '下拉選單', '', null, undefined];
      const firstItem = data[0];
      const secondItem = data[1];

      const shouldSkipFirst = invalidItems.includes(firstItem);
      const shouldSkipSecond = invalidItems.includes(secondItem);

      if (shouldSkipFirst && shouldSkipSecond && data.length > 2) {
        // 如果前兩個都是無效項目，跳過它們
        sheetNames = data.slice(2);
        hasInvalidFirstTwoSheets = true;
      } else {
        // 如果前兩個不是無效項目，使用所有數據（都是有效的月份）
        sheetNames = data;
        hasInvalidFirstTwoSheets = false;
      }

      // 保存到 sessionStorage
      try {
        sessionStorage.setItem('expense_sheetNames', JSON.stringify(sheetNames));
        sessionStorage.setItem('expense_hasInvalidFirstTwoSheets', String(hasInvalidFirstTwoSheets));
      } catch (e) {
        // sessionStorage 可能已滿或不可用，忽略錯誤
      }

      return sheetNames;
    } else {
      return [];
    }
  } catch (error) {
    return [];
  }
}

// 顯示月份選擇
async function showMonthSelect() {
  // 如果已經打開，不重複打開
  if (isHistoryModalOpen) {
    return;
  }

  isHistoryModalOpen = true;
  historyButton.disabled = true;

  // 如果已經存在月份選擇容器，先移除
  if (monthSelectContainer) {
    monthSelectContainer.remove();
  }

  // 每次打開都重新載入月份列表，確保數據是最新的
  const months = await loadMonthNames();
  // 如果載入失敗或為空，顯示錯誤信息
  if (!months || months.length === 0) {
    alert('無法載入月份列表，請稍後再試');
    isHistoryModalOpen = false;
    historyButton.disabled = false;
    return;
  }

  // 創建彈出視窗
  const modal = document.createElement('div');
  modal.className = 'month-select-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;

  // 創建內容容器
  const content = document.createElement('div');
  content.className = 'month-select-modal-content';
  content.style.cssText = `
    background-color: #fff;
    border-radius: 12px;
    padding: 30px;
    max-width: 400px;
    width: 100%;
    position: relative;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  `;

  // 關閉按鈕（右上角）
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '✕';
  closeBtn.style.cssText = `
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    border: none;
    background: transparent;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    line-height: 1;
  `;
  closeBtn.onclick = () => {
    modal.remove();
    isHistoryModalOpen = false;
    historyButton.disabled = false;
  };

  // 標題
  const title = document.createElement('h2');
  title.textContent = '選擇月份';
  title.style.cssText = `
    margin: 0 0 20px 0;
    font-size: 20px;
    font-weight: 600;
  `;

  // 創建下拉選單容器
  const selectContainer = document.createElement('div');
  selectContainer.style.cssText = `
    margin-bottom: 20px;
  `;

  // 創建下拉選單
  const select = document.createElement('select');
  select.id = 'month-select';
  select.name = 'month-select';
  select.style.cssText = `
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background-color: #fff;
    color: #333;
    font-size: 16px;
    cursor: pointer;
  `;

  // 添加選項
  if (months.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = '載入中...';
    option.disabled = true;
    select.appendChild(option);
  } else {
    months.forEach((month, index) => {
      const option = document.createElement('option');
      // sheetIndex 的計算：無論如何，月份的 sheet index 都是從 2 開始（因為前兩個是空白表和下拉選單）
      const sheetIndex = index + 2;
      option.value = sheetIndex;
      option.textContent = month;
      option.dataset.monthName = month; // 儲存月份名稱以便調試
      if (sheetIndex === currentSheetIndex) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  }

  // 選擇月份後載入該月份的歷史紀錄
  select.addEventListener('change', async (e) => {
    const selectedSheetIndex = parseInt(e.target.value, 10);
    if (isNaN(selectedSheetIndex)) {
      return;
    }

    const selectedOption = e.target.options[e.target.selectedIndex];
    const selectedMonthName = selectedOption ? selectedOption.dataset.monthName || selectedOption.textContent : '';
    currentSheetIndex = selectedSheetIndex;

    // 關閉月份選擇彈出視窗
    modal.remove();
    isHistoryModalOpen = false;

    // 顯示歷史紀錄彈出視窗
    await showHistoryModal();
  });

  selectContainer.appendChild(select);

  content.appendChild(closeBtn);
  content.appendChild(title);
  content.appendChild(selectContainer);
  modal.appendChild(content);

  // 點擊背景關閉
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
      isHistoryModalOpen = false;
      historyButton.disabled = false;
    }
  };

  document.body.appendChild(modal);
}

historyButton.onclick = showHistoryModal;

// 創建歷史記錄項目的輔助函數
function createHistoryItem(record, listElement) {
  const item = document.createElement('div');
  item.className = 'history-item';
  item.style.cssText = `
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
  `;
  item.onmouseenter = () => item.style.backgroundColor = '#f5f5f5';
  item.onmouseleave = () => item.style.backgroundColor = 'transparent';

  const itemContent = document.createElement('div');
  itemContent.style.cssText = 'flex: 1; min-width: 0;';

  const date = document.createElement('div');
  date.textContent = formatRecordDateTime(record.row[0] || '');
  date.style.cssText = 'font-size: 14px; color: #666; margin-bottom: 4px;';

  const itemTitle = document.createElement('div');
  itemTitle.textContent = record.row[1] || '(無標題)';
  itemTitle.style.cssText = 'font-size: 16px; font-weight: 500; color: #333;';

  itemContent.appendChild(date);
  itemContent.appendChild(itemTitle);

  // 刪除按鈕
  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = '刪除';
  deleteBtn.style.cssText = `
    padding: 4px 12px;
    border: 1px solid #dc3545;
    border-radius: 4px;
    background-color: #fff;
    color: #dc3545;
    font-size: 12px;
    cursor: pointer;
    margin-left: 10px;
    transition: all 0.2s;
    flex-shrink: 0;
  `;
  deleteBtn.onmouseenter = () => {
    deleteBtn.style.backgroundColor = '#dc3545';
    deleteBtn.style.color = '#fff';
  };
  deleteBtn.onmouseleave = () => {
    deleteBtn.style.backgroundColor = '#fff';
    deleteBtn.style.color = '#dc3545';
  };
  deleteBtn.onclick = async (e) => {
    e.stopPropagation();
    if (!confirm('確定要刪除這筆記錄嗎？')) return;

    // 鎖定整個頁面，等待後端回傳
    showSpinner();
    deleteBtn.disabled = true;

    // 禁用所有輸入和按鈕
    const itemInput = document.getElementById('item-input');
    const expenseCategorySelect = document.getElementById('expense-category-select');
    const paymentMethodSelect = document.getElementById('payment-method-select');
    const creditCardPaymentSelect = document.getElementById('credit-card-payment-select');
    const monthPaymentSelect = document.getElementById('month-payment-select');
    const paymentPlatformSelect = document.getElementById('payment-platform-select');
    const actualCostInput = document.getElementById('actual-cost-input');
    const recordCostInput = document.getElementById('record-cost-input');
    const noteInput = document.getElementById('note-input');
    if (itemInput) itemInput.disabled = true;
    if (expenseCategorySelect) expenseCategorySelect.disabled = true;
    if (paymentMethodSelect) paymentMethodSelect.disabled = true;
    if (creditCardPaymentSelect) creditCardPaymentSelect.disabled = true;
    if (monthPaymentSelect) monthPaymentSelect.disabled = true;
    if (paymentPlatformSelect) paymentPlatformSelect.disabled = true;
    if (actualCostInput) actualCostInput.disabled = true;
    if (recordCostInput) recordCostInput.disabled = true;
    if (noteInput) noteInput.disabled = true;
    if (saveButton) saveButton.disabled = true;
    if (historyButton) historyButton.disabled = true;

    try {
      await deleteRecord(record);
      // 等待後端回傳後才顯示成功訊息
      alert('記錄已成功刪除！');
      // 從畫面上移除這一筆
      if (listElement && item.parentNode === listElement) {
        listElement.removeChild(item);
      } else {
        item.remove();
      }
    } catch (error) {
      alert('刪除失敗: ' + error.message);
    } finally {
      // 恢復所有按鈕和輸入
      hideSpinner();
      deleteBtn.disabled = false;
      if (itemInput) itemInput.disabled = false;
      if (expenseCategorySelect) expenseCategorySelect.disabled = false;
      if (paymentMethodSelect) paymentMethodSelect.disabled = false;
      if (creditCardPaymentSelect) creditCardPaymentSelect.disabled = false;
      if (monthPaymentSelect) monthPaymentSelect.disabled = false;
      if (paymentPlatformSelect) paymentPlatformSelect.disabled = false;
      if (actualCostInput) actualCostInput.disabled = false;
      if (recordCostInput) recordCostInput.disabled = false;
      if (noteInput) noteInput.disabled = false;
      if (saveButton) saveButton.disabled = false;
      if (historyButton) historyButton.disabled = false;
    }
  };

  item.appendChild(itemContent);
  item.appendChild(deleteBtn);

  item.onclick = (e) => {
    if (e.target === deleteBtn || deleteBtn.contains(e.target)) {
      return;
    }
    showEditModal(record);
  };

  return item;
}

// 從暫存區載入歷史紀錄列表（不發送請求）
function loadHistoryListFromCache(sheetIndex) {
  // 先清空目前的記錄
  allRecords = [];

  // 先從記憶體讀取資料
  let monthData = allMonthsData[sheetIndex];

  // 如果記憶體中沒有，嘗試從 sessionStorage 讀取
  if (!monthData) {
    try {
      const storageKey = `expense_monthData_${sheetIndex}`;
      const storedData = sessionStorage.getItem(storageKey);
      if (storedData) {
        monthData = JSON.parse(storedData);
        // 同時載入到記憶體
        allMonthsData[sheetIndex] = monthData;
      }
    } catch (e) {
      // sessionStorage 可能不可用或數據損壞，忽略錯誤
    }
  }

  if (!monthData || !monthData.data) {
    return [];
  }

  // 處理資料（不進行過濾，因為只需要記錄列表）
  // 傳入 sheetIndex 確保正確處理月份資料
  processDataFromResponse(monthData.data, false, sheetIndex);

  // 為每一筆記錄標註對應的試算表列號
  // 注意：由於 processDataFromResponse 已經過濾了標題和總計行，
  // 我們使用簡單的索引計算（第 1 列是標題，所以從第 2 列開始）
  // 如果資料是陣列格式，ShowTabData 返回的資料中第一行（索引 0）是標題，資料從第二行（索引 1）開始
  // 但由於我們已經過濾了標題行，這裡的 index 對應的是過濾後的記錄索引
  // 實際的 sheet 行號需要考慮：標題行（第 1 行）+ 過濾掉的總計行
  // 為了簡化，我們假設記錄是按順序的，使用 index + 2（第 1 行是標題，第 2 行開始是資料）
  allRecords.forEach((r, index) => {
    r.sheetRowIndex = index + 2;
  });
  return allRecords;
}

// 找到最接近的月份（當前月份或最新月份）
function findClosestMonth() {
  if (sheetNames.length === 0) return 2; // 預設為第一個月份

  // 根據現在的年月選擇最接近的月份
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1;
  const currentMonthStr = `${currentYear}${String(currentMonth).padStart(2, '0')}`;

  // 先嘗試找到當前月份
  const currentIndex = sheetNames.findIndex(name => name === currentMonthStr);
  if (currentIndex !== -1) {
    return currentIndex + 2;
  }

  // 如果找不到當前月份，返回最新的月份（最後一個）
  return sheetNames.length + 1; // 最後一個月份的 sheetIndex
}

// 顯示歷史紀錄彈出視窗（包含月份選擇）
async function showHistoryModal() {
  // 檢查是否已經有現有的歷史記錄彈出視窗
  const existingModal = document.querySelector('.history-modal');
  if (existingModal && isHistoryModalOpen) {
    return;
  }

  // 如果有現有的彈出視窗，先移除
  if (existingModal) {
    existingModal.remove();
  }

  isHistoryModalOpen = true;
  historyButton.disabled = true; // 禁用按鈕，防止重複點擊

  // 創建彈出視窗（先顯示，準備顯示載入中）
  const modal = document.createElement('div');
  modal.className = 'history-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;

  // 創建內容容器
  const content = document.createElement('div');
  content.className = 'history-modal-content';
  content.style.cssText = `
    background-color: #fff;
    border-radius: 12px;
    padding: 0 20px 20px 20px; /* 上緣貼齊，移除頂部內距 */
    max-width: 600px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  `;

  // 創建載入中顯示（填滿整個內容區域）- 使用進度條
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'history-loading-progress';
  loadingDiv.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.95);
    z-index: 10001;
    padding: 40px 20px;
  `;

  const progressContainer = document.createElement('div');
  progressContainer.style.cssText = `
    width: 300px;
    text-align: center;
  `;

  const progressText = document.createElement('div');
  progressText.className = 'progress-text';
  progressText.textContent = '載入中...';
  progressText.style.cssText = `
    font-size: 16px;
    margin-bottom: 15px;
    color: #333;
  `;

  const progressBarContainer = document.createElement('div');
  progressBarContainer.style.cssText = `
    width: 100%;
    height: 8px;
    background-color: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
  `;

  const progressBar = document.createElement('div');
  progressBar.className = 'progress-bar';
  progressBar.style.cssText = `
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #3498db, #2ecc71);
    border-radius: 4px;
    transition: width 0.3s ease;
  `;

  progressBarContainer.appendChild(progressBar);
  progressContainer.appendChild(progressText);
  progressContainer.appendChild(progressBarContainer);
  loadingDiv.appendChild(progressContainer);
  content.appendChild(loadingDiv);

  // 顯示不確定的進度動畫
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress = (progress + 5) % 100;
    progressBar.style.width = `${progress}%`;
  }, 100);
  modal.appendChild(content);
  document.body.appendChild(modal);

  // 如果月份列表還沒載入，先載入
  if (sheetNames.length === 0) {
    await loadMonthNames();
  }

  // 找到最接近的月份並設為當前月份
  const closestSheetIndex = findClosestMonth();
  currentSheetIndex = closestSheetIndex;
  // 確保至少載入當前月份（若暫存尚未有，先嘗試從 sessionStorage 讀取，否則單次拉取）
  if (!allMonthsData[currentSheetIndex]) {
    try {
      const storageKey = `expense_monthData_${currentSheetIndex}`;
      const storedData = sessionStorage.getItem(storageKey);
      if (storedData) {
        allMonthsData[currentSheetIndex] = JSON.parse(storedData);
      } else {
        const monthData = await loadMonthData(currentSheetIndex);
        allMonthsData[currentSheetIndex] = monthData;

        // 保存到 sessionStorage
        try {
          sessionStorage.setItem(storageKey, JSON.stringify(monthData));
        } catch (e) {
          // sessionStorage 可能已滿或不可用，忽略錯誤
        }
      }
    } catch (e) {
    }
  }

  // 從暫存區載入歷史記錄列表
  const records = loadHistoryListFromCache(currentSheetIndex);

  // 移除載入中顯示
  clearInterval(progressInterval);
  progressBar.style.width = '100%';
  progressBar.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
  progressText.textContent = '✓ 已完成';
  progressText.style.color = '#2ecc71';
  progressText.style.fontWeight = 'bold';

  setTimeout(() => {
    loadingDiv.remove();
  }, 500);

  // 手機版本添加右側 padding
  if (window.innerWidth <= 768) {
    content.style.paddingRight = '20px';
    content.style.paddingLeft = '20px';
  }

  // 關閉按鈕（放在頁首，與標題同一列，一起 sticky）
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '✕';
  closeBtn.style.cssText = `
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    font-size: 20px;
    cursor: pointer;
    color: #666;
    line-height: 1;
  `;
  closeBtn.onclick = () => {
    modal.remove();
    isHistoryModalOpen = false;
    historyButton.disabled = false; // 重新啟用按鈕
  };

  // 更新記錄列表顯示的函數
  const updateHistoryList = (listElement, recordsToShow) => {
    listElement.innerHTML = '';

    // 顯示所有記錄（過濾標題行）
    const displayRecords = recordsToShow.filter(r => !isHeaderRecord(r));

    if (displayRecords.length === 0) {
      const emptyMsg = document.createElement('div');
      emptyMsg.textContent = '尚無歷史紀錄';
      emptyMsg.style.cssText = 'text-align: center; padding: 40px; color: #999;';
      listElement.appendChild(emptyMsg);
  } else {
      displayRecords.forEach((record, index) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.style.cssText = `
          padding: 12px;
          padding-right: ${window.innerWidth <= 768 ? '20px' : '12px'};
          border-bottom: 1px solid #eee;
          cursor: pointer;
          transition: background-color 0.2s;
          display: flex;
          align-items: center;
          justify-content: space-between;
          position: relative;
        `;
        listElement.appendChild(createHistoryItem(record, listElement));
      });
    }
  };

  // 標題和月份選擇容器（固定浮現）
  const headerContainer = document.createElement('div');
  headerContainer.style.cssText = `
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    position: sticky;
    top: 0;
    background-color: #fff;
    padding: 10px 0;
    z-index: 10;
    border-bottom: 1px solid #eee;
  `;

  const title = document.createElement('h2');
  title.textContent = '歷史紀錄';
  title.id = 'history-modal-title';
  title.style.cssText = `
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  `;

  // 月份選擇下拉選單
  monthSelectContainer = document.createElement('div');
  monthSelectContainer.style.cssText = `
    display: flex;
    align-items: center;
    gap: 10px;
  `;

  const monthLabel = document.createElement('label');
  monthLabel.textContent = '月份：';
  monthLabel.htmlFor = 'history-month-select'; // 關聯到 select
  monthLabel.style.cssText = 'font-size: 14px; color: #666;';

  const monthSelect = document.createElement('select');
  monthSelect.id = 'history-month-select';
  monthSelect.name = 'history-month-select';
  monthSelect.style.cssText = `
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background-color: #fff;
    color: #333;
    font-size: 14px;
    cursor: pointer;
  `;

  // 添加月份選項
  sheetNames.forEach((month, index) => {
    const option = document.createElement('option');
    const sheetIndex = index + 2;
    option.value = sheetIndex;
    option.textContent = month;
    option.dataset.monthName = month; // 儲存月份名稱以便調試
    if (sheetIndex === currentSheetIndex) {
      option.selected = true;
    }
    monthSelect.appendChild(option);
  });

  // 月份選擇變更事件
  monthSelect.addEventListener('change', async (e) => {
    const selectedSheetIndex = parseInt(e.target.value, 10);
    if (isNaN(selectedSheetIndex)) {
      return;
    }

    const selectedOption = e.target.options[e.target.selectedIndex];
    const selectedMonthName = selectedOption ? selectedOption.dataset.monthName || selectedOption.textContent : '';
    currentSheetIndex = selectedSheetIndex;

    // 如果該月份的資料還沒載入，顯示載入中
    if (!allMonthsData[currentSheetIndex]) {
      // 創建載入中顯示（填滿列表區域）
      const loadingDiv = document.createElement('div');
      loadingDiv.style.cssText = `
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        width: 100%;
        padding: 40px 20px;
      `;

      const spinner = document.createElement('div');
      spinner.style.cssText = `
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      `;

      const loadingText = document.createElement('div');
      loadingText.textContent = '載入中...';
      loadingText.style.cssText = `
        font-size: 16px;
        color: #666;
      `;

      // 改用進度條
      const progressContainer = document.createElement('div');
      progressContainer.style.cssText = `
        width: 300px;
        text-align: center;
      `;

      const progressText = document.createElement('div');
      progressText.className = 'progress-text';
      progressText.textContent = '載入中...';
      progressText.style.cssText = `
        font-size: 16px;
        margin-bottom: 15px;
        color: #333;
      `;

      const progressBarContainer = document.createElement('div');
      progressBarContainer.style.cssText = `
        width: 100%;
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
      `;

      const progressBar = document.createElement('div');
      progressBar.className = 'progress-bar';
      progressBar.style.cssText = `
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        border-radius: 4px;
        transition: width 0.3s ease;
      `;

      progressBarContainer.appendChild(progressBar);
      progressContainer.appendChild(progressText);
      progressContainer.appendChild(progressBarContainer);
      loadingDiv.innerHTML = '';
      loadingDiv.appendChild(progressContainer);
      list.innerHTML = '';
      list.appendChild(loadingDiv);

      // 顯示不確定的進度動畫
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress = (progress + 5) % 100;
        progressBar.style.width = `${progress}%`;
      }, 100);

        // 載入該月份的資料
        try {
          const monthData = await loadMonthData(currentSheetIndex);
          allMonthsData[currentSheetIndex] = monthData;

          // 保存到 sessionStorage
          try {
            const storageKey = `expense_monthData_${currentSheetIndex}`;
            sessionStorage.setItem(storageKey, JSON.stringify(monthData));
          } catch (e) {
            // sessionStorage 可能已滿或不可用，忽略錯誤
          }

        // 移除載入中顯示
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
        progressText.textContent = '✓ 已完成';
        progressText.style.color = '#2ecc71';
        progressText.style.fontWeight = 'bold';

        setTimeout(() => {
          loadingDiv.remove();
        }, 500);
      } catch (e) {
        // 載入失敗，顯示錯誤訊息
        clearInterval(progressInterval);
        list.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">載入失敗，請稍後再試</div>';
        return;
      }
    }

    // 從暫存區重新載入該月份的記錄
    const newRecords = loadHistoryListFromCache(currentSheetIndex);

    // 更新記錄列表顯示
    updateHistoryList(list, newRecords);
  });

  monthSelectContainer.appendChild(monthLabel);
  monthSelectContainer.appendChild(monthSelect);

  // 左側：標題 + 月份選擇；右側：叉叉關閉
  const headerLeftContainer = document.createElement('div');
  headerLeftContainer.style.cssText = `
    display: flex;
    align-items: center;
    gap: 16px;
  `;
  headerLeftContainer.appendChild(title);
  headerLeftContainer.appendChild(monthSelectContainer);

  headerContainer.appendChild(headerLeftContainer);
  headerContainer.appendChild(closeBtn);

  // 記錄列表
  const list = document.createElement('div');
  list.className = 'history-list';

  // 初始化記錄列表顯示
  updateHistoryList(list, records);

  // 只添加一次：headerContainer 已經包含 closeBtn
  content.appendChild(headerContainer);
  content.appendChild(list);
  modal.appendChild(content);

  // 點擊背景關閉
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
      isHistoryModalOpen = false;
      historyButton.disabled = false; // 重新啟用按鈕
    }
  };

  document.body.appendChild(modal);
}

// 顯示編輯彈出視窗
function showEditModal(record) {
  // 先從暫存區載入該月份的完整記錄列表
  const allRecordsForMonth = loadHistoryListFromCache(currentSheetIndex);
  // 根據記錄的唯一標識（時間和項目）找到對應的完整記錄
  const recordTime = record.row[0] || '';
  const recordItem = record.row[1] || '';
  const fullRecord = allRecordsForMonth.find(r => {
    const rTime = r.row[0] || '';
    const rItem = r.row[1] || '';
    return rTime === recordTime && rItem === recordItem;
  });

  if (!fullRecord) {
    alert('無法載入完整的記錄數據，請重新選擇');
    return;
  }
  const modal = document.createElement('div');
  modal.className = 'edit-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;

  const content = document.createElement('div');
  content.className = 'edit-modal-content';
  content.style.cssText = `
    background-color: #fff;
    border-radius: 12px;
    padding: 30px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  `;

  // 關閉按鈕（右上角）
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '✕';
  closeBtn.style.cssText = `
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    border: none;
    background: transparent;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    line-height: 1;
    z-index: 12;
  `;
  // 關閉按鈕：只關閉編輯視窗，回到歷史記錄列表
  closeBtn.onclick = () => {
    modal.remove();
    // 不關閉歷史記錄列表，讓用戶可以繼續選擇其他記錄
  };

  // 標題
  const title = document.createElement('h2');
  title.textContent = '編輯記錄';
  title.style.cssText = `
    margin: 0 0 20px 0;
    font-size: 20px;
    font-weight: 600;
  `;

  // 創建表單容器（複製表單結構）
  const formContainer = document.createElement('div');
  formContainer.className = 'edit-form-container';

  // 重新創建表單元素（避免ID衝突）
  const itemRow = createInputRow('項目：', 'edit-item-input');
  const expenseCategoryRow = createSelectRow('類別：', 'edit-expense-category-select', EXPENSE_CATEGORY_OPTIONS);

  const paymentMethodRow = createSelectRow('支付方式：', 'edit-payment-method-select', PAYMENT_METHOD_OPTIONS);

  const creditCardPaymentRow = createSelectRow('信用卡支付方式：', 'edit-credit-card-payment-select', CREDIT_CARD_PAYMENT_OPTIONS);

  const monthPaymentRow = createSelectRow('本月／次月支付：', 'edit-month-payment-select', MONTH_PAYMENT_OPTIONS);

  const paymentPlatformRow = createSelectRow('支付平台：', 'edit-payment-platform-select', PAYMENT_PLATFORM_OPTIONS);

  const actualCostRow = createInputRow('實際消費金額：', 'edit-actual-cost-input', 'number');
  const recordCostRow = createInputRow('列帳消費金額：', 'edit-record-cost-input', 'number');

  // 備註使用 textarea
  const noteRow = document.createElement('div');
  noteRow.className = 'input-row';
  const noteLabel = document.createElement('label');
  noteLabel.textContent = '備註：';
  noteLabel.htmlFor = 'edit-note-input';
  const noteInput = document.createElement('textarea');
  noteInput.id = 'edit-note-input';
  noteInput.name = 'edit-note-input';
  noteInput.rows = 3;
  noteRow.appendChild(noteLabel);
  noteRow.appendChild(noteInput);

  // 設置條件顯示的初始狀態（預設隱藏）
  creditCardPaymentRow.style.display = 'none';
  monthPaymentRow.style.display = 'none';
  paymentPlatformRow.style.display = 'none';

  // 添加支付方式變更事件處理，控制條件欄位的顯示/隱藏
  const paymentMethodSelect = paymentMethodRow.querySelector('#edit-payment-method-select');
  if (paymentMethodSelect) {
    paymentMethodSelect.addEventListener('change', () => {
      const paymentMethod = paymentMethodSelect.value;
      if (paymentMethod === '信用卡支出') {
        creditCardPaymentRow.style.display = 'flex';
        monthPaymentRow.style.display = 'flex';
        paymentPlatformRow.style.display = 'none';
      } else if (paymentMethod === '存款或儲值的支出：LINE BANK / 悠遊付 / mos card / 髮果 等') {
        creditCardPaymentRow.style.display = 'none';
        monthPaymentRow.style.display = 'none';
        paymentPlatformRow.style.display = 'flex';
  } else {
        creditCardPaymentRow.style.display = 'none';
        monthPaymentRow.style.display = 'none';
        paymentPlatformRow.style.display = 'none';
      }
    });
  }

  formContainer.appendChild(itemRow);
  formContainer.appendChild(expenseCategoryRow);
  formContainer.appendChild(paymentMethodRow);
  formContainer.appendChild(creditCardPaymentRow);
  formContainer.appendChild(monthPaymentRow);
  formContainer.appendChild(paymentPlatformRow);
  formContainer.appendChild(actualCostRow);
  formContainer.appendChild(recordCostRow);
  formContainer.appendChild(noteRow);

  // 先將表單添加到 modal，確保元素在 DOM 中
  content.appendChild(closeBtn);
  content.appendChild(title);
  content.appendChild(formContainer);
  modal.appendChild(content);
  document.body.appendChild(modal);

  // 等待 DOM 更新後再填充數據
  setTimeout(() => {
    // 使用完整記錄數據填充表單
    const row = fullRecord.row;

  const itemInput = document.getElementById('edit-item-input');
  const expenseCategorySelect = document.getElementById('edit-expense-category-select');
  // paymentMethodSelect 已經在第 1858 行聲明，不需要重複聲明
  const creditCardPaymentSelect = document.getElementById('edit-credit-card-payment-select');
  const monthPaymentSelect = document.getElementById('edit-month-payment-select');
  const paymentPlatformSelect = document.getElementById('edit-payment-platform-select');
  const actualCostInput = document.getElementById('edit-actual-cost-input');
  const recordCostInput = document.getElementById('edit-record-cost-input');
  const noteInput = document.getElementById('edit-note-input'); // 重新獲取，確保元素已存在

  // 填充項目（確保可以編輯）
  if (itemInput) {
    itemInput.value = row[1] || '';
    itemInput.readOnly = false; // 確保可以編輯
    itemInput.disabled = false; // 確保可以編輯
  } else {
  }

  // 填充類別
  if (expenseCategorySelect) {
    expenseCategorySelect.value = row[2] || '';
    const selectContainer = expenseCategorySelect.parentElement;
    if (selectContainer) {
      const selectDisplay = selectContainer.querySelector('.select-display');
      if (selectDisplay) {
        const selectText = selectDisplay.querySelector('.select-text');
        if (selectText) {
          const selectedOption = expenseCategorySelect.options[expenseCategorySelect.selectedIndex];
          selectText.textContent = selectedOption ? selectedOption.textContent : row[2] || '';
        }
      }
    }
  }

  // 填充支付方式（先設置值，觸發 change 事件以顯示/隱藏條件欄位）
  if (paymentMethodSelect) {
    paymentMethodSelect.value = row[3] || '';
    const selectContainer = paymentMethodSelect.parentElement;
    if (selectContainer) {
      const selectDisplay = selectContainer.querySelector('.select-display');
      if (selectDisplay) {
        const selectText = selectDisplay.querySelector('.select-text');
        if (selectText) {
          const selectedOption = paymentMethodSelect.options[paymentMethodSelect.selectedIndex];
          selectText.textContent = selectedOption ? selectedOption.textContent : row[3] || '';
        }
      }
    }
    // 手動設置條件欄位的顯示狀態
    const paymentMethod = row[3] || '';
    if (paymentMethod === '信用卡支出') {
      creditCardPaymentRow.style.display = 'flex';
      monthPaymentRow.style.display = 'flex';
      paymentPlatformRow.style.display = 'none';
    } else if (paymentMethod === '存款或儲值的支出：LINE BANK / 悠遊付 / mos card / 髮果 等') {
      creditCardPaymentRow.style.display = 'none';
      monthPaymentRow.style.display = 'none';
      paymentPlatformRow.style.display = 'flex';
    } else {
      creditCardPaymentRow.style.display = 'none';
      monthPaymentRow.style.display = 'none';
      paymentPlatformRow.style.display = 'none';
    }

    // 等待 DOM 更新後再填充條件欄位
    setTimeout(() => {
      // 填充信用卡支付方式（如果支付方式是信用卡）
      if (paymentMethod === '信用卡支出' && creditCardPaymentSelect) {
        creditCardPaymentSelect.value = row[4] || '';
        const selectContainer = creditCardPaymentSelect.parentElement;
        if (selectContainer) {
          const selectDisplay = selectContainer.querySelector('.select-display');
          if (selectDisplay) {
            const selectText = selectDisplay.querySelector('.select-text');
            if (selectText) {
              const selectedOption = creditCardPaymentSelect.options[creditCardPaymentSelect.selectedIndex];
              selectText.textContent = selectedOption ? selectedOption.textContent : row[4] || '';
            }
          }
        }
      }

      // 填充本月/次月支付（如果支付方式是信用卡）
      if (paymentMethod === '信用卡支出' && monthPaymentSelect) {
        monthPaymentSelect.value = row[5] || '';
        const selectContainer = monthPaymentSelect.parentElement;
        if (selectContainer) {
          const selectDisplay = selectContainer.querySelector('.select-display');
          if (selectDisplay) {
            const selectText = selectDisplay.querySelector('.select-text');
            if (selectText) {
              const selectedOption = monthPaymentSelect.options[monthPaymentSelect.selectedIndex];
              selectText.textContent = selectedOption ? selectedOption.textContent : row[5] || '';
            }
          }
        }
      }

      // 填充支付平台（如果支付方式是存款或儲值）
      if (paymentMethod === '存款或儲值的支出：LINE BANK / 悠遊付 / mos card / 髮果 等' && paymentPlatformSelect) {
        paymentPlatformSelect.value = row[7] || '';
        const selectContainer = paymentPlatformSelect.parentElement;
        if (selectContainer) {
          const selectDisplay = selectContainer.querySelector('.select-display');
          if (selectDisplay) {
            const selectText = selectDisplay.querySelector('.select-text');
            if (selectText) {
              const selectedOption = paymentPlatformSelect.options[paymentPlatformSelect.selectedIndex];
              selectText.textContent = selectedOption ? selectedOption.textContent : row[7] || '';
            }
          }
        }
      }
    }, 50);
  }

  // 填充金額和備註（在 setTimeout 內部，確保元素已存在）
  if (actualCostInput) {
    actualCostInput.value = row[6] || '';
  } else {
  }
  if (recordCostInput) {
    recordCostInput.value = row[8] || '';
  } else {
  }
  if (noteInput) {
    noteInput.value = row[9] || '';
  } else {
  }
  }, 100); // 等待 DOM 完全渲染後再填充

  // 儲存按鈕
  const saveBtn = document.createElement('button');
  saveBtn.textContent = '儲存';
  saveBtn.className = 'save-button';
  saveBtn.style.cssText = `
    margin-top: 20px;
    width: 100%;
  `;

  let isSaving = false;
  saveBtn.onclick = async () => {
    if (isSaving) return;
    isSaving = true;

    // 鎖定整個頁面，等待後端回傳
    showSpinner();
    saveBtn.textContent = '儲存中...';
    saveBtn.disabled = true;

    // 禁用所有輸入和按鈕
    const editItemInput = document.getElementById('edit-item-input');
    const editExpenseCategorySelect = document.getElementById('edit-expense-category-select');
    const editPaymentMethodSelect = document.getElementById('edit-payment-method-select');
    const editCreditCardPaymentSelect = document.getElementById('edit-credit-card-payment-select');
    const editMonthPaymentSelect = document.getElementById('edit-month-payment-select');
    const editPaymentPlatformSelect = document.getElementById('edit-payment-platform-select');
    const editActualCostInput = document.getElementById('edit-actual-cost-input');
    const editRecordCostInput = document.getElementById('edit-record-cost-input');
    const editNoteInput = document.getElementById('edit-note-input');
    if (editItemInput) editItemInput.disabled = true;
    if (editExpenseCategorySelect) editExpenseCategorySelect.disabled = true;
    if (editPaymentMethodSelect) editPaymentMethodSelect.disabled = true;
    if (editCreditCardPaymentSelect) editCreditCardPaymentSelect.disabled = true;
    if (editMonthPaymentSelect) editMonthPaymentSelect.disabled = true;
    if (editPaymentPlatformSelect) editPaymentPlatformSelect.disabled = true;
    if (editActualCostInput) editActualCostInput.disabled = true;
    if (editRecordCostInput) editRecordCostInput.disabled = true;
    if (editNoteInput) editNoteInput.disabled = true;

    // 禁用主頁面的所有輸入和按鈕
    const itemInput = document.getElementById('item-input');
    const expenseCategorySelect = document.getElementById('expense-category-select');
    const paymentMethodSelect = document.getElementById('payment-method-select');
    const creditCardPaymentSelect = document.getElementById('credit-card-payment-select');
    const monthPaymentSelect = document.getElementById('month-payment-select');
    const paymentPlatformSelect = document.getElementById('payment-platform-select');
    const actualCostInput = document.getElementById('actual-cost-input');
    const recordCostInput = document.getElementById('record-cost-input');
    const noteInput = document.getElementById('note-input');
    if (itemInput) itemInput.disabled = true;
    if (expenseCategorySelect) expenseCategorySelect.disabled = true;
    if (paymentMethodSelect) paymentMethodSelect.disabled = true;
    if (creditCardPaymentSelect) creditCardPaymentSelect.disabled = true;
    if (monthPaymentSelect) monthPaymentSelect.disabled = true;
    if (paymentPlatformSelect) paymentPlatformSelect.disabled = true;
    if (actualCostInput) actualCostInput.disabled = true;
    if (recordCostInput) recordCostInput.disabled = true;
    if (noteInput) noteInput.disabled = true;
    if (saveButton) saveButton.disabled = true;
    if (historyButton) historyButton.disabled = true;

    try {
      await saveDataForEdit(fullRecord);
      // 等待後端回傳後才顯示成功訊息
      alert('修改成功！');
      modal.remove();
      // 關閉編輯視窗後，重新載入歷史記錄列表以顯示最新數據
      // 找到歷史記錄列表的 modal
      const historyModal = document.querySelector('.history-modal');
      if (historyModal) {
        // 重新載入當前月份的記錄列表（從暫存區重新載入，因為已經更新）
        const newRecords = loadHistoryListFromCache(currentSheetIndex);
        const listElement = historyModal.querySelector('.history-list');
        if (listElement) {
          // 使用 updateHistoryList 函數更新列表
          listElement.innerHTML = '';
          const displayRecords = newRecords;
          if (displayRecords.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = '尚無歷史紀錄';
            emptyMsg.style.cssText = 'text-align: center; padding: 40px; color: #999;';
            listElement.appendChild(emptyMsg);
          } else {
            displayRecords.forEach(record => {
              listElement.appendChild(createHistoryItem(record, listElement));
            });
          }
        }
      }
    } catch (error) {
      alert('儲存失敗: ' + error.message);
    } finally {
      // 恢復所有按鈕和輸入
      hideSpinner();
      isSaving = false;
      saveBtn.textContent = '儲存';
      saveBtn.disabled = false;

      // 恢復編輯 modal 的輸入
      if (editItemInput) editItemInput.disabled = false;
      if (editExpenseCategorySelect) editExpenseCategorySelect.disabled = false;
      if (editPaymentMethodSelect) editPaymentMethodSelect.disabled = false;
      if (editCreditCardPaymentSelect) editCreditCardPaymentSelect.disabled = false;
      if (editMonthPaymentSelect) editMonthPaymentSelect.disabled = false;
      if (editPaymentPlatformSelect) editPaymentPlatformSelect.disabled = false;
      if (editActualCostInput) editActualCostInput.disabled = false;
      if (editRecordCostInput) editRecordCostInput.disabled = false;
      if (editNoteInput) editNoteInput.disabled = false;

      // 恢復主頁面的輸入和按鈕
      if (itemInput) itemInput.disabled = false;
      if (expenseCategorySelect) expenseCategorySelect.disabled = false;
      if (paymentMethodSelect) paymentMethodSelect.disabled = false;
      if (creditCardPaymentSelect) creditCardPaymentSelect.disabled = false;
      if (monthPaymentSelect) monthPaymentSelect.disabled = false;
      if (paymentPlatformSelect) paymentPlatformSelect.disabled = false;
      if (actualCostInput) actualCostInput.disabled = false;
      if (recordCostInput) recordCostInput.disabled = false;
      if (noteInput) noteInput.disabled = false;
      if (saveButton) saveButton.disabled = false;
      if (historyButton) historyButton.disabled = false;
    }
  };

  content.appendChild(closeBtn);
  content.appendChild(title);
  content.appendChild(formContainer);
  content.appendChild(saveBtn);
  modal.appendChild(content);

  // 點擊背景關閉編輯視窗，返回歷史記錄列表
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  };

  document.body.appendChild(modal);
}

// 刪除記錄的函數
async function deleteRecord(record) {
  // 優先使用預先標註好的 sheetRowIndex（在 loadHistoryListFromCache 中設定）
  const row = record.sheetRowIndex;

  if (!row) {
    throw new Error('無法找到要刪除的記錄位置（缺少列號資訊）');
  }

  const result = await callAPI({
    name: "Delete Data",
    sheet: currentSheetIndex,
    // 後端統一使用 updateRow 作為列號參數（新增/修改/刪除共用）
    updateRow: row
  });

  // 更新總計顯示（使用最新資料重新計算）
  updateTotalDisplay();

  // 更新暫存區和歷史記錄（使用回傳的 data）
  if (result.data) {
    processDataFromResponse(result.data, false, currentSheetIndex);
    allMonthsData[currentSheetIndex] = { data: result.data, total: result.total };

    // 保存到 sessionStorage
    try {
      const storageKey = `expense_monthData_${currentSheetIndex}`;
      sessionStorage.setItem(storageKey, JSON.stringify(allMonthsData[currentSheetIndex]));
    } catch (e) {
      // sessionStorage 可能已滿或不可用，忽略錯誤
    }

    refreshHistoryList();
  }
}

// 編輯模式的儲存函數
async function saveDataForEdit(record) {
  const formData = getFormData('edit');

  const allRecordsForMonth = loadHistoryListFromCache(currentSheetIndex);
  const recordTime = formatRecordDateTime(record.row[0] || '');
  const recordItem = (record.row[1] || '').trim();
  const recordCategory = (record.row[2] || '').trim();
  const originalRecordCost = (record.row[6] || '').toString().trim();

  const recordIndex = allRecordsForMonth.findIndex(r => {
    const rTime = formatRecordDateTime(r.row[0] || '');
    const rItem = (r.row[1] || '').trim();
    const rCategory = (r.row[2] || '').trim();
    const rCost = (r.row[6] || '').toString().trim();
    return rTime === recordTime && rItem === recordItem && rCategory === recordCategory && rCost === originalRecordCost;
  });

  if (recordIndex === -1) {
    throw new Error('無法找到對應的記錄位置');
  }

  const result = await callAPI({
    name: "Upsert Data",
    sheet: currentSheetIndex,
    ...formData,
    // sheet 第 1 列是標題，第 2 列才是第一筆資料，所以要 +2
    updateRow: recordIndex + 2
  });

  // 更新總計顯示（使用最新資料重新計算）
  updateTotalDisplay();

  // 更新暫存區和歷史記錄（使用回傳的 data）
  if (result.data) {
    processDataFromResponse(result.data, false, currentSheetIndex);
    allMonthsData[currentSheetIndex] = { data: result.data, total: result.total };

    // 保存到 sessionStorage
    try {
      const storageKey = `expense_monthData_${currentSheetIndex}`;
      sessionStorage.setItem(storageKey, JSON.stringify(allMonthsData[currentSheetIndex]));
    } catch (e) {
      // sessionStorage 可能已滿或不可用，忽略錯誤
    }

    refreshHistoryList();
  }
}

// 切換收入/支出類型
function switchType(targetType) {
    // 確保 categorySelect 元素存在
    const categorySelectElement = document.getElementById('category-select');
    if (!categorySelectElement) {
      return; // 如果元素不存在，直接返回
    }

    const currentType = categorySelectElement.value || '支出';

    // 如果目標類型與當前類型不同，則切換
    if (currentType !== targetType) {
      // 先更新全局變數，這樣 updateDivVisibility 才能讀取到正確的值
      if (typeof categorySelect !== 'undefined') {
        categorySelect.value = targetType;
      }

      // 更新 DOM 元素
      categorySelectElement.value = targetType;

      // 更新顯示文字
      const selectContainer = categorySelectElement.parentElement;
      if (selectContainer) {
        const selectDisplay = selectContainer.querySelector('div');
        if (selectDisplay) {
          const selectText = selectDisplay.querySelector('div');
          if (selectText) {
            selectText.textContent = targetType;
          }
        }
      }

      // 先更新 UI 元素顯示（特別是支出/收入的欄位切換）
      if (typeof updateDivVisibility === 'function') {
        updateDivVisibility();
      }

      // 然後過濾記錄並更新 UI（filterRecordsByType 會自動處理相同編號的查找）
      // 使用 setTimeout 確保 updateDivVisibility 完成後再執行
      setTimeout(() => {
      // updateDivVisibility 會重新創建 expense-category-select 元素，需要重新獲取並更新
      const newCategorySelectElement = document.getElementById('expense-category-select');
        if (newCategorySelectElement) {
          // 更新新創建的元素的值（如果目標類型是支出，設置第一個選項；如果是收入，不需要設置）
          if (targetType === '支出' && newCategorySelectElement.options.length > 0) {
            newCategorySelectElement.value = newCategorySelectElement.options[0].value;
            // 同步更新自訂下拉顯示文字
            const newSelectContainer = newCategorySelectElement.parentElement;
            if (newSelectContainer) {
              const newSelectDisplay = newSelectContainer.querySelector('div');
              if (newSelectDisplay) {
                const newSelectText = newSelectDisplay.querySelector('div');
                if (newSelectText) {
                  newSelectText.textContent = newCategorySelectElement.options[0].textContent;
                }
              }
            }
          }

          // 更新全局變數的 value 屬性（雖然元素已更換，但我們可以通過更新屬性來保持一致性）
          // 實際上，由於 categorySelect 是 const，我們需要確保後續代碼使用 getElementById 獲取最新元素
          // 但為了兼容性，我們也更新全局變數的 value（如果元素還存在的話）
          if (typeof categorySelect !== 'undefined' && categorySelect.parentNode) {
            categorySelect.value = targetType;
          }
        }

        if (typeof filterRecordsByType === 'function') {
          filterRecordsByType(targetType);
        }

        // 更新相關 UI 元素
        if (typeof updateArrowButtons === 'function') {
          updateArrowButtons();
        }
        if (typeof updateDeleteButton === 'function') {
          updateDeleteButton();
        }
      }, 200);
  }
}

// 鍵盤事件已簡化，移除導航功能

// 觸摸滑動事件已移除（純新增模式不需要）

// 移除類別選擇（支出/收入），改為新的表單欄位結構

const itemContainer = document.createElement('div');
itemContainer.className = 'item-container';

// 0. 日期（所有類型都要填寫）
const dateRow = createInputRow('日期：', 'date-input', 'date');
const dateInput = dateRow.querySelector('#date-input');
if (dateInput) {
  // 預設帶入今天（YYYY-MM-DD），可以手動修改
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  dateInput.value = `${year}-${month}-${day}`;
}

// 1. 項目
const itemRow = createInputRow('項目：', 'item-input', 'text');
const itemInput = itemRow.querySelector('#item-input');
itemInput.placeholder = '輸入項目名稱...';

// 2. 類別（消費類別）- 使用統一常數
const categoryRow = createSelectRow('類別：', 'expense-category-select', EXPENSE_CATEGORY_OPTIONS);
const expenseCategorySelect = categoryRow.querySelector('#expense-category-select');

// 類別變更時即時更新上方「預算 / 支出 / 餘額」
if (expenseCategorySelect) {
  expenseCategorySelect.addEventListener('change', () => {
    updateTotalDisplay();
  });
}

// 3. 支付方式 - 使用統一常數
const paymentMethodRow = createSelectRow('支付方式：', 'payment-method-select', PAYMENT_METHOD_OPTIONS);
const paymentMethodSelect = paymentMethodRow.querySelector('#payment-method-select');

// 4. 信用卡支付方式（條件顯示：支付方式是信用卡）- 使用統一常數
const creditCardPaymentRow = createSelectRow('信用卡支付方式：', 'credit-card-payment-select', CREDIT_CARD_PAYMENT_OPTIONS);
creditCardPaymentRow.style.display = 'none'; // 預設隱藏
const creditCardPaymentSelect = creditCardPaymentRow.querySelector('#credit-card-payment-select');

// 5. 本月／次月支付（條件顯示：支付方式是信用卡）- 使用統一常數
const monthPaymentRow = createSelectRow('本月／次月支付：', 'month-payment-select', MONTH_PAYMENT_OPTIONS);
monthPaymentRow.style.display = 'none'; // 預設隱藏
const monthPaymentSelect = monthPaymentRow.querySelector('#month-payment-select');

// 6. 支付平台（條件顯示：支付方式是存款或儲值的支出）- 使用統一常數
const paymentPlatformRow = createSelectRow('支付平台：', 'payment-platform-select', PAYMENT_PLATFORM_OPTIONS);
paymentPlatformRow.style.display = 'none'; // 預設隱藏
const paymentPlatformSelect = paymentPlatformRow.querySelector('#payment-platform-select');

// 7. 實際消費金額
const actualCostRow = createInputRow('實際消費金額：', 'actual-cost-input', 'number');
const actualCostInput = actualCostRow.querySelector('#actual-cost-input');

// 8. 列帳消費金額
const recordCostRow = createInputRow('列帳消費金額：', 'record-cost-input', 'number');
const recordCostInput = recordCostRow.querySelector('#record-cost-input');

// 實際金額 / 列帳金額 / 類別變更時即時更新上方「預算 / 支出 / 餘額」
if (actualCostInput) {
  actualCostInput.addEventListener('input', () => {
    updateTotalDisplay();
  });
}
if (recordCostInput) {
  recordCostInput.addEventListener('input', () => {
    updateTotalDisplay();
  });
}

// 9. 備註
const noteRow = document.createElement('div');
noteRow.className = 'input-row';
const noteLabel = document.createElement('label');
noteLabel.textContent = '備註：';
noteLabel.htmlFor = 'note-input';
const noteInput = document.createElement('textarea');
noteInput.id = 'note-input';
noteInput.name = 'note-input';
noteInput.rows = 3;
noteRow.appendChild(noteLabel);
noteRow.appendChild(noteInput);

// 條件顯示邏輯：根據支付方式顯示/隱藏相關欄位
const updatePaymentFieldsVisibility = () => {
  const paymentMethod = paymentMethodSelect.value;

  // 如果支付方式是信用卡，顯示信用卡支付方式和本月/次月支付
  if (paymentMethod === '信用卡支出') {
    creditCardPaymentRow.style.display = 'flex';
    monthPaymentRow.style.display = 'flex';
    paymentPlatformRow.style.display = 'none';
  }
  // 如果支付方式是存款或儲值的支出，顯示支付平台
  else if (paymentMethod === '存款或儲值的支出：LINE BANK / 悠遊付 / mos card / 髮果 等') {
    creditCardPaymentRow.style.display = 'none';
    monthPaymentRow.style.display = 'none';
    paymentPlatformRow.style.display = 'flex';
  }
  // 其他情況隱藏所有條件欄位
  else {
    creditCardPaymentRow.style.display = 'none';
    monthPaymentRow.style.display = 'none';
    paymentPlatformRow.style.display = 'none';
  }
};

// 監聽支付方式變更
paymentMethodSelect.addEventListener('change', updatePaymentFieldsVisibility);

// 將所有欄位添加到 itemContainer（日期放在項目名稱下面）
itemContainer.appendChild(itemRow);
itemContainer.appendChild(dateRow);
itemContainer.appendChild(categoryRow);
itemContainer.appendChild(paymentMethodRow);
itemContainer.appendChild(creditCardPaymentRow);
itemContainer.appendChild(monthPaymentRow);
itemContainer.appendChild(paymentPlatformRow);
itemContainer.appendChild(actualCostRow);
itemContainer.appendChild(recordCostRow);
itemContainer.appendChild(noteRow);

const saveButton = document.createElement('button');
saveButton.textContent = '儲存';
saveButton.className = 'save-button';

const columnsContainer = document.createElement('div');
columnsContainer.className = 'columns-container';

const incomeColumn = document.createElement('div');
incomeColumn.className = 'income-column';

const incomeTitle = document.createElement('h3');
incomeTitle.className = 'income-title';
incomeTitle.textContent = '預算：';

const incomeAmount = document.createElement('div');
incomeAmount.className = 'income-amount';
incomeAmount.textContent = 0;

const expenseColumn = document.createElement('div');
expenseColumn.className = 'expense-column';

const expenseTitle = document.createElement('h3');
expenseTitle.className = 'expense-title';
expenseTitle.textContent = '支出：';

const expenseAmount = document.createElement('div');
expenseAmount.className = 'expense-amount';
expenseAmount.textContent = 0;

const totalColumn = document.createElement('div');
totalColumn.className = 'total-column';

const totalTitle = document.createElement('h3');
totalTitle.className = 'total-title';
totalTitle.textContent = '餘額：';

const totalAmount = document.createElement('div');
totalAmount.className = 'total-amount';
totalAmount.textContent = 0;

const updateTotalColor = (value) => {
  const numValue = parseFloat(value) || 0;
  totalAmount.classList.remove('positive', 'negative');
  totalTitle.classList.remove('positive', 'negative');
  if (numValue > 0) {
    totalAmount.classList.add('positive');
    totalTitle.classList.add('positive');
  } else if (numValue < 0) {
    totalAmount.classList.add('negative');
    totalTitle.classList.add('negative');
  }
};


// 移除圓餅圖區域

const submitContainer = document.createElement('div');
submitContainer.style.width = '100%';
submitContainer.style.display = 'flex';
submitContainer.style.justifyContent = 'center';
submitContainer.style.padding = '0';



totalContainer.appendChild(columnsContainer);
      columnsContainer.appendChild(incomeColumn);
        incomeColumn.appendChild(incomeTitle);
        incomeColumn.appendChild(incomeAmount);
      columnsContainer.appendChild(expenseColumn);
        expenseColumn.appendChild(expenseTitle);
        expenseColumn.appendChild(expenseAmount);
      columnsContainer.appendChild(totalColumn);
        totalColumn.appendChild(totalTitle);
        totalColumn.appendChild(totalAmount);
budgetCardsContainer.appendChild(itemContainer);
budgetCardsContainer.appendChild(submitContainer);
  submitContainer.appendChild(saveButton);

saveButton.addEventListener('click', saveData);
saveButton.addEventListener('click', loadTotal);

// 為下拉選單容器添加防止回彈（主頁面由 CSS 處理）
// (function() {
//   // 檢查是否為拖拽元素
//   function isDragElement(target) {
//     return target.closest('.drag-handle') ||
//            target.closest('.option-item') ||
//            target.closest('[draggable="true"]') ||
//            target.classList.contains('drag-handle') ||
//            target.classList.contains('option-item') ||
//            target.hasAttribute('draggable');
//   }

//   // 硬鎖方案：在 dropdown 開啟時鎖定 body 滾動（防止整頁被拉開）
//   let bodyScrollLocked = false;
//   let scrollY = 0;

//   function lockBodyScroll() {
//     if (!bodyScrollLocked) {
//       // 記住當前滾動位置
//       scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
//       console.log('[硬鎖] 鎖定 body 滾動，當前 scrollY:', scrollY);

//       // 同時鎖定 html 和 body（iOS 上真正的 scroll container 有時是 html）
//       document.documentElement.style.overflow = 'hidden';
//       document.body.style.overflow = 'hidden';

//       // 使用 fixed 定位保持視覺位置，避免跳動
//       document.body.style.position = 'fixed';
//       document.body.style.top = `-${scrollY}px`;
//       document.body.style.width = '100%';

//       bodyScrollLocked = true;
//       console.log('[硬鎖] 鎖定完成，bodyScrollLocked:', bodyScrollLocked);
//     } else {
//       console.log('[硬鎖] 已經鎖定，跳過');
//     }
//   }

//   function unlockBodyScroll() {
//     if (bodyScrollLocked) {
//       console.log('[硬鎖] 解鎖 body 滾動，恢復 scrollY:', scrollY);

//       // 還原 html 和 body 的 overflow
//       document.documentElement.style.overflow = '';
//       document.body.style.overflow = '';

//       // 還原 body 的定位樣式
//       document.body.style.position = '';
//       document.body.style.top = '';
//       document.body.style.width = '';

//       // 恢復到原本的滾動位置
//       window.scrollTo(0, scrollY);

//       bodyScrollLocked = false;
//       console.log('[硬鎖] 解鎖完成，bodyScrollLocked:', bodyScrollLocked);
//     } else {
//       console.log('[硬鎖] 未鎖定，跳過解鎖');
//     }
//   }

//   // 監聽所有下拉選單的顯示/隱藏
//   let dropdownObserver = null;
//   let styleObserver = null;
//   const observedDropdowns = new Set();

//   function checkDropdownsAndLock() {
//     // 重新查詢所有下拉選單（因為是動態創建的）
//     const dropdowns = document.querySelectorAll('.category-dropdown, .select-dropdown');
//     console.log('[硬鎖] 檢查下拉選單，找到', dropdowns.length, '個');

//     let anyOpen = false;
//     const openDropdowns = [];

//     dropdowns.forEach((dropdown, index) => {
//       const isOpen = dropdown.style.display === 'block' ||
//                     window.getComputedStyle(dropdown).display === 'block';
//       if (isOpen) {
//         anyOpen = true;
//         openDropdowns.push(index);
//       }

//       // 為新創建的下拉選單設置監聽
//       if (!observedDropdowns.has(dropdown)) {
//         observedDropdowns.add(dropdown);
//         if (styleObserver) {
//           styleObserver.observe(dropdown, {
//             attributes: true,
//             attributeFilter: ['style']
//           });
//           console.log('[硬鎖] 開始監聽新下拉選單', index);
//         }
//       }
//     });

//     if (openDropdowns.length > 0) {
//       console.log('[硬鎖] 下拉選單狀態變化，開啟的數量:', openDropdowns.length, '索引:', openDropdowns);
//     }

//     if (anyOpen) {
//       lockBodyScroll();
//     } else {
//       unlockBodyScroll();
//     }
//   }

//   function setupBodyScrollLock() {
//     console.log('[硬鎖] 開始初始化');

//     // 創建監聽下拉選單樣式變化的 observer
//     styleObserver = new MutationObserver(() => {
//       checkDropdownsAndLock();
//     });

//     // 創建監聽 DOM 變化的 observer（當有新的 dropdown 被創建時）
//     dropdownObserver = new MutationObserver((mutations) => {
//       let hasNewDropdown = false;
//       mutations.forEach(mutation => {
//         mutation.addedNodes.forEach(node => {
//           if (node.nodeType === 1) { // Element node
//             if (node.classList && (
//               node.classList.contains('category-dropdown') ||
//               node.classList.contains('select-dropdown')
//             )) {
//               hasNewDropdown = true;
//             }
//             // 檢查子節點
//             if (node.querySelectorAll) {
//               const childDropdowns = node.querySelectorAll('.category-dropdown, .select-dropdown');
//               if (childDropdowns.length > 0) {
//                 hasNewDropdown = true;
//               }
//             }
//           }
//         });
//       });

//       if (hasNewDropdown) {
//         console.log('[硬鎖] 檢測到新的下拉選單被創建');
//         checkDropdownsAndLock();
//       }
//     });

//     // 監聽整個 body 的變化
//     dropdownObserver.observe(document.body, {
//       childList: true,
//       subtree: true
//     });

//     // 初始檢查一次
//     checkDropdownsAndLock();

//     console.log('[硬鎖] 設置完成，開始監聽 DOM 變化');
//   }

//   // 為所有下拉選單容器添加防止回彈
//   function setupDropdownPrevention() {
//     const dropdowns = document.querySelectorAll('.category-dropdown, .select-dropdown, .options-list, .select-options');
//     dropdowns.forEach(dropdown => {
//       // 避免重複綁定
//       if (dropdown.dataset.bouncePrevented) return;
//       dropdown.dataset.bouncePrevented = 'true';

//       let dropdownTouchStartY = 0;

//       dropdown.addEventListener('touchstart', function(e) {
//         if (isDragElement(e.target) || window._isDragging) {
//           return;
//         }
//         dropdownTouchStartY = e.touches[0].clientY;
//       }, { passive: true });

//       dropdown.addEventListener('touchmove', function(e) {
//         if (window._isDragging || isDragElement(e.target)) {
//           return;
//         }

//         const currentY = e.touches[0].clientY;
//         const deltaY = currentY - dropdownTouchStartY;
//         const currentScrollTop = dropdown.scrollTop;
//         const scrollHeight = dropdown.scrollHeight;
//         const clientHeight = dropdown.clientHeight;

//         // 精準判斷：只在邊界且繼續向邊界方向滑動時阻止
//         // 使用 <= 1 而不是 === 0 以處理負值和次像素捨入（與設定頁保持一致）
//         const isAtTop = currentScrollTop <= 1;
//         const isAtBottom = currentScrollTop + clientHeight >= scrollHeight - 1;

//         // 在頂部且向下拉（deltaY > 0）時阻止
//         if (isAtTop && deltaY > 0) {
//           if (e.cancelable) {
//             e.preventDefault();
//           }
//           dropdown.scrollTop = 0;
//         }
//         // 在底部且向上拉（deltaY < 0）時阻止
//         else if (isAtBottom && deltaY < 0) {
//           if (e.cancelable) {
//             e.preventDefault();
//           }
//           dropdown.scrollTop = Math.max(0, scrollHeight - clientHeight);
//         }
//       }, { passive: false });
//     });
//   }

//   // 頁面載入後設置下拉選單
//   if (document.readyState === 'loading') {
//     document.addEventListener('DOMContentLoaded', () => {
//       setupDropdownPrevention();
//       // 啟用硬鎖方案（防止整頁被拉開）
//       setupBodyScrollLock();
//     });
//   } else {
//     setupDropdownPrevention();
//     // 啟用硬鎖方案（防止整頁被拉開）
//     setupBodyScrollLock();
//   }

//   // 監聽動態添加的下拉選單
//   const observer = new MutationObserver(() => {
//     setupDropdownPrevention();
//   });
//   observer.observe(document.body, { childList: true, subtree: true });
// })();

document.addEventListener('DOMContentLoaded', async function() {
  // 清除舊的快取資料，強制從 API 重新載入
  try {
    Object.keys(sessionStorage).forEach(key => {
      if (key.startsWith('expense_monthData_')) {
        sessionStorage.removeItem(key);
      }
    });
    // 清除記憶體中的資料
    Object.keys(allMonthsData).forEach(key => delete allMonthsData[key]);
  } catch (e) {
    // 忽略錯誤
  }

  // 先嘗試從 sessionStorage 載入 sheetNames
  try {
    const storedSheetNames = sessionStorage.getItem('expense_sheetNames');
    const storedHasInvalid = sessionStorage.getItem('expense_hasInvalidFirstTwoSheets');
    if (storedSheetNames) {
      sheetNames = JSON.parse(storedSheetNames);
      hasInvalidFirstTwoSheets = storedHasInvalid === 'true';
    }
  } catch (e) {
    // sessionStorage 可能不可用或數據損壞，忽略錯誤
  }

  try {
    // 確保 post-content 元素存在
    const postContentElements = document.getElementsByClassName('post-content');
    if (!postContentElements || postContentElements.length === 0) {
      // 嘗試等待一下再重試
      setTimeout(() => {
        const retryElements = document.getElementsByClassName('post-content');
        if (retryElements && retryElements.length > 0) {
          retryElements[0].appendChild(totalContainer);
          retryElements[0].appendChild(budgetCardsContainer);
        } else {
        }
      }, 500);
      return;
    }

    const postContent = postContentElements[0];
    // 添加總計容器和表單容器
    postContent.appendChild(totalContainer);
    postContent.appendChild(budgetCardsContainer);
    // 非阻塞載入「下拉選單」sheet 的最新選項，載入完成後更新所有 select
    const refreshDropdowns = () => {
      loadDropdownOptions().then(() => {
        // 更新所有下拉選單，確保順序同步
        updateSelectOptions('expense-category-select', EXPENSE_CATEGORY_OPTIONS);
        updateSelectOptions('payment-method-select', PAYMENT_METHOD_OPTIONS);
        updateSelectOptions('credit-card-payment-select', CREDIT_CARD_PAYMENT_OPTIONS);
        updateSelectOptions('month-payment-select', MONTH_PAYMENT_OPTIONS);
        updateSelectOptions('payment-platform-select', PAYMENT_PLATFORM_OPTIONS);
      }).catch(err => {
      });
    };

    refreshDropdowns();

    // 監聽設定頁的更新通知（當設定頁更新下拉選單後，自動重新載入）
    // 使用 capture 階段確保能捕獲到事件
    window.addEventListener('storage', (e) => {
      if (e.key === 'dropdownUpdated') {
        refreshDropdowns();
      }
    }, true);

    // 監聽同頁面的自定義事件（當同一頁面觸發更新時）
    window.addEventListener('dropdownUpdated', () => {
      refreshDropdowns();
    });

    // 也監聽同頁面的 storage 事件（因為 storage 事件只在其他標籤頁觸發）
    let lastUpdateTime = localStorage.getItem('dropdownUpdated');
    const checkInterval = setInterval(() => {
      const current = localStorage.getItem('dropdownUpdated');
      if (current && current !== lastUpdateTime) {
        lastUpdateTime = current;
        refreshDropdowns();
      }
    }, 500); // 每500毫秒檢查一次，更頻繁地檢查

    // 頁面卸載時清理定時器
    window.addEventListener('beforeunload', () => {
      clearInterval(checkInterval);
    });

    // 將歷史紀錄按鈕添加到頁面標題右側（留空隙）
    const pageTitle = document.querySelector('h1.post-title, h1, .post-title');

    if (pageTitle) {
      pageTitle.style.cssText = 'display: flex; align-items: center; justify-content: space-between;';
      // 在標題和按鈕之間留空隙
      const spacer = document.createElement('div');
      spacer.style.cssText = 'flex: 1;';
      pageTitle.appendChild(spacer);
      pageTitle.appendChild(historyButton);
    } else {
      // 如果找不到標題，創建一個標題容器
      const titleContainer = document.createElement('div');
      titleContainer.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;';
      const title = document.createElement('h1');
      title.textContent = '支出';
      titleContainer.appendChild(title);
      const spacer = document.createElement('div');
      spacer.style.cssText = 'flex: 1;';
      titleContainer.appendChild(spacer);
      titleContainer.appendChild(historyButton);
      postContent.insertBefore(titleContainer, postContent.firstChild);
    }

    // 預先載入月份列表和所有月份的數據
    try {
      await loadMonthNames();

      // 一開始就顯示總數
      const totalMonths = sheetNames.length;
      const totalProgress = totalMonths + 1; // 總進度 = 月份列表(1) + 所有月份
      updateProgress(0, totalProgress, '載入月份列表');

      // 更新進度：載入月份列表完成
      updateProgress(1, totalProgress, '載入月份列表');

      // 檢查當前月份是否已有表格，若沒有則請後端建立
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const currentMonthStr = `${year}${month}`;
      const hasCurrentMonth = sheetNames.includes(currentMonthStr);

      if (!hasCurrentMonth) {
        try {
          const createResult = await callAPI({ name: "Create Tab" });
          alert(createResult.message || `已建立新分頁：${currentMonthStr}`);
          // 重新載入月份列表，加入新建的月份
          await loadMonthNames();
          // 更新總數
          const newTotalMonths = sheetNames.length;
          const newTotalProgress = newTotalMonths + 1;
          updateProgress(1, newTotalProgress, '載入月份列表');
        } catch (createError) {
          alert('無法自動建立本月表格，請稍後再試或手動建立。');
        }
      }

      // 根據目前日期，設定對應的 sheet（找最接近的月份）
      if (sheetNames.length > 0) {
        const closestSheetIndex = findClosestMonth();
        currentSheetIndex = closestSheetIndex;
      }

      // 預載所有月份的資料（支出 + 預算）
      if (sheetNames.length > 0) {
        // 先嘗試從 sessionStorage 載入所有月份的資料
        sheetNames.forEach((name, idx) => {
          const sheetIndex = idx + 2;
          if (!allMonthsData[sheetIndex]) {
            try {
              const storageKey = `expense_monthData_${sheetIndex}`;
              const storedData = sessionStorage.getItem(storageKey);
              if (storedData) {
                allMonthsData[sheetIndex] = JSON.parse(storedData);
              }
            } catch (e) {
              // sessionStorage 可能不可用或數據損壞，忽略錯誤
            }
          }
        });

        // 載入當前月份資料（優先從記憶體讀取）
        updateProgress(2, totalProgress, '載入當前月份');
        let currentMonthData = allMonthsData[currentSheetIndex];

        // 如果記憶體中沒有當前月份資料，才發送請求
        if (!currentMonthData) {
          currentMonthData = await loadMonthData(currentSheetIndex);
        allMonthsData[currentSheetIndex] = currentMonthData;

          // 保存到 sessionStorage
          try {
            const storageKey = `expense_monthData_${currentSheetIndex}`;
            sessionStorage.setItem(storageKey, JSON.stringify(currentMonthData));
          } catch (e) {
            // sessionStorage 可能已滿或不可用，忽略錯誤
          }
        }

        // 立即處理並顯示當前月份資料
        processDataFromResponse(currentMonthData.data, true);
        updateTotalDisplay(currentMonthData.total);

        // 預載所有月份的支出資料
        preloadAllMonthsData()
          .then(() => {
            // 載入完成後更新總計顯示
            updateTotalDisplay();
            // 隱藏載入動畫
            hideSpinner();
          })
          .catch(e => {
            // 即使失敗也隱藏載入動畫
            hideSpinner();
          });

        // 預載所有月份的預算資料
        sheetNames.forEach((name, idx) => {
          const sheetIndex = idx + 2;
          loadBudgetForMonth(sheetIndex)
            .then(() => {
              // 如果是當月，更新總計顯示
              if (sheetIndex === currentSheetIndex) {
                updateTotalDisplay();
              }
            })
            .catch(err => {
            });
        });
      }
    } catch (e) {
    }

    // 等待 DOM 更新後再初始化表單，但避免清掉使用者已經輸入的內容
    setTimeout(() => {
      const itemInput = document.getElementById('item-input');
      const actualCostInput = document.getElementById('actual-cost-input');
      const recordCostInput = document.getElementById('record-cost-input');
      const noteInput = document.getElementById('note-input');

      const hasUserInput = !!(
        (itemInput && itemInput.value && itemInput.value.trim() !== '') ||
        (actualCostInput && actualCostInput.value && actualCostInput.value.trim() !== '') ||
        (recordCostInput && recordCostInput.value && recordCostInput.value !== '') ||
        (noteInput && noteInput.value && noteInput.value.trim() !== '')
      );

      if (!hasUserInput) {
        // 只有在表單目前是空的時候才執行初始化，避免清掉使用者正在輸入的內容
      clearForm();
      } else {
      }
    }, 100);

    // 載入總計
    try {
      await loadTotal();
    } catch (e) {
    }
  } catch (error) {
  }
});
</script>
