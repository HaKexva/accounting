<script>
  const WEB_APP_URL =
    'https://script.google.com/macros/s/AKfycbxd_aHlwcWnxNjD-f20kpobPOT_6YtrfaPmKSbgHTMHjUL0TPONXptzw5ngD1MsQFaFPQ/exec';
  let LAST_DATA = null;
  let IS_EDIT_MODE = true;

  // ç­‰å¾… DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
  document.addEventListener('DOMContentLoaded', function() {
    fetchData();
  });

  async function sendSectionUpdate(sectionTitle, headers, rows) {
    // å¾Œç«¯éœ€æ”¯æ´ action:updateSectionï¼Œä¾ sectionTitle æ±ºå®šæ›´æ–°å“ªå€‹å·¥ä½œè¡¨æˆ–å€å¡Š
    const payload = {
      action: 'updateSection',
      section: sectionTitle,
      headers,
      rows,
    };
    const resp = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload),
    });
    if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
    return resp.json();
  }

  function fetchData() {
    const container = document.getElementById('data-container');
    if (!container) {
      console.error('æ‰¾ä¸åˆ° data-container å…ƒç´ ');
      return;
    }

    // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
    container.innerHTML = '<p>æ­£åœ¨è¼‰å…¥è¨˜å¸³è³‡æ–™...</p>';

    fetch(WEB_APP_URL)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((result) => {
        console.log('æ”¶åˆ°çš„è³‡æ–™:', result);
        
        if (result && result.data) {
          LAST_DATA = result.data;
          displayAccountingData(LAST_DATA);
        } else {
          throw new Error('è³‡æ–™æ ¼å¼ä¸æ­£ç¢º');
        }
      })
      .catch((error) => {
        console.error('è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        container.innerHTML = `
          <div style="color: red; padding: 10px; background-color: #ffe6e6; border-radius: 5px;">
            <h3>è¼‰å…¥å¤±æ•—</h3>
            <p>ç„¡æ³•è¼‰å…¥è¨˜å¸³è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>
            <p>éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
          </div>
        `;
      });
  }

  function displayAccountingData(data) {
    const container = document.getElementById('data-container');
    if (!container) return;

    container.innerHTML = ''; // æ¸…é™¤è¼‰å…¥ä¸­è¨Šæ¯

    // å‰µå»ºä¸»è¦æ¨™é¡Œ
    const mainTitle = document.createElement('h1');
    mainTitle.textContent = 'è¨˜å¸³è³‡æ–™ç¸½è¦½';
    mainTitle.style.textAlign = 'center';
    mainTitle.style.marginBottom = '30px';
    mainTitle.style.color = '#2c3e50';
    container.appendChild(mainTitle);

    // æ°¸é ç·¨è¼¯æ¨¡å¼ï¼šä¸é¡¯ç¤ºåˆ‡æ›å·¥å…·åˆ—

    // é¡¯ç¤ºç•¶æœˆæ”¶å…¥
    if (data['ç•¶æœˆæ”¶å…¥'] && data['ç•¶æœˆæ”¶å…¥'].length > 0) {
      displaySection(container, 'ç•¶æœˆæ”¶å…¥', data['ç•¶æœˆæ”¶å…¥'], 'income');
    }

    // é¡¯ç¤ºç•¶æœˆæ”¯å‡º
    if (data['ç•¶æœˆæ”¯å‡ºé ç®—'] && data['ç•¶æœˆæ”¯å‡ºé ç®—'].length > 0) {
      displaySection(container, 'ç•¶æœˆæ”¯å‡ºé ç®—', data['ç•¶æœˆæ”¯å‡ºé ç®—'], 'expense');
    }

    // é¡¯ç¤ºéš”æœˆé è¨ˆæ”¯å‡º
    if (data['éš”æœˆé è¨ˆæ”¯å‡º'] && data['éš”æœˆé è¨ˆæ”¯å‡º'].length > 0) {
      displaySection(container, 'éš”æœˆé è¨ˆæ”¯å‡º', data['éš”æœˆé è¨ˆæ”¯å‡º'], 'future');
    }

    // é¡¯ç¤ºç•¶æœˆæ”¯å‡ºç´°é …
    if (data['ç•¶æœˆå¯¦éš›æ”¯å‡ºç´°é …'] && data['ç•¶æœˆå¯¦éš›æ”¯å‡ºç´°é …'].length > 0) {
      displayTransactionDetails(container, 'ç•¶æœˆå¯¦éš›æ”¯å‡ºç´°é …', data['ç•¶æœˆå¯¦éš›æ”¯å‡ºç´°é …']);
    }
  }

  function displaySection(container, title, items, type) {
    const section = document.createElement('div');
    section.className = 'accounting-section';
    section.style.marginBottom = '30px';
    section.style.padding = '20px';
    section.style.borderRadius = '8px';
    section.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';

    // æ ¹æ“šé¡å‹è¨­å®šèƒŒæ™¯è‰²
    if (type === 'income') {
      section.style.backgroundColor = '#e8f5e8';
      section.style.borderLeft = '4px solid #27ae60';
    } else if (type === 'expense') {
      section.style.backgroundColor = '#ffeaea';
      section.style.borderLeft = '4px solid #e74c3c';
    } else {
      section.style.backgroundColor = '#f0f8ff';
      section.style.borderLeft = '4px solid #3498db';
    }

    // å‰µå»ºå¯æ”¶åˆæ¨™é¡Œ
    const sectionTitle = document.createElement('h2');
    sectionTitle.textContent = title + ' â–¼';
    sectionTitle.style.marginBottom = '15px';
    sectionTitle.style.color = '#2c3e50';
    sectionTitle.style.cursor = 'pointer';
    sectionTitle.setAttribute('tabindex', '0');
    sectionTitle.setAttribute('role', 'button');
    sectionTitle.setAttribute('aria-expanded', 'true');
    section.appendChild(sectionTitle);

    // å‰µå»ºå…§å®¹å®¹å™¨
    const contentDiv = document.createElement('div');
    contentDiv.style.display = 'block';

    // å€å¡Šæ§åˆ¶åˆ—ï¼ˆåƒ…ç·¨è¼¯æ¨¡å¼é¡¯ç¤ºï¼‰
    const controlsDiv = document.createElement('div');
    controlsDiv.style.display = IS_EDIT_MODE ? 'flex' : 'none';
    controlsDiv.style.gap = '8px';
    controlsDiv.style.margin = '8px 0 12px 0';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'å„²å­˜æ­¤å€å¡Š';
    saveBtn.style.padding = '6px 10px';
    saveBtn.style.border = '1px solid #27ae60';
    saveBtn.style.background = '#e8f8f0';
    saveBtn.style.borderRadius = '6px';
    saveBtn.style.cursor = 'pointer';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'å–æ¶ˆè®Šæ›´';
    cancelBtn.style.padding = '6px 10px';
    cancelBtn.style.border = '1px solid #aaa';
    cancelBtn.style.background = '#f1f1f1';
    cancelBtn.style.borderRadius = '6px';
    cancelBtn.style.cursor = 'pointer';

    controlsDiv.appendChild(saveBtn);
    controlsDiv.appendChild(cancelBtn);
    contentDiv.appendChild(controlsDiv);

    // å‰µå»ºè¡¨æ ¼
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';
    table.style.tableLayout = 'auto'; // è®“è¡¨æ ¼è‡ªå‹•èª¿æ•´æ¬„ä½å¯¬åº¦

    // å‰µå»ºè¡¨é ­
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = Object.keys(items[0] || {});
    headers.forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      th.style.padding = '12px 15px';
      th.style.textAlign = 'left';
      th.style.borderBottom = '2px solid #ddd';
      th.style.backgroundColor = '#f8f9fa';
      th.style.whiteSpace = 'nowrap'; // é˜²æ­¢æ¨™é¡Œæ›è¡Œ
      th.style.minWidth = '80px'; // æœ€å°å¯¬åº¦
      // æ ¹æ“šæ¬„ä½å…§å®¹è¨­å®šå¯¬åº¦
      if (header.includes('é‡‘é¡') || header.includes('é ç®—') || header.includes('å¯¦éš›æ¶ˆè²»é‡‘é¡')) {
        th.style.width = '120px';
        th.style.textAlign = 'right';
      } else if (header.includes('é …ç›®')) {
        th.style.width = '200px';
      } else if (header.includes('ç´°ç¯€') || header.includes('å‚™è¨»')) {
        th.style.width = '300px';
        th.style.whiteSpace = 'normal'; // å…è¨±æ›è¡Œ
        th.style.wordWrap = 'break-word';
      } else if (header.includes('æ—¥æœŸ')) {
        th.style.width = '120px';
      } else if (header.includes('é¡åˆ¥')) {
        th.style.width = '250px';
      } else if (header.includes('æ–¹å¼')) {
        th.style.width = '150px';
      } else {
        th.style.width = 'auto';
      }
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // å‰µå»ºè¡¨æ ¼å…§å®¹
    const tbody = document.createElement('tbody');
    items.forEach((item, index) => {
      const row = document.createElement('tr');
      row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
      headers.forEach(header => {
        const td = document.createElement('td');
        td.textContent = item[header] || '';
        td.style.padding = '10px 15px';
        td.style.borderBottom = '1px solid #ddd';
        td.style.verticalAlign = 'top';
        if (IS_EDIT_MODE) {
          td.contentEditable = 'true';
          td.style.outline = '1px dashed rgba(0,0,0,0.2)';
          td.style.backgroundColor = 'rgba(255,255,0,0.06)';
        }
        // æ ¹æ“šæ¬„ä½é¡å‹è¨­å®šæ¨£å¼
        if (header.includes('é‡‘é¡') || header.includes('é ç®—') || header.includes('å¯¦éš›æ¶ˆè²»é‡‘é¡')) {
          td.style.fontWeight = 'bold';
          td.style.textAlign = 'right';
          td.style.fontFamily = 'monospace';
          if (type === 'income') {
            td.style.color = '#27ae60';
          } else if (type === 'expense') {
            td.style.color = '#e74c3c';
          }
        } else if (header.includes('ç´°ç¯€') || header.includes('å‚™è¨»')) {
          td.style.whiteSpace = 'normal';
          td.style.wordWrap = 'break-word';
          td.style.maxWidth = '300px';
          td.style.lineHeight = '1.4';
        } else if (header.includes('é …ç›®')) {
          td.style.fontWeight = '500';
          td.style.color = '#2c3e50';
        } else if (header.includes('æ—¥æœŸ')) {
          td.style.fontFamily = 'monospace';
          td.style.color = '#7f8c8d';
        } else if (header.includes('é¡åˆ¥')) {
          td.style.color = '#34495e';
          td.style.fontSize = '0.95em';
        } else if (header.includes('æ–¹å¼')) {
          td.style.color = '#7f8c8d';
          td.style.fontSize = '0.9em';
        }
        row.appendChild(td);
      });
      tbody.appendChild(row);
    });
    table.appendChild(tbody);

    // tfoot ç¸½è¨ˆåˆ—ï¼ˆè‡ªå‹•åŠ ç¸½ã€ä¸å¯ç·¨è¼¯ï¼‰
    const tfoot = document.createElement('tfoot');
    const totalRow = document.createElement('tr');
    headers.forEach((header, i) => {
      const td = document.createElement('td');
      td.style.padding = '10px 15px';
      td.style.borderTop = '2px solid #aaa';
      td.style.fontWeight = 'bold';
      if (i === 0) {
        td.textContent = 'ç¸½è¨ˆ';
      } else if (header.includes('é‡‘é¡') || header.includes('é ç®—') || header.includes('å¯¦éš›æ¶ˆè²»é‡‘é¡')) {
        td.style.textAlign = 'right';
        td.style.fontFamily = 'monospace';
        td.dataset.totalFor = header;
      } else {
        td.textContent = '';
      }
      totalRow.appendChild(td);
    });
    tfoot.appendChild(totalRow);
    table.appendChild(tfoot);

    // è¨ˆç®—ç¸½è¨ˆçš„å‡½å¼
    function recalcTotals() {
      headers.forEach((header) => {
        if (header.includes('é‡‘é¡') || header.includes('é ç®—') || header.includes('å¯¦éš›æ¶ˆè²»é‡‘é¡')) {
          let sum = 0;
          Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
            const idx = headers.indexOf(header);
            const cell = tr.children[idx];
            const num = parseFloat((cell?.innerText || '').replace(/[^\d.-]/g, '')) || 0;
            sum += num;
          });
          const totalCell = totalRow.children[headers.indexOf(header)];
          if (totalCell) totalCell.textContent = sum.toLocaleString();
        }
      });
    }

    // é¦–æ¬¡è¨ˆç®— + ç·¨è¼¯å³æ™‚æ›´æ–°
    setTimeout(recalcTotals, 0);
    tbody.addEventListener('input', recalcTotals);
    contentDiv.appendChild(table);
    section.appendChild(contentDiv);
    container.appendChild(section);

    // äº‹ä»¶ï¼šå„²å­˜/å–æ¶ˆï¼ˆåƒ…ç·¨è¼¯æ¨¡å¼ï¼‰
    cancelBtn.addEventListener('click', () => {
      displayAccountingData(LAST_DATA || data);
    });

    saveBtn.addEventListener('click', async () => {
      // å¾è¡¨æ ¼è®€å›è³‡æ–™
      const newRows = [];
      const bodyRows = Array.from(tbody.querySelectorAll('tr'));
      bodyRows.forEach((tr) => {
        const obj = {};
        const cells = Array.from(tr.querySelectorAll('td'));
        headers.forEach((h, i) => {
          obj[h] = (cells[i]?.innerText || '').trim();
        });
        newRows.push(obj);
      });

      saveBtn.disabled = true;
      saveBtn.textContent = 'å„²å­˜ä¸­...';
      try {
        const resp = await sendSectionUpdate(title, headers, newRows);
        if (resp && resp.data) {
          LAST_DATA = resp.data;
        }
        // é‡æ–°æ¸²æŸ“
        displayAccountingData(LAST_DATA || data);
        alert('å·²å„²å­˜æˆåŠŸ');
      } catch (e) {
        console.error(e);
        alert('å„²å­˜å¤±æ•—ï¼š' + (e?.message || 'æœªçŸ¥éŒ¯èª¤'));
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'å„²å­˜æ­¤å€å¡Š';
      }
    });

    // æ”¶åˆ/å±•é–‹åŠŸèƒ½
    sectionTitle.addEventListener('click', function() {
      if (contentDiv.style.display === 'none') {
        contentDiv.style.display = 'block';
        sectionTitle.textContent = title + ' â–¼';
        sectionTitle.setAttribute('aria-expanded', 'true');
      } else {
        contentDiv.style.display = 'none';
        sectionTitle.textContent = title + ' â–²';
        sectionTitle.setAttribute('aria-expanded', 'false');
      }
    });
    sectionTitle.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        sectionTitle.click();
      }
    });
  }

  function displayTransactionDetails(container, title, transactions) {
    const section = document.createElement('div');
    section.className = 'transaction-section';
    section.style.marginBottom = '30px';
    section.style.padding = '20px';
    section.style.backgroundColor = '#f9f9f9';
    section.style.borderRadius = '8px';
    section.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
    section.style.borderLeft = '4px solid #9b59b6';

    // å‰µå»ºå¯æ”¶åˆæ¨™é¡Œ
    const sectionTitle = document.createElement('h2');
    sectionTitle.textContent = title + ' â–¼';
    sectionTitle.style.marginBottom = '15px';
    sectionTitle.style.color = '#2c3e50';
    sectionTitle.style.cursor = 'pointer';
    sectionTitle.setAttribute('tabindex', '0');
    sectionTitle.setAttribute('role', 'button');
    sectionTitle.setAttribute('aria-expanded', 'true');
    section.appendChild(sectionTitle);

    // å…§å®¹å®¹å™¨
    const contentDiv = document.createElement('div');
    contentDiv.style.display = 'block';

    // å€å¡Šæ§åˆ¶åˆ—ï¼ˆåƒ…ç·¨è¼¯æ¨¡å¼é¡¯ç¤ºï¼‰
    const controlsDiv = document.createElement('div');
    controlsDiv.style.display = IS_EDIT_MODE ? 'flex' : 'none';
    controlsDiv.style.gap = '8px';
    controlsDiv.style.margin = '8px 0 12px 0';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'å„²å­˜æ­¤å€å¡Š';
    saveBtn.style.padding = '6px 10px';
    saveBtn.style.border = '1px solid #27ae60';
    saveBtn.style.background = '#e8f8f0';
    saveBtn.style.borderRadius = '6px';
    saveBtn.style.cursor = 'pointer';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'å–æ¶ˆè®Šæ›´';
    cancelBtn.style.padding = '6px 10px';
    cancelBtn.style.border = '1px solid #aaa';
    cancelBtn.style.background = '#f1f1f1';
    cancelBtn.style.borderRadius = '6px';
    cancelBtn.style.cursor = 'pointer';

    controlsDiv.appendChild(saveBtn);
    controlsDiv.appendChild(cancelBtn);
    contentDiv.appendChild(controlsDiv);

    // å‰µå»ºçµ±è¨ˆè³‡è¨Š
    const totalAmount = transactions.reduce((sum, t) => sum + (parseFloat(t['å¯¦éš›æ¶ˆè²»é‡‘é¡']) || 0), 0);
    const statsDiv = document.createElement('div');
    statsDiv.style.marginBottom = '15px';
    statsDiv.style.padding = '10px';
    statsDiv.style.backgroundColor = '#ffffff';
    statsDiv.style.borderRadius = '5px';
    statsDiv.innerHTML = `
      <strong>ç¸½äº¤æ˜“ç­†æ•¸:</strong> ${transactions.length} ç­† | 
      <strong>ç¸½æ”¯å‡ºé‡‘é¡:</strong> <span style="color: #e74c3c; font-weight: bold;">${totalAmount.toLocaleString()} å…ƒ</span>
    `;
    contentDiv.appendChild(statsDiv);

    // å‰µå»ºäº¤æ˜“åˆ—è¡¨
    const transactionList = document.createElement('div');
    transactions.forEach((transaction) => {
      const transactionDiv = document.createElement('div');
      transactionDiv.style.backgroundColor = '#ffffff';
      transactionDiv.style.marginBottom = '10px';
      transactionDiv.style.padding = '15px';
      transactionDiv.style.borderRadius = '5px';
      transactionDiv.style.borderLeft = '3px solid #9b59b6';
      transactionDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

      // æ¨™é¡Œåˆ—ï¼ˆé …ç›®èˆ‡é‡‘é¡ï¼‰
      const titleRow = document.createElement('div');
      titleRow.style.display = 'flex';
      titleRow.style.justifyContent = 'space-between';
      titleRow.style.alignItems = 'center';
      titleRow.style.marginBottom = '5px';

      const nameEl = document.createElement('strong');
      nameEl.style.color = '#2c3e50';
      nameEl.textContent = transaction['äº¤æ˜“é …ç›®'] || '';
      if (IS_EDIT_MODE) nameEl.contentEditable = 'true';

      const amountEl = document.createElement('span');
      amountEl.style.color = '#e74c3c';
      amountEl.style.fontWeight = 'bold';
      amountEl.style.fontSize = '1.1em';
      const amountNumber = parseFloat(transaction['å¯¦éš›æ¶ˆè²»é‡‘é¡'] || 0) || 0;
      amountEl.textContent = IS_EDIT_MODE ? String(amountNumber) : `${amountNumber.toLocaleString()} å…ƒ`;
      if (IS_EDIT_MODE) amountEl.contentEditable = 'true';

      titleRow.appendChild(nameEl);
      titleRow.appendChild(amountEl);

      // è³‡è¨Šåˆ—ï¼ˆæ—¥æœŸã€é¡åˆ¥ã€æ”¯ä»˜ã€å‚™è¨»ï¼‰
      const metaRow = document.createElement('div');
      metaRow.style.color = '#7f8c8d';
      metaRow.style.fontSize = '0.9em';

      const dateEl = document.createElement('span');
      const originalDate = transaction['äº¤æ˜“æ—¥æœŸ'] || '';
      if (IS_EDIT_MODE) {
        dateEl.textContent = originalDate;
        dateEl.contentEditable = 'true';
      } else {
        const date = originalDate ? new Date(originalDate) : null;
        const formattedDate = date && !isNaN(date) ? date.toLocaleDateString('zh-TW') : originalDate;
        dateEl.textContent = `ğŸ“… ${formattedDate}`;
      }

      const catEl = document.createElement('span');
      catEl.textContent = IS_EDIT_MODE ? (transaction['æ¶ˆè²»é¡åˆ¥'] || '') : `ğŸ·ï¸ ${transaction['æ¶ˆè²»é¡åˆ¥'] || ''}`;
      if (IS_EDIT_MODE) catEl.contentEditable = 'true';

      const payEl = document.createElement('span');
      payEl.textContent = IS_EDIT_MODE ? (transaction['æ”¯ä»˜æ–¹å¼'] || '') : `ğŸ’³ ${transaction['æ”¯ä»˜æ–¹å¼'] || ''}`;
      if (IS_EDIT_MODE) payEl.contentEditable = 'true';

      const noteEl = document.createElement('span');
      noteEl.textContent = IS_EDIT_MODE ? (transaction['å‚™è¨»'] || '') : (transaction['å‚™è¨»'] ? `ğŸ“ ${transaction['å‚™è¨»']}` : '');
      if (IS_EDIT_MODE) noteEl.contentEditable = 'true';

      // çµ„è£ metaRowï¼ŒåŠ å…¥åˆ†éš”ç¬¦è™Ÿ
      metaRow.appendChild(dateEl);
      if (!IS_EDIT_MODE) metaRow.appendChild(document.createTextNode(' | '));
      metaRow.appendChild(catEl);
      if (!IS_EDIT_MODE) metaRow.appendChild(document.createTextNode(' | '));
      metaRow.appendChild(payEl);
      if (!IS_EDIT_MODE) metaRow.appendChild(document.createTextNode(' | '));
      if (noteEl.textContent !== '' || IS_EDIT_MODE) {
        metaRow.appendChild(noteEl);
      }

      transactionDiv.appendChild(titleRow);
      transactionDiv.appendChild(metaRow);

      transactionList.appendChild(transactionDiv);
    });
    contentDiv.appendChild(transactionList);
    section.appendChild(contentDiv);
    container.appendChild(section);

    // äº‹ä»¶ï¼šå„²å­˜/å–æ¶ˆï¼ˆåƒ…ç·¨è¼¯æ¨¡å¼ï¼‰
    cancelBtn.addEventListener('click', () => {
      displayAccountingData(LAST_DATA);
    });

    saveBtn.addEventListener('click', async () => {
      // è®€å›è³‡æ–™
      const newRows = [];
      const cards = Array.from(transactionList.children);
      cards.forEach((card) => {
        const strong = card.querySelector('strong');
        const spans = card.querySelectorAll('span');
        // spans: amountEl + others; å› ç‚ºæˆ‘å€‘æœ‰å¤šå€‹ spanï¼Œéœ€ç²¾ç¢ºæŠ“å–
        const name = strong?.innerText?.trim() || '';
        const amountText = spans[0]?.innerText?.trim() || '0';
        // æ¥è‘—æ˜¯ dateEl, catEl, payEl, noteElï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
        const dateText = spans[1]?.innerText?.replace(/^ğŸ“…\s*/, '').trim() || spans[1]?.innerText?.trim() || '';
        const cat = spans[2]?.innerText?.replace(/^ğŸ·ï¸\s*/, '').trim() || spans[2]?.innerText?.trim() || '';
        const pay = spans[3]?.innerText?.replace(/^ğŸ’³\s*/, '').trim() || spans[3]?.innerText?.trim() || '';
        const note = (spans[4]?.innerText || '').replace(/^ğŸ“\s*/, '').trim();
        newRows.push({
          'äº¤æ˜“æ—¥æœŸ': dateText,
          'äº¤æ˜“é …ç›®': name,
          'æ¶ˆè²»é¡åˆ¥': cat,
          'æ”¯ä»˜æ–¹å¼': pay,
          'å¯¦éš›æ¶ˆè²»é‡‘é¡': amountText,
          'å‚™è¨»': note,
        });
      });

      saveBtn.disabled = true;
      saveBtn.textContent = 'å„²å­˜ä¸­...';
      try {
        const headers = ['äº¤æ˜“æ—¥æœŸ','äº¤æ˜“é …ç›®','æ¶ˆè²»é¡åˆ¥','æ”¯ä»˜æ–¹å¼','å¯¦éš›æ¶ˆè²»é‡‘é¡','å‚™è¨»'];
        const resp = await sendSectionUpdate(title, headers, newRows);
        if (resp && resp.data) {
          LAST_DATA = resp.data;
        }
        displayAccountingData(LAST_DATA);
        alert('å·²å„²å­˜æˆåŠŸ');
      } catch (e) {
        console.error(e);
        alert('å„²å­˜å¤±æ•—ï¼š' + (e?.message || 'æœªçŸ¥éŒ¯èª¤'));
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'å„²å­˜æ­¤å€å¡Š';
      }
    });

    // æ”¶åˆ/å±•é–‹åŠŸèƒ½
    sectionTitle.addEventListener('click', function() {
      if (contentDiv.style.display === 'none') {
        contentDiv.style.display = 'block';
        sectionTitle.textContent = title + ' â–¼';
        sectionTitle.setAttribute('aria-expanded', 'true');
      } else {
        contentDiv.style.display = 'none';
        sectionTitle.textContent = title + ' â–²';
        sectionTitle.setAttribute('aria-expanded', 'false');
      }
    });
    sectionTitle.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        sectionTitle.click();
      }
    });
  }
</script>