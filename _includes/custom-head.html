<script>
  const WEB_APP_URL =
    'https://script.google.com/macros/s/AKfycbz13j4ymrL3VExn-yYEPsdkEMk9NB7YK5a_2F2lSgWycD_27c--p4h9Uzr5OdFBVZnIxw/exec';

  // ç­‰å¾… DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
  document.addEventListener('DOMContentLoaded', function() {
    fetchData();
  });

  function fetchData() {
    const container = document.getElementById('data-container');
    if (!container) {
      console.error('æ‰¾ä¸åˆ° data-container å…ƒç´ ');
      return;
    }

    // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
    container.innerHTML = '<p>æ­£åœ¨è¼‰å…¥è¨˜å¸³è³‡æ–™...</p>';

    fetch(WEB_APP_URL)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((result) => {
        console.log('æ”¶åˆ°çš„è³‡æ–™:', result);
        
        if (result && result.data) {
          displayAccountingData(result.data);
        } else {
          throw new Error('è³‡æ–™æ ¼å¼ä¸æ­£ç¢º');
        }
      })
      .catch((error) => {
        console.error('è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        container.innerHTML = `
          <div style="color: red; padding: 10px; background-color: #ffe6e6; border-radius: 5px;">
            <h3>è¼‰å…¥å¤±æ•—</h3>
            <p>ç„¡æ³•è¼‰å…¥è¨˜å¸³è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>
            <p>éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
          </div>
        `;
      });
  }

  function displayAccountingData(data) {
    const container = document.getElementById('data-container');
    if (!container) return;

    container.innerHTML = ''; // æ¸…é™¤è¼‰å…¥ä¸­è¨Šæ¯

    // å‰µå»ºä¸»è¦æ¨™é¡Œ
    const mainTitle = document.createElement('h1');
    mainTitle.textContent = 'è¨˜å¸³è³‡æ–™ç¸½è¦½';
    mainTitle.style.textAlign = 'center';
    mainTitle.style.marginBottom = '30px';
    mainTitle.style.color = '#2c3e50';
    container.appendChild(mainTitle);

    // é¡¯ç¤ºç•¶æœˆæ”¶å…¥
    if (data['ç•¶æœˆæ”¶å…¥'] && data['ç•¶æœˆæ”¶å…¥'].length > 0) {
      displaySection(container, 'ç•¶æœˆæ”¶å…¥', data['ç•¶æœˆæ”¶å…¥'], 'income');
    }

    // é¡¯ç¤ºç•¶æœˆæ”¯å‡º
    if (data['ç•¶æœˆæ”¯å‡º'] && data['ç•¶æœˆæ”¯å‡º'].length > 0) {
      displaySection(container, 'ç•¶æœˆæ”¯å‡º', data['ç•¶æœˆæ”¯å‡º'], 'expense');
    }

    // é¡¯ç¤ºéš”æœˆé è¨ˆæ”¯å‡º
    if (data['éš”æœˆé è¨ˆæ”¯å‡º'] && data['éš”æœˆé è¨ˆæ”¯å‡º'].length > 0) {
      displaySection(container, 'éš”æœˆé è¨ˆæ”¯å‡º', data['éš”æœˆé è¨ˆæ”¯å‡º'], 'future');
    }

    // é¡¯ç¤ºç•¶æœˆæ”¯å‡ºç´°é …
    if (data['ç•¶æœˆæ”¯å‡ºç´°é …'] && data['ç•¶æœˆæ”¯å‡ºç´°é …'].length > 0) {
      displayTransactionDetails(container, 'ç•¶æœˆæ”¯å‡ºç´°é …', data['ç•¶æœˆæ”¯å‡ºç´°é …']);
    }
  }

  function displaySection(container, title, items, type) {
    const section = document.createElement('div');
    section.className = 'accounting-section';
    section.style.marginBottom = '30px';
    section.style.padding = '20px';
    section.style.borderRadius = '8px';
    section.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';

    // æ ¹æ“šé¡å‹è¨­å®šèƒŒæ™¯è‰²
    if (type === 'income') {
      section.style.backgroundColor = '#e8f5e8';
      section.style.borderLeft = '4px solid #27ae60';
    } else if (type === 'expense') {
      section.style.backgroundColor = '#ffeaea';
      section.style.borderLeft = '4px solid #e74c3c';
    } else {
      section.style.backgroundColor = '#f0f8ff';
      section.style.borderLeft = '4px solid #3498db';
    }

    // å‰µå»ºæ¨™é¡Œ
    const sectionTitle = document.createElement('h2');
    sectionTitle.textContent = title;
    sectionTitle.style.marginBottom = '15px';
    sectionTitle.style.color = '#2c3e50';
    section.appendChild(sectionTitle);

    // å‰µå»ºè¡¨æ ¼
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';

    // å‰µå»ºè¡¨é ­
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    // æ ¹æ“šè³‡æ–™çµæ§‹å‹•æ…‹å‰µå»ºè¡¨é ­
    const headers = Object.keys(items[0] || {});
    headers.forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      th.style.padding = '10px';
      th.style.textAlign = 'left';
      th.style.borderBottom = '2px solid #ddd';
      th.style.backgroundColor = '#f8f9fa';
      headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // å‰µå»ºè¡¨æ ¼å…§å®¹
    const tbody = document.createElement('tbody');
    items.forEach((item, index) => {
      const row = document.createElement('tr');
      row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
      
      headers.forEach(header => {
        const td = document.createElement('td');
        td.textContent = item[header] || '';
        td.style.padding = '8px 10px';
        td.style.borderBottom = '1px solid #ddd';
        
        // å¦‚æœæ˜¯é‡‘é¡æ¬„ä½ï¼ŒåŠ ä¸Šç‰¹æ®Šæ¨£å¼
        if (header.includes('é‡‘é¡') || header.includes('é ç®—') || header.includes('å¯¦éš›æ¶ˆè²»é‡‘é¡')) {
          td.style.fontWeight = 'bold';
          if (type === 'income') {
            td.style.color = '#27ae60';
          } else if (type === 'expense') {
            td.style.color = '#e74c3c';
          }
        }
        
        row.appendChild(td);
      });
      
      tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    section.appendChild(table);
    container.appendChild(section);
  }

  function displayTransactionDetails(container, title, transactions) {
    const section = document.createElement('div');
    section.className = 'transaction-section';
    section.style.marginBottom = '30px';
    section.style.padding = '20px';
    section.style.backgroundColor = '#f9f9f9';
    section.style.borderRadius = '8px';
    section.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
    section.style.borderLeft = '4px solid #9b59b6';

    // å‰µå»ºæ¨™é¡Œ
    const sectionTitle = document.createElement('h2');
    sectionTitle.textContent = title;
    sectionTitle.style.marginBottom = '15px';
    sectionTitle.style.color = '#2c3e50';
    section.appendChild(sectionTitle);

    // å‰µå»ºçµ±è¨ˆè³‡è¨Š
    const totalAmount = transactions.reduce((sum, t) => sum + (parseFloat(t['å¯¦éš›æ¶ˆè²»é‡‘é¡']) || 0), 0);
    const statsDiv = document.createElement('div');
    statsDiv.style.marginBottom = '15px';
    statsDiv.style.padding = '10px';
    statsDiv.style.backgroundColor = '#ffffff';
    statsDiv.style.borderRadius = '5px';
    statsDiv.innerHTML = `
      <strong>ç¸½äº¤æ˜“ç­†æ•¸:</strong> ${transactions.length} ç­† | 
      <strong>ç¸½æ”¯å‡ºé‡‘é¡:</strong> <span style="color: #e74c3c; font-weight: bold;">${totalAmount.toLocaleString()} å…ƒ</span>
    `;
    section.appendChild(statsDiv);

    // å‰µå»ºäº¤æ˜“åˆ—è¡¨
    const transactionList = document.createElement('div');
    transactions.forEach((transaction, index) => {
      const transactionDiv = document.createElement('div');
      transactionDiv.style.backgroundColor = '#ffffff';
      transactionDiv.style.marginBottom = '10px';
      transactionDiv.style.padding = '15px';
      transactionDiv.style.borderRadius = '5px';
      transactionDiv.style.borderLeft = '3px solid #9b59b6';
      transactionDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

      // æ ¼å¼åŒ–æ—¥æœŸ
      const date = new Date(transaction['äº¤æ˜“æ—¥æœŸ']);
      const formattedDate = date.toLocaleDateString('zh-TW');

      transactionDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <strong style="color: #2c3e50;">${transaction['äº¤æ˜“é …ç›®']}</strong>
          <span style="color: #e74c3c; font-weight: bold; font-size: 1.1em;">
            ${parseFloat(transaction['å¯¦éš›æ¶ˆè²»é‡‘é¡'] || 0).toLocaleString()} å…ƒ
          </span>
        </div>
        <div style="color: #7f8c8d; font-size: 0.9em;">
          <span>ğŸ“… ${formattedDate}</span> | 
          <span>ğŸ·ï¸ ${transaction['æ¶ˆè²»é¡åˆ¥']}</span> | 
          <span>ğŸ’³ ${transaction['æ”¯ä»˜æ–¹å¼']}</span>
          ${transaction['å‚™è¨»'] ? ` | <span>ğŸ“ ${transaction['å‚™è¨»']}</span>` : ''}
        </div>
      `;

      transactionList.appendChild(transactionDiv);
    });

    section.appendChild(transactionList);
    container.appendChild(section);
  }
</script>